---
phase: 54-usd-exchange-rate-auto-lock
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216400000_usd_exchange_rate_constraints.sql
  - app/(dashboard)/po/new/page.tsx
  - app/(dashboard)/invoice/new/page.tsx
  - app/(dashboard)/qmhq/new/[route]/page.tsx
  - components/qmhq/transaction-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "When USD is selected on PO create form, exchange rate auto-sets to 1.0 and input is disabled"
    - "When USD is selected on Invoice create form, exchange rate auto-sets to 1.0 and input is disabled"
    - "When USD is selected on QMHQ expense/po route form, exchange rate auto-sets to 1.0 and input is disabled"
    - "When USD is selected on financial transaction dialog, exchange rate auto-sets to 1.0 and input is disabled"
    - "Database rejects non-1.0 exchange rates for USD on purchase_orders, invoices, financial_transactions, and qmhq tables"
    - "Selecting a non-USD currency re-enables the exchange rate input"
  artifacts:
    - path: "supabase/migrations/20260216400000_usd_exchange_rate_constraints.sql"
      provides: "USD rate=1.0 constraints on 4 tables"
      contains: "usd_rate_one"
    - path: "app/(dashboard)/po/new/page.tsx"
      provides: "USD auto-lock on PO create"
      contains: "handleCurrencyChange"
    - path: "app/(dashboard)/invoice/new/page.tsx"
      provides: "USD auto-lock on Invoice create"
      contains: "handleCurrencyChange"
    - path: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      provides: "USD auto-lock on QMHQ route page"
      contains: "handleCurrencyChange"
    - path: "components/qmhq/transaction-dialog.tsx"
      provides: "USD auto-lock on transaction dialog"
      contains: "disabled"
  key_links:
    - from: "app/(dashboard)/po/new/page.tsx"
      to: "components/ui/exchange-rate-input.tsx"
      via: "disabled prop when currency === USD"
      pattern: "disabled.*currency.*USD"
    - from: "supabase/migrations/20260216400000_usd_exchange_rate_constraints.sql"
      to: "purchase_orders, invoices, financial_transactions, qmhq"
      via: "CHECK constraint"
      pattern: "currency != 'USD' OR exchange_rate = 1"
---

<objective>
Add USD exchange rate auto-lock to all financial forms and enforce at database level.

Purpose: Currently only the stock-in page auto-locks the exchange rate to 1.0 when USD is selected (Phase 9). The PO create, invoice create, QMHQ expense/po route, and transaction dialog all allow manual exchange rate entry for USD, which is incorrect since USD IS the reference currency (1 USD = 1 EUSD). This phase extends the auto-lock pattern and adds database constraints for data integrity.

Output: Database constraints on 4 tables + UI auto-lock on 4 forms.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/038_currency_constraints.sql
@app/(dashboard)/inventory/stock-in/page.tsx (lines 440-446 for handleCurrencyChange pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database constraints enforcing USD exchange_rate = 1.0</name>
  <files>supabase/migrations/20260216400000_usd_exchange_rate_constraints.sql</files>
  <action>
Create a migration that adds CHECK constraints to 4 tables, following the exact pattern from `038_currency_constraints.sql` on `inventory_transactions`.

For each of the following tables, add a constraint enforcing `currency != 'USD' OR exchange_rate = 1.0`:
1. `purchase_orders` - constraint name: `purchase_orders_usd_rate_one`
2. `invoices` - constraint name: `invoices_usd_rate_one`
3. `financial_transactions` - constraint name: `financial_transactions_usd_rate_one`
4. `qmhq` - constraint name: `qmhq_usd_rate_one`

Each constraint should:
- Use `DROP CONSTRAINT IF EXISTS` before `ADD CONSTRAINT` (idempotent)
- Use `CHECK (currency != 'USD' OR exchange_rate = 1.0)`
- Include a `COMMENT ON CONSTRAINT` explaining it (matching 038 pattern)

Also add positive exchange rate constraints for tables that don't have them yet (matching `inventory_transactions_exchange_rate_positive` pattern):
- `purchase_orders_exchange_rate_positive` - CHECK (exchange_rate > 0)
- `invoices_exchange_rate_positive` - CHECK (exchange_rate > 0)
- `financial_transactions_exchange_rate_positive` - CHECK (exchange_rate > 0)
- `qmhq_exchange_rate_positive` - CHECK (exchange_rate > 0) - only for records where exchange_rate IS NOT NULL (QMHQ item route has no exchange rate, but the column has a default of 1.0 so this should be fine)

Also add currency validation constraints for tables that don't have them yet (matching `inventory_transactions_currency_valid` pattern):
- `purchase_orders_currency_valid` - CHECK (currency IN ('USD', 'MMK', 'CNY', 'THB'))
- `invoices_currency_valid` - CHECK (currency IN ('USD', 'MMK', 'CNY', 'THB'))
- `financial_transactions_currency_valid` - CHECK (currency IN ('USD', 'MMK', 'CNY', 'THB', 'EUR', 'SGD')) - Note: transaction dialog supports EUR and SGD in addition to the base 4
- `qmhq_currency_valid` - CHECK (currency IN ('USD', 'MMK', 'CNY', 'THB', 'EUR', 'SGD')) - QMHQ route page also supports EUR/SGD

IMPORTANT: Before adding currency_valid constraints, check existing data. The transaction dialog and QMHQ new page support EUR and SGD currencies (see `currencies` array in those files), so the constraint must include those. For purchase_orders and invoices, the UI only offers MMK, USD, THB, CNY so the constraint can be tighter.

Add a header comment block explaining the migration purpose.
  </action>
  <verify>Run `npx supabase db reset` in the project root. The migration should apply cleanly without errors. All existing data should pass the new constraints (existing USD records should already have rate=1.0, or if not, verify there are no USD records with non-1.0 rates first).</verify>
  <done>All 4 tables have usd_rate_one, exchange_rate_positive, and currency_valid constraints. Migration runs cleanly on reset.</done>
</task>

<task type="auto">
  <name>Task 2: UI auto-lock on all financial forms</name>
  <files>
    app/(dashboard)/po/new/page.tsx
    app/(dashboard)/invoice/new/page.tsx
    app/(dashboard)/qmhq/new/[route]/page.tsx
    components/qmhq/transaction-dialog.tsx
  </files>
  <action>
Add USD exchange rate auto-lock to all 4 forms, following the exact pattern from `app/(dashboard)/inventory/stock-in/page.tsx` lines 440-446.

**Pattern to replicate (from stock-in page):**
```tsx
// Handle currency change - auto-set USD rate to 1.0 per database constraint
const handleCurrencyChange = (value: string) => {
  setCurrency(value);
  if (value === 'USD') {
    setExchangeRate('1');
  }
};
```

And on the ExchangeRateInput:
```tsx
<ExchangeRateInput
  value={exchangeRate}
  onValueChange={setExchangeRate}
  disabled={currency === 'USD'}
  className="..."
/>
```

And a helper text below the input:
```tsx
{currency === 'USD' && (
  <p className="text-xs text-amber-500 mt-1">USD rate is always 1.0</p>
)}
```

**File-specific changes:**

1. **PO create page** (`app/(dashboard)/po/new/page.tsx`):
   - Add `handleCurrencyChange` function (same pattern as stock-in)
   - Change `<Select value={currency} onValueChange={setCurrency}>` to `onValueChange={handleCurrencyChange}` (around line 448)
   - Add `disabled={currency === 'USD'}` to ExchangeRateInput (around line 462)
   - Add helper text below ExchangeRateInput when USD selected
   - NOTE: The currency Select currently uses MMK, USD, THB, CNY options. Keep these as-is.

2. **Invoice create page** (`app/(dashboard)/invoice/new/page.tsx`):
   - Add `handleCurrencyChange` function
   - Change `<Select value={currency} onValueChange={setCurrency}>` to `onValueChange={handleCurrencyChange}` (around line 539)
   - Add `disabled={currency === 'USD'}` to ExchangeRateInput (around line 553)
   - Add helper text below ExchangeRateInput when USD selected

3. **QMHQ route page** (`app/(dashboard)/qmhq/new/[route]/page.tsx`):
   - Add `handleCurrencyChange` function
   - Find the currency Select (uses the `currencies` array) and change `onValueChange={setCurrency}` to `onValueChange={handleCurrencyChange}`
   - Add `disabled={currency === 'USD'}` to ExchangeRateInput
   - Add helper text below ExchangeRateInput when USD selected

4. **Transaction dialog** (`components/qmhq/transaction-dialog.tsx`):
   - This one is special: currency is inherited from QMHQ and is already disabled in the UI
   - BUT the inherited exchange rate from QMHQ might not be 1.0 when QMHQ currency is USD
   - In the `useEffect` that fetches QMHQ data (lines 97-121), after setting currency and exchange rate from QMHQ data, add a check: if currency is 'USD', force exchange rate to '1'
   - Add `disabled={currency === 'USD'}` to the ExchangeRateInput (around line 406)
   - Add helper text when USD: below the ExchangeRateInput, show "USD rate is always 1.0" in amber text
   - Since currency is already locked/inherited, the user cannot change it, but the exchange rate should still be disabled for USD to prevent manual override

For all forms, also ensure that if the form initializes with USD already selected (e.g., from session storage restore in QMHQ route page), the exchange rate is forced to 1.0 on mount.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Then verify the changes by reading each file and confirming:
1. `handleCurrencyChange` function exists (or equivalent USD check for transaction dialog)
2. ExchangeRateInput has `disabled={currency === 'USD'}` prop
3. Helper text appears conditionally for USD
  </verify>
  <done>
All 4 forms auto-lock exchange rate to 1.0 when USD is selected and disable the input. Helper text "USD rate is always 1.0" appears when USD is the active currency. Build passes with no errors.
  </done>
</task>

</tasks>

<verification>
1. `npx supabase db reset` runs cleanly (all migrations including new constraints)
2. `npm run build` passes with no TypeScript errors
3. All 4 financial forms show disabled exchange rate input with value "1" when USD is selected
4. Changing from USD to another currency re-enables the exchange rate input
5. Database rejects INSERT/UPDATE with currency='USD' AND exchange_rate != 1.0 on all 4 tables
</verification>

<success_criteria>
- Database constraints enforce USD exchange_rate = 1.0 on purchase_orders, invoices, financial_transactions, and qmhq tables
- All financial forms (PO create, Invoice create, QMHQ expense/po route, Transaction dialog) auto-lock exchange rate to 1.0 when USD selected
- Exchange rate input is disabled when USD is the selected currency
- Helper text "USD rate is always 1.0" appears on all forms when USD selected
- Build passes, migration runs cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/54-usd-exchange-rate-auto-lock/54-01-SUMMARY.md`
</output>
