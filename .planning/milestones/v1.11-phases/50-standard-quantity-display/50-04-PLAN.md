---
phase: 50-standard-quantity-display
plan: 04
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - app/(dashboard)/qmhq/[id]/page.tsx
  - components/qmhq/items-summary-progress.tsx
  - app/(dashboard)/inventory/stock-out-requests/page.tsx
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMHQ item detail shows standard qty on requested quantities and stock-out transactions"
    - "QMHQ items summary progress shows standard qty alongside requested/approved/executed quantities"
    - "Stock-out requests list page shows standard qty in quantity columns"
    - "PO detail page passes standardUnitName to InvoicePDFButton for PDF generation"
    - "Invoice detail page passes standardUnitName to InvoicePDFButton for PDF generation"
  artifacts:
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail page with standard qty on item quantities and stock-outs"
    - path: "components/qmhq/items-summary-progress.tsx"
      provides: "Items progress component with standard qty alongside requested/approved"
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "PO detail page wiring standardUnitName to PDF button"
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail page wiring standardUnitName to PDF button and table"
  key_links:
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/ui/standard-unit-display.tsx"
      via: "import StandardUnitDisplay"
      pattern: "StandardUnitDisplay"
    - from: "app/(dashboard)/invoice/[id]/page.tsx"
      to: "lib/hooks/use-standard-unit-name.ts"
      via: "useStandardUnitName hook to pass to PDF button"
      pattern: "useStandardUnitName"
---

<objective>
Add standard quantity display to QMHQ detail, stock-out request list, and wire standardUnitName into PO/Invoice detail pages for PDF export.

Purpose: Complete the standard qty integration across all remaining views where quantities are displayed, including QMHQ item details, stock-out request lists, and wiring the PDF export props.
Output: Updated QMHQ detail, items summary progress, stock-out request list, PO detail, and Invoice detail with standard qty display.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-standard-quantity-display/50-01-SUMMARY.md
@app/(dashboard)/qmhq/[id]/page.tsx
@components/qmhq/items-summary-progress.tsx
@app/(dashboard)/po/[id]/page.tsx
@app/(dashboard)/invoice/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add standard qty to QMHQ detail page and items summary progress</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
    components/qmhq/items-summary-progress.tsx
  </files>
  <action>
**QMHQ Detail Page (app/(dashboard)/qmhq/[id]/page.tsx):**

1. Import `useStandardUnitName` from `@/lib/hooks/use-standard-unit-name`.

2. Call `useStandardUnitName()` at the component level to get `{ unitName }`.

3. Find the Item Route display section where item quantities are shown (around line ~870):
   ```tsx
   <span className="text-lg font-mono text-blue-400">{item.quantity}</span>
   ```
   Add standard qty below:
   ```tsx
   <span className="text-lg font-mono text-blue-400">{item.quantity}</span>
   {unitName && item.quantity != null && (
     <div className="text-xs font-mono text-slate-400">
       {(item.quantity * (item.conversion_rate ?? 1)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {unitName}
     </div>
   )}
   ```
   Note: qmhq_items may not have conversion_rate directly. Check the data structure — if conversion_rate is not on qmhq_items, use 1 as fallback since the QMHQ item route is a requested quantity (not a transaction with its own conversion rate). The conversion rate applies at the stock-out transaction level.

4. In the stock-out transactions section where `tx.quantity` is shown, add standard qty:
   ```tsx
   <div className="text-lg font-mono font-bold text-red-400">-{tx.quantity}</div>
   {unitName && (
     <div className="text-xs font-mono text-slate-400">
       -{((tx.quantity || 0) * (tx.conversion_rate ?? 1)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {unitName}
     </div>
   )}
   ```

5. Ensure the stock-out transaction query includes `conversion_rate` in the select.

6. For the SOR transaction groups, the transactions already include quantity. Pass `unitName` as a prop if needed, or use the hook in SORTransactionGroup component.

**Items Summary Progress (components/qmhq/items-summary-progress.tsx):**

1. Read the file to understand the ItemProgressData interface and how quantities are displayed.

2. Import `useStandardUnitName` and call at component level.

3. Add standard qty displays alongside requested, approved, and executed quantities in the progress display. Use the same two-line muted pattern:
   - For each quantity value shown (requested, approved, executed), add a smaller muted line below with the standard equivalent.
   - Since ItemsSummaryProgress receives aggregated quantities (not per-transaction), and different transactions may have different conversion_rates, the standard qty for requested should use 1 as default (QMHQ items don't have conversion_rate).
   - For approved/executed quantities, these come from SOR approvals and inventory transactions which do have conversion_rates. But since ItemsSummaryProgress receives pre-aggregated numbers, the standard qty calculation should also be pre-aggregated.

4. **Pragmatic approach:** Add optional `standardRequested`, `standardApproved`, `standardExecuted` fields to ItemProgressData. Compute them in the parent QMHQ detail page where the raw data is available. If not provided, skip the standard qty line.

5. In the QMHQ detail page, compute standard quantities when building `itemsProgressData`:
   - `standardExecuted`: sum of `standard_qty` from completed stock-out transactions for each item
   - `standardApproved`: sum of `approved_quantity * conversion_rate` from SOR approvals for each item
   - `standardRequested`: `requested_quantity * conversion_rate` from SOR line items (which have conversion_rate)
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(qmhq|items-summary)" | head -20` — should return 0 type errors.
  </verify>
  <done>
QMHQ detail page shows standard qty on item quantities and stock-out transactions. ItemsSummaryProgress shows standard qty alongside requested/approved/executed. Standard quantities use conversion_rate from their respective data sources.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire standardUnitName into PO and Invoice detail pages for PDF and list displays</name>
  <files>
    app/(dashboard)/po/[id]/page.tsx
    app/(dashboard)/invoice/[id]/page.tsx
    app/(dashboard)/inventory/stock-out-requests/page.tsx
  </files>
  <action>
**PO Detail Page (app/(dashboard)/po/[id]/page.tsx):**

1. Import `useStandardUnitName` from `@/lib/hooks/use-standard-unit-name`.

2. Call `useStandardUnitName()` at component level.

3. The PO detail page uses `ReadonlyLineItemsTable` which is already updated in Plan 02. No additional changes needed for the line items table itself.

4. If the PO detail page has any summary/aggregate quantity displays (total ordered, total invoiced, total received), add standard qty equivalents. Check if the page shows aggregate quantities in KPI cards or summary panels.

5. The PO detail page likely doesn't call InvoicePDFButton directly (invoices have their own detail page), but verify and add wiring if needed.

**Invoice Detail Page (app/(dashboard)/invoice/[id]/page.tsx):**

1. Import `useStandardUnitName` from `@/lib/hooks/use-standard-unit-name`.

2. Call `useStandardUnitName()` at component level.

3. The Invoice detail page uses `ReadonlyInvoiceLineItemsTable` which is already updated in Plan 02. No additional changes needed for the table itself.

4. The Invoice detail page renders `InvoicePDFButton`. Pass `standardUnitName={unitName}` prop:
   ```tsx
   <InvoicePDFButton
     invoice={...}
     lineItems={...}
     purchaseOrder={...}
     supplier={...}
     standardUnitName={unitName}
   />
   ```

5. Make sure the lineItems data passed to InvoicePDFButton includes `conversion_rate` for each line item. Check the Supabase query and add `conversion_rate` to the select if not already there.

6. If the Invoice detail page has summary quantity displays (total qty ordered, total received), add standard qty equivalents below them.

**Stock-Out Requests List Page (app/(dashboard)/inventory/stock-out-requests/page.tsx):**

1. Import `useStandardUnitName`.

2. If the list page shows quantity columns (requested qty, approved qty), add standard qty display below each quantity value.

3. Check the data table column definitions. If there are quantity columns, update them to show two-line format with standard qty using conversion_rate from the data.

4. The list page may show aggregated quantities per request. Use the same pattern: muted secondary line with standard equivalent.

**Stock-Out Request Detail wiring for PDF:**

1. In `app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx` (already modified in Plan 03), ensure the `StockOutPDFButton` call passes `standardUnitName={unitName}`:
   ```tsx
   <StockOutPDFButton
     request={...}
     lineItems={...}
     approvals={...}
     standardUnitName={unitName}
   />
   ```

2. Make sure lineItems and approvals passed to StockOutPDFButton include `conversion_rate` for each item.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(po/\[id\]|invoice/\[id\]|stock-out-requests/page)" | head -20` — should return 0 type errors.
  </verify>
  <done>
PO detail page uses updated ReadonlyLineItemsTable with standard qty. Invoice detail page passes standardUnitName to InvoicePDFButton for PDF generation. Stock-out requests list page shows standard qty in quantity columns. All PDF buttons receive standardUnitName prop.
  </done>
</task>

</tasks>

<verification>
1. QMHQ detail item quantities show standard qty below
2. QMHQ stock-out transactions show standard qty below
3. ItemsSummaryProgress shows standard qty for requested/approved/executed
4. Invoice detail page wires standardUnitName to InvoicePDFButton
5. Stock-out request list page shows standard qty in columns
6. Stock-out request detail wires standardUnitName to StockOutPDFButton
7. No TypeScript errors in modified files
</verification>

<success_criteria>
- QMHQ item route shows standard qty on all quantity displays
- Items summary progress shows standard equivalents
- PO and Invoice detail pages pass standardUnitName for PDF generation
- Stock-out request list shows standard qty columns
- All PDF buttons receive and pass standardUnitName
- Existing data with conversion_rate=1 displays correctly throughout
</success_criteria>

<output>
After completion, create `.planning/phases/50-standard-quantity-display/50-04-SUMMARY.md`
</output>
