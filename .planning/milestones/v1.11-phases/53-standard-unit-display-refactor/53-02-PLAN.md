---
phase: 53-standard-unit-display-refactor
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - components/po/po-line-items-table.tsx
  - components/invoice/invoice-line-items-table.tsx
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/po/new/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
  - app/(dashboard)/invoice/new/page.tsx
  - lib/pdf/documents/invoice-pdf.tsx
  - components/invoice/invoice-pdf-button.tsx
autonomous: true

must_haves:
  truths:
    - "PO readonly line items show per-item standard unit name (e.g. '25 kg', '120 pcs') on each row"
    - "PO readonly line items table has NO aggregate/total standard qty in footer"
    - "Invoice readonly line items show per-item standard unit name on each row"
    - "Invoice readonly line items table has NO aggregate/total standard qty in footer"
    - "Invoice PDF shows per-item unit names inline in Std Qty column"
    - "Invoice PDF has NO Total Standard Qty row in totals section"
    - "PO line item form shows live preview under conversion rate input: calculated total + unit name"
    - "Invoice creation Step 3 summary shows per-item unit names"
    - "No code in these files references useStandardUnitName hook"
  artifacts:
    - path: "components/po/po-line-items-table.tsx"
      provides: "ReadonlyLineItemsTable with per-item unitName, no aggregate totals"
    - path: "components/invoice/invoice-line-items-table.tsx"
      provides: "ReadonlyInvoiceLineItemsTable with per-item unitName, no aggregate totals"
    - path: "lib/pdf/documents/invoice-pdf.tsx"
      provides: "Invoice PDF with per-item unit names, no Total Standard Qty row"
  key_links:
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "components/po/po-line-items-table.tsx"
      via: "items array with unitName per line item from items->standard_units join"
      pattern: "standard_unit"
    - from: "app/(dashboard)/invoice/[id]/page.tsx"
      to: "lib/pdf/documents/invoice-pdf.tsx"
      via: "lineItems with per-item unitName passed to PDF"
      pattern: "unit_name"
---

<objective>
Refactor PO and Invoice display components to use per-item standard unit names from the items->standard_units join. Remove all aggregate standard qty totals. Add conversion rate live preview to PO form. Update Invoice PDF to use per-item unit names.

Purpose: PO and Invoice views show the correct per-item unit name (e.g. "kg", "pcs") on each line instead of a global name.
Output: Updated PO/Invoice display components, PDF, and form with per-item unit names.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/53-standard-unit-display-refactor/53-01-SUMMARY.md
@components/po/po-line-items-table.tsx
@components/invoice/invoice-line-items-table.tsx
@app/(dashboard)/po/[id]/page.tsx
@app/(dashboard)/invoice/[id]/page.tsx
@lib/pdf/documents/invoice-pdf.tsx
@components/invoice/invoice-pdf-button.tsx
@app/(dashboard)/invoice/new/page.tsx
@app/(dashboard)/po/new/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor PO and Invoice readonly tables to per-item unit names, remove aggregate totals</name>
  <files>
    components/po/po-line-items-table.tsx
    components/invoice/invoice-line-items-table.tsx
    app/(dashboard)/po/[id]/page.tsx
    app/(dashboard)/invoice/[id]/page.tsx
  </files>
  <action>
**ReadonlyLineItemsTable (PO) in `components/po/po-line-items-table.tsx`:**

1. Remove `import { useStandardUnitName }` from the file entirely (used in ReadonlyLineItemsTable).
2. Remove `const { unitName } = useStandardUnitName();` from ReadonlyLineItemsTable.
3. Remove the `totalStandardQty` calculation (`items.reduce(...)` computing total standard qty).
4. The items prop already has `item?: Pick<Item, "id" | "name" | "sku"> | null`. Extend this to include unit name. Change the items type to include a `unit_name?: string` field. Update `ReadonlyLineItemsTableProps`:
   ```
   items: (POLineItem & { item?: Pick<Item, "id" | "name" | "sku"> | null; unit_name?: string })[];
   ```
5. Pass `unitName={item.unit_name}` to each `<StandardUnitDisplay>` in the Qty cell.
6. In the footer: Remove the entire `totalStandardQty` display block (the `<td>` that shows aggregated standard qty with unit name). Replace it with a simple empty `<td>` or remove it. Keep the "Total" label and "Subtotal (currency)" cells intact.
7. Also keep the `import { StandardUnitDisplay }` -- it's still used per-row.

**Also in `po-line-items-table.tsx` -- EditableLineItemsTable:**
- Remove `import { useStandardUnitName }` if it was only used by ReadonlyLineItemsTable (check -- it is).
- The EditableLineItemsTable uses `StandardUnitDisplay` import -- but actually looking at the code, it imports it but does NOT use it in the editable table. Remove the unused import if so.
- Actually, the EditableLineItemsTable references `default_unit` in `availableItems` prop type and uses it. Leave those as-is for now (they'll work fine).

**ReadonlyInvoiceLineItemsTable in `components/invoice/invoice-line-items-table.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();` from ReadonlyInvoiceLineItemsTable.
3. Remove the `totalStandardQty` calculation.
4. Update `ReadonlyInvoiceLineItemsTableProps` items type to include `unit_name?: string`:
   ```
   items: (InvoiceLineItem & { item?: Pick<Item, "id" | "name" | "sku"> | null; unit_name?: string })[];
   ```
5. Pass `unitName={item.unit_name}` to each `<StandardUnitDisplay>` in the Qty cell.
6. In the footer: Remove the `totalStandardQty` display block. Keep "Total" label, "Subtotal" display intact.

**PO Detail Page `app/(dashboard)/po/[id]/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Update the PO line items query to join items->standard_units to get the unit name. The query currently fetches `item:items(id, name, sku)` on PO line items. Update to:
   ```
   item:items!po_line_items_item_id_fkey(id, name, sku, standard_unit_id, standard_unit_rel:standard_units!items_standard_unit_id_fkey(name))
   ```
   Or use a simpler approach: fetch items with their standard_unit relation, then map `unit_name` from the join result.
4. When passing items to ReadonlyLineItemsTable, map each item to include `unit_name: item.item?.standard_unit_rel?.name || undefined`.

**Invoice Detail Page `app/(dashboard)/invoice/[id]/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Update the invoice line items query to join through items->standard_units. The query fetches `item:items(id, name, sku)`. Update to include standard unit:
   ```
   item:items!invoice_line_items_item_id_fkey(id, name, sku, standard_unit_rel:standard_units!items_standard_unit_id_fkey(name))
   ```
4. When passing items to ReadonlyInvoiceLineItemsTable, map each item to include `unit_name: item.item?.standard_unit_rel?.name || undefined`.
5. Remove the `standardUnitName={unitName}` prop from InvoicePDFButton. Instead, pass per-item unit names in the lineItems array (see Task 2).
  </action>
  <verify>
    - `grep -c "useStandardUnitName" components/po/po-line-items-table.tsx` returns 0
    - `grep -c "useStandardUnitName" components/invoice/invoice-line-items-table.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/po/[id]/page.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/invoice/[id]/page.tsx` returns 0
    - `grep -c "totalStandardQty" components/po/po-line-items-table.tsx` returns 0
    - `grep -c "totalStandardQty" components/invoice/invoice-line-items-table.tsx` returns 0
    - `grep "unit_name" components/po/po-line-items-table.tsx` shows unit_name in props and usage
  </verify>
  <done>PO and Invoice readonly tables show per-item unit names on each row with no aggregate totals. Detail pages fetch unit names via items->standard_units joins.</done>
</task>

<task type="auto">
  <name>Task 2: Update Invoice PDF, Invoice creation, and PO form with per-item unit names and live preview</name>
  <files>
    lib/pdf/documents/invoice-pdf.tsx
    components/invoice/invoice-pdf-button.tsx
    app/(dashboard)/invoice/new/page.tsx
    app/(dashboard)/po/new/page.tsx
  </files>
  <action>
**Invoice PDF `lib/pdf/documents/invoice-pdf.tsx`:**

1. Remove the `standardUnitName?: string` prop from `InvoicePDFProps`.
2. Add `unit_name?: string` to the lineItems type within InvoicePDFProps (each line item has its own unit name).
3. The Std Qty column should ALWAYS be shown (since items always have a unit now, per Phase 52 NOT NULL constraint). Remove the conditional logic that checks `standardUnitName` to decide whether to show the column. Always include the "Std Qty" column.
4. In the table data mapping, render each line item's standard_qty with its own unit_name: `{formatAmount(standard_qty)} {item.unit_name || ''}` instead of using the global `standardUnitName`.
5. Remove the "Total Standard Qty" row from the totals section entirely (per locked decision: no aggregate standard qty sums anywhere).
6. Remove the `totalStandardQty` calculation.
7. Adjust column widths: since Std Qty column is always present, use the "with standard" widths permanently (Item: 25%, Std Qty: 12%, etc.).

**Invoice PDF Button `components/invoice/invoice-pdf-button.tsx`:**

1. Remove the `standardUnitName?: string` prop from `InvoicePDFButtonProps`.
2. Add `unit_name?: string` to the lineItems type.
3. Remove passing `standardUnitName` to InvoicePDF.
4. Pass `unit_name` through in lineItems array.

**Invoice Detail Page `app/(dashboard)/invoice/[id]/page.tsx` (continued from Task 1):**

5. When building lineItems for InvoicePDFButton, include `unit_name` per line item from the joined data.
6. Remove the `standardUnitName={unitName}` prop from InvoicePDFButton invocation.

**Invoice Creation Page `app/(dashboard)/invoice/new/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. The Step 3 summary currently uses `<StandardUnitDisplay>` for each line item. Update to pass `unitName` prop from item data.
4. To get the unit name, the invoice creation flow needs item data enriched with standard_unit. When PO line items are loaded in Step 2, the items already have names/SKUs. Update the PO line items query (or the items query used in the flow) to also fetch `standard_unit_rel:standard_units!items_standard_unit_id_fkey(name)` through the items join.
5. Pass `unitName={item.unit_name}` to `<StandardUnitDisplay>` in Step 3 summary.

**PO Creation Form `app/(dashboard)/po/new/page.tsx` -- Live Preview:**

1. Add a live preview below the ConversionRateInput in the EditableLineItemsTable. This requires updating the table in `components/po/po-line-items-table.tsx`.
2. In the EditableLineItemsTable, under the ConversionRateInput cell for each line item:
   - When `item.conversion_rate` is non-empty and `item.quantity > 0`, calculate: `standardQty = item.quantity * parseFloat(item.conversion_rate)`
   - Show below the input: `<span className="text-xs font-mono text-slate-400 mt-1">{formattedStdQty} {unitName}</span>`
   - The unit name needs to come from item data. The `availableItems` prop includes `default_unit` but we need the standard_units name.
   - Update `po/new/page.tsx` to fetch items with their standard unit names. The items query currently fetches `id, name, sku, default_unit, price_reference`. Add the standard_units join: update query to also fetch standard unit name.
   - Add `item_standard_unit?: string` to `LineItemFormData` interface.
   - When an item is selected (either from CategoryItemSelector or ItemDialog), populate `item_standard_unit` from the item's standard unit relation.
   - In the conversion rate cell, show preview: if `conversion_rate` is valid and > 0, show `{(quantity * parseFloat(conversion_rate)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {item.item_standard_unit || ''}` in muted text below the input.
   - Style: `text-xs font-mono text-slate-400 mt-0.5` (same muted secondary style as EUSD displays).

3. Similarly, in the EditableInvoiceLineItemsTable in `components/invoice/invoice-line-items-table.tsx`:
   - The invoice creation Step 2 also has a conversion rate column (check -- actually it does NOT. The editable invoice table has a `conversion_rate` field in the form data but there's no ConversionRateInput shown in the current table). Actually looking at the EditableInvoiceLineItemsTable, there's no conversion_rate input column. The conversion rate is entered elsewhere. Skip this -- live preview only applies where ConversionRateInput is visible.
  </action>
  <verify>
    - `grep -c "standardUnitName" lib/pdf/documents/invoice-pdf.tsx` returns 0
    - `grep -c "standardUnitName" components/invoice/invoice-pdf-button.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/invoice/new/page.tsx` returns 0
    - `grep -c "Total Standard Qty" lib/pdf/documents/invoice-pdf.tsx` returns 0
    - `grep "unit_name" lib/pdf/documents/invoice-pdf.tsx` shows per-item unit_name usage
    - `grep "item_standard_unit\|conversion_rate.*preview\|text-slate-400" components/po/po-line-items-table.tsx` shows live preview code
    - `npm run type-check` -- may still have errors from files in Plan 03. Check only the files in this plan compile.
  </verify>
  <done>Invoice PDF uses per-item unit names with no aggregate total. Invoice creation shows per-item unit names. PO form shows live conversion rate preview with per-item unit name. No code references the global standardUnitName.</done>
</task>

</tasks>

<verification>
- No file in this plan imports or references useStandardUnitName
- PO/Invoice readonly tables have no aggregate totalStandardQty
- Invoice PDF always shows Std Qty column with per-item unit names
- Invoice PDF has no "Total Standard Qty" row
- PO form shows live preview under conversion rate input
- All standard qty displays show per-item unit: "25 kg", "120 pcs"
</verification>

<success_criteria>
- Every PO/Invoice line item displays its own unit name (from items->standard_units)
- No aggregate/summed standard quantities exist in PO or Invoice views
- Invoice PDF renders correctly with per-item Std Qty column
- PO creation form shows real-time standard qty preview as user types conversion rate
- Invoice creation Step 3 summary shows per-item standard unit names
</success_criteria>

<output>
After completion, create `.planning/phases/53-standard-unit-display-refactor/53-02-SUMMARY.md`
</output>
