---
phase: 01-critical-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/inventory/stock-in/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can select an invoice to receive stock from"
    - "User can select line items and set quantities to receive"
    - "User can select destination warehouse"
    - "User can submit and stock-in transactions are created"
    - "Invoice line item received_quantity is updated"
    - "Item WAC is recalculated after stock-in"
  artifacts:
    - path: "app/(dashboard)/inventory/stock-in/page.tsx"
      provides: "Stock-in form"
      contains: "handleSubmit"
    - path: "supabase/migrations/024_inventory_wac_trigger.sql"
      provides: "WAC calculation and stock validation triggers"
      contains: "update_item_wac"
  key_links:
    - from: "app/(dashboard)/inventory/stock-in/page.tsx"
      to: "inventory_transactions table"
      via: "supabase.from('inventory_transactions').insert"
      pattern: "from\\(['\"]inventory_transactions['\"]\\)"
    - from: "supabase/migrations/024_inventory_wac_trigger.sql"
      to: "invoice_line_items.received_quantity"
      via: "update_invoice_line_received_quantity trigger"
      pattern: "UPDATE invoice_line_items"
---

<objective>
Investigate and fix the stock-in functionality so users can successfully receive inventory from invoices or manual entry.

Purpose: Stock-in is critical for updating warehouse inventory and tracking invoice fulfillment. Without working stock-in, received goods cannot be tracked.

Output: Working stock-in page that creates inventory transactions and updates WAC.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fixes/01-CONTEXT.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

# Key source files
@app/(dashboard)/inventory/stock-in/page.tsx
@supabase/migrations/023_inventory_transactions.sql
@supabase/migrations/024_inventory_wac_trigger.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate stock-in failure root cause</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx</files>
  <action>
Debug the stock-in workflow to identify the root cause of failure:

1. Start the dev server (`npm run dev`) and open browser DevTools
2. Navigate to /inventory/stock-in
3. Test BOTH modes:

**Invoice mode:**
- Select an invoice that has unreceived line items
- Select items to receive, set quantities
- Select destination warehouse
- Submit and capture errors

**Manual mode:**
- Select an item
- Enter quantity and unit cost
- Select warehouse
- Submit and capture errors

4. Capture from each test:
   - Browser Console errors (unhandled exceptions)
   - Network tab response from Supabase (error details, status codes)
   - UI validation errors

5. Check Supabase logs for trigger errors:
   - update_item_wac trigger (fires on inventory_in)
   - update_invoice_line_received_quantity trigger (updates received qty)
   - Any constraint violations

6. Check for common issues identified in research:
   - Missing required fields: item_id, warehouse_id, created_by
   - Missing currency/exchange_rate for WAC calculation in manual mode
   - invoice_line_item_id not passed correctly
   - RLS policy denial

7. Verify database state:
   - Are there invoices with unreceived line items?
   - Are there active warehouses to select?
   - Are the invoice line items linked to valid items?

Document the specific error message and root cause found.
  </action>
  <verify>Root cause identified and documented with specific error message from browser console, network response, or Supabase logs</verify>
  <done>Clear understanding of why stock-in fails, ready to implement fix</done>
</task>

<task type="auto">
  <name>Task 2: Fix stock-in based on root cause</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx</files>
  <action>
Based on the root cause found in Task 1, implement the fix:

**If trigger validation failure:**
- Ensure transaction data meets trigger requirements
- Add client-side validation to match database constraints
- Improve error message handling

**If missing required fields:**
- For invoice mode: Ensure item_id, warehouse_id, invoice_line_item_id are set (lines 311-325)
- For manual mode: Ensure currency and exchange_rate have defaults (currently missing - add "MMK" and 1)

**Manual mode fix (likely issue):**
The manual mode insert (lines 340-352) is missing currency and exchange_rate:
```typescript
.insert({
  movement_type: "inventory_in",
  item_id: manualItemId,
  warehouse_id: warehouseId,
  quantity: manualQuantity,
  unit_cost: manualUnitCost,
  currency: "MMK",        // ADD THIS
  exchange_rate: 1,       // ADD THIS
  transaction_date: transactionDate.toISOString().split("T")[0],
  notes: notes || null,
  status: "completed",
  created_by: user.id,
})
```

**If RLS policy denial:**
- Check user role has INSERT permission on inventory_transactions
- Verify auth context is properly passed

**Clean while fixing:**
- Fix the bug AND clean up obvious issues
- Add brief comments explaining what was wrong
- The error handling (lines 369-384) already extracts details - ensure it displays them clearly
  </action>
  <verify>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Can manually perform stock-in through the form (tested in dev)
  </verify>
  <done>Stock-in fix implemented, builds successfully, ready for verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify stock-in works end-to-end</name>
  <what-built>Fixed stock-in workflow</what-built>
  <how-to-verify>
**Test Invoice Mode:**
1. Prerequisites: Must have an invoice with unreceived items (create PO, create invoice if needed)
2. Navigate to /inventory/stock-in
3. Click "From Invoice" mode
4. Select an invoice
5. Check items to receive, adjust quantities if needed
6. Select destination warehouse
7. Click "Record Stock In"
8. Verify:
   - No error message appears
   - Toast shows success
   - Redirected to /invoice/[id]
   - Invoice line items show updated received_quantity

**Test Manual Mode:**
1. Navigate to /inventory/stock-in
2. Click "Manual Entry" mode
3. Select an item
4. Enter quantity (e.g., 5) and unit cost (e.g., 500)
5. Select warehouse
6. Click "Record Stock In"
7. Verify:
   - No error message appears
   - Toast shows success
   - Redirected to /warehouse
   - Item's WAC is updated (check /item/[id])

**Verify Database State:**
- inventory_transactions table has new records
- invoice_line_items.received_quantity updated (invoice mode)
- items.wac_amount updated (both modes)
  </how-to-verify>
  <resume-signal>Type "approved" if both modes work, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
- Stock-in form loads without errors for both modes
- Invoice selection shows invoices with unreceived items
- Item selection populates correctly for manual mode
- Warehouse dropdown shows active warehouses
- Successful submission creates inventory transactions
- WAC is calculated correctly after stock-in
- Invoice received quantities are updated (invoice mode)
</verification>

<success_criteria>
1. User can complete stock-in from invoice without system errors
2. User can complete manual stock-in without system errors
3. Inventory transactions are created with correct data
4. Invoice line item received_quantity is updated (invoice mode)
5. Item WAC is recalculated after stock-in
6. Warehouse stock is visible in warehouse detail page
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-02-SUMMARY.md`
</output>
