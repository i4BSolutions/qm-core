---
phase: 01-critical-bug-fixes
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - app/(dashboard)/invoice/new/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can create invoice from PO using 3-step wizard"
    - "Invoice line item quantity cannot exceed PO available quantity"
    - "Invoice total amount CAN exceed PO total amount"
    - "User can issue stock out from warehouse"
    - "Stock-out validates against available warehouse stock"
    - "Transfer creates both stock-out and stock-in transactions"
  artifacts:
    - path: "app/(dashboard)/invoice/new/page.tsx"
      provides: "Invoice creation wizard"
      contains: "handleSubmit"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Stock-out form"
      contains: "handleSubmit"
    - path: "supabase/migrations/022_invoice_line_items.sql"
      provides: "Invoice line quantity validation trigger"
      contains: "validate_invoice_line_quantity"
  key_links:
    - from: "app/(dashboard)/invoice/new/page.tsx"
      to: "invoices table"
      via: "supabase.from('invoices').insert"
      pattern: "from\\(['\"]invoices['\"]\\)"
    - from: "app/(dashboard)/inventory/stock-out/page.tsx"
      to: "inventory_transactions table"
      via: "supabase.from('inventory_transactions').insert"
      pattern: "from\\(['\"]inventory_transactions['\"]\\)"
---

<objective>
Verify invoice creation wizard and stock-out functionality work correctly, and confirm invoice quantity validation is enforced.

Purpose: Invoice and stock-out are downstream from PO and stock-in. This plan verifies the full procurement cycle works end-to-end.

Output: Confirmed working invoice creation and stock-out, documented invoice validation behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fixes/01-CONTEXT.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

# Depends on prior plan summaries
@.planning/phases/01-critical-bug-fixes/01-01-SUMMARY.md
@.planning/phases/01-critical-bug-fixes/01-02-SUMMARY.md

# Key source files
@app/(dashboard)/invoice/new/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
@supabase/migrations/022_invoice_line_items.sql
@supabase/migrations/024_inventory_wac_trigger.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and verify invoice creation workflow</name>
  <files>app/(dashboard)/invoice/new/page.tsx</files>
  <action>
Test the invoice creation 3-step wizard to verify it works correctly:

1. Prerequisites: Need a PO with available (uninvoiced) line items
   - If 01-01 created a test PO, use that
   - Otherwise create a PO first using the fixed workflow

2. Navigate to /invoice/new and test the wizard:

**Step 1 - Select PO:**
- Verify POs with available items appear in the list
- Select a PO
- Set invoice date, currency, exchange rate
- Click Next

**Step 2 - Line Items:**
- Verify available items from PO are shown
- Select items to include
- Verify quantity defaults to available quantity
- Test: Try entering quantity > available (should show error)
- Adjust unit prices if needed
- Click Next

**Step 3 - Summary:**
- Review all details
- Add notes if desired
- Click "Create Invoice"

3. Verify success:
- Toast shows success message
- Redirected to /invoice/[id] detail page
- Invoice number displayed (format: INV-2026-00001)
- Line items shown with correct quantities and prices

4. Verify database constraints:
- Invoice total CAN be different from PO total (INV-02: allowed)
- Line item quantities ARE limited by PO quantities (INV-01: enforced)

5. If any step fails, capture:
- Console errors
- Network response errors
- UI validation messages

Document the result: Working or specific issue found.
  </action>
  <verify>Invoice creation wizard completes all 3 steps successfully, invoice appears in database with correct data</verify>
  <done>Invoice creation verified working OR specific issue identified and documented</done>
</task>

<task type="auto">
  <name>Task 2: Test and verify stock-out workflow</name>
  <files>app/(dashboard)/inventory/stock-out/page.tsx</files>
  <action>
Test the stock-out functionality to verify it works correctly:

1. Prerequisites: Need warehouse with stock
   - If 01-02 created stock via stock-in, use that warehouse
   - Otherwise perform a manual stock-in first

2. Navigate to /inventory/stock-out and test:

**Basic stock-out:**
- Select an item (should show stock by warehouse)
- Select source warehouse
- Enter quantity (within available stock)
- Select reason (e.g., "consumption")
- Click "Record Stock Out"
- Verify: Success toast, redirected to /warehouse

3. Test quantity validation:
- Try entering quantity > available stock
- Verify: Error shown, cannot submit

4. Test transfer functionality:
- Select item with stock
- Select source warehouse
- Enter quantity
- Select reason: "transfer"
- Select destination warehouse
- Click "Record Stock Out"
- Verify:
  - Success toast
  - Source warehouse stock decreased
  - Destination warehouse stock increased

5. Verify database state:
- inventory_transactions has stock-out record
- For transfer: also has stock-in record at destination

6. If any step fails, capture errors and document.

Document the result: Working or specific issue found.
  </action>
  <verify>Stock-out completes successfully including transfer mode, warehouse stock is updated correctly</verify>
  <done>Stock-out verified working OR specific issue identified and documented</done>
</task>

<task type="auto">
  <name>Task 3: Verify invoice quantity validation (INV-01)</name>
  <files>supabase/migrations/022_invoice_line_items.sql, app/(dashboard)/invoice/new/page.tsx</files>
  <action>
Explicitly verify the invoice line quantity validation is enforced:

**UI-level validation:**
1. Create invoice, go to Step 2 (Line Items)
2. Find an item with available_quantity = X
3. Try to enter quantity = X + 1
4. Verify: UI shows error "exceeds available" before submitting

**Database-level validation (trigger):**
1. Use Supabase SQL Editor or direct insert to test:
```sql
-- Find a PO line item with limited availability
SELECT pli.id, pli.quantity, pli.invoiced_quantity,
       (pli.quantity - COALESCE(pli.invoiced_quantity, 0)) as available
FROM po_line_items pli
WHERE (pli.quantity - COALESCE(pli.invoiced_quantity, 0)) > 0
LIMIT 1;

-- Try to insert invoice line with quantity exceeding available
-- (This should fail with trigger error)
```

2. Confirm the validate_invoice_line_quantity trigger rejects over-quantity inserts

**Document findings:**
- UI validation present: Yes/No
- Database trigger validation: Yes/No (should be Yes per migration 022)
- Error message format: [capture actual message]
  </action>
  <verify>Both UI and database validations prevent invoice quantity from exceeding PO available quantity</verify>
  <done>INV-01 requirement verified: Invoice line qty cannot exceed PO line qty</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Final verification of critical workflows</name>
  <what-built>Verified invoice creation, stock-out, and quantity validation</what-built>
  <how-to-verify>
**Complete Procurement Cycle Test:**

1. **Create QMHQ (PO route)** - if not already exists:
   - Navigate to /qmhq/new
   - Select a QMRL, choose "PO" route
   - Enter budget amount (e.g., 100,000 EUSD)
   - Save

2. **Create PO** (using fixed 01-01):
   - Navigate to /po/new
   - Select the QMHQ
   - Add line items (e.g., 10 units @ 5,000 each = 50,000)
   - Create PO

3. **Create Invoice** (this plan Task 1):
   - Navigate to /invoice/new
   - Select the PO
   - Complete 3-step wizard
   - Verify invoice created

4. **Stock In** (using fixed 01-02):
   - Navigate to /inventory/stock-in
   - Select the invoice
   - Receive items into warehouse
   - Verify stock appears

5. **Stock Out** (this plan Task 2):
   - Navigate to /inventory/stock-out
   - Select item with stock
   - Issue some quantity
   - Verify warehouse stock reduced

**Verify All Success Criteria:**
- [ ] PO creation works (01-01)
- [ ] Invoice creation wizard works (this plan)
- [ ] Stock-in from invoice works (01-02)
- [ ] Stock-out works (this plan)
- [ ] Invoice qty validation works (this plan)
- [ ] No console errors in any workflow
  </how-to-verify>
  <resume-signal>Type "approved" if all workflows complete successfully, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
- Invoice creation wizard completes all 3 steps
- Invoice appears in database with correct line items
- Stock-out reduces warehouse stock correctly
- Transfer creates both out and in transactions
- Quantity validations enforced at UI and database level
- No console errors during any workflow
</verification>

<success_criteria>
1. Invoice creation wizard completes all steps without errors (BUG-03)
2. Stock-out processes transactions and updates warehouse quantities (BUG-04)
3. Invoice line item quantity validation enforces PO limits (INV-01)
4. Invoice total amount can exceed PO total amount (INV-02)
5. Full procurement cycle works: QMHQ -> PO -> Invoice -> Stock In -> Stock Out
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-03-SUMMARY.md`
</output>
