---
phase: 01-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/po/new/page.tsx
  - components/po/po-line-items-table.tsx
autonomous: false

must_haves:
  truths:
    - "User can select a QMHQ (PO route) with positive balance"
    - "User can add line items with item, quantity, and unit price"
    - "User can submit form and PO is created in database"
    - "User is redirected to PO detail page after creation"
    - "PO total is calculated correctly from line items"
  artifacts:
    - path: "app/(dashboard)/po/new/page.tsx"
      provides: "PO creation form"
      contains: "handleSubmit"
    - path: "supabase/migrations/015_purchase_orders.sql"
      provides: "PO table and triggers"
      contains: "validate_po_qmhq_route"
  key_links:
    - from: "app/(dashboard)/po/new/page.tsx"
      to: "purchase_orders table"
      via: "supabase.from('purchase_orders').insert"
      pattern: "from\\(['\"]purchase_orders['\"]\\)"
    - from: "app/(dashboard)/po/new/page.tsx"
      to: "po_line_items table"
      via: "supabase.from('po_line_items').insert"
      pattern: "from\\(['\"]po_line_items['\"]\\)"
---

<objective>
Investigate and fix the PO creation workflow so users can successfully create purchase orders from QMHQ records with PO route type.

Purpose: PO creation is a critical path for procurement. Without working PO creation, the entire invoice and stock-in flow is blocked.

Output: Working PO creation page that successfully creates PO and line items in database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fixes/01-CONTEXT.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

# Key source files
@app/(dashboard)/po/new/page.tsx
@components/po/po-line-items-table.tsx
@supabase/migrations/015_purchase_orders.sql
@supabase/migrations/016_po_line_items.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate PO creation failure root cause</name>
  <files>app/(dashboard)/po/new/page.tsx, components/po/po-line-items-table.tsx</files>
  <action>
Debug the PO creation workflow to identify the root cause of failure:

1. Start the dev server (`npm run dev`) and open browser DevTools
2. Navigate to /po/new, select a QMHQ with balance, fill form, add line items
3. Attempt to create PO and capture:
   - Browser Console errors (unhandled exceptions)
   - Network tab response from Supabase (error details, status codes)
   - Any validation errors displayed in UI

4. Check Supabase logs for trigger errors:
   - validate_po_qmhq_route trigger (QMHQ must have route_type='po')
   - update_po_total trigger (runs after line items insert)
   - update_qmhq_po_committed trigger (updates QMHQ balance)

5. Verify database state:
   - Are there QMHQs with route_type='po' and balance_in_hand > 0?
   - Are there active suppliers to select?
   - Are there active items for line items?

6. Check for common issues identified in research:
   - Missing created_by field (already present in code - line 185)
   - RLS policy denial based on user role
   - QMHQ route_type validation failure
   - Foreign key constraint violations

Document the specific error message and root cause found.
  </action>
  <verify>Root cause identified and documented with specific error message from browser console, network response, or Supabase logs</verify>
  <done>Clear understanding of why PO creation fails, ready to implement fix</done>
</task>

<task type="auto">
  <name>Task 2: Fix PO creation based on root cause</name>
  <files>app/(dashboard)/po/new/page.tsx, components/po/po-line-items-table.tsx</files>
  <action>
Based on the root cause found in Task 1, implement the fix:

**If trigger validation failure:**
- Ensure form data meets trigger requirements
- Add client-side validation to match database constraints
- Improve error message handling to show specific trigger errors

**If missing required fields:**
- Add any missing fields to the insert payload
- Ensure all NOT NULL columns have values

**If RLS policy denial:**
- Check user role has INSERT permission on purchase_orders and po_line_items
- If needed, verify auth context is properly passed

**If foreign key violation:**
- Ensure only active records are shown in dropdowns
- Validate foreign key references exist before insert

**Clean while fixing:**
- Fix the bug AND clean up obvious issues in the same file
- Add brief comments explaining what was wrong
- Improve error handling to show meaningful messages to users

**Error handling improvement:**
In the catch block (lines 215-218), enhance to extract detailed Supabase error:
```typescript
} catch (err) {
  console.error("Error creating PO:", err);
  // Extract Supabase error details
  let errorMessage = "Failed to create Purchase Order";
  if (err && typeof err === "object") {
    if ("message" in err) errorMessage = String(err.message);
    if ("details" in err) errorMessage += `: ${err.details}`;
    if ("hint" in err) errorMessage += ` (${err.hint})`;
  }
  setError(errorMessage);
}
```
  </action>
  <verify>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Can manually create a PO through the form (tested in dev)
  </verify>
  <done>PO creation fix implemented, builds successfully, ready for verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify PO creation works end-to-end</name>
  <what-built>Fixed PO creation workflow</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Login as a user with PO creation permission (admin, quartermaster, finance, or proposal role)
3. Navigate to /po/new
4. Select a QMHQ with PO route and positive balance
5. Select a supplier
6. Set currency and exchange rate
7. Add at least one line item:
   - Select an item
   - Enter quantity (e.g., 10)
   - Enter unit price (e.g., 1000)
8. Click "Create Purchase Order"
9. Verify:
   - No error message appears
   - Redirected to /po/[id] detail page
   - PO number is displayed (format: PO-2026-00001)
   - Line items are shown with correct totals
   - QMHQ balance_in_hand is reduced by PO amount (check QMHQ detail page)
  </how-to-verify>
  <resume-signal>Type "approved" if PO creation works, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
- PO creation form loads without errors
- All dropdowns populate with active records
- Form validation prevents invalid submissions
- Successful submission creates PO and line items in database
- User is redirected to detail page
- No console errors during the flow
</verification>

<success_criteria>
1. User can create a PO from QMHQ with PO route without system errors
2. PO appears in /po list with correct PO number
3. Line items are saved with correct quantities and prices
4. PO total is calculated correctly (sum of line item totals)
5. QMHQ.total_po_committed is updated to reflect the new PO
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-01-SUMMARY.md`
</output>
