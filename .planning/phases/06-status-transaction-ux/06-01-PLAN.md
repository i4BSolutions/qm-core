---
phase: 06-status-transaction-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/status/clickable-status-badge.tsx
  - components/status/status-change-dialog.tsx
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click QMRL status badge on detail page to see dropdown"
    - "User can click QMHQ status badge on detail page to see dropdown"
    - "Dropdown groups statuses by status_group (to_do, in_progress, done)"
    - "Confirmation dialog appears before status change is saved"
    - "Status changes show in audit history with old and new values"
  artifacts:
    - path: "components/status/clickable-status-badge.tsx"
      provides: "Clickable badge component with permission checking"
      exports: ["ClickableStatusBadge"]
    - path: "components/status/status-change-dialog.tsx"
      provides: "Confirmation dialog with note field and status preview"
      exports: ["StatusChangeDialog"]
  key_links:
    - from: "components/status/clickable-status-badge.tsx"
      to: "supabase update"
      via: "onClick -> select status -> confirm dialog -> save"
      pattern: "supabase.*from.*update"
    - from: "app/(dashboard)/qmrl/[id]/page.tsx"
      to: "components/status/clickable-status-badge.tsx"
      via: "import and render"
      pattern: "ClickableStatusBadge"
---

<objective>
Build quick status change component with dropdown for QMRL and QMHQ detail pages.

Purpose: Users can change entity status without navigating to full edit forms, improving workflow speed.
Output: Clickable status badge component with grouped dropdown, confirmation dialog, and integration into both QMRL and QMHQ detail pages.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-status-transaction-ux/06-CONTEXT.md
@.planning/phases/06-status-transaction-ux/06-RESEARCH.md

@components/ui/select.tsx
@components/ui/dialog.tsx
@components/ui/badge.tsx
@components/ui/use-toast.tsx
@lib/hooks/use-permissions.ts
@app/(dashboard)/qmrl/[id]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClickableStatusBadge and StatusChangeDialog components</name>
  <files>
    components/status/clickable-status-badge.tsx
    components/status/status-change-dialog.tsx
  </files>
  <action>
Create two components in a new `components/status/` directory:

**ClickableStatusBadge** (`clickable-status-badge.tsx`):
- Props: `status: StatusConfig`, `entityType: 'qmrl' | 'qmhq'`, `entityId: string`, `onStatusChange?: () => void`, `isClickable?: boolean` (default true on detail pages)
- Uses `usePermissions()` hook to check `can('update', entityType)`
- If user cannot update: render non-clickable Badge (existing pattern)
- If user can update: render button-styled badge with hover effect
- Maintains `isUpdating` state to show spinner and disable clicks
- On click: opens Select dropdown positioned below badge
- Fetches all statuses for `entityType` from `status_config` table (filter by entity_type, is_active)
- Groups statuses by `status_group` (to_do, in_progress, done) using SelectGroup + SelectLabel
- Current status shown but disabled (greyed out)
- On status select: stores selected status and opens StatusChangeDialog

**StatusChangeDialog** (`status-change-dialog.tsx`):
- Props: `open: boolean`, `onOpenChange`, `currentStatus: StatusConfig`, `newStatus: StatusConfig`, `entityType`, `entityId`, `onConfirm: () => Promise<void>`
- Dialog shows: "Change status from [OldBadge] to [NewBadge]?" with visual badge previews
- Optional Textarea for note (placeholder: "Add note (optional)")
- Cancel and Confirm buttons
- Confirm button triggers onConfirm callback

**Save logic in ClickableStatusBadge:**
- Uses Supabase client to update qmrl/qmhq table
- Sets `status_id`, `updated_at`, `updated_by` (from auth context)
- On success: toast with "Status Updated" message, calls `onStatusChange` callback
- On error: toast with error message
- Debounces: checks `isUpdating` at start, returns early if true

Use existing patterns from:
- Select: `/components/ui/select.tsx` for dropdown
- Dialog: `/components/ui/dialog.tsx` for confirmation
- Toast: `useToast()` from `/components/ui/use-toast.tsx`
- Badge styling: Match existing badge pattern with status.color

Note: Audit trigger already handles status_change action type. The note field value is NOT passed to trigger (would require RPC function). For V1, note is informational in dialog only - status change itself is logged by trigger.
  </action>
  <verify>
- `npm run type-check` passes
- Components export correctly
- File structure: `components/status/clickable-status-badge.tsx`, `components/status/status-change-dialog.tsx`
  </verify>
  <done>
- ClickableStatusBadge renders status with permission-gated click
- StatusChangeDialog shows confirmation with badge previews
- Save logic updates database and shows toast
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ClickableStatusBadge into QMRL detail page</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
  </files>
  <action>
Modify the QMRL detail page to use ClickableStatusBadge:

1. Import the new component: `import { ClickableStatusBadge } from "@/components/status/clickable-status-badge";`

2. Replace the static Badge in the header section (around line 206-218) with ClickableStatusBadge:
   - Current code renders `<Badge variant="outline" ...>{qmrl.status.name}</Badge>`
   - Replace with: `<ClickableStatusBadge status={qmrl.status} entityType="qmrl" entityId={qmrl.id} onStatusChange={() => fetchQMRL(params.id as string)} />`

3. Replace the static Badge in the Status Information panel (around line 420-430) with same component.

4. Keep the static badges in list views (QMHQ Lines tab) - these should NOT be clickable per CONTEXT.md.

5. Pass `onStatusChange` callback to refetch QMRL data after status update so UI reflects new status.
  </action>
  <verify>
- `npm run build` succeeds
- Navigate to `/qmrl/[id]` in browser
- Status badge shows hover effect (if user has update permission)
- Clicking badge opens dropdown with grouped statuses
  </verify>
  <done>
- QMRL detail page header shows clickable status badge
- QMRL Status Information panel shows clickable status badge
- Status in QMHQ Lines list remains static (non-clickable)
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ClickableStatusBadge into QMHQ detail page</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Modify the QMHQ detail page to use ClickableStatusBadge:

1. Import the new component: `import { ClickableStatusBadge } from "@/components/status/clickable-status-badge";`

2. Replace the static Badge in the header section (around line 284-295) with ClickableStatusBadge:
   - Current code renders `<Badge variant="outline" ...>{qmhq.status.name}</Badge>`
   - Replace with: `<ClickableStatusBadge status={qmhq.status} entityType="qmhq" entityId={qmhq.id} onStatusChange={fetchData} />`

3. Replace the static Badge in the Details tab "Basic Information" panel (around line 443-455) with same component.

4. Pass `onStatusChange` callback as `fetchData` to refetch all QMHQ data after status update.
  </action>
  <verify>
- `npm run build` succeeds
- Navigate to `/qmhq/[id]` in browser
- Status badge shows hover effect (if user has update permission)
- Clicking badge opens dropdown with grouped statuses
- Selecting new status opens confirmation dialog
- Confirming updates status and shows toast
  </verify>
  <done>
- QMHQ detail page header shows clickable status badge
- QMHQ Basic Information panel shows clickable status badge
- Status changes update UI immediately after confirmation
  </done>
</task>

</tasks>

<verification>
1. Navigate to a QMRL detail page (`/qmrl/[id]`)
2. Click the status badge in the header
3. Verify dropdown shows statuses grouped by to_do, in_progress, done
4. Select a different status
5. Verify confirmation dialog appears with old/new badge previews
6. Confirm the change
7. Verify toast notification appears
8. Verify status badge updates to new value
9. Check History tab - status change should appear in audit log
10. Repeat steps 1-9 for QMHQ detail page (`/qmhq/[id]`)
</verification>

<success_criteria>
- Users can click status badge on QMRL detail page to change status
- Users can click status badge on QMHQ detail page to change status
- Dropdown groups statuses by status_group with section labels
- Confirmation dialog shows visual preview of old and new status
- Status changes appear in audit history timeline
- Users without update permission see non-clickable badge
- Spinner shows during save operation
- Toast notifications appear on success/error
</success_criteria>

<output>
After completion, create `.planning/phases/06-status-transaction-ux/06-01-SUMMARY.md`
</output>
