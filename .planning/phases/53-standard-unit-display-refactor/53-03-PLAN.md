---
phase: 53-standard-unit-display-refactor
plan: 03
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - app/(dashboard)/warehouse/[id]/page.tsx
  - app/(dashboard)/inventory/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - components/qmhq/items-summary-progress.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - components/stock-out-requests/line-item-table.tsx
  - components/stock-out-requests/stock-out-pdf-button.tsx
  - lib/pdf/documents/stock-out-pdf.tsx
  - app/(dashboard)/inventory/stock-in/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Warehouse detail page has NO 'Total Standard Stock' KPI card -- aggregate standard qty is removed"
    - "Warehouse inventory rows show per-item standard_stock with the item's standard unit name inline (e.g. '120 pcs', '50 kg')"
    - "Inventory dashboard transaction list shows per-item unit name on standard qty line"
    - "QMHQ detail item display shows per-item standard unit name"
    - "Stock-out request line items show per-item unit names on all quantity columns"
    - "Stock-out PDF shows per-item unit names"
    - "Stock-in form shows live conversion rate preview with item's unit name"
    - "Stock-out request form shows live conversion rate preview with item's unit name"
    - "No code in these files references useStandardUnitName hook"
  artifacts:
    - path: "app/(dashboard)/warehouse/[id]/page.tsx"
      provides: "Warehouse detail with per-item unit names on inventory rows and no aggregate standard stock KPI"
    - path: "lib/pdf/documents/stock-out-pdf.tsx"
      provides: "Stock-out PDF with per-item unit names"
  key_links:
    - from: "app/(dashboard)/warehouse/[id]/page.tsx"
      to: "items->standard_units"
      via: "Supabase join through items FK to standard_units"
      pattern: "standard_unit"
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "components/stock-out-requests/line-item-table.tsx"
      via: "Line items with per-item unit_name"
      pattern: "unit_name"
---

<objective>
Refactor inventory, warehouse, QMHQ, and stock-out display components to use per-item standard unit names. Remove cross-item aggregate standard qty totals (KPI cards that sum across items with different units). Keep per-item standard_stock on warehouse inventory rows with the item's unit name inline. Add conversion rate live preview to stock-in and stock-out request forms. Update stock-out PDF to use per-item unit names.

Purpose: Inventory, warehouse, and stock-out views show the correct per-item unit name on each row.
Output: Updated warehouse, inventory, QMHQ, stock-out components with per-item unit names and live previews.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/53-standard-unit-display-refactor/53-01-SUMMARY.md
@app/(dashboard)/warehouse/[id]/page.tsx
@app/(dashboard)/inventory/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
@components/qmhq/items-summary-progress.tsx
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@components/stock-out-requests/line-item-table.tsx
@components/stock-out-requests/stock-out-pdf-button.tsx
@lib/pdf/documents/stock-out-pdf.tsx
@app/(dashboard)/inventory/stock-in/page.tsx
@app/(dashboard)/inventory/stock-out-requests/new/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor warehouse, inventory dashboard, and QMHQ to per-item unit names</name>
  <files>
    app/(dashboard)/warehouse/[id]/page.tsx
    app/(dashboard)/inventory/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
    components/qmhq/items-summary-progress.tsx
  </files>
  <action>
**Warehouse Detail Page `app/(dashboard)/warehouse/[id]/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. The inventory_transactions query already joins `item:items!inventory_transactions_item_id_fkey(id, name, sku, default_unit, wac_amount, wac_currency, wac_amount_eusd)`. Extend the items join to include standard_units:
   ```
   item:items!inventory_transactions_item_id_fkey(id, name, sku, default_unit, wac_amount, wac_currency, wac_amount_eusd, standard_unit_rel:standard_units!items_standard_unit_id_fkey(name))
   ```
4. In the `WarehouseInventoryItem` interface, add `standard_unit_name: string | null` (alongside existing `item_unit`).
5. KEEP the `standard_stock` field in `WarehouseInventoryItem`. KEEP the `standard_stock` aggregation logic in the transaction processing loop (the lines that do `inv.standard_stock += ...` and `inv.standard_stock -= ...`). This per-item aggregate is valid -- it aggregates standard_qty for a single item across its transactions, which is fine to display per-row. Only cross-item aggregation (summing standard_stock across items with different units) must be removed.
6. When building inventoryMap, populate `standard_unit_name` from `item.standard_unit_rel?.name || null`.
7. In KPI calculations, remove `totalStandardUnits` entirely. The `kpis` memo should return `{ totalItems, totalUnits, totalValueEusd }` only.
8. Remove the "Total Standard Stock" KPI card in the KPI section (the `{unitName && ...}` block under Total Units that shows aggregated standard stock across all items). This is the cross-item aggregate that must go.
9. In the inventory table, the current_stock cell currently shows standard_stock below it using `{unitName && ...}`. KEEP showing per-item standard_stock on each row, but replace the global `unitName` with the per-item `standard_unit_name`. Per the locked decision "Per-row standard qty display shows inline unit name: '50 kg', '120 pcs'" -- each warehouse inventory row should show standard_stock with the item's own unit name inline below current_stock. Update the display to: `{row.original.standard_unit_name && (<span className="text-xs text-muted-foreground">{row.original.standard_stock.toLocaleString(...)} {row.original.standard_unit_name}</span>)}`. Always show both lines per the decision, even when redundant.
10. In the Stock Movement tab's quantity column, there ARE per-transaction standard_qty values. For each transaction row, show the per-item unit name: `{(t.standard_qty ?? t.quantity).toLocaleString(...)} {standard_unit_name || ''}` using muted text below the quantity. The standard_unit_name comes from the transaction's item relationship.

**Inventory Dashboard `app/(dashboard)/inventory/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. The transaction list currently shows `{unitName}` as the unit label for standard qty. Instead, each transaction row needs the item's standard unit name.
4. The transactions come from `getInventoryTransactions()` server action. Check what data it returns. If it doesn't include item standard unit name, update the action or the mapping.
5. For the transaction list display (the `{unitName && transaction.conversion_rate && ...}` block around line 514), replace `{unitName}` with the per-item unit name. If the transaction data includes item info, extract the standard unit name. If not available from the server action, fetch it via a separate lookup or update the server action.
6. If modifying the server action is too complex, an alternative: show the calculated standard qty without a unit label, or show a generic "std" label. But per the decision, each row should show its item's unit name. The simplest approach: update `getInventoryTransactions` to join items->standard_units or add `unit_name` to the transaction interface returned. Check `lib/actions/inventory-dashboard.ts` for the current query and extend it.

**QMHQ Detail Page `app/(dashboard)/qmhq/[id]/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. The page fetches `item:items!qmhq_item_id_fkey(id, name, sku, default_unit)`. Update to join standard_units:
   ```
   item:items!qmhq_item_id_fkey(id, name, sku, default_unit, standard_unit_rel:standard_units!items_standard_unit_id_fkey(name))
   ```
4. Also update other item queries on this page (stock_out_line_items->items, etc.) to include the standard_units join.
5. Replace all `{unitName}` references with the per-item `standard_unit_rel?.name`.
6. For the inline standard qty displays in the QMHQ items list (around line 903-904 which shows `default_unit`), update to show standard qty with the per-item unit name from the join.
7. When passing data to ItemsSummaryProgress, include the standard_unit_name per item.

**ItemsSummaryProgress `components/qmhq/items-summary-progress.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Add `standardUnitName?: string` to the `ItemProgressData` interface (per-item unit name).
4. Replace all `{unitName && ...}` conditionals with `{item.standardUnitName && ...}` using the per-item name.
5. This means each item in the progress display shows its OWN unit name.
  </action>
  <verify>
    - `grep -c "useStandardUnitName" app/(dashboard)/warehouse/[id]/page.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/inventory/page.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/qmhq/[id]/page.tsx` returns 0
    - `grep -c "useStandardUnitName" components/qmhq/items-summary-progress.tsx` returns 0
    - `grep -c "totalStandardUnits" app/(dashboard)/warehouse/[id]/page.tsx` returns 0
    - `grep "standard_stock" app/(dashboard)/warehouse/[id]/page.tsx` still shows per-item standard_stock field and display logic (NOT removed)
    - `grep "standard_unit" app/(dashboard)/warehouse/[id]/page.tsx` shows join query and per-item unit name usage
  </verify>
  <done>Warehouse detail has no cross-item aggregate standard stock KPI card, but per-item standard_stock with inline unit name is preserved on each inventory row (e.g. "120 pcs", "50 kg"). Per-transaction standard qty in Stock Movement tab shows per-item unit name. Inventory dashboard shows per-item unit names. QMHQ detail uses per-item unit names throughout. No code references useStandardUnitName.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor stock-out displays, PDF, and add live preview to stock-in and stock-out forms</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
    components/stock-out-requests/line-item-table.tsx
    components/stock-out-requests/stock-out-pdf-button.tsx
    lib/pdf/documents/stock-out-pdf.tsx
    app/(dashboard)/inventory/stock-in/page.tsx
    app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  </files>
  <action>
**Stock-Out Request Detail `app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Update queries that fetch stock_out_line_items to join through items->standard_units:
   ```
   item:items(id, name, sku, default_unit, standard_unit_rel:standard_units!items_standard_unit_id_fkey(name))
   ```
4. When mapping data to LineItemWithApprovals, add `unit_name: lineItem.item?.standard_unit_rel?.name || undefined`.
5. Remove `standardUnitName={unitName}` from StockOutPDFButton invocation.
6. Pass per-item unit names through lineItems and approvals to the PDF button.
7. For the inline standard qty displays on approval details and transaction cards, replace `{unitName}` with the per-item unit name.

**Line Item Table `components/stock-out-requests/line-item-table.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Add `unit_name?: string` to the `LineItemWithApprovals` interface (or its extension point).
4. Replace all `{unitName && ...}` conditionals with `{item.unit_name && ...}` using the per-item name.
5. Each quantity column (Requested, Approved, Rejected, Remaining) shows the per-item unit name inline: "50 kg".

**Stock-Out PDF Button `components/stock-out-requests/stock-out-pdf-button.tsx`:**

1. Remove `import { useStandardUnitName }`.
2. Remove `const { unitName } = useStandardUnitName();`.
3. Remove `standardUnitName={unitName || undefined}` from StockOutPDF invocation.
4. Instead, pass `unit_name` per line item in the lineItems array.

**Stock-Out PDF `lib/pdf/documents/stock-out-pdf.tsx`:**

1. Remove `standardUnitName?: string` prop from `StockOutPDFProps`.
2. Add `unit_name?: string` to the lineItems type.
3. Replace all conditional logic that checks `standardUnitName` with always-on per-item rendering. Since all items now have a standard unit (NOT NULL FK from Phase 52):
   - Always use the wider column layout (the `standardUnitName ?` ternary can be removed -- always use the "with standard" layout).
   - In each line item row, render `{(qty * conversionRate).toLocaleString(...)} {item.unit_name || ''}` for each quantity cell.
4. For approvals section, each approval's standard qty display uses the parent line item's unit_name.
5. Remove the global `standardUnitName` references throughout.

**Stock-In Form `app/(dashboard)/inventory/stock-in/page.tsx` -- Live Preview:**

1. This page has ConversionRateInput in two places: per-line from-invoice mode (line ~909) and manual mode (line ~1002).
2. For from-invoice mode:
   - Each line has an item with its details. The line items come from invoice line items which have `item` relation. Ensure item standard unit name is available in `StockInLine` interface.
   - Below the ConversionRateInput for each line, add live preview:
     ```
     {line.conversion_rate && parseFloat(line.conversion_rate) > 0 && line.quantity > 0 && (
       <span className="text-xs font-mono text-slate-400 mt-0.5 block">
         {(line.quantity * parseFloat(line.conversion_rate)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {line.item_standard_unit || ''}
       </span>
     )}
     ```
   - The item's standard unit name needs to flow from the items query. Update the items join in the invoice line items query to include standard_units.
3. For manual mode:
   - The selected item is `selectedManualItem`. Update the items query (around line ~191) to also fetch `standard_unit_rel:standard_units!items_standard_unit_id_fkey(name)`.
   - Below the manual ConversionRateInput, add live preview:
     ```
     {manualConversionRate && parseFloat(manualConversionRate) > 0 && quantity > 0 && (
       <span className="text-xs font-mono text-slate-400 mt-0.5 block">
         {(quantity * parseFloat(manualConversionRate)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {selectedManualItem?.standard_unit_rel?.name || ''}
       </span>
     )}
     ```

**Stock-Out Request Form `app/(dashboard)/inventory/stock-out-requests/new/page.tsx` -- Live Preview:**

1. This page has ConversionRateInput per line item (around line ~658).
2. Each line item has `itemId` and the item is selected via CategoryItemSelector. Need the item's standard unit name.
3. Update the items query or the item selection handler to capture the standard unit name. When an item is selected, store its standard_unit name in the line item state.
4. Add `standardUnitName?: string` to the line item interface.
5. Below the ConversionRateInput for each line item, add live preview:
   ```
   {item.conversionRate && parseFloat(item.conversionRate) > 0 && parseFloat(item.quantity) > 0 && (
     <span className="text-xs font-mono text-slate-400 mt-0.5 block">
       {(parseFloat(item.quantity) * parseFloat(item.conversionRate)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {item.standardUnitName || ''}
     </span>
   )}
   ```
6. To get the standard unit name during item selection, the CategoryItemSelector may need to be updated to also return the standard unit, OR do a separate lookup. Check how items flow from the selector. The simplest approach: update the items query in the form to include standard_units join, and when an item is selected, look it up from the loaded items list and extract the unit name.
  </action>
  <verify>
    - `grep -c "useStandardUnitName" app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx` returns 0
    - `grep -c "useStandardUnitName" components/stock-out-requests/line-item-table.tsx` returns 0
    - `grep -c "useStandardUnitName" components/stock-out-requests/stock-out-pdf-button.tsx` returns 0
    - `grep -c "useStandardUnitName" app/(dashboard)/inventory/stock-in/page.tsx` returns 0
    - `grep -c "standardUnitName" lib/pdf/documents/stock-out-pdf.tsx` returns 0
    - `grep "text-slate-400.*font-mono" app/(dashboard)/inventory/stock-in/page.tsx` shows live preview spans
    - `grep "text-slate-400.*font-mono" app/(dashboard)/inventory/stock-out-requests/new/page.tsx` shows live preview spans
    - `npm run type-check` passes (all files should now compile -- all useStandardUnitName references removed system-wide)
  </verify>
  <done>Stock-out displays, PDF, and forms all use per-item unit names. Stock-in and stock-out request forms show live conversion rate preview with item's unit name. The entire codebase has zero references to useStandardUnitName or the global standard unit config.</done>
</task>

</tasks>

<verification>
- `grep -r "useStandardUnitName" --include="*.ts" --include="*.tsx" components/ app/ lib/` returns 0 matches (complete removal)
- `grep -r "system_config" --include="*.ts" --include="*.tsx" components/ app/ lib/` returns 0 matches
- `grep -r "standardUnitName" --include="*.tsx" components/ app/ lib/` returns 0 matches (all replaced with per-item unit_name)
- No cross-item aggregate standard qty totals exist anywhere (KPI cards summing across items removed)
- Per-item standard_stock with inline unit name IS shown on warehouse inventory rows
- Live preview visible under conversion rate inputs in stock-in, stock-out request, and PO forms
- `npm run type-check` passes
- `npm run build` succeeds
</verification>

<success_criteria>
- Every inventory/warehouse/QMHQ/stock-out display uses per-item standard unit names
- No cross-item aggregate/summed standard quantities exist in any view (KPI totals removed)
- Per-item standard_stock with inline unit name is preserved on warehouse inventory rows (e.g. "120 pcs", "50 kg")
- Warehouse "Total Standard Stock" KPI card is removed
- Stock-out PDF renders per-item unit names
- Stock-in form shows live conversion rate preview
- Stock-out request form shows live conversion rate preview
- Zero references to useStandardUnitName in the entire codebase (excluding .planning/)
- `npm run type-check` and `npm run build` pass
</success_criteria>

<output>
After completion, create `.planning/phases/53-standard-unit-display-refactor/53-03-SUMMARY.md`
</output>
