---
phase: 15-edit-capability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMRL Edit button is visible only to users with update permission"
    - "QMHQ Edit button is visible only to users with update permission"
    - "PO Edit button is visible only when user has permission AND status is not closed/cancelled"
    - "Invoice detail page has no Edit button"
    - "Edit buttons show icon-only on mobile, icon+text on desktop"
  artifacts:
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "Permission-gated QMRL Edit button"
      contains: "can(\"update\", \"qmrl\")"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Permission-gated QMHQ Edit button"
      contains: "can(\"update\", \"qmhq\")"
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "Permission-gated PO Edit button with status check"
      contains: "can(\"update\", \"purchase_orders\")"
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail with no Edit button"
  key_links:
    - from: "app/(dashboard)/qmrl/[id]/page.tsx"
      to: "lib/hooks/use-permissions.ts"
      via: "usePermissions hook"
      pattern: "usePermissions.*can"
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "lib/utils/po-status.ts"
      via: "canEditPO function"
      pattern: "canEditPO.*status"
---

<objective>
Add permission-gated Edit buttons to QMRL, QMHQ, and PO detail pages, and remove Edit button from Invoice detail page.

Purpose: Users can only see Edit buttons for entities they have permission to modify. PO Edit button respects both permission and status (hidden when closed/cancelled). Invoice has no Edit button since void functionality serves as the modification mechanism.

Output: Updated detail pages with permission-based Edit button visibility and responsive mobile display.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-edit-capability/15-CONTEXT.md
@.planning/phases/15-edit-capability/15-RESEARCH.md

# Key files
@lib/hooks/use-permissions.ts
@lib/utils/po-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission check to QMRL and QMHQ Edit buttons</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
    **QMRL Detail Page (`qmrl/[id]/page.tsx`):**
    1. Import `usePermissions` hook from `@/lib/hooks/use-permissions`
    2. Add `const { can } = usePermissions();` after `useAuth()` call
    3. Wrap existing Edit button (around line 266-271) with permission check:
       ```tsx
       {can("update", "qmrl") && (
         <Link href={`/qmrl/${qmrl.id}/edit`}>
           <Button variant="outline" className="border-slate-700 hover:bg-slate-800 hover:border-amber-500/30">
             <Pencil className="h-4 w-4 md:mr-2" />
             <span className="hidden md:inline">Edit</span>
           </Button>
         </Link>
       )}
       ```
    4. Make responsive: Change `<Pencil className="mr-2 h-4 w-4" />` to `<Pencil className="h-4 w-4 md:mr-2" />`
    5. Add `<span className="hidden md:inline">` around "Edit" text

    **QMHQ Detail Page (`qmhq/[id]/page.tsx`):**
    1. Import `usePermissions` hook from `@/lib/hooks/use-permissions`
    2. Add `const { can } = usePermissions();` in component (near other hooks)
    3. Wrap existing Edit button (around line 424-429) with permission check:
       ```tsx
       {can("update", "qmhq") && (
         <Link href={`/qmhq/${qmhqId}/edit`}>
           <Button variant="outline" className="border-slate-700 hover:bg-slate-800 text-slate-300">
             <Edit className="h-4 w-4 md:mr-2" />
             <span className="hidden md:inline">Edit</span>
           </Button>
         </Link>
       )}
       ```
    4. Make responsive: Change icon margin class, wrap text in hidden span
  </action>
  <verify>
    1. Build succeeds: `npm run build` completes without errors
    2. TypeScript checks pass: `npm run type-check` shows no errors
    3. Manual verification: QMRL and QMHQ detail pages load without console errors
  </verify>
  <done>
    - QMRL Edit button only visible when `can("update", "qmrl")` returns true
    - QMHQ Edit button only visible when `can("update", "qmhq")` returns true
    - Both buttons show icon-only on mobile (< 768px), icon + "Edit" text on desktop
  </done>
</task>

<task type="auto">
  <name>Task 2: Add permission check to PO Edit button</name>
  <files>
    app/(dashboard)/po/[id]/page.tsx
  </files>
  <action>
    **PO Detail Page (`po/[id]/page.tsx`):**
    1. Import `usePermissions` hook from `@/lib/hooks/use-permissions`
    2. Add `const { can } = usePermissions();` in component (near other hooks)
    3. Update `showEditButton` logic (around line 214) to include permission check:
       ```tsx
       const showEditButton = can("update", "purchase_orders") && canEditPO(po.status as POStatusEnum);
       ```
    4. Make Edit button responsive (around line 277-284):
       ```tsx
       {showEditButton && (
         <Link href={`/po/${poId}/edit`}>
           <Button variant="outline" className="border-slate-700 hover:bg-slate-800 text-slate-300">
             <Edit className="h-4 w-4 md:mr-2" />
             <span className="hidden md:inline">Edit</span>
           </Button>
         </Link>
       )}
       ```
    5. Change icon margin class from `mr-2` to `md:mr-2`
    6. Wrap "Edit" text in `<span className="hidden md:inline">`
  </action>
  <verify>
    1. Build succeeds: `npm run build` completes without errors
    2. TypeScript checks pass: `npm run type-check` shows no errors
    3. Manual verification: PO detail page loads without console errors
  </verify>
  <done>
    - PO Edit button only visible when user has `update` permission on `purchase_orders` AND status is not `closed`/`cancelled`
    - Button shows icon-only on mobile, icon + "Edit" text on desktop
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove Edit button from Invoice detail page</name>
  <files>
    app/(dashboard)/invoice/[id]/page.tsx
  </files>
  <action>
    **Invoice Detail Page (`invoice/[id]/page.tsx`):**
    1. Remove the `showEditButton` variable declaration (around line 285-288):
       ```tsx
       // DELETE this entire block:
       const showEditButton = canEditInvoice(
         invoice.status as InvoiceStatus,
         invoice.is_voided ?? false
       );
       ```
    2. Remove the `canEditInvoice` import from `@/lib/utils/invoice-status` (around line 36)
    3. Remove the Edit button JSX block (around line 372-382):
       ```tsx
       // DELETE this entire block:
       {showEditButton && (
         <Link href={`/invoice/${invoiceId}/edit`}>
           <Button
             variant="outline"
             className="border-slate-700 hover:bg-slate-800 text-slate-300"
           >
             <Edit className="mr-2 h-4 w-4" />
             Edit
           </Button>
         </Link>
       )}
       ```
    4. Clean up: If `Edit` icon is no longer used elsewhere in the file, remove it from lucide-react imports (line 14)
    5. Verify void button remains unchanged (around line 362-370)
  </action>
  <verify>
    1. Build succeeds: `npm run build` completes without errors
    2. TypeScript checks pass: `npm run type-check` shows no errors
    3. Manual verification: Invoice detail page loads without Edit button, Void button still works
    4. No unused imports warning for Edit icon
  </verify>
  <done>
    - Invoice detail page has no Edit button
    - Void button functionality preserved and unchanged
    - No unused imports or dead code
  </done>
</task>

</tasks>

<verification>
All tasks verified via:
1. `npm run build` - Production build succeeds
2. `npm run type-check` - TypeScript compilation passes
3. `npm run lint` - No linting errors

Functional verification:
- QMRL detail page: Edit button visible only for users with qmrl update permission
- QMHQ detail page: Edit button visible only for users with qmhq update permission
- PO detail page: Edit button visible only for users with purchase_orders update permission AND when PO is not closed/cancelled
- Invoice detail page: No Edit button present, Void button unchanged
- All Edit buttons: Icon-only on mobile, icon + text on desktop
</verification>

<success_criteria>
1. QMRL Edit button respects `can("update", "qmrl")` permission
2. QMHQ Edit button respects `can("update", "qmhq")` permission
3. PO Edit button respects `can("update", "purchase_orders")` AND `canEditPO(status)`
4. Invoice detail page has NO Edit button
5. All Edit buttons are responsive (icon-only on mobile)
6. Build and type-check pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-edit-capability/15-01-SUMMARY.md`
</output>
