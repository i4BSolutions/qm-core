---
phase: 28-stock-out-request-approval-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/layout/sidebar.tsx
  - lib/hooks/use-permissions.ts
  - app/(dashboard)/inventory/stock-out-requests/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  - components/stock-out-requests/request-card.tsx
autonomous: true

must_haves:
  truths:
    - "Stock-Out Requests nav item visible under Inventory section in sidebar"
    - "List page shows stock-out requests with card/list toggle"
    - "List page has status tabs (All / Pending / Approved / Rejected / Cancelled)"
    - "User can create a manual stock-out request with multiple line items"
    - "User can create a QMHQ-linked stock-out request with locked item and quantity"
    - "Role-based list visibility works (admin/QM/inventory see all, others see own)"
  artifacts:
    - path: "components/layout/sidebar.tsx"
      provides: "Stock-Out Requests nav item under Inventory"
      contains: "stock-out-requests"
    - path: "lib/hooks/use-permissions.ts"
      provides: "stock_out_requests resource in permission matrix"
      contains: "stock_out_requests"
    - path: "app/(dashboard)/inventory/stock-out-requests/page.tsx"
      provides: "Request list page with card/list toggle and status tabs"
      min_lines: 150
    - path: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      provides: "Request creation form for manual and QMHQ-linked requests"
      min_lines: 200
    - path: "components/stock-out-requests/request-card.tsx"
      provides: "Card component for list view"
      min_lines: 30
  key_links:
    - from: "components/layout/sidebar.tsx"
      to: "/inventory/stock-out-requests"
      via: "navigation link"
      pattern: "stock-out-requests"
    - from: "app/(dashboard)/inventory/stock-out-requests/page.tsx"
      to: "stock_out_requests"
      via: "Supabase query"
      pattern: "from.*stock_out_requests"
    - from: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      to: "stock_out_requests"
      via: "Supabase insert"
      pattern: "from.*stock_out_requests.*insert"
---

<objective>
Create the stock-out request list page and creation form, plus foundation changes (sidebar nav, permissions).

Purpose: Users need to view, filter, and create stock-out requests. This plan establishes the navigation entry point, permission resource, list page with card/list toggle and status tabs, and the creation form supporting both QMHQ-linked and manual multi-line-item requests.

Output: Working list page at `/inventory/stock-out-requests` and create page at `/inventory/stock-out-requests/new`
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-stock-out-request-approval-ui/28-CONTEXT.md
@.planning/phases/28-stock-out-request-approval-ui/28-RESEARCH.md
@.planning/phases/27-stock-out-approval-db-foundation/27-01-SUMMARY.md
@.planning/phases/27-stock-out-approval-db-foundation/27-03-SUMMARY.md
@components/layout/sidebar.tsx
@lib/hooks/use-permissions.ts
@app/(dashboard)/qmhq/page.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sidebar nav, permissions, and request list page</name>
  <files>
    components/layout/sidebar.tsx
    lib/hooks/use-permissions.ts
    app/(dashboard)/inventory/stock-out-requests/page.tsx
    components/stock-out-requests/request-card.tsx
  </files>
  <action>
**1. Sidebar (components/layout/sidebar.tsx):**
Add "Stock-Out Requests" as a child of the Inventory nav group. Insert it after "Stock Out" in the children array:
```
{ label: "Stock-Out Requests", href: "/inventory/stock-out-requests" }
```

**2. Permissions (lib/hooks/use-permissions.ts):**
Add `"stock_out_requests"` to the `PermissionResource` type union. Add permission matrix entry:
- admin: CRUD
- quartermaster: CRUD
- inventory: CRUD
- proposal: ["create", "read"]
- finance: ["read"]
- frontline: ["read"]
- requester: ["read"]

Also add `/inventory/stock-out-requests` to `roleNavigation` for roles that already have `/inventory` access (admin, quartermaster, inventory). For proposal role, add it too since they can create requests.

**3. Request List Page (app/(dashboard)/inventory/stock-out-requests/page.tsx):**
Create a client component following the QMHQ list page pattern (card/list toggle, filters).

State:
- `viewMode`: "card" | "list" (default "card")
- `statusFilter`: "all" | "pending" | "approved" | "rejected" | "cancelled" (default "all")
- `searchQuery`: string
- `requests`: fetched data array
- `isLoading`, `error`

Data fetching:
- Query `stock_out_requests` with joined relations:
  ```
  id, request_number, status, reason, notes, qmhq_id, requester_id, created_at,
  requester:users!stock_out_requests_requester_id_fkey(id, full_name),
  qmhq:qmhq!stock_out_requests_qmhq_id_fkey(id, request_id, line_name),
  line_items:stock_out_line_items(id, item_name, item_sku, requested_quantity, status)
  ```
- Filter by `is_active = true`
- RLS handles role-based visibility at database level (admin/QM/inventory see all, others see own)

Status tabs at top: All, Pending, Approved, Rejected, Cancelled — with count badges. Filter `requests` client-side by `statusFilter`.

Search: filter by `request_number` or `requester.full_name` matching `searchQuery`.

Card view: 3-column grid grouped by status groups (Pending, In Progress, Done). Map request statuses to groups:
- Pending group: pending
- In Progress group: partially_approved, approved, partially_executed
- Done group: executed, rejected, cancelled

Each card uses `<RequestCard>` component showing: request_number, requester name, reason badge, line item count, created_at, overall status badge. Clicking navigates to `/inventory/stock-out-requests/{id}`.

List view: Table with columns: Request #, Requester, Reason, Items, Status, Created. Rows clickable navigating to detail page.

Header: "Stock-Out Requests" title with search input and view toggle buttons. "New Request" button (show if `can('create', 'stock_out_requests')`) linking to `/inventory/stock-out-requests/new`.

**4. Request Card (components/stock-out-requests/request-card.tsx):**
Props: `request` object with relations. Display:
- Request number as code/monospace
- Requester full_name
- Reason as colored badge (reuse STOCK_OUT_REASON_CONFIG from lib/utils/inventory for colors)
- Line item count: "{N} item(s)"
- Status badge with colors: pending=amber, partially_approved=blue, approved=emerald, rejected=red, cancelled=slate, partially_executed=purple, executed=emerald
- Created date formatted
- If qmhq_id present, show small "QMHQ" label
- Wrap in Link to `/inventory/stock-out-requests/{request.id}`

Use the same command-panel / corner-accents styling patterns from QMHQ cards.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify sidebar.tsx contains "stock-out-requests" nav link. Verify use-permissions.ts contains "stock_out_requests" resource. Verify list page file exists with card/list toggle and status tabs.
  </verify>
  <done>
Sidebar shows "Stock-Out Requests" under Inventory. Permission matrix includes stock_out_requests resource. List page renders with card/list toggle, status tab filters, search, and "New Request" button. Card component displays request info with status badge and reason.
  </done>
</task>

<task type="auto">
  <name>Task 2: Stock-out request creation form</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  </files>
  <action>
Create client component at `app/(dashboard)/inventory/stock-out-requests/new/page.tsx`.

**Query param detection:**
- Read `?qmhq={id}` from search params
- If present: QMHQ-linked mode. If absent: manual mode.

**QMHQ-linked mode:**
- Fetch QMHQ data: `qmhq.select('id, request_id, line_name, item_id, quantity, route_type, item:items!qmhq_item_id_fkey(id, name, sku)')` filtering by ID
- Also fetch from qmhq_items for multi-item QMHQ: `qmhq_items.select('item_id, quantity, item:items(id, name, sku)').eq('qmhq_id', qmhqId)`
- Pre-fill a single line item with item_id and quantity from QMHQ (use qmhq_items if available, else fall back to qmhq.item_id/quantity for legacy)
- Show QMHQ reference banner: blue info box with "Linked to QMHQ: {request_id}" and line_name
- Item and quantity fields are DISABLED/LOCKED — show lock icon or "Locked" badge
- Cannot add more line items (per schema: QMHQ-linked enforces exactly one line item)
- Reason defaults to "request" for QMHQ-linked

**Manual mode:**
- Show multi-line-item form
- Each line item row has: Item selector (using CategoryItemSelector pattern from existing stock-out page), Quantity input (number, font-mono, handleQuantityKeyDown)
- "Add Item" button to add more rows
- Remove button (X) on each row (if more than one row)
- No stock levels shown (per user decision: requester does not see stock)
- No warehouse selection (per user decision: approver assigns warehouse)

**Common fields (both modes):**
- Reason selector: Grid of reason cards (reuse pattern from existing stock-out page — STOCK_OUT_REASON_CONFIG with colored cards showing label + description)
- Notes: optional textarea

**Form sections (command-panel pattern):**
1. QMHQ Reference (only if linked) — blue info banner
2. Line Items — item selector + quantity per row
3. Reason — grid of reason cards
4. Notes — optional textarea

**Submission:**
- Validate: at least one line item, each line has item_id and quantity > 0, reason is selected
- Insert into `stock_out_requests`: `{ qmhq_id, reason, notes, requester_id: user.id, created_by: user.id }`
- Insert line items into `stock_out_line_items`: `{ request_id, item_id, requested_quantity, created_by: user.id }` for each line
- On success: toast "Stock-Out Request Created" and redirect to `/inventory/stock-out-requests/{id}`
- On error: show error in alert box

**Header:**
- Back button linking to `/inventory/stock-out-requests`
- Title: "New Stock-Out Request"
- Subtitle: "Request items to be issued from warehouse"

**Layout:** Max-width 3xl centered (matching existing stock-out page pattern).

**Important:** Do NOT show available stock anywhere on this form. The request form is purely for the requester to specify what they need. Stock validation happens at the DB level and during approval.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify the create page file exists with QMHQ-linked detection, multi-line-item support for manual mode, and locked fields for QMHQ mode.
  </verify>
  <done>
Create page renders at `/inventory/stock-out-requests/new`. QMHQ-linked mode pre-fills and locks item/quantity from QMHQ. Manual mode allows multiple line items with item selector and quantity. Reason selector uses grid cards. Submit inserts into stock_out_requests and stock_out_line_items tables. Redirects to detail page on success.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without TypeScript errors
- Sidebar contains "Stock-Out Requests" link under Inventory section
- Permission matrix includes `stock_out_requests` resource with correct role mappings
- List page loads at `/inventory/stock-out-requests` with card/list toggle and status tabs
- Create page loads at `/inventory/stock-out-requests/new` with form fields
- Create page with `?qmhq={id}` parameter shows QMHQ reference and locked fields
</verification>

<success_criteria>
- Sidebar nav shows "Stock-Out Requests" under Inventory for admin/QM/inventory roles
- List page displays requests in card and list views with status tab filtering
- Create form supports both QMHQ-linked (locked fields) and manual (multi-line-item) modes
- Form submission creates stock_out_requests + stock_out_line_items records
- Permission matrix correctly gates create/read access by role
</success_criteria>

<output>
After completion, create `.planning/phases/28-stock-out-request-approval-ui/28-01-SUMMARY.md`
</output>
