---
phase: 28-stock-out-request-approval-ui
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - components/stock-out-requests/line-item-table.tsx
  - components/stock-out-requests/approval-dialog.tsx
  - components/stock-out-requests/rejection-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Detail page shows request info with Details tab and History tab"
    - "Line item table shows columns: Item, SKU, Requested Qty, Approved Qty, Remaining, Status, Warehouse"
    - "Approver can select line items and click Approve to open approval dialog"
    - "Approval dialog shows editable approved qty and warehouse selector with stock levels per warehouse"
    - "Approver can reject selected line items with mandatory rejection reason"
    - "Requester can cancel own pending request"
    - "Each approval creates a stock_out_approvals record and a pending inventory_transactions record"
  artifacts:
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "Request detail page with tabs, line items, and action buttons"
      min_lines: 300
    - path: "components/stock-out-requests/line-item-table.tsx"
      provides: "Line item table with checkboxes, running totals, and selection actions"
      min_lines: 100
    - path: "components/stock-out-requests/approval-dialog.tsx"
      provides: "Approval modal with per-item qty and warehouse selection"
      min_lines: 150
    - path: "components/stock-out-requests/rejection-dialog.tsx"
      provides: "Rejection modal with free text reason"
      min_lines: 60
  key_links:
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "stock_out_requests"
      via: "Supabase query with line_items join"
      pattern: "from.*stock_out_requests.*select"
    - from: "components/stock-out-requests/approval-dialog.tsx"
      to: "stock_out_approvals"
      via: "Supabase insert for approval records"
      pattern: "from.*stock_out_approvals.*insert"
    - from: "components/stock-out-requests/approval-dialog.tsx"
      to: "inventory_transactions"
      via: "Supabase insert for pending execution records"
      pattern: "from.*inventory_transactions.*insert"
---

<objective>
Build the stock-out request detail page with line item table, approval dialog, rejection dialog, and cancel action.

Purpose: Admins/approvers need to view request details, select line items, and approve with quantities + warehouse assignment or reject with reasons. Requesters need to cancel their own pending requests. This plan implements the core approval workflow UI.

Output: Working detail page at `/inventory/stock-out-requests/[id]` with full approval/rejection/cancel capabilities.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-stock-out-request-approval-ui/28-CONTEXT.md
@.planning/phases/28-stock-out-request-approval-ui/28-RESEARCH.md
@.planning/phases/27-stock-out-approval-db-foundation/27-01-SUMMARY.md
@.planning/phases/27-stock-out-approval-db-foundation/27-02-SUMMARY.md
@.planning/phases/27-stock-out-approval-db-foundation/27-03-SUMMARY.md
@.planning/phases/28-stock-out-request-approval-ui/28-01-SUMMARY.md
@app/(dashboard)/qmhq/[id]/page.tsx
@components/history/history-tab.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Request detail page with line item table and cancel action</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
    components/stock-out-requests/line-item-table.tsx
  </files>
  <action>
**1. Line Item Table (components/stock-out-requests/line-item-table.tsx):**

Props:
```typescript
interface LineItemTableProps {
  items: LineItemWithApprovals[];
  canApprove: boolean;
  selectedIds: Set<string>;
  onSelectionChange: (ids: Set<string>) => void;
}
```

Where `LineItemWithApprovals` extends the DB type to include computed totals:
```typescript
interface LineItemWithApprovals {
  id: string;
  item_id: string;
  item_name: string | null;
  item_sku: string | null;
  requested_quantity: number;
  status: SorLineItemStatus;
  // Computed from joined approvals:
  total_approved_quantity: number;
  remaining_quantity: number;  // requested - total_approved
  // Latest warehouse assignment (from most recent approval):
  assigned_warehouse_name: string | null;
}
```

Table columns: Checkbox (if canApprove), Item, SKU, Requested, Approved, Remaining, Status, Warehouse.

Checkbox behavior:
- Only line items with status 'pending' or having remaining > 0 can be selected for approval
- Only line items with status 'pending' can be selected for rejection
- Select-all checkbox toggles all selectable items
- Disabled checkbox for non-selectable items (executed, cancelled, etc.)

Status badge colors: pending=amber, approved=emerald, rejected=red, cancelled=slate, partially_executed=purple, executed=emerald-bright.

Remaining quantity: Show in amber if > 0, show "0" in slate if fully approved.

Bottom action bar (shown when selectedIds.size > 0):
- Amber highlight bar showing "{N} line item(s) selected"
- "Approve Selected" button (emerald) — only show if all selected items have remaining > 0
- "Reject Selected" button (red) — only show if all selected items are 'pending'

**2. Detail Page (app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx):**

Client component. Read `id` from params.

Data fetching:
- Fetch request: `stock_out_requests` with joins:
  ```
  id, request_number, status, reason, notes, qmhq_id, requester_id, created_at,
  requester:users!stock_out_requests_requester_id_fkey(id, full_name),
  qmhq:qmhq!stock_out_requests_qmhq_id_fkey(id, request_id, line_name)
  ```
- Fetch line items: `stock_out_line_items` with joins:
  ```
  id, request_id, item_id, item_name, item_sku, requested_quantity, status, created_at,
  approvals:stock_out_approvals(id, approval_number, approved_quantity, decision, rejection_reason, decided_by, decided_at, decided_by_user:users!stock_out_approvals_decided_by_fkey(id, full_name))
  ```
  Filter: `.eq('request_id', requestId).eq('is_active', true)`
- Compute per line item: total_approved_quantity (sum of approvals where decision='approved'), remaining_quantity, assigned_warehouse_name (from latest approval)

Header:
- Back button -> `/inventory/stock-out-requests`
- Request number (h1, monospace)
- Requester name subtitle
- Status badge (large)
- If QMHQ linked: show QMHQ reference code linking to `/qmhq/{qmhq_id}`
- Action buttons (top right):
  - "Cancel Request" button: Show if current user is requester AND request.status is 'pending'. Uses destructive variant. On click: confirm dialog, then update `stock_out_requests.status` to 'cancelled' (which triggers DB status update). Also updates all pending line items to cancelled.
    Note: Actually, cancellation at DB level may need direct update of line item statuses since request status is computed. Update each line item status to 'cancelled' via: `stock_out_line_items.update({ status: 'cancelled' }).eq('request_id', id).eq('status', 'pending')`. The request status trigger will auto-compute.

Request info section (command-panel):
- Reason badge (using STOCK_OUT_REASON_CONFIG colors)
- QMHQ reference (if linked, show code + link)
- Requester name
- Created date
- Notes (if present)

Tabs: Details, Approvals, History

**Details tab:**
- LineItemTable component with the computed line items
- `canApprove`: true if user role is admin/quartermaster/inventory
- Selected IDs state managed in parent
- "Approve Selected" opens ApprovalDialog
- "Reject Selected" opens RejectionDialog

**Approvals tab:**
- Show all approvals grouped by line item
- For each approval: approval_number, decision badge, approved_quantity, decided_by name, decided_at, rejection_reason (if rejected), notes

**History tab:**
- Reuse existing `<HistoryTab entityType="stock_out_request" entityId={requestId} />` component

Refetch data after any mutation (approval, rejection, cancellation).
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify detail page file exists with tabs, line item table with selection, and cancel action. Verify line-item-table component exports with checkbox selection.
  </verify>
  <done>
Detail page renders at `/inventory/stock-out-requests/[id]` showing request info, status badge, and QMHQ link if applicable. Line item table shows all columns (Item, SKU, Requested, Approved, Remaining, Status, Warehouse) with selectable checkboxes. Cancel button visible for requester on pending requests. Tabs switch between Details, Approvals, and History.
  </done>
</task>

<task type="auto">
  <name>Task 2: Approval dialog and rejection dialog</name>
  <files>
    components/stock-out-requests/approval-dialog.tsx
    components/stock-out-requests/rejection-dialog.tsx
  </files>
  <action>
**1. Approval Dialog (components/stock-out-requests/approval-dialog.tsx):**

Props:
```typescript
interface ApprovalDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  lineItems: LineItemWithApprovals[];  // Selected line items
  requestId: string;
  requestReason: string;  // To pass to execution instance
  onSuccess: () => void;  // Callback to refetch parent data
}
```

State:
- `approvalData`: Map<string, { approvedQuantity: string; warehouseId: string }> — per line item
- `warehouseStocks`: Map<string, WarehouseStock[]> — stock levels per item_id
- `notes`: string (optional approval notes)
- `isSubmitting`: boolean

On open (useEffect when `open` changes to true):
- Initialize `approvalData` for each line item with:
  - `approvedQuantity` pre-filled with `remaining_quantity` (requested - already approved)
  - `warehouseId` empty
- Fetch warehouse stock levels for each unique item_id. Create a helper function `fetchWarehouseStockForItem(supabase, itemId)` directly inside this component (or import the `fetchItemStock` function from `app/(dashboard)/inventory/stock-out/page.tsx` if it is exported as a standalone utility). If `fetchItemStock` is not exported or is tightly coupled to the stock-out page component, create a new standalone async function in the approval dialog that:
  1. Queries `inventory_transactions` filtering by `item_id` and `status = 'completed'`
  2. Groups results by `warehouse_id`, summing `quantity` for `inventory_in` and subtracting for `inventory_out`
  3. Joins warehouse names from the `warehouses` table
  4. Returns `Array<{ warehouse_id: string; warehouse_name: string; available_stock: number }>`
  - Store results in `warehouseStocks` map keyed by item_id

Dialog content (max-w-3xl, scrollable):
- Title: "Approve Line Items"
- Description: "Set approved quantities and assign warehouses for {N} line item(s)"

For each selected line item, show a card (border border-slate-700 rounded-lg p-4):
- Item name (font-medium), SKU (text-sm text-slate-400)
- Right side: "Requested: {qty}", "Already Approved: {total_approved}", "Remaining: {remaining}"
- Two-column grid:
  - **Approved Quantity**: Number input, pre-filled with remaining. Validate: > 0 and <= remaining_quantity. Show error text if invalid. Use handleQuantityKeyDown for number-only input.
  - **Warehouse**: Select dropdown. Options from warehouseStocks[item_id]. Each option shows: warehouse name + current stock in emerald monospace. If stock < approved qty, show warning text in amber. Required field.

Notes textarea at bottom (optional).

Validation before submit:
- Every line item has approvedQuantity > 0 and <= remaining
- Every line item has a warehouseId selected
- Show validation error if any item fails

Submit handler:
- For each line item:
  1. Insert into `stock_out_approvals`: `{ line_item_id, approved_quantity, decision: 'approved', decided_by: user.id, created_by: user.id }`
  2. Get the returned approval record (need the id)
  3. Insert into `inventory_transactions`: `{ movement_type: 'inventory_out', item_id, warehouse_id, quantity: approved_qty, reason: requestReason, stock_out_approval_id: approval.id, status: 'pending', created_by: user.id }` — this creates the "ready to execute" instance
- Use sequential inserts (approval first, then transaction with the approval ID)
- On success: toast "Approved {N} line item(s)", call onSuccess(), close dialog
- On error: toast error, keep dialog open

**2. Rejection Dialog (components/stock-out-requests/rejection-dialog.tsx):**

Props:
```typescript
interface RejectionDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  lineItems: LineItemWithApprovals[];  // Selected line items
  onSuccess: () => void;
}
```

State:
- `rejectionReason`: string (required, minimum 1 character)
- `isSubmitting`: boolean

Dialog content (max-w-lg):
- Title: "Reject Line Items"
- Description: "Provide a reason for rejecting {N} line item(s)"
- Show list of items being rejected: item_name, item_sku, requested_quantity
- Textarea for rejection reason (required, placeholder: "Enter rejection reason...")
- Warning: "Rejection is terminal. The requester will need to create a new request."

Submit handler:
- For each selected line item:
  - Insert into `stock_out_approvals`: `{ line_item_id, approved_quantity: 0, decision: 'rejected', rejection_reason: rejectionReason, decided_by: user.id, created_by: user.id }`
- On success: toast "Rejected {N} line item(s)", call onSuccess(), close dialog
- On error: toast error, keep dialog open

Footer: Cancel button (outline) + Reject button (destructive variant).
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify approval-dialog.tsx creates stock_out_approvals + inventory_transactions records. Verify rejection-dialog.tsx creates rejection records with mandatory reason. Both dialogs integrate with the detail page's line item selection.
  </verify>
  <done>
Approval dialog opens for selected line items, shows per-item approved quantity input and warehouse selector with stock levels. Submit creates approval + pending execution records. Rejection dialog opens for selected pending line items, requires rejection reason, and creates rejection records. Both dialogs close and refresh parent data on success.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without TypeScript errors
- Detail page at `/inventory/stock-out-requests/[id]` shows request info, line item table, and tabs
- Line item table displays checkboxes for selectable items with running totals
- Approval dialog shows per-item qty and warehouse selector with stock levels
- Rejection dialog requires a reason and creates rejection records
- Cancel action visible for requester on pending requests
- Approval creates both stock_out_approvals and pending inventory_transactions records
</verification>

<success_criteria>
- Approver can select line items, click Approve, set qty + warehouse, and submit successfully
- Approver can select pending line items, click Reject, enter reason, and submit successfully
- Requester can cancel own pending request via Cancel button
- Line item table shows accurate running totals (requested, approved, remaining)
- Each approval auto-creates a pending inventory_transaction for later execution
- Detail page refreshes after any mutation to show updated statuses
</success_criteria>

<output>
After completion, create `.planning/phases/28-stock-out-request-approval-ui/28-02-SUMMARY.md`
</output>
