---
phase: 28-stock-out-request-approval-ui
plan: 03
type: execute
wave: 3
depends_on: ["28-02"]
files_modified:
  - components/stock-out-requests/execution-dialog.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
autonomous: true

must_haves:
  truths:
    - "Executor can confirm one-click execution of all approved lines in a request"
    - "Execution blocked if any line has insufficient stock in assigned warehouse"
    - "QMHQ item route detail page shows 'Request Stock-Out' button linking to create page"
    - "QMHQ item route detail page shows stock-out request status badge with link to request detail"
    - "Existing stock-out page redirects to stock-out requests (no manual stock-out without approval)"
  artifacts:
    - path: "components/stock-out-requests/execution-dialog.tsx"
      provides: "Execution confirmation dialog with stock validation"
      min_lines: 100
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Modified QMHQ detail with Request Stock-Out button and SOR status badge"
      contains: "stock-out-requests"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Modified stock-out page redirecting to request flow"
      contains: "stock-out-requests"
  key_links:
    - from: "components/stock-out-requests/execution-dialog.tsx"
      to: "inventory_transactions"
      via: "Supabase update status to completed"
      pattern: "inventory_transactions.*update.*completed"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "/inventory/stock-out-requests/new"
      via: "Link with qmhq query param"
      pattern: "stock-out-requests/new.*qmhq"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "stock_out_requests"
      via: "Supabase query for linked SOR"
      pattern: "from.*stock_out_requests.*qmhq_id"
---

<objective>
Add execution dialog for approved stock-out requests, integrate "Request Stock-Out" button into QMHQ detail page, show SOR status on QMHQ detail, and modify the existing stock-out page to require the approval workflow.

Purpose: Completes the approval-to-execution flow. Executors confirm pre-built stock-out records. QMHQ item routes gain the "Request Stock-Out" entry point. The existing direct stock-out page transitions to the request-based workflow. This plan delivers the end-to-end flow from QMHQ through request, approval, and execution.

Output: Complete stock-out request workflow from QMHQ integration through execution.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-stock-out-request-approval-ui/28-CONTEXT.md
@.planning/phases/28-stock-out-request-approval-ui/28-RESEARCH.md
@.planning/phases/27-stock-out-approval-db-foundation/27-01-SUMMARY.md
@.planning/phases/27-stock-out-approval-db-foundation/27-02-SUMMARY.md
@.planning/phases/28-stock-out-request-approval-ui/28-01-SUMMARY.md
@.planning/phases/28-stock-out-request-approval-ui/28-02-SUMMARY.md
@app/(dashboard)/qmhq/[id]/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execution dialog and detail page integration</name>
  <files>
    components/stock-out-requests/execution-dialog.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
**1. Execution Dialog (components/stock-out-requests/execution-dialog.tsx):**

Props:
```typescript
interface ExecutionDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  requestId: string;
  onSuccess: () => void;
}
```

State:
- `executionItems`: array of pending inventory_transactions for this request
- `validationErrors`: string[] (stock availability issues)
- `isLoading`: boolean
- `isExecuting`: boolean

On open (useEffect):
1. Fetch all pending inventory_transactions linked to this request:
   - Query `inventory_transactions` with joins:
     ```
     id, item_id, warehouse_id, quantity, reason, stock_out_approval_id, status,
     item:items!inventory_transactions_item_id_fkey(id, name, sku),
     warehouse:warehouses!inventory_transactions_warehouse_id_fkey(id, name)
     ```
   - Filter: `status = 'pending'`, `movement_type = 'inventory_out'`, `stock_out_approval_id IS NOT NULL`
   - Then filter client-side: only transactions whose approval's line_item belongs to this request.
     Alternative approach: First fetch all approvals for this request's line items, get approval IDs, then fetch transactions by those approval IDs:
     ```
     Step 1: stock_out_line_items.select('id').eq('request_id', requestId)
     Step 2: stock_out_approvals.select('id').in('line_item_id', lineItemIds).eq('decision', 'approved')
     Step 3: inventory_transactions.select(...).in('stock_out_approval_id', approvalIds).eq('status', 'pending')
     ```
   This 3-step approach is cleaner than complex nested joins.

2. Validate stock per item+warehouse:
   For each execution item, calculate current available stock in the assigned warehouse:
   - Query `inventory_transactions` for that item+warehouse, sum in/out for completed transactions
   - If available_stock < execution quantity, add error: "{item.name}: Insufficient stock in {warehouse.name} (need {qty}, have {available})"

3. Store validation results

Dialog content (max-w-2xl):
- Title: "Execute Stock-Out"
- Description: "{N} item(s) ready for execution"

If loading: show spinner.

If validation errors exist: Show red error box with list of issues. Execute button disabled.

Show table of items to be executed:
- Each row: item name, SKU, warehouse name, quantity (in red monospace)
- Background: slate-800/50 rounded

Warning banner (amber): "Execution is permanent. Stock-out transactions cannot be voided. Use stock-in to correct."

Footer: Cancel (outline) + Execute Stock-Out (red gradient, disabled if errors or executing)

Execute handler:
- Update all pending transactions to `status: 'completed'` and `transaction_date: new Date().toISOString()`:
  ```
  inventory_transactions.update({ status: 'completed', transaction_date: now }).in('id', transactionIds)
  ```
- The DB triggers will auto-update line item statuses (approved -> partially_executed -> executed) and request status
- On success: toast "Stock-out executed successfully for {N} items", call onSuccess(), close dialog
- On error: toast error with message, keep dialog open

**2. Detail Page Integration (app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx):**

Add "Execute" button to the detail page header, next to the Cancel button:
- Show if: user role is admin or inventory, AND request has at least one approved line item with pending execution records
- Button style: red gradient (matching existing stock-out button style: `bg-gradient-to-r from-red-600 to-red-500`)
- Text: "Execute Stock-Out"
- On click: open ExecutionDialog

To determine if execution is possible:
- Check if any line items have status 'approved' or 'partially_executed'
- Or simpler: fetch count of pending inventory_transactions linked to this request's approvals
- Store in state: `hasPendingExecutions: boolean`

Import and render the ExecutionDialog component, passing requestId and onSuccess callback that refetches data.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify execution-dialog.tsx fetches pending transactions, validates stock, and updates to completed. Verify detail page shows Execute button for eligible roles/states.
  </verify>
  <done>
Execute button appears on detail page for admin/inventory roles when pending execution records exist. Execution dialog shows items, warehouses, quantities, validates stock availability, and completes transactions on confirm. Validation errors block execution with clear messages. DB triggers auto-update line item and request statuses after execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: QMHQ integration and stock-out page modification</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
    app/(dashboard)/inventory/stock-out/page.tsx
  </files>
  <action>
**1. QMHQ Detail Page Modification (app/(dashboard)/qmhq/[id]/page.tsx):**

This page already has a "Stock Out" tab for item route QMHQs. Modify it to integrate with the new stock-out request workflow.

Changes to the Stock Out tab section:

A. **Fetch linked stock-out request:**
Add a query in the data fetching section to check for an existing stock-out request linked to this QMHQ:
```typescript
const { data: sorData } = await supabase
  .from('stock_out_requests')
  .select(`
    id, request_number, status,
    line_items:stock_out_line_items(
      id, requested_quantity, status,
      approvals:stock_out_approvals(approved_quantity, decision)
    )
  `)
  .eq('qmhq_id', qmhqId)
  .eq('is_active', true)
  .maybeSingle();
```
Store in state: `stockOutRequest`

B. **Replace the "Issue Items" button with "Request Stock-Out" button:**
In the Stock Out tab header, change the button logic:
- If NO stock-out request exists for this QMHQ:
  - Show "Request Stock-Out" button linking to `/inventory/stock-out-requests/new?qmhq={qmhqId}`
  - Blue gradient style (different from the old red "Issue Items")
  - Only show if `can('create', 'stock_out_requests')` — uses the permission resource added in plan 01
- If a stock-out request EXISTS:
  - Show status badge (Pending/Approved/Rejected/etc.) that links to the request detail page: `/inventory/stock-out-requests/{sorData.id}`
  - Compute and display: total requested qty, total approved qty
  - If request is executed/fulfilled: show green "Fulfilled" badge

C. **Update the Stock Out tab content:**
Keep the existing "Requested Items Summary" section showing QMHQ items.
Below it, add a "Stock-Out Request" section if `stockOutRequest` exists:
- Request number (code, clickable link to SOR detail)
- Status badge
- Summary: "Requested: {total_requested}, Approved: {total_approved}"
- Link: "View Details" button navigating to SOR detail page

If no request exists yet, show a call-to-action:
- Info text: "Create a stock-out request to initiate the approval workflow"
- The "Request Stock-Out" button (already in header)

D. **Remove direct stock-out creation:**
Remove or disable the old "Issue Items" button that linked to `/inventory/stock-out?qmhq={qmhqId}`.
All stock-out must now go through the request/approval flow.

**2. Stock-Out Page Modification (app/(dashboard)/inventory/stock-out/page.tsx):**

The existing stock-out page at `/inventory/stock-out` allows direct stock-out without approval. Per user decision, ALL stock-outs now require approved requests.

Replace the entire page content with a redirect/info page:
- Show an informational message: "Stock-out operations now require an approved request."
- Provide a link to the stock-out requests list: `/inventory/stock-out-requests`
- Include a "View Requests" button and a "Create New Request" button
- Style: command-panel with info icon, centered content

Keep the URL functional (don't delete the page) so existing bookmarks/links don't 404. This acts as a transition page guiding users to the new workflow.

Alternatively, if the page still receives `?qmhq={id}` query parameter (from old QMHQ links), redirect to the new create request page:
```typescript
const qmhqId = searchParams.get("qmhq");
if (qmhqId) {
  router.replace(`/inventory/stock-out-requests/new?qmhq=${qmhqId}`);
  return;
}
```
This handles any remaining links from older QMHQ pages.

Important: Do NOT delete the stock-out page file. Modify it in place to redirect/guide users.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify QMHQ detail page has "Request Stock-Out" button for item routes. Verify QMHQ detail shows SOR status badge when request exists. Verify stock-out page redirects QMHQ links and shows info message for direct access.
  </verify>
  <done>
QMHQ item route detail page shows "Request Stock-Out" button when no SOR exists, and shows SOR status badge + link when one does. Old "Issue Items" button replaced. Existing stock-out page redirects `?qmhq` params to new request page and shows info message for direct access. End-to-end flow: QMHQ -> Request Stock-Out -> Create Request -> Approve -> Execute.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without TypeScript errors
- Execution dialog validates stock and completes transactions
- QMHQ item route detail shows "Request Stock-Out" button linking to new request page
- QMHQ item route detail shows SOR status badge when request exists
- Stock-out page redirects QMHQ links and shows info message
- End-to-end: QMHQ -> Request -> Approve (with warehouse) -> Execute -> Fulfilled
</verification>

<success_criteria>
- Executor sees pre-built stock-out records and confirms with one click
- Stock shortage in assigned warehouse blocks entire execution with clear error messages
- QMHQ item detail "Request Stock-Out" navigates to `/inventory/stock-out-requests/new?qmhq={id}`
- QMHQ detail shows linked SOR status badge clickable to request detail
- Old stock-out page gracefully redirects to new request workflow
- DB triggers auto-update statuses through the full lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/28-stock-out-request-approval-ui/28-03-SUMMARY.md`
</output>
