---
phase: 28-stock-out-request-approval-ui
plan: 03
type: execute
wave: 3
depends_on: ["28-02"]
files_modified:
  - components/stock-out-requests/execution-dialog.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
autonomous: true

must_haves:
  truths:
    - "Executor can confirm one-click execution of ALL approved lines in a request as a single atomic operation"
    - "Execution validates and executes ALL pending transactions for the entire request simultaneously (not selective per-line)"
    - "Execution blocked if any line has insufficient stock in assigned warehouse"
    - "QMHQ item route detail page shows 'Request Stock-Out' button linking to create page"
    - "QMHQ item route detail page shows stock-out request status badge with link to request detail"
    - "QMHQ item route detail page shows requested qty and approved qty in a Stock-Out Status card"
    - "Existing stock-out page redirects to stock-out requests (no manual stock-out without approval)"
  artifacts:
    - path: "components/stock-out-requests/execution-dialog.tsx"
      provides: "Execution confirmation dialog with stock validation"
      min_lines: 100
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Modified QMHQ detail with Request Stock-Out button, SOR status badge, and requested/approved qty display"
      contains: "stock-out-requests"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Modified stock-out page redirecting to request flow"
      contains: "stock-out-requests"
  key_links:
    - from: "components/stock-out-requests/execution-dialog.tsx"
      to: "inventory_transactions"
      via: "Supabase update status to completed"
      pattern: "inventory_transactions.*update.*completed"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "/inventory/stock-out-requests/new"
      via: "Link with qmhq query param"
      pattern: "stock-out-requests/new.*qmhq"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "stock_out_requests"
      via: "Supabase query for linked SOR"
      pattern: "from.*stock_out_requests.*qmhq_id"
---

<objective>
Add execution dialog for approved stock-out requests, integrate "Request Stock-Out" button into QMHQ detail page, show SOR status and requested/approved quantities on QMHQ detail, and modify the existing stock-out page to require the approval workflow.

Purpose: Completes the approval-to-execution flow. Executors confirm pre-built stock-out records. QMHQ item routes gain the "Request Stock-Out" entry point and display requested/approved quantities per SOAR-08. The existing direct stock-out page transitions to the request-based workflow. This plan delivers the end-to-end flow from QMHQ through request, approval, and execution.

Output: Complete stock-out request workflow from QMHQ integration through execution.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-stock-out-request-approval-ui/28-CONTEXT.md
@.planning/phases/28-stock-out-request-approval-ui/28-RESEARCH.md
@.planning/phases/27-stock-out-approval-db-foundation/27-01-SUMMARY.md
@.planning/phases/27-stock-out-approval-db-foundation/27-02-SUMMARY.md
@.planning/phases/28-stock-out-request-approval-ui/28-01-SUMMARY.md
@.planning/phases/28-stock-out-request-approval-ui/28-02-SUMMARY.md
@app/(dashboard)/qmhq/[id]/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execution dialog and detail page integration</name>
  <files>
    components/stock-out-requests/execution-dialog.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
**1. Execution Dialog (components/stock-out-requests/execution-dialog.tsx):**

Props:
```typescript
interface ExecutionDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  requestId: string;
  onSuccess: () => void;
}
```

State:
- `executionItems`: array of ALL pending inventory_transactions for this entire request
- `validationErrors`: string[] (stock availability issues)
- `isLoading`: boolean
- `isExecuting`: boolean

**CRITICAL: Whole-request execution (per user decision).** This dialog fetches and executes ALL pending transactions for the ENTIRE request across ALL line items and ALL approvals in a single atomic operation. There is NO selective per-line or per-approval execution. The user clicks "Execute Stock-Out" and either ALL pending transactions execute together, or none do (if any validation fails).

On open (useEffect):
1. Fetch ALL pending inventory_transactions linked to this request. Use a 3-step query approach:
   ```
   Step 1: stock_out_line_items.select('id').eq('request_id', requestId)
   Step 2: stock_out_approvals.select('id').in('line_item_id', lineItemIds).eq('decision', 'approved')
   Step 3: inventory_transactions.select(
     id, item_id, warehouse_id, quantity, reason, stock_out_approval_id, status,
     item:items!inventory_transactions_item_id_fkey(id, name, sku),
     warehouse:warehouses!inventory_transactions_warehouse_id_fkey(id, name)
   ).in('stock_out_approval_id', approvalIds).eq('status', 'pending')
   ```
   This fetches every pending transaction belonging to the request, not just one approval's transactions. All of them will be executed together.

2. Validate stock for ALL items across ALL warehouses:
   For each unique item_id + warehouse_id combination among the execution items, calculate current available stock:
   - Query `inventory_transactions` for that item+warehouse, sum in/out for completed transactions
   - If available_stock < total execution quantity for that item+warehouse pair, add error: "{item.name}: Insufficient stock in {warehouse.name} (need {qty}, have {available})"
   - If ANY validation error exists, the ENTIRE execution is blocked (per user decision: "Stock shortage blocks entire execution")

3. Store validation results

Dialog content (max-w-2xl):
- Title: "Execute Stock-Out"
- Description: "Execute ALL {N} pending item(s) for this request"

If loading: show spinner.

If validation errors exist: Show red error box with list of ALL issues. Execute button disabled. Message: "Cannot execute: stock shortages found. All items must have sufficient stock to proceed."

Show table of ALL items to be executed:
- Each row: item name, SKU, warehouse name, quantity (in red monospace)
- Background: slate-800/50 rounded

Warning banner (amber): "Execution is permanent and covers all pending items in this request. Stock-out transactions cannot be voided. Use stock-in to correct."

Footer: Cancel (outline) + Execute Stock-Out (red gradient, disabled if errors or executing)

Execute handler:
- Update ALL pending transactions to `status: 'completed'` and `transaction_date: new Date().toISOString()` in a single update:
  ```
  inventory_transactions.update({ status: 'completed', transaction_date: now }).in('id', allTransactionIds)
  ```
  Where `allTransactionIds` includes every pending transaction for the entire request. This is one atomic database call, not per-line.
- The DB triggers will auto-update line item statuses (approved -> partially_executed -> executed) and request status
- On success: toast "Stock-out executed successfully for {N} items", call onSuccess(), close dialog
- On error: toast error with message, keep dialog open

**2. Detail Page Integration (app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx):**

Add "Execute" button to the detail page header, next to the Cancel button:
- Show if: user role is admin or inventory, AND request has at least one pending execution record
- Button style: red gradient (matching existing stock-out button style: `bg-gradient-to-r from-red-600 to-red-500`)
- Text: "Execute Stock-Out"
- On click: open ExecutionDialog

To determine if execution is possible:
- Check if any line items have status 'approved' or 'partially_executed'
- Or simpler: fetch count of pending inventory_transactions linked to this request's approvals
- Store in state: `hasPendingExecutions: boolean`

Import and render the ExecutionDialog component, passing requestId and onSuccess callback that refetches data.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify execution-dialog.tsx fetches ALL pending transactions for the entire request, validates stock for all of them, and updates all to completed in a single operation. Verify detail page shows Execute button for eligible roles/states.
  </verify>
  <done>
Execute button appears on detail page for admin/inventory roles when pending execution records exist. Execution dialog shows ALL items across all approvals for the entire request, validates stock availability for every item, and completes ALL transactions in one atomic operation on confirm. If any single item has insufficient stock, the entire execution is blocked. DB triggers auto-update line item and request statuses after execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: QMHQ integration and stock-out page modification</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
    app/(dashboard)/inventory/stock-out/page.tsx
  </files>
  <action>
**1. QMHQ Detail Page Modification (app/(dashboard)/qmhq/[id]/page.tsx):**

This page already has a "Stock Out" tab for item route QMHQs. Modify it to integrate with the new stock-out request workflow.

Changes to the Stock Out tab section:

A. **Fetch linked stock-out request:**
Add a query in the data fetching section to check for an existing stock-out request linked to this QMHQ:
```typescript
const { data: sorData } = await supabase
  .from('stock_out_requests')
  .select(`
    id, request_number, status,
    line_items:stock_out_line_items(
      id, requested_quantity, status,
      approvals:stock_out_approvals(approved_quantity, decision)
    )
  `)
  .eq('qmhq_id', qmhqId)
  .eq('is_active', true)
  .maybeSingle();
```
Store in state: `stockOutRequest`

B. **Replace the "Issue Items" button with "Request Stock-Out" button:**
In the Stock Out tab header, change the button logic:
- If NO stock-out request exists for this QMHQ:
  - Show "Request Stock-Out" button linking to `/inventory/stock-out-requests/new?qmhq={qmhqId}`
  - Blue gradient style (different from the old red "Issue Items")
  - Only show if `can('create', 'stock_out_requests')` — uses the permission resource added in plan 01
- If a stock-out request EXISTS:
  - Show status badge (Pending/Approved/Rejected/etc.) that links to the request detail page: `/inventory/stock-out-requests/{sorData.id}`
  - Badge is clickable (wrapped in Link component) so users can navigate to the full request detail

C. **Add "Stock-Out Status" card to the Stock Out tab content (SOAR-08):**
When `stockOutRequest` exists, render a dedicated **"Stock-Out Status"** card positioned BELOW the existing "Requested Items Summary" section. This card uses the command-panel styling (border border-slate-700/50 rounded-xl bg-slate-800/30 p-4) and contains:

- **Header row:** "Stock-Out Request" label on the left, request_number as monospace code on the right (clickable Link to `/inventory/stock-out-requests/{sorData.id}`)
- **Status badge:** Overall request status (Pending/Approved/Rejected/Executed/etc.) with standard status colors
- **Quantities row (the key SOAR-08 display):** A horizontal flex row with two stat blocks:
  - **"Requested"** label (text-xs text-slate-400) above the total requested quantity in large font-mono text (text-lg font-semibold). Compute: sum of all `line_items[].requested_quantity`
  - **"Approved"** label (text-xs text-slate-400) above the total approved quantity in large emerald font-mono text. Compute: sum of all `line_items[].approvals[]` where `decision === 'approved'`, summing `approved_quantity`
  - Separator pipe between the two blocks (text-slate-600)
  - Example rendering: `Requested: 20 units  |  Approved: 10 units`
- **"View Details" link:** Text button at bottom right navigating to `/inventory/stock-out-requests/{sorData.id}`

If no request exists yet, show a call-to-action section instead:
- Info text: "Create a stock-out request to initiate the approval workflow"
- The "Request Stock-Out" button (already in header, but also repeat here as a prominent CTA)

D. **Remove direct stock-out creation:**
Remove or disable the old "Issue Items" button that linked to `/inventory/stock-out?qmhq={qmhqId}`.
All stock-out must now go through the request/approval flow.

**2. Stock-Out Page Modification (app/(dashboard)/inventory/stock-out/page.tsx):**

The existing stock-out page at `/inventory/stock-out` allows direct stock-out without approval. Per user decision, ALL stock-outs now require approved requests.

Replace the entire page content with a redirect/info page:
- Show an informational message: "Stock-out operations now require an approved request."
- Provide a link to the stock-out requests list: `/inventory/stock-out-requests`
- Include a "View Requests" button and a "Create New Request" button
- Style: command-panel with info icon, centered content

Keep the URL functional (don't delete the page) so existing bookmarks/links don't 404. This acts as a transition page guiding users to the new workflow.

Alternatively, if the page still receives `?qmhq={id}` query parameter (from old QMHQ links), redirect to the new create request page:
```typescript
const qmhqId = searchParams.get("qmhq");
if (qmhqId) {
  router.replace(`/inventory/stock-out-requests/new?qmhq=${qmhqId}`);
  return;
}
```
This handles any remaining links from older QMHQ pages.

Important: Do NOT delete the stock-out page file. Modify it in place to redirect/guide users.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify QMHQ detail page has "Request Stock-Out" button for item routes. Verify QMHQ detail shows "Stock-Out Status" card with requested qty and approved qty when a request exists. Verify QMHQ detail shows SOR status badge clickable to request detail. Verify stock-out page redirects QMHQ links and shows info message for direct access.
  </verify>
  <done>
QMHQ item route detail page shows "Request Stock-Out" button when no SOR exists, and shows a "Stock-Out Status" card when one does. The card displays: request number, status badge, total requested quantity, and total approved quantity (fulfilling SOAR-08: "QMHQ item detail shows requested qty and approved qty"). Status badge is clickable and navigates to request detail page. Old "Issue Items" button replaced. Existing stock-out page redirects `?qmhq` params to new request page and shows info message for direct access. End-to-end flow: QMHQ -> Request Stock-Out -> Create Request -> Approve -> Execute.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without TypeScript errors
- Execution dialog validates stock for ALL pending transactions and completes them all atomically
- Execution dialog does NOT allow selective per-line execution (whole request only per user decision)
- QMHQ item route detail shows "Request Stock-Out" button linking to new request page
- QMHQ item route detail shows "Stock-Out Status" card with requested qty and approved qty (SOAR-08)
- QMHQ item route detail shows SOR status badge clickable to request detail
- Stock-out page redirects QMHQ links and shows info message
- End-to-end: QMHQ -> Request -> Approve (with warehouse) -> Execute -> Fulfilled
</verification>

<success_criteria>
- Executor sees ALL pre-built stock-out records for the entire request and confirms with one click
- Stock shortage in ANY assigned warehouse blocks the ENTIRE execution with clear error messages
- Execution is whole-request: all pending transactions execute together, not selectively
- QMHQ item detail "Request Stock-Out" navigates to `/inventory/stock-out-requests/new?qmhq={id}`
- QMHQ detail shows "Stock-Out Status" card displaying "Requested: {qty} units | Approved: {qty} units" with status badge
- QMHQ detail status badge is clickable and navigates to request detail
- Old stock-out page gracefully redirects to new request workflow
- DB triggers auto-update statuses through the full lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/28-stock-out-request-approval-ui/28-03-SUMMARY.md`
</output>
