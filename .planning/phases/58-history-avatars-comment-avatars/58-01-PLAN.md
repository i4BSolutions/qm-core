---
phase: 58-history-avatars-comment-avatars
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/history/history-tab.tsx
autonomous: true
requirements:
  - HIST-01
  - HIST-02
  - AVTR-02

must_haves:
  truths:
    - "Each audit history entry with a non-null changed_by shows a 20px UserAvatar circle next to the user name"
    - "System-generated history entries (changed_by is null) show a Bot icon in a slate-700 circle with muted 'System' text instead of a user avatar"
    - "Comment cards already show UserAvatar next to commenter name (no change needed -- AVTR-02 pre-satisfied)"
  artifacts:
    - path: "components/history/history-tab.tsx"
      provides: "UserAvatar in history entries + system indicator"
      contains: "UserAvatar"
  key_links:
    - from: "components/history/history-tab.tsx"
      to: "components/ui/user-avatar.tsx"
      via: "import UserAvatar"
      pattern: "import.*UserAvatar.*from.*user-avatar"
    - from: "components/history/history-tab.tsx"
      to: "lucide-react"
      via: "Bot icon import"
      pattern: "Bot.*from.*lucide-react"
---

<objective>
Add UserAvatar circles to audit history entries and a distinct system indicator for automated actions.

Purpose: Complete v1.12 avatar integration -- every user name in history tabs gets its auto-generated avatar, and system actions are visually distinct from human actions.

Output: Modified `components/history/history-tab.tsx` with avatar rendering in HistoryEntry. Comment cards (AVTR-02) are already done -- verified only.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-history-avatars-comment-avatars/58-RESEARCH.md
@components/history/history-tab.tsx
@components/ui/user-avatar.tsx
@components/comments/comment-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserAvatar and system indicator to HistoryEntry component</name>
  <files>components/history/history-tab.tsx</files>
  <action>
Modify the HistoryEntry component in `components/history/history-tab.tsx` to show avatars for user actions and a system indicator for automated actions.

**Import changes (top of file):**
1. Add import: `import { UserAvatar } from "@/components/ui/user-avatar";`
2. Add `Bot` to the existing lucide-react import list (alphabetical order with existing imports).

**HistoryEntry component changes (lines 254-265, the "User and time" section):**

Replace the current user name display block:
```typescript
<span className="flex items-center gap-1">
  <span className="font-medium text-slate-300">
    {log.changed_by_name || "System"}
  </span>
</span>
```

With conditional avatar/system rendering:
```typescript
<span className="flex items-center gap-1.5">
  {log.changed_by ? (
    <>
      <UserAvatar fullName={log.changed_by_name || "Unknown"} size={20} />
      <span className="font-medium text-slate-300">
        {log.changed_by_name}
      </span>
    </>
  ) : (
    <>
      <span className="inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-700">
        <Bot className="h-3 w-3 text-slate-400" />
      </span>
      <span className="font-medium text-slate-500">System</span>
    </>
  )}
</span>
```

**Key implementation details:**
- Detection uses `log.changed_by` (UUID null check), NOT `log.changed_by_name === "System"` -- UUID is authoritative, name-based check is fragile.
- Avatar size is 20px -- matches precedent in filter dropdowns (qmrl/page.tsx:271) and is proportional to `text-xs` (12px) context.
- Fallback `"Unknown"` for UserAvatar fullName when `changed_by` is non-null but `changed_by_name` is null (edge case from old audit data).
- System indicator uses a 20px (h-5 w-5) slate-700 circle with a Bot icon inside -- visually distinct from colorful user avatars.
- Gap increased from `gap-1` to `gap-1.5` to accommodate the avatar circle spacing.
- Do NOT modify HistoryEntrySkeleton -- the 20px avatar is too small to warrant a skeleton addition.
- Do NOT touch any other part of the file.
  </action>
  <verify>
1. Run `npm run build` -- must compile without errors.
2. Run `npm run type-check` -- must pass TypeScript checks.
3. Grep for the import: `grep "UserAvatar" components/history/history-tab.tsx` should show the import line.
4. Grep for system indicator: `grep "Bot" components/history/history-tab.tsx` should show the Bot import and usage.
5. Grep to confirm no "System" string is passed to UserAvatar: the pattern `UserAvatar.*System` should NOT appear.
  </verify>
  <done>
- History entries with a real user (changed_by non-null) show a 20px UserAvatar circle next to the user name.
- History entries with no user (changed_by null) show a Bot icon in a slate-700 circle with muted "System" text.
- Build passes, no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify AVTR-02 is already satisfied in comment cards</name>
  <files>components/comments/comment-card.tsx</files>
  <action>
AVTR-02 (user avatar in comment cards) was resolved during a prior debug fix. This task is verification-only -- no code changes.

Verify that `components/comments/comment-card.tsx` line 36 contains:
```typescript
<UserAvatar fullName={comment.author.full_name} size={32} />
```

And that the import exists:
```typescript
import { UserAvatar } from "@/components/ui/user-avatar";
```

If both are present, AVTR-02 is confirmed satisfied. Do NOT modify this file.
  </action>
  <verify>
1. `grep "UserAvatar" components/comments/comment-card.tsx` should show both the import and the usage.
2. `grep "size={32}" components/comments/comment-card.tsx` should confirm the 32px size for comment cards.
  </verify>
  <done>
- CommentCard renders UserAvatar at size 32 next to commenter name -- AVTR-02 confirmed.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors.
2. `npm run type-check` passes.
3. `grep -n "UserAvatar\|Bot" components/history/history-tab.tsx` shows correct imports and usage.
4. `grep -n "UserAvatar" components/comments/comment-card.tsx` confirms existing avatar in comment cards.
5. Navigate to any detail page History tab -- user entries show colorful avatar circles, system entries show muted Bot icon.
</verification>

<success_criteria>
- Every audit history entry with a human actor shows a 20px UserAvatar next to their name (HIST-01).
- System-generated entries show a Bot icon in a slate circle with "System" text (HIST-02).
- Comment cards continue showing 32px UserAvatar next to commenter name (AVTR-02 -- pre-existing).
- Build and type-check pass cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/58-history-avatars-comment-avatars/58-01-SUMMARY.md`
</output>
