---
phase: 63-qmhq-auto-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/utils/qmhq-auto-status.ts
  - components/qmhq/auto-status-badge.tsx
autonomous: true
requirements:
  - AUTO-01
  - AUTO-02
  - AUTO-03
  - AUTO-04
  - AUTO-05
  - AUTO-06
  - AUTO-07
  - AUTO-08
  - AUTO-09

must_haves:
  truths:
    - "Item route QMHQ with no SOR approvals computes to Item Pending"
    - "Item route QMHQ with any L1/L2 approval computes to Item Processing"
    - "Item route QMHQ with all SOR line items executed computes to Item Done"
    - "Expense route QMHQ with no money-in computes to Expense Pending"
    - "Expense route QMHQ with any money-in computes to Expense Processing"
    - "Expense route QMHQ with yet-to-receive <= 0 computes to Expense Done"
    - "PO route QMHQ with no non-cancelled PO computes to PO Pending"
    - "PO route QMHQ with any non-cancelled PO computes to PO Processing"
    - "PO route QMHQ with yet-to-receive <= 0 AND balance-in-hand <= 0 computes to PO Done"
  artifacts:
    - path: "lib/utils/qmhq-auto-status.ts"
      provides: "Auto status computation functions and config"
      exports: ["computeQmhqAutoStatus", "QMHQ_AUTO_STATUS_CONFIG", "QmhqAutoStatus"]
    - path: "components/qmhq/auto-status-badge.tsx"
      provides: "Visual badge component for auto status display"
      exports: ["AutoStatusBadge"]
  key_links:
    - from: "components/qmhq/auto-status-badge.tsx"
      to: "lib/utils/qmhq-auto-status.ts"
      via: "import computeQmhqAutoStatus and config"
      pattern: "import.*qmhq-auto-status"
---

<objective>
Create the QMHQ auto status computation utility and badge component.

Purpose: Establish the core logic that derives auto status from child record state for all three route types (Item, Expense, PO), plus the visual badge component that displays it.
Output: `lib/utils/qmhq-auto-status.ts` (computation + config) and `components/qmhq/auto-status-badge.tsx` (display component)
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-qmhq-auto-status/63-CONTEXT.md

@lib/utils/po-status.ts
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auto status computation utility</name>
  <files>lib/utils/qmhq-auto-status.ts</files>
  <action>
Create `lib/utils/qmhq-auto-status.ts` with the following:

1. **Type definition** `QmhqAutoStatus` as a union of 9 string literals:
   `"item_pending" | "item_processing" | "item_done" | "expense_pending" | "expense_processing" | "expense_done" | "po_pending" | "po_processing" | "po_done"`

2. **Config object** `QMHQ_AUTO_STATUS_CONFIG` keyed by `QmhqAutoStatus`, each entry containing:
   - `label`: Display name (e.g., "Item Pending", "Expense Done", "PO Processing")
   - `color`: Tailwind text color class — Pending = "text-amber-400", Processing = "text-blue-400", Done = "text-emerald-400"
   - `bgColor`: Background — Pending = "bg-amber-500/10", Processing = "bg-blue-500/10", Done = "bg-emerald-500/10"
   - `borderColor`: Border — Pending = "border-amber-500/30", Processing = "border-blue-500/30", Done = "border-emerald-500/30"
   - `iconName`: For route type — Item = "Package", Expense = "Wallet", PO = "ShoppingCart" (matching lucide-react icons used in routeConfig on the QMHQ detail page)

3. **Main function** `computeQmhqAutoStatus(params)` that returns `QmhqAutoStatus`. Accept a single params object:

```typescript
interface AutoStatusParams {
  routeType: "item" | "expense" | "po";
  // Item route fields
  hasAnySorApproval?: boolean;      // any L1 or L2 approval exists
  allSorLineItemsExecuted?: boolean; // every SOR line item is fully executed
  // Expense route fields
  hasAnyMoneyIn?: boolean;           // any non-voided money_in transaction exists
  yetToReceiveEusd?: number;         // amount_eusd - total_money_in_eusd
  // PO route fields
  hasNonCancelledPO?: boolean;       // any PO with status != 'cancelled' exists
  yetToReceivePOEusd?: number;       // amount_eusd - total_money_in_eusd (same calc)
  balanceInHandEusd?: number;        // total_money_in_eusd - total_po_committed_eusd
}
```

Logic per route type:

**Item route:**
- If `allSorLineItemsExecuted` === true -> `"item_done"`
- Else if `hasAnySorApproval` === true -> `"item_processing"`
- Else -> `"item_pending"`

**Expense route:**
- If `yetToReceiveEusd` is defined AND `yetToReceiveEusd` <= 0 -> `"expense_done"`
- Else if `hasAnyMoneyIn` === true -> `"expense_processing"`
- Else -> `"expense_pending"`

**PO route:**
- If `yetToReceivePOEusd` is defined AND `yetToReceivePOEusd` <= 0 AND `balanceInHandEusd` is defined AND `balanceInHandEusd` <= 0 -> `"po_done"`
- Else if `hasNonCancelledPO` === true -> `"po_processing"`
- Else -> `"po_pending"`

4. **Helper function** `getAutoStatusHexColor(status: QmhqAutoStatus): string` returning hex values:
   - Pending = "#f59e0b" (amber-500)
   - Processing = "#3b82f6" (blue-500)
   - Done = "#10b981" (emerald-500)

Follow the same JSDoc documentation pattern as `lib/utils/po-status.ts`. Use `RouteType` from `@/types/database` for the routeType parameter type.
  </action>
  <verify>Run `npx tsc --noEmit lib/utils/qmhq-auto-status.ts` (or the project type-check command) to confirm no TypeScript errors. Verify the file exports the expected types, config, and functions.</verify>
  <done>The file exports QmhqAutoStatus type, QMHQ_AUTO_STATUS_CONFIG object with 9 entries, computeQmhqAutoStatus function, and getAutoStatusHexColor function. All 9 auto status values are covered across the 3 route types with correct transition logic.</done>
</task>

<task type="auto">
  <name>Task 2: Create auto status badge component</name>
  <files>components/qmhq/auto-status-badge.tsx</files>
  <action>
Create `components/qmhq/auto-status-badge.tsx` as a client component ("use client").

The component receives auto status data and renders a badge with route type icon + text label.

**Props interface:**
```typescript
interface AutoStatusBadgeProps {
  status: QmhqAutoStatus;
  size?: "sm" | "md";  // default "md"
}
```

**Implementation:**
1. Import `QMHQ_AUTO_STATUS_CONFIG` and `QmhqAutoStatus` from `@/lib/utils/qmhq-auto-status`
2. Import `Package, Wallet, ShoppingCart` from `lucide-react`
3. Create an icon map: `{ Package, Wallet, ShoppingCart }` keyed by the config's `iconName` field
4. Look up the config entry for the given status
5. Render a badge with:
   - Container: `inline-flex items-center gap-1.5 px-2.5 py-1 rounded border` + config bgColor + config borderColor
   - Icon: The resolved lucide icon, sized h-3.5 w-3.5 for md, h-3 w-3 for sm, colored with config color
   - Label: `<span>` with config color class, text-xs font-medium for md, text-[11px] for sm

This follows the same structural pattern as the existing `<POStatusBadge>` and the route type badge in QMHQ detail header (routeConfig object at line ~123 of the detail page).

Do NOT use emojis. Use lucide-react SVG icons only.
  </action>
  <verify>Run `npm run type-check` to confirm no TypeScript errors. Verify the component renders correctly by checking it accepts QmhqAutoStatus values and produces the expected badge markup.</verify>
  <done>AutoStatusBadge component exists, accepts QmhqAutoStatus prop, renders route-type icon + label text with Pending=amber, Processing=blue, Done=green color scheme. Supports sm and md sizes.</done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with no errors
2. `lib/utils/qmhq-auto-status.ts` exports: QmhqAutoStatus, QMHQ_AUTO_STATUS_CONFIG, computeQmhqAutoStatus, getAutoStatusHexColor
3. `components/qmhq/auto-status-badge.tsx` exports: AutoStatusBadge
4. Config covers all 9 auto status values with correct colors (amber/blue/green) and route-type icons (Package/Wallet/ShoppingCart)
</verification>

<success_criteria>
- All 9 auto status states defined and computable
- Badge component renders with icon + label for any QmhqAutoStatus value
- No TypeScript errors
- Follows existing codebase patterns (JSDoc, naming, Tailwind styling)
</success_criteria>

<output>
After completion, create `.planning/phases/63-qmhq-auto-status/63-01-SUMMARY.md`
</output>
