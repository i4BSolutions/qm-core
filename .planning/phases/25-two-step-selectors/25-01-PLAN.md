---
phase: 25-two-step-selectors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/forms/category-item-selector.tsx
autonomous: true

must_haves:
  truths:
    - "Category selector displays searchable dropdown with color dots before category names"
    - "Item selector is disabled until category is selected with helper text visible"
    - "Selecting a category clears any previous item selection and closes dropdown"
    - "Item selector filters to show only items in the selected category"
    - "Items display as 'Name + SKU' format in dropdown"
    - "Both selectors support keyboard navigation (arrow keys, Enter, Escape)"
  artifacts:
    - path: "components/forms/category-item-selector.tsx"
      provides: "Reusable two-step category-then-item selector"
      min_lines: 250
      exports: ["CategoryItemSelector"]
  key_links:
    - from: "components/forms/category-item-selector.tsx"
      to: "@/lib/supabase/client"
      via: "createClient for fetching categories and items"
      pattern: "createClient\\(\\)"
    - from: "components/forms/category-item-selector.tsx"
      to: "@/components/ui/popover"
      via: "Popover, PopoverTrigger, PopoverContent imports"
      pattern: "from.*popover"
---

<objective>
Create a reusable CategoryItemSelector component that implements two-step category-first item selection.

Purpose: Reduce cognitive load when selecting items from large catalogs by first narrowing by category, then selecting from filtered items. This pattern will be used across PO, Invoice, and Inventory pages.

Output: A fully functional `CategoryItemSelector` component in `/components/forms/category-item-selector.tsx` that can be dropped into any form needing item selection.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-two-step-selectors/25-CONTEXT.md
@.planning/phases/25-two-step-selectors/25-RESEARCH.md
@components/forms/inline-create-select.tsx
@components/ui/popover.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryItemSelector component</name>
  <files>components/forms/category-item-selector.tsx</files>
  <action>
Create a new component that implements the two-step category-first item selection pattern.

**Component Props:**
```typescript
interface CategoryItemSelectorProps {
  categoryId: string;
  itemId: string;
  onCategoryChange: (categoryId: string) => void;
  onItemChange: (itemId: string) => void;
  disabled?: boolean;
}
```

**Layout (per user decision):**
- Stacked layout: category dropdown above, item dropdown below
- Both dropdowns are full width
- Space between with helper text under category

**Category Selector Requirements:**
1. Fetch categories with `entity_type = 'item'` and `is_active = true`
2. Filter to only categories that have at least one active item (query items, build Set of category_ids with items)
3. Sort alphabetically A-Z by name
4. Display color dot before category name (use `category.color` with fallback to `#6B7280`)
5. Searchable via Popover with search input (pattern from inline-create-select.tsx)
6. Show check mark on selected item
7. Helper text below: "Selecting a category will filter items below"

**Item Selector Requirements:**
1. Disabled until category is selected (with text "Select category first...")
2. When category selected, fetch items with `category_id = selectedCategoryId` and `is_active = true`
3. Sort alphabetically by name
4. Display as "Name + SKU" (name in slate-200, SKU as amber-400 code element)
5. Inactive items are hidden (not shown grayed out)
6. Empty state when no items: "No items in this category"
7. Search matches both name and SKU

**Behavior (per user decision):**
1. Category change: clear item selection, close category dropdown, reset search
2. Item change: close item dropdown, reset search
3. Search resets when popover closes
4. Search starts immediately on first character (no minimum)
5. Full keyboard support via Radix primitives

**State Management:**
- Categories loaded on mount (prefetch)
- Items loaded when category changes (on-demand)
- Loading states for both fetches
- Search state for each dropdown

**Styling:**
- Match existing patterns from inline-create-select.tsx
- Dark theme: bg-slate-800/50, border-slate-700, hover:border-amber-500/50
- Use Popover with `w-[var(--radix-popover-trigger-width)]` for matching width
  </action>
  <verify>
1. File exists at components/forms/category-item-selector.tsx
2. `npm run type-check` passes
3. Component exports CategoryItemSelector
4. Component imports from @/lib/supabase/client, @/components/ui/popover, @/components/ui/button
  </verify>
  <done>
CategoryItemSelector component exists with:
- Stacked layout with category above item
- Color dots on categories
- Searchable dropdowns for both
- Item disabled until category selected
- Category change clears item
- Items display as Name + SKU
- Empty state message for no items in category
  </done>
</task>

<task type="auto">
  <name>Task 2: Add loading and error states</name>
  <files>components/forms/category-item-selector.tsx</files>
  <action>
Enhance the component with proper loading and error states:

**Loading States (Claude's discretion - using on-demand with visual feedback):**
1. Categories: Show "Loading categories..." in trigger button while fetching on mount
2. Items: Show "Loading items..." in trigger button while fetching after category change
3. Use subtle loading indicator (not blocking spinner)

**Error Handling:**
1. If categories fetch fails, show empty state with message
2. If items fetch fails, show error state in item dropdown
3. Console.error for debugging but don't crash

**Search Clear Button:**
1. Add X button to clear search when text exists
2. Reset search on popover close

**Edge Cases:**
1. Handle case where category has items but they're all inactive (should not show category per user decision)
2. Handle rapid category switching (cancel previous item fetch)
3. Handle unmount during fetch (cleanup)

**Testing the component locally:**
After implementation, the component should be importable and render without errors.
  </action>
  <verify>
1. `npm run type-check` passes
2. `npm run lint` passes (or has no new errors in this file)
3. Component handles loading states gracefully
  </verify>
  <done>
CategoryItemSelector has:
- Loading states for categories and items
- Error handling that doesn't crash
- Search clear buttons
- Proper cleanup on unmount
  </done>
</task>

</tasks>

<verification>
1. Component file exists and exports CategoryItemSelector
2. Type checking passes: `npm run type-check`
3. Linting passes: `npm run lint`
4. Component follows existing patterns from inline-create-select.tsx
5. All user decisions from CONTEXT.md are implemented
</verification>

<success_criteria>
- CategoryItemSelector component is created and type-safe
- Implements stacked layout with category above item
- Categories show color dots and are sorted A-Z
- Empty categories (no active items) are hidden
- Item selector disabled until category selected
- Category change clears item selection
- Both selectors are searchable (items match name + SKU)
- Items display as "Name + SKU" format
- Empty state shows "No items in this category"
- Loading states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/25-two-step-selectors/25-01-SUMMARY.md`
</output>
