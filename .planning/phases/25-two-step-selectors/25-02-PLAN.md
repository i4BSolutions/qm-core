---
phase: 25-two-step-selectors
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - components/po/po-line-items-table.tsx
  - app/(dashboard)/inventory/stock-in/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
  - app/(dashboard)/po/new/page.tsx
autonomous: false

must_haves:
  truths:
    - "PO line item creation uses category-first then item selection"
    - "Stock-in manual mode uses category-first then item selection"
    - "Stock-out page uses category-first then item selection"
    - "All integrations maintain existing functionality after adding two-step selector"
    - "User can successfully create PO line items with category-item workflow"
  artifacts:
    - path: "components/po/po-line-items-table.tsx"
      provides: "Updated line items table with CategoryItemSelector"
      contains: "CategoryItemSelector"
    - path: "app/(dashboard)/inventory/stock-in/page.tsx"
      provides: "Updated stock-in with CategoryItemSelector for manual mode"
      contains: "CategoryItemSelector"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Updated stock-out with CategoryItemSelector"
      contains: "CategoryItemSelector"
  key_links:
    - from: "components/po/po-line-items-table.tsx"
      to: "components/forms/category-item-selector.tsx"
      via: "import and usage in editable mode"
      pattern: "import.*CategoryItemSelector"
    - from: "app/(dashboard)/inventory/stock-in/page.tsx"
      to: "components/forms/category-item-selector.tsx"
      via: "import and usage in manual mode"
      pattern: "import.*CategoryItemSelector"
---

<objective>
Integrate the CategoryItemSelector component into all item selection locations across the application.

Purpose: Replace flat item dropdowns with category-first filtering to reduce complexity when selecting items from large catalogs. Per user decision, this pattern applies to ALL item selectors across the app.

Output: Updated PO line items table, stock-in page (manual mode), and stock-out page all using the two-step category-item selection pattern.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-two-step-selectors/25-CONTEXT.md
@.planning/phases/25-two-step-selectors/25-01-SUMMARY.md
@components/forms/category-item-selector.tsx
@components/po/po-line-items-table.tsx
@app/(dashboard)/po/new/page.tsx
@app/(dashboard)/inventory/stock-in/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PO line items table</name>
  <files>components/po/po-line-items-table.tsx, app/(dashboard)/po/new/page.tsx</files>
  <action>
Replace the current flat item Select in EditableLineItemsTable with CategoryItemSelector.

**Changes to po-line-items-table.tsx:**

1. Add import at top:
```typescript
import { CategoryItemSelector } from "@/components/forms/category-item-selector";
```

2. Update LineItemFormData interface to include category_id:
```typescript
interface LineItemFormData {
  id: string;
  category_id: string | null;  // ADD THIS
  item_id: string | null;
  item_name: string;
  item_sku?: string;
  item_unit?: string;
  item_price_reference?: string;
  quantity: number;
  unit_price: number;
}
```

3. Replace the current item Select with CategoryItemSelector in the table cell where `!item.item_id`:
```tsx
<CategoryItemSelector
  categoryId={item.category_id || ""}
  itemId=""
  onCategoryChange={(catId) => {
    onUpdateItem(item.id, "category_id", catId);
  }}
  onItemChange={(itmId) => {
    // Need to fetch item details - use availableItems prop
    const selectedItem = availableItems.find(i => i.id === itmId);
    if (selectedItem) {
      onUpdateItem(item.id, "item_id", itmId);
      onUpdateItem(item.id, "item_name", selectedItem.name);
      onUpdateItem(item.id, "item_sku", selectedItem.sku || "");
      onUpdateItem(item.id, "item_unit", selectedItem.default_unit || "");
      onUpdateItem(item.id, "item_price_reference", selectedItem.price_reference || "");
    }
  }}
  disabled={disabled}
/>
```

4. Keep the "Change" button functionality - when clicked, it clears item_id AND category_id:
```typescript
onUpdateItem(item.id, "item_id", null);
onUpdateItem(item.id, "category_id", null);  // ADD THIS
// ... rest of clears
```

5. Keep the [+] inline create button for creating new items.

**Changes to po/new/page.tsx:**

1. Update the LineItemFormData type definition to include category_id:
```typescript
interface LineItemFormData {
  id: string;
  category_id: string | null;  // ADD THIS
  item_id: string | null;
  // ... rest
}
```

2. Update handleAddLineItem to include category_id:
```typescript
{ id: crypto.randomUUID(), category_id: null, item_id: null, item_name: "", quantity: 1, unit_price: 0 }
```

**Important:** The availableItems prop is still passed to the table but will only be used to look up item details after selection. The CategoryItemSelector handles its own data fetching.

**Column width:** Increase min-width from 200px to 280px to accommodate the stacked layout.
  </action>
  <verify>
1. `npm run type-check` passes
2. `npm run lint` passes
3. PO create page still loads without errors
4. Line items table renders CategoryItemSelector for new items
  </verify>
  <done>
PO line items table uses CategoryItemSelector:
- Category selector appears above item selector in table cell
- Selecting category enables item dropdown
- Item selection populates all item fields
- "Change" button clears both category and item
  </done>
</task>

<task type="auto">
  <name>Task 2: Update stock-in manual mode and stock-out page</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx, app/(dashboard)/inventory/stock-out/page.tsx</files>
  <action>
Replace flat item selects with CategoryItemSelector in both inventory pages.

**Changes to stock-in/page.tsx (Manual Mode section):**

1. Add import:
```typescript
import { CategoryItemSelector } from "@/components/forms/category-item-selector";
```

2. Add state for manual category:
```typescript
const [manualCategoryId, setManualCategoryId] = useState("");
```

3. Replace the manual item Select (currently around line 400-450 in manual mode section) with CategoryItemSelector:
```tsx
<CategoryItemSelector
  categoryId={manualCategoryId}
  itemId={manualItemId}
  onCategoryChange={(catId) => {
    setManualCategoryId(catId);
    setManualItemId("");  // Clear item when category changes
  }}
  onItemChange={(itmId) => {
    setManualItemId(itmId);
  }}
  disabled={isSubmitting}
/>
```

4. Clear category when switching away from manual mode:
```typescript
// In the mode switch handler or useEffect
setManualCategoryId("");
```

**Changes to stock-out/page.tsx:**

1. Add import:
```typescript
import { CategoryItemSelector } from "@/components/forms/category-item-selector";
```

2. Add state for category:
```typescript
const [selectedCategoryId, setSelectedCategoryId] = useState("");
```

3. Replace the item Select (currently in the form section) with CategoryItemSelector:
```tsx
<CategoryItemSelector
  categoryId={selectedCategoryId}
  itemId={selectedItemId}
  onCategoryChange={(catId) => {
    setSelectedCategoryId(catId);
    setSelectedItemId("");  // Clear item when category changes
    setItemWarehouses([]);  // Also clear warehouse stock info
  }}
  onItemChange={(itmId) => {
    setSelectedItemId(itmId);
  }}
  disabled={isSubmitting}
/>
```

4. Keep the existing item selection side effects (fetching warehouse stock when item changes).

**Layout considerations:**
- Both pages have form layouts with label above input
- CategoryItemSelector is self-contained with its own labels/helper text
- May need to adjust surrounding layout to accommodate stacked selectors
  </action>
  <verify>
1. `npm run type-check` passes
2. `npm run lint` passes
3. Stock-in page loads without errors in manual mode
4. Stock-out page loads without errors
5. Both pages show CategoryItemSelector for item selection
  </verify>
  <done>
Inventory pages use CategoryItemSelector:
- Stock-in manual mode has category-first item selection
- Stock-out has category-first item selection
- Category changes clear item selection in both
- Existing functionality (warehouse stock lookup, etc.) preserved
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify two-step selector integration</name>
  <what-built>
Two-step category-item selector integrated across all item selection locations:
1. PO line items creation
2. Stock-in manual mode
3. Stock-out item selection
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`

2. **Test PO Creation:**
   - Navigate to /po/new
   - Select a QMHQ with balance
   - In Line Items section, observe the new row has two dropdowns (category above, item below)
   - Click category dropdown - verify:
     - Categories show color dots
     - Categories are searchable
     - Only categories with items appear
   - Select a category - verify:
     - Item dropdown becomes enabled
     - Helper text visible under category
   - Click item dropdown - verify:
     - Only items from selected category appear
     - Items show "Name + SKU" format
     - Items are searchable
   - Select an item - verify:
     - Item row populates correctly (name, SKU, unit visible)
   - Click "Change" button - verify:
     - Both category and item are cleared
     - Selector returns to initial state

3. **Test Stock-In (Manual Mode):**
   - Navigate to /inventory/stock-in
   - Switch to Manual mode if not already
   - Observe category-item selector
   - Select category then item
   - Verify item details appear correctly

4. **Test Stock-Out:**
   - Navigate to /inventory/stock-out
   - Observe category-item selector
   - Select category then item
   - Verify warehouse stock info loads for selected item

5. **Test Edge Cases:**
   - Search for item by SKU - should find it
   - Change category after selecting item - item should clear
   - Select category with only one item - should show that item
  </how-to-verify>
  <resume-signal>
Type "approved" if all verifications pass, or describe specific issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. All files updated with CategoryItemSelector import and usage
2. Type checking passes: `npm run type-check`
3. Linting passes: `npm run lint`
4. Dev server starts without errors: `npm run dev`
5. All three integration points work correctly
6. Existing functionality preserved (PO submission, stock-in, stock-out)
</verification>

<success_criteria>
- PO line items use category-first item selection
- Stock-in manual mode uses category-first item selection
- Stock-out uses category-first item selection
- Category change clears item selection in all locations
- Existing form submissions still work correctly
- User can create PO line items with the new workflow
- Human verification confirms all integrations work
</success_criteria>

<output>
After completion, create `.planning/phases/25-two-step-selectors/25-02-SUMMARY.md`
</output>
