---
phase: 56-list-view-standardization
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - app/(dashboard)/qmhq/page.tsx
  - app/(dashboard)/po/page.tsx
  - app/(dashboard)/invoice/page.tsx
  - app/(dashboard)/item/page.tsx
autonomous: true
requirements:
  - LIST-02
  - LIST-03
  - LIST-04
  - LIST-05
  - PAGE-02

must_haves:
  truths:
    - "QMHQ list view shows columns: ID, Name, Route, Status, Assigned Person (avatar), QMRL Ref"
    - "PO list view shows columns: PO ID, Supplier, Status, Total Amount/EUSD, Progress, Date"
    - "Invoice list view shows columns: INV ID, Status, Amount/EUSD, Received %, Date, PO Ref"
    - "Items page has card/list toggle with list view showing SKU, Name, Category, Unit, Price Ref"
    - "QMHQ, PO, Invoice, and Items pages all have an assigned person filter"
    - "QMHQ assigned column shows avatar-only with tooltip"
    - "All 4 pages use URL-driven pagination via usePaginationParams"
    - "View toggle is inside the FilterBar (toolbar) on all 4 pages, not in PageHeader actions"
    - "Status badges in list views use colored background + white text"
    - "All row clicks use router.push (not window.location.href)"
  artifacts:
    - path: "app/(dashboard)/qmhq/page.tsx"
      provides: "QMHQ list page with assigned filter, avatar column, URL pagination, toolbar toggle"
      min_lines: 350
    - path: "app/(dashboard)/po/page.tsx"
      provides: "PO list page with assigned filter (via QMHQ join), URL pagination, toolbar toggle"
      min_lines: 350
    - path: "app/(dashboard)/invoice/page.tsx"
      provides: "Invoice list page with assigned filter (via created_by), URL pagination, toolbar toggle"
      min_lines: 350
    - path: "app/(dashboard)/item/page.tsx"
      provides: "Items page with card/list toggle, FilterBar toolbar, card view, URL pagination"
      min_lines: 200
  key_links:
    - from: "app/(dashboard)/qmhq/page.tsx"
      to: "lib/hooks/use-pagination-params.ts"
      via: "import usePaginationParams"
      pattern: "usePaginationParams"
    - from: "app/(dashboard)/po/page.tsx"
      to: "lib/hooks/use-pagination-params.ts"
      via: "import usePaginationParams"
      pattern: "usePaginationParams"
    - from: "app/(dashboard)/invoice/page.tsx"
      to: "lib/hooks/use-pagination-params.ts"
      via: "import usePaginationParams"
      pattern: "usePaginationParams"
    - from: "app/(dashboard)/item/page.tsx"
      to: "lib/hooks/use-pagination-params.ts"
      via: "import usePaginationParams"
      pattern: "usePaginationParams"
    - from: "app/(dashboard)/qmhq/page.tsx"
      to: "components/ui/user-avatar.tsx"
      via: "UserAvatar in assigned column and filter dropdown"
      pattern: "UserAvatar"
---

<objective>
Apply the standardized list view pattern (established in Plan 01) to QMHQ, PO, Invoice, and Items pages. Each page gets URL-driven pagination, an assigned person filter with avatar+name dropdown, the view toggle moved into the FilterBar, status badges with colored backgrounds, router.push for navigation, and responsive behavior.

Purpose: These 4 pages follow the same pattern as QMRL but each has unique column requirements and data model differences (PO has no assigned_to, Invoice uses created_by, Items has no person field). This plan standardizes them all while respecting each page's data model.

Output: Updated QMHQ, PO, Invoice, and Items pages with consistent toolbar layout, URL pagination, assigned person filters, and responsive behavior.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-list-view-standardization/56-CONTEXT.md
@.planning/phases/56-list-view-standardization/56-RESEARCH.md
@.planning/phases/56-list-view-standardization/56-01-SUMMARY.md
@app/(dashboard)/qmhq/page.tsx
@app/(dashboard)/po/page.tsx
@app/(dashboard)/invoice/page.tsx
@app/(dashboard)/item/page.tsx
@lib/hooks/use-pagination-params.ts
@components/ui/user-avatar.tsx
@components/ui/pagination.tsx
@components/composite/filter-bar.tsx
@components/ui/tooltip.tsx
@components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standardize QMHQ and PO pages with assigned filter, URL pagination, and toolbar toggle</name>
  <files>app/(dashboard)/qmhq/page.tsx, app/(dashboard)/po/page.tsx</files>
  <action>
**QMHQ page (`app/(dashboard)/qmhq/page.tsx`):**

Apply the same standardization pattern from QMRL (Plan 01). Keep ALL existing card view, list view, and data fetching logic. Make these targeted changes:

1. **Replace pagination state with `usePaginationParams(20)`:**
   - Remove `useState` for `currentPage` and `pageSize`
   - Remove `handlePageSizeChange`
   - Remove the `useEffect` that resets page on filter change
   - Import and use: `const { page: currentPage, pageSize, setPage: setCurrentPage, setPageSize } = usePaginationParams(20);`
   - Wrap every filter onChange to also call `setCurrentPage(1)`

2. **Add assigned person filter:**
   - Add `users` state: `const [users, setUsers] = useState<UserType[]>([]);`
   - Add `assignedFilter` state: `const [assignedFilter, setAssignedFilter] = useState<string>("all");`
   - Import `UserType` as `User as UserType` from `@/types/database`
   - Fetch users in `fetchData`: add to the `Promise.all` array:
     ```typescript
     supabase.from("users").select("id, full_name").eq("is_active", true).order("full_name")
     ```
   - Add users query error check and `setUsers` call
   - Add assigned filter to `filteredQmhqs`:
     ```typescript
     if (assignedFilter !== "all" && qmhq.assigned_to !== assignedFilter) return false;
     ```
   - Add the filter-resets-page for assignedFilter

3. **Add assigned person filter dropdown with avatar+name (raw Shadcn Select, not FilterBar.Select):**
   - Position after status filter in the FilterBar
   - Use `UserAvatar` size 20 in dropdown options
   - Import `UserAvatar` from `@/components/ui/user-avatar`

4. **Move card/list toggle from PageHeader.actions INTO FilterBar:**
   - Remove toggle from PageHeader.actions (keep only the "New QMHQ" button there)
   - Add toggle as last child of FilterBar with `ml-auto`
   - Same styling as QMRL Plan 01

5. **Update list view assigned column to avatar-only with tooltip:**
   - Replace the text `qmhq.assigned_user?.full_name || "â€”"` with UserAvatar + Tooltip pattern
   - Import `Tooltip, TooltipProvider, TooltipTrigger, TooltipContent` from `@/components/ui/tooltip`

6. **Update status badge in list view to colored background + white text:**
   - Change from `variant="outline"` with `borderColor`/`color` style to:
     ```tsx
     <Badge className="text-xs text-white" style={{ backgroundColor: qmhq.status.color || "#94a3b8", border: "none" }}>
       {qmhq.status.name}
     </Badge>
     ```

7. **Replace `window.location.href` with `router.push` in list view row click:**
   - Import `useRouter` from `next/navigation`
   - `onClick={() => router.push(`/qmhq/${qmhq.id}`)}`

8. **Add responsive behavior:**
   - Auto-switch to card view below md breakpoint (same useEffect as QMRL)
   - Wrap filter dropdowns in `hidden md:flex`, add mobile Popover (same pattern as QMRL)
   - Import Popover and SlidersHorizontal

9. **Verify QMHQ list view columns match LIST-02:** ID, Name, Route, Status, Assigned Person, QMRL Ref
   - Current columns: ID, Name, Route, Parent QMRL, Amount (EUSD), Status, Assigned
   - Keep all existing columns but ensure the required ones are present. The existing columns already satisfy LIST-02 plus show Amount. That is fine.

---

**PO page (`app/(dashboard)/po/page.tsx`):**

Apply the same standardization pattern. Keep ALL existing card view, list view, and data fetching logic.

1. **Replace pagination state with `usePaginationParams(20)`:**
   - Same pattern as QMHQ above

2. **Add assigned person filter (via QMHQ join):**
   - PO has no `assigned_to`. The PO query already joins QMHQ. Extend the QMHQ join to include assigned_to user:
     Update the PO query's QMHQ join from:
     ```
     qmhq:qmhq!purchase_orders_qmhq_id_fkey(id, request_id, line_name)
     ```
     to:
     ```
     qmhq:qmhq!purchase_orders_qmhq_id_fkey(id, request_id, line_name, assigned_to, assigned_user:users!qmhq_assigned_to_fkey(id, full_name))
     ```
   - Update `POWithRelations.qmhq` type to include `assigned_to?: string | null` and `assigned_user?: { id: string; full_name: string } | null`
   - Add `users` state and fetch users for the dropdown
   - Add `assignedFilter` state and filter logic:
     ```typescript
     if (assignedFilter !== "all" && po.qmhq?.assigned_to !== assignedFilter) return false;
     ```
   - Add assigned person dropdown (avatar+name) in FilterBar, after supplier filter

3. **Move card/list toggle from PageHeader.actions INTO FilterBar:**
   - Remove toggle from PageHeader.actions (keep "New PO" button)
   - Add toggle in FilterBar with `ml-auto`

4. **Replace `window.location.href` with `router.push` in list view row click:**
   - `onClick={() => router.push(`/po/${po.id}`)}`

5. **Add responsive behavior:**
   - Auto-switch to card view below md breakpoint
   - Filter collapse on narrow screens

6. **Verify PO list view columns match LIST-03:** PO ID, Supplier, Status, Total Amount/EUSD, Progress, Date
   - Current columns: PO#, Supplier, QMHQ, Amount (EUSD), Status, Date. Status already has progress bar.
   - This already satisfies LIST-03. No column changes needed, just the standardization changes above.

7. **Note:** LIST-03 does NOT specify an Assigned Person column, so do NOT add one to the PO list view table rows. The assigned filter only filters the data; it does not require a visible column.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no TypeScript errors.
2. Run `npm run build` to verify both pages build.
3. Test QMHQ at `/qmhq`:
   - Toggle is in toolbar, not PageHeader
   - Assigned person filter shows avatar+name options
   - List view assigned column shows avatar with tooltip
   - Status badges have colored background + white text
   - URL pagination works
   - Row clicks don't cause full page reload
4. Test PO at `/po`:
   - Assigned person filter works (filters by QMHQ's assigned user)
   - Toggle in toolbar
   - URL pagination works
   - Row clicks use router.push
  </verify>
  <done>QMHQ page has assigned filter with avatars, avatar-only assigned column with tooltip, toolbar toggle, URL pagination, colored status badges, router.push navigation, and responsive behavior. PO page has assigned filter via QMHQ join, toolbar toggle, URL pagination, router.push, and responsive behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Standardize Invoice and Items pages with assigned filter, URL pagination, and toolbar toggle</name>
  <files>app/(dashboard)/invoice/page.tsx, app/(dashboard)/item/page.tsx</files>
  <action>
**Invoice page (`app/(dashboard)/invoice/page.tsx`):**

Apply standardization pattern. Keep ALL existing card view, list view, and data fetching logic.

1. **Replace pagination state with `usePaginationParams(20)`:**
   - Same replacement pattern as other pages
   - Ensure `showVoided` filter also resets page: wrap with `setCurrentPage(1)`

2. **Add assigned person filter (use `created_by` field):**
   - Invoice has no `assigned_to`. Use `created_by` as the practical person field.
   - Add creator join to invoice query:
     ```
     creator:users!invoices_created_by_fkey(id, full_name)
     ```
   - Update `InvoiceWithRelations` interface to include `creator?: { id: string; full_name: string } | null`
   - Add `users` state and fetch users for dropdown
   - Add `assignedFilter` state and filter logic:
     ```typescript
     if (assignedFilter !== "all" && inv.created_by !== assignedFilter) return false;
     ```
   - Add assigned person dropdown (avatar+name, raw Shadcn Select) in FilterBar after status filter, before the show-voided toggle

3. **Move card/list toggle from PageHeader.actions INTO FilterBar:**
   - Remove toggle from PageHeader.actions (keep "New Invoice" button)
   - Add toggle in FilterBar with `ml-auto`

4. **Replace `window.location.href` with `router.push` in list view row click**

5. **Add responsive behavior** (auto-switch + filter collapse)

6. **Verify Invoice list view columns match LIST-04:** INV ID, Status, Amount/EUSD, Received %, Date, PO Ref
   - Current columns: Invoice#, Supplier Ref, PO#, Supplier, Amount (EUSD), Status, Date
   - These already satisfy LIST-04 and show more. No column removal needed.

7. **Note:** LIST-04 does NOT specify an Assigned Person column, so do NOT add one to the Invoice list view table rows. The filter only filters data.

---

**Items page (`app/(dashboard)/item/page.tsx`):**

This is the biggest change -- Items currently uses TanStack DataTable with no card view. Replace with the standardized pattern.

1. **Replace TanStack DataTable with manual card/list views:**
   - Remove `DataTable` and `DataTableColumnHeader` imports
   - Remove `ColumnDef` import and the `columns` definition
   - Remove the DataTable render
   - Keep the existing data fetching, dialog, error handling, and edit/delete logic

2. **Add viewMode state (default "card" per user decision):**
   - `const [viewMode, setViewMode] = useState<"card" | "list">("card");`

3. **Add FilterBar toolbar with search, category filter, and toggle:**
   - Import `FilterBar` from `@/components/composite`
   - Add `searchQuery` state, `categoryFilter` state
   - Fetch categories for filter:
     ```typescript
     supabase.from("categories").select("id, name, color").eq("entity_type", "item").eq("is_active", true).order("display_order")
     ```
     If items do not have entity_type "item" for categories, check the actual data model. Items have `category_id` linking to `categories` table. Fetch all active categories for the filter dropdown. Check existing query -- Items are not entity-type-specific for categories. Fetch categories used by items:
     ```typescript
     supabase.from("categories").select("id, name, color").eq("is_active", true).order("name")
     ```
   - Add `usePaginationParams(20)` for URL pagination
   - Items have NO person association. Per research, skip the assigned person filter on Items page. The FilterBar shows: Search | Category filter | [toggle]
   - Add `ml-auto` toggle in FilterBar

4. **Add client-side filtering and pagination:**
   - Filter items by search (match name, sku) and category
   - Paginate with `usePaginationParams`
   - Wrap Pagination component below the content

5. **Build card view for Items:**
   - Show in grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
   - Each card is a `command-panel` div with: photo thumbnail (or placeholder icon), SKU badge, item name, category colored badge, unit name, price reference
   - Make entire card clickable to `/item/[id]` using `router.push`
   - Keep the edit/delete actions -- add a small dropdown menu on the card OR navigate to detail page and edit from there. Simplest: card click goes to detail, the edit/delete dialog stays triggered from the ItemDialog. For cards, just show the item info and link to detail.

6. **Build list view for Items:**
   - Columns per LIST-05: SKU, Name, Category, Unit, Price Ref
   - Optionally keep the Photo column (small thumbnail) as the first column for visual identification
   - Table structure matches codebase pattern (command-panel, standard thead/tbody)
   - Row click: `router.push(`/item/${item.id}`)`
   - Add edit/delete dropdown in last column (keep existing DropdownMenu pattern)

7. **Add responsive behavior** (auto-switch + filter collapse)

8. **Keep ItemDialog** -- the dialog for create/edit remains. The "Add Item" button stays in PageHeader.actions (calling `handleCreate`).
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no TypeScript errors.
2. Run `npm run build` to verify both pages build.
3. Test Invoice at `/invoice`:
   - Assigned person filter works (filters by creator)
   - Toggle in toolbar
   - URL pagination works
   - Row clicks use router.push
4. Test Items at `/item`:
   - Default view is card with item cards showing photo/SKU/name/category
   - Toggle switches to list view with SKU, Name, Category, Unit, Price Ref columns
   - Category filter works
   - Search works
   - URL pagination works
   - Edit/delete functionality still works
   - Responsive: auto-switch to card below md
  </verify>
  <done>Invoice page has assigned person filter (via created_by), toolbar toggle, URL pagination, router.push, and responsive behavior. Items page is rebuilt from DataTable to card/list toggle pattern with FilterBar toolbar, card view grid, list view table (SKU, Name, Category, Unit, Price Ref), URL pagination, category filter, and responsive behavior. No assigned person filter on Items (no person field in data model).</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` completes successfully
- QMHQ list view columns match LIST-02
- PO list view columns match LIST-03
- Invoice list view columns match LIST-04
- Items list view columns match LIST-05
- All 4 pages have assigned person filter (except Items which has no person field)
- All 4 pages have URL-driven pagination
- All 4 pages have card/list toggle in FilterBar
- All list view status badges use colored background + white text
- All row clicks use router.push
- Responsive behavior works on all 4 pages
</verification>

<success_criteria>
- QMHQ page: assigned filter with avatar, avatar column with tooltip, toggle in toolbar, URL pagination
- PO page: assigned filter via QMHQ join, toggle in toolbar, URL pagination
- Invoice page: assigned filter via created_by, toggle in toolbar, URL pagination
- Items page: card/list toggle, FilterBar, card view, list view with LIST-05 columns, URL pagination, no assigned filter
- All pages: responsive auto-switch and filter collapse, router.push for navigation, colored status badges
</success_criteria>

<output>
After completion, create `.planning/phases/56-list-view-standardization/56-02-SUMMARY.md`
</output>
