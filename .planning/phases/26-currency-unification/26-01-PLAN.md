---
phase: 26-currency-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/transaction-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Money-in currency field shows QMHQ currency and is locked (disabled)"
    - "Money-out currency field shows QMHQ currency and is locked (disabled)"
    - "Exchange rate defaults from QMHQ but remains editable"
    - "Money-out form displays current balance in hand"
    - "Submitting money-out exceeding balance shows warning toast but allows submission"
  artifacts:
    - path: "components/qmhq/transaction-dialog.tsx"
      provides: "Currency inheritance and balance validation"
      contains: "Lock"
  key_links:
    - from: "components/qmhq/transaction-dialog.tsx"
      to: "supabase qmhq table"
      via: "fetch on dialog open"
      pattern: "from\\(['\"]qmhq['\"]\\)"
---

<objective>
Implement currency inheritance for TransactionDialog - money-in/out transactions inherit locked currency from parent QMHQ with balance validation warning.

Purpose: Ensures currency consistency across QMHQ financial transactions and warns users when money-out exceeds available balance.
Output: Updated TransactionDialog with locked currency field, balance display, and soft validation warning.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-currency-unification/26-CONTEXT.md
@.planning/phases/26-currency-unification/26-RESEARCH.md
@components/qmhq/transaction-dialog.tsx
@app/(dashboard)/qmhq/new/page.tsx (lock icon pattern reference, lines 350-384)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QMHQ data fetch and locked currency field</name>
  <files>components/qmhq/transaction-dialog.tsx</files>
  <action>
Modify TransactionDialog to fetch QMHQ data and lock currency:

1. Add state for QMHQ data:
```typescript
const [qmhqData, setQmhqData] = useState<{
  currency: string;
  exchange_rate: number;
  balance_in_hand: number;
} | null>(null);
const [isLoadingQmhq, setIsLoadingQmhq] = useState(false);
```

2. Add useEffect to fetch QMHQ data when dialog opens:
```typescript
useEffect(() => {
  if (open && qmhqId) {
    const fetchQmhqData = async () => {
      setIsLoadingQmhq(true);
      const supabase = createClient();
      const { data } = await supabase
        .from('qmhq')
        .select('currency, exchange_rate, balance_in_hand')
        .eq('id', qmhqId)
        .single();

      if (data) {
        setQmhqData(data);
        setCurrency(data.currency || 'MMK');
        setExchangeRate(String(data.exchange_rate || 1));
      }
      setIsLoadingQmhq(false);
    };
    fetchQmhqData();
  }
}, [open, qmhqId]);
```

3. Import Lock icon from lucide-react (add to existing imports)

4. Update currency Select to be locked with visual indicator:
- Add Lock icon + "Inherited" badge next to label (per locked decision)
- Add `disabled={true}` to Select
- Add `opacity-70 cursor-not-allowed` to SelectTrigger
- Add helper text: "Currency is set by the parent QMHQ"

Pattern reference from qmhq/new/page.tsx lines 350-384:
```typescript
<Label htmlFor="currency" className="text-slate-300 flex items-center gap-2">
  Currency
  <span className="flex items-center gap-1 text-xs text-amber-500 font-normal">
    <Lock className="h-3 w-3" />
    Inherited
  </span>
</Label>
<Select value={currency} onValueChange={() => {}} disabled={true}>
  <SelectTrigger className="bg-slate-800/50 border-slate-700 opacity-70 cursor-not-allowed">
    <SelectValue />
  </SelectTrigger>
  ...
</Select>
<p className="text-xs text-slate-400">Currency is set by the parent QMHQ</p>
```

5. Update resetForm to also reset qmhqData:
```typescript
const resetForm = () => {
  // existing resets...
  setQmhqData(null);
};
```
  </action>
  <verify>
1. `npm run build` passes
2. Open transaction dialog on QMHQ detail page
3. Currency field shows lock icon + "Inherited" badge
4. Currency dropdown is disabled (cannot change)
5. Exchange rate defaults from QMHQ value
  </verify>
  <done>
Currency field is locked with Lock icon and "Inherited" badge, exchange rate defaults from QMHQ, both money-in and money-out show inherited currency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add balance display and validation warning</name>
  <files>components/qmhq/transaction-dialog.tsx</files>
  <action>
Add balance display for money-out and validation warning on submit:

1. Add balance display section that shows only for money_out transactions:
```typescript
{/* Balance Display - Money Out only */}
{transactionType === "money_out" && qmhqData && (
  <div className="p-3 rounded-lg bg-slate-800/30 border border-slate-700">
    <div className="flex items-center justify-between">
      <span className="text-sm text-slate-400">Available Balance</span>
      <span className="text-lg font-mono text-purple-400">
        {formatCurrency(qmhqData.balance_in_hand ?? 0)} EUSD
      </span>
    </div>
    <p className="text-xs text-slate-500 mt-1">
      Current Balance in Hand from money received
    </p>
  </div>
)}
```

Place this section after the EUSD Calculation box (around line 378) and before Transaction Date.

2. Update handleSubmit to add balance warning for money-out:
```typescript
const handleSubmit = async () => {
  // Existing amount validation...
  // Existing exchange rate validation...

  // Balance warning for money-out (per user decision: warning only, not block)
  if (transactionType === 'money_out' && qmhqData) {
    const availableBalance = qmhqData.balance_in_hand ?? 0;
    if (calculatedEusd > availableBalance) {
      const excessAmount = Math.round((calculatedEusd - availableBalance) * 100) / 100;
      const formattedAvailable = Math.round(availableBalance * 100) / 100;

      toast({
        title: "Balance Warning",
        description: `Amount exceeds balance by ${formatCurrency(excessAmount)} EUSD (Available: ${formatCurrency(formattedAvailable)} EUSD)`,
        variant: "warning",
      });
      // Note: Intentionally NOT returning - per user decision, this is a warning, not a block
    }
  }

  setIsSubmitting(true);
  // ... rest of existing submit logic
};
```

3. Ensure toast has "warning" variant (amber color). If "warning" variant doesn't exist in the toast system, use a custom approach:
```typescript
// Check toast system - if no warning variant, create appropriate styling
toast({
  title: "Balance Warning",
  description: `...`,
  variant: "warning", // Should show amber, not red
});
```
  </action>
  <verify>
1. `npm run build` passes
2. Open transaction dialog, select Money Out
3. "Available Balance" section appears showing current balance
4. Enter amount exceeding balance
5. Click submit - warning toast appears with amber color and message format "Amount exceeds balance by X EUSD (Available: Y EUSD)"
6. Transaction still submits successfully (warning, not block)
  </verify>
  <done>
Money-out form shows static balance display, submitting amount exceeding balance shows warning toast with correct message format, transaction still proceeds (soft validation per user decision).
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Manual testing:
   - Open QMHQ detail page (expense or po route)
   - Click "Add Transaction"
   - Verify currency field shows Lock icon + "Inherited" badge
   - Verify currency dropdown is disabled
   - Verify exchange rate defaults from QMHQ
   - Select Money Out (for expense route)
   - Verify "Available Balance" section appears
   - Enter amount greater than balance
   - Submit - verify warning toast appears with amber styling
   - Verify transaction is created despite warning
</verification>

<success_criteria>
- Currency field locked with Lock + "Inherited" indicator (CURR-01)
- Exchange rate defaults from QMHQ (CURR-02)
- Money-out shows balance display (CURR-05)
- Exceeds-balance shows warning toast, allows submission (CURR-06)
</success_criteria>

<output>
After completion, create `.planning/phases/26-currency-unification/26-01-SUMMARY.md`
</output>
