---
phase: 49-conversion-rate-input
plan: 03
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - app/(dashboard)/inventory/stock-in/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  - components/stock-out-requests/approval-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Stock-in form (both invoice and manual modes) includes conversion rate input and sends conversion_rate in inventory_transactions insert"
    - "Stock-out form includes conversion rate input and sends conversion_rate in inventory_transactions insert (including transfer-in)"
    - "Stock-out request creation includes conversion rate input per line item and sends conversion_rate in stock_out_line_items insert"
    - "Approval dialog sends conversion_rate in inventory_transactions insert"
    - "Conversion rate is required on all forms (validated > 0 before submit)"
  artifacts:
    - path: "app/(dashboard)/inventory/stock-in/page.tsx"
      provides: "Stock-in with conversion_rate in inserts"
      contains: "conversion_rate"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Stock-out with conversion_rate in inserts"
      contains: "conversion_rate"
    - path: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      provides: "Stock-out request with conversion_rate per line item"
      contains: "conversion_rate"
    - path: "components/stock-out-requests/approval-dialog.tsx"
      provides: "Approval dialog with conversion_rate in inventory transaction insert"
      contains: "conversion_rate"
  key_links:
    - from: "app/(dashboard)/inventory/stock-in/page.tsx"
      to: "supabase inventory_transactions insert"
      via: "conversion_rate field in insert payload"
      pattern: "conversion_rate"
    - from: "app/(dashboard)/inventory/stock-out/page.tsx"
      to: "supabase inventory_transactions insert"
      via: "conversion_rate field in both stock-out and transfer-in inserts"
      pattern: "conversion_rate"
    - from: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      to: "supabase stock_out_line_items insert"
      via: "conversion_rate field in insert payload"
      pattern: "conversion_rate"
---

<objective>
Add conversion rate input to stock-in, stock-out, stock-out request creation, and stock-out approval dialog.

Purpose: Fix remaining Phase 47 TypeScript breaking changes by adding conversion_rate input UI and including conversion_rate in all remaining database insert payloads for inventory_transactions and stock_out_line_items.
Output: All inventory forms accept and submit conversion_rate. TypeScript compilation passes (zero Phase 47 errors remaining).
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-conversion-rate-input/49-01-SUMMARY.md

# Files to modify:
@app/(dashboard)/inventory/stock-in/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
@app/(dashboard)/inventory/stock-out-requests/new/page.tsx
@components/stock-out-requests/approval-dialog.tsx

# Pattern reference:
@components/ui/conversion-rate-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conversion rate to stock-in form (invoice and manual modes)</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx</files>
  <action>
    **1. Import ConversionRateInput:**
    ```
    import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
    ```

    **2. Invoice mode (from-invoice stock-in):**
    The stock-in form has a `StockInLineItem` interface and creates transactions from selected invoice line items.

    a. Add `conversion_rate: string` to the `StockInLineItem` interface.

    b. When populating line items from invoice selection, set `conversion_rate: ""` (empty, required input).

    c. Add a ConversionRateInput in the UI for each invoice line item. Find where quantity and unit_cost are displayed/edited for each line item and add a conversion rate input nearby:
       ```
       <div>
         <label className="text-xs text-slate-500 block mb-1">Conv. Rate</label>
         <ConversionRateInput
           value={line.conversion_rate}
           onValueChange={(val) => handleUpdateStockInLine(line.id, "conversion_rate", val)}
           className="w-24 text-right bg-slate-800 border-slate-700"
         />
       </div>
       ```
       (Adapt the handler name to whatever exists for updating line items.)

    d. In the submit handler for invoice mode, add `conversion_rate: parseFloat(line.conversion_rate) || 1` to each transaction object in the `transactions` array.

    e. Add validation: ensure all selected line items have valid conversion_rate (not empty, > 0) before allowing submit. Update `hasErrors` or equivalent validation check.

    **3. Manual mode (manual stock-in):**

    a. Add a state variable for manual conversion rate:
       ```
       const [manualConversionRate, setManualConversionRate] = useState<string>("");
       ```

    b. Add a ConversionRateInput field in the manual mode form UI, near the quantity and unit cost fields:
       ```
       <FormField label="Conversion Rate" htmlFor="conversion_rate" required>
         <ConversionRateInput
           value={manualConversionRate}
           onValueChange={setManualConversionRate}
           className="bg-slate-800/50 border-slate-700"
         />
       </FormField>
       ```

    c. In the manual mode submit handler, add `conversion_rate: parseFloat(manualConversionRate) || 1` to the insert payload.

    d. Add to manual mode validation: require `manualConversionRate` to be non-empty and > 0.

    This fixes the two TypeScript errors for inventory_transactions insert in stock-in/page.tsx.
  </action>
  <verify>
    Run: `npx tsc --noEmit app/(dashboard)/inventory/stock-in/page.tsx 2>&1 | grep -c "conversion_rate"` should return 0.
  </verify>
  <done>Stock-in form has conversion rate input in both invoice and manual modes. Both submit paths include conversion_rate in inventory_transactions insert.</done>
</task>

<task type="auto">
  <name>Task 2: Add conversion rate to stock-out, stock-out requests, and approval dialog</name>
  <files>app/(dashboard)/inventory/stock-out/page.tsx, app/(dashboard)/inventory/stock-out-requests/new/page.tsx, components/stock-out-requests/approval-dialog.tsx</files>
  <action>
    **1. Stock-out form (`app/(dashboard)/inventory/stock-out/page.tsx`):**

    a. Import ConversionRateInput:
       ```
       import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
       ```

    b. Add conversion rate state:
       ```
       const [conversionRate, setConversionRate] = useState<string>("");
       ```

    c. Add ConversionRateInput to the form UI, near the quantity field:
       ```
       <FormField label="Conversion Rate" htmlFor="conversion_rate" required>
         <ConversionRateInput
           value={conversionRate}
           onValueChange={setConversionRate}
           className="bg-slate-800/50 border-slate-700"
         />
       </FormField>
       ```

    d. In the submit handler, add `conversion_rate: parseFloat(conversionRate) || 1` to BOTH inserts:
       - The `inventory_out` transaction insert
       - The `inventory_in` transfer transaction insert (when reason === "transfer")

    e. Add to validation: require conversionRate to be non-empty and > 0 before submit.

    **2. Stock-out request creation (`app/(dashboard)/inventory/stock-out-requests/new/page.tsx`):**

    a. Import ConversionRateInput:
       ```
       import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
       ```

    b. Add `conversionRate: string` to the `LineItem` interface (currently has id, categoryId, itemId, quantity).

    c. When creating new line items, initialize `conversionRate: ""`.

    d. Add ConversionRateInput UI for each line item, near the quantity input:
       ```
       <ConversionRateInput
         value={item.conversionRate}
         onValueChange={(val) => updateLineItem(item.id, "conversionRate", val)}
         className="w-24 bg-slate-800/50 border-slate-700"
         placeholder="1.0000"
       />
       ```
       (Adapt handler name to match existing update pattern.)

    e. In the submit handler, add `conversion_rate: parseFloat(item.conversionRate) || 1` to each item in `lineItemsToInsert`:
       ```
       const lineItemsToInsert = lineItems.map((item) => ({
         request_id: requestData.id,
         item_id: item.itemId,
         requested_quantity: parseFloat(item.quantity),
         conversion_rate: parseFloat(item.conversionRate) || 1,
         created_by: user.id,
       }));
       ```

    f. Add to form validation: require all line items to have valid conversionRate.

    **3. Approval dialog (`components/stock-out-requests/approval-dialog.tsx`):**

    a. Import ConversionRateInput:
       ```
       import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
       ```

    b. Add `conversionRate: string` to the `ApprovalData` interface (currently has approvedQuantity, warehouseId).

    c. Initialize conversionRate in the approval data when the dialog opens. When initializing `approvalData` map from `lineItems`, set `conversionRate: ""`.

    d. Add ConversionRateInput UI for each line item in the approval dialog, near the approved quantity and warehouse selection:
       ```
       <div>
         <Label className="text-xs">Conv. Rate</Label>
         <ConversionRateInput
           value={data.conversionRate}
           onValueChange={(val) => {
             const newData = new Map(approvalData);
             newData.set(item.id, { ...data, conversionRate: val });
             setApprovalData(newData);
           }}
           className="w-24 bg-slate-800 border-slate-700"
         />
       </div>
       ```

    e. In the submit handler, add `conversion_rate: parseFloat(data.conversionRate) || 1` to the inventory_transactions insert:
       ```
       conversion_rate: parseFloat(data.conversionRate) || 1,
       ```

    f. Add validation: ensure all line items have valid conversionRate before allowing approval submit.

    This fixes all remaining TypeScript errors from Phase 47.
  </action>
  <verify>
    Run: `npm run type-check 2>&1 | grep "conversion_rate"` should return no errors.
    Run: `npm run type-check 2>&1 | grep "error TS"` should return 0 errors total (all Phase 47 breaking changes resolved).
  </verify>
  <done>Stock-out, stock-out requests, and approval dialog all include conversion_rate inputs and send conversion_rate in database inserts. All Phase 47 TypeScript errors are resolved. `npm run type-check` passes cleanly.</done>
</task>

</tasks>

<verification>
- [ ] Stock-in form (invoice mode): conversion rate input per line item, conversion_rate in insert
- [ ] Stock-in form (manual mode): conversion rate input field, conversion_rate in insert
- [ ] Stock-out form: conversion rate input field, conversion_rate in both out and transfer-in inserts
- [ ] Stock-out request creation: conversion rate input per line item, conversion_rate in stock_out_line_items insert
- [ ] Approval dialog: conversion rate input per line item, conversion_rate in inventory_transactions insert
- [ ] All conversion rate inputs validated as required (> 0)
- [ ] `npm run type-check` passes with zero errors
</verification>

<success_criteria>
All inventory-related forms accept conversion_rate input and include it in database inserts. All Phase 47 TypeScript breaking changes are fully resolved. The application compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/49-conversion-rate-input/49-03-SUMMARY.md`
</output>
