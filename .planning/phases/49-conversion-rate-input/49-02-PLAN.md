---
phase: 49-conversion-rate-input
plan: 02
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - app/(dashboard)/po/new/page.tsx
  - components/po/po-line-items-table.tsx
  - app/(dashboard)/invoice/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "PO line item creation form shows a conversion rate input per line item"
    - "PO submit includes conversion_rate for each po_line_item insert"
    - "Invoice line item entry shows a conversion rate input per line item"
    - "Invoice submit includes conversion_rate for each invoice_line_item insert"
    - "Conversion rate is required (form validation prevents submit without it)"
  artifacts:
    - path: "app/(dashboard)/po/new/page.tsx"
      provides: "PO creation with conversion_rate in line items insert"
      contains: "conversion_rate"
    - path: "components/po/po-line-items-table.tsx"
      provides: "Editable line items table with conversion rate column"
      contains: "ConversionRateInput"
    - path: "app/(dashboard)/invoice/new/page.tsx"
      provides: "Invoice creation with conversion_rate in line items insert"
      contains: "conversion_rate"
  key_links:
    - from: "components/po/po-line-items-table.tsx"
      to: "components/ui/conversion-rate-input.tsx"
      via: "import and render per row"
      pattern: "import.*ConversionRateInput"
    - from: "app/(dashboard)/po/new/page.tsx"
      to: "supabase po_line_items insert"
      via: "conversion_rate field in insert payload"
      pattern: "conversion_rate.*parseFloat"
    - from: "app/(dashboard)/invoice/new/page.tsx"
      to: "supabase invoice_line_items insert"
      via: "conversion_rate field in insert payload"
      pattern: "conversion_rate.*parseFloat"
---

<objective>
Add conversion rate input to PO line items and Invoice line items creation forms.

Purpose: Fix the Phase 47 TypeScript breaking changes for PO and Invoice creation by adding conversion_rate input UI and including conversion_rate in database insert payloads.
Output: PO and Invoice creation forms accept and submit conversion_rate per line item.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-conversion-rate-input/49-01-SUMMARY.md

# Files to modify:
@app/(dashboard)/po/new/page.tsx
@components/po/po-line-items-table.tsx
@app/(dashboard)/invoice/new/page.tsx

# Pattern reference:
@components/ui/exchange-rate-input.tsx
@components/ui/conversion-rate-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conversion rate to PO line items table and PO creation</name>
  <files>components/po/po-line-items-table.tsx, app/(dashboard)/po/new/page.tsx</files>
  <action>
    **1. Update EditableLineItemsTable component (`components/po/po-line-items-table.tsx`):**

    a. Import ConversionRateInput:
       ```
       import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
       ```

    b. Add `conversion_rate` field to `LineItemFormData` interface:
       ```
       conversion_rate: string; // stored as string for input state, parsed on submit
       ```

    c. Add a "Conv. Rate" column header in the table head, after "Unit Price" and before "Total":
       ```
       <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-28">
         Conv. Rate
       </th>
       ```

    d. Add ConversionRateInput cell in each row, after Unit Price and before Total:
       ```
       <td className="py-2 px-3">
         <ConversionRateInput
           value={item.conversion_rate}
           onValueChange={(val) => onUpdateItem(item.id, "conversion_rate", val)}
           className="w-28 text-right bg-slate-800 border-slate-700"
           disabled={disabled}
         />
       </td>
       ```

    **2. Update PO creation page (`app/(dashboard)/po/new/page.tsx`):**

    a. Update the `LineItemFormData` interface to add:
       ```
       conversion_rate: string;
       ```

    b. Update initial line item state to include `conversion_rate: ""` (empty string = required, user must fill):
       ```
       { id: crypto.randomUUID(), category_id: null, item_id: null, item_name: "", quantity: 1, unit_price: 0, conversion_rate: "" }
       ```

    c. Update `handleAddLineItem` to include `conversion_rate: ""` in new items.

    d. Update `canSubmit` validation to require conversion_rate on every line item:
       Add to the `lineItems.every(...)` check: `&& li.conversion_rate && parseFloat(li.conversion_rate) > 0`

    e. Update the submit handler's `lineItemsToInsert` mapping to include:
       ```
       conversion_rate: parseFloat(li.conversion_rate) || 1,
       ```

    This fixes the TypeScript error: "Property 'conversion_rate' is missing in type" for po_line_items insert.
  </action>
  <verify>
    Run: `npx tsc --noEmit app/(dashboard)/po/new/page.tsx 2>&1 | grep -c "conversion_rate"` should return 0 (no errors about conversion_rate).
    The po/new/page.tsx file should compile without the conversion_rate missing error.
  </verify>
  <done>PO creation form has conversion rate input per line item. Submit includes conversion_rate in po_line_items insert. The Phase 47 type error for po/new is resolved.</done>
</task>

<task type="auto">
  <name>Task 2: Add conversion rate to Invoice line items</name>
  <files>app/(dashboard)/invoice/new/page.tsx</files>
  <action>
    **1. Update invoice creation page (`app/(dashboard)/invoice/new/page.tsx`):**

    a. Import ConversionRateInput:
       ```
       import { ConversionRateInput } from "@/components/ui/conversion-rate-input";
       ```

    b. Check the `InvoiceLineItemFormData` type (imported from `@/components/invoice`). If it doesn't have `conversion_rate`, update that type. If it does, use it. Most likely need to add `conversion_rate: string` to the type.
       - Find and read `components/invoice/index.ts` or wherever `InvoiceLineItemFormData` is defined
       - Add `conversion_rate: string` to the interface

    c. When populating line items from PO selection (the `useEffect` that sets lineItems when PO changes), set default `conversion_rate: ""` (empty, user must fill):
       ```
       conversion_rate: "",
       ```

    d. In Step 2 (Line Items), add a conversion rate input for each selected line item. Add it alongside the Qty and Unit Price inputs. After the Unit Price input div, add:
       ```
       <div>
         <label className="text-xs text-slate-500 block mb-1">Conv. Rate</label>
         <ConversionRateInput
           value={item.conversion_rate}
           onValueChange={(val) => handleUpdateLineItem(item.id, "conversion_rate", val)}
           className="w-24 text-right bg-slate-800 border-slate-700"
         />
       </div>
       ```

    e. Update Step 2 validation (`hasQuantityErrors` or `canProceed`): Add check that all selected items have a valid conversion_rate (not empty, > 0). Add a new check:
       ```
       const hasConversionRateErrors = selectedItems.some(
         (li) => !li.conversion_rate || parseFloat(li.conversion_rate) <= 0
       );
       ```
       Update `canProceed` for step 2 to include `!hasConversionRateErrors`.

    f. Update the submit handler's `lineItemsToInsert` mapping to include:
       ```
       conversion_rate: parseFloat(li.conversion_rate) || 1,
       ```

    g. In Step 3 (Summary), add a "Conv. Rate" column to the line items summary table showing the conversion rate for each item.

    This fixes the TypeScript error: "Property 'conversion_rate' is missing in type" for invoice_line_items insert.
  </action>
  <verify>
    Run: `npx tsc --noEmit app/(dashboard)/invoice/new/page.tsx 2>&1 | grep -c "conversion_rate"` should return 0.
    The invoice/new/page.tsx file should compile without the conversion_rate missing error.
  </verify>
  <done>Invoice creation form has conversion rate input per line item. Submit includes conversion_rate in invoice_line_items insert. The Phase 47 type error for invoice/new is resolved.</done>
</task>

</tasks>

<verification>
- [ ] PO creation form shows conversion rate input per line item
- [ ] PO submit includes conversion_rate in po_line_items insert payload
- [ ] Invoice creation form shows conversion rate input per line item
- [ ] Invoice submit includes conversion_rate in invoice_line_items insert payload
- [ ] Conversion rate is validated as required (> 0) before form submission
- [ ] `npm run type-check` no longer shows conversion_rate errors for po/new and invoice/new
</verification>

<success_criteria>
PO and Invoice creation forms accept conversion_rate input per line item and include it in database inserts. Phase 47 TypeScript errors for these two files are resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/49-conversion-rate-input/49-02-SUMMARY.md`
</output>
