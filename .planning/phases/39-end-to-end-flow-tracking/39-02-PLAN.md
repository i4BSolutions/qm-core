---
phase: 39-end-to-end-flow-tracking
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - app/(dashboard)/admin/flow-tracking/page.tsx
  - app/(dashboard)/admin/flow-tracking/layout.tsx
  - components/flow-tracking/flow-search.tsx
  - components/flow-tracking/flow-chain-timeline.tsx
  - components/flow-tracking/flow-qmrl-node.tsx
  - components/flow-tracking/flow-qmhq-node.tsx
  - components/flow-tracking/flow-po-node.tsx
  - components/flow-tracking/flow-invoice-node.tsx
  - components/flow-tracking/flow-stock-node.tsx
  - components/flow-tracking/flow-financial-node.tsx
  - components/flow-tracking/flow-sor-node.tsx
  - components/layout/sidebar.tsx
  - lib/hooks/use-permissions.ts
autonomous: true

must_haves:
  truths:
    - "Admin can access flow tracking page from sidebar navigation under Admin section"
    - "Admin can search by QMRL ID and see the complete downstream chain rendered as a vertical timeline"
    - "QMRL node shows ID, title, status badge, dates, and people (requester/assigned)"
    - "QMHQ nodes show ID, status, route type with distinct accent colors per route (Item=blue, Expense=green, PO=purple)"
    - "PO and Invoice nodes show ID, status, dates, and supplier name; voided invoices and cancelled POs have faded/strikethrough styling"
    - "Stock nodes show simple status indicator; financial transaction nodes show transaction type and date"
    - "Clicking any node navigates to its entity detail page"
    - "Non-admin users cannot access the flow tracking page (server-side redirect)"
    - "Empty state shows search box with instructions before any search"
    - "Not-found case shows inline error message below search box"
  artifacts:
    - path: "app/(dashboard)/admin/flow-tracking/page.tsx"
      provides: "Flow tracking page with server-side data fetching and admin auth check"
      min_lines: 40
    - path: "app/(dashboard)/admin/flow-tracking/layout.tsx"
      provides: "Admin-only route guard layout"
      min_lines: 15
    - path: "components/flow-tracking/flow-chain-timeline.tsx"
      provides: "Timeline container rendering nested chain with connector lines"
      min_lines: 40
    - path: "components/flow-tracking/flow-search.tsx"
      provides: "QMRL ID search input with form submission"
      min_lines: 20
    - path: "components/flow-tracking/flow-qmrl-node.tsx"
      provides: "QMRL root node card component"
      min_lines: 30
    - path: "components/flow-tracking/flow-qmhq-node.tsx"
      provides: "QMHQ node with route type color variants"
      min_lines: 40
    - path: "components/layout/sidebar.tsx"
      provides: "Flow Tracking nav item under Admin section"
      contains: "flow-tracking"
    - path: "lib/hooks/use-permissions.ts"
      provides: "Flow tracking route in admin roleNavigation"
      contains: "flow-tracking"
  key_links:
    - from: "app/(dashboard)/admin/flow-tracking/page.tsx"
      to: "lib/supabase/flow-tracking-queries.ts"
      via: "fetchFlowChain call"
      pattern: "fetchFlowChain"
    - from: "app/(dashboard)/admin/flow-tracking/page.tsx"
      to: "components/flow-tracking/flow-chain-timeline.tsx"
      via: "FlowChainTimeline component render"
      pattern: "FlowChainTimeline"
    - from: "components/flow-tracking/flow-chain-timeline.tsx"
      to: "components/flow-tracking/flow-qmrl-node.tsx"
      via: "FlowQMRLNode render"
      pattern: "FlowQMRLNode"
    - from: "components/flow-tracking/flow-qmhq-node.tsx"
      to: "/qmhq/[id]"
      via: "Link href"
      pattern: "href=.*qmhq"
---

<objective>
Build the flow tracking page UI: admin-only route with search, vertical timeline visualization of the QMRL downstream chain, and navigation integration. Each entity type gets a distinct card component with color-coded borders, icons, status badges, dates, and people.

Purpose: Give admins visibility into the complete lifecycle of any QMRL by tracing its downstream chain.
Output: Flow tracking page, timeline components, navigation sidebar entry, route guard.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-end-to-end-flow-tracking/39-RESEARCH.md
@.planning/phases/39-end-to-end-flow-tracking/39-01-SUMMARY.md

Key existing files to reference:
- components/layout/sidebar.tsx (navigation structure with admin section, roles-based filtering)
- lib/hooks/use-permissions.ts (roleNavigation map, canAccessRoute function)
- app/(dashboard)/qmhq/layout.tsx (server-side route guard pattern to replicate)
- components/status/clickable-status-badge.tsx (existing status badge for read-only display)
- app/(dashboard)/dashboard/components/activity-timeline.tsx (timeline UI pattern)
- components/po/po-card.tsx (card display pattern)

User constraints (LOCKED - do not deviate):
- Vertical timeline layout with top-to-bottom flow and connecting lines
- Branching with indented sub-timelines under parent nodes
- Always fully expanded, no collapsible sections
- Clicking any node navigates to entity detail page (no inline previews)
- Color-coded left border AND icon per entity type
- QMHQ cards: distinct accent colors per route type (Item, Expense, PO)
- Stock-out request and execution combined into single node
- QMRL ID search only, exact match, enter to search
- Empty state: search box + instructions
- Not-found: inline error message below search
- Each node: ID, status, dates, people (no financial amounts)
- Users with avatar + name; contacts/suppliers as text only
- Existing colored status badges (same as list/detail pages)
- Voided invoices/cancelled POs: strikethrough/faded styling
- No warning icons, no summary stats, no overall flow status indicator

Discretion areas (Claude's choice):
- Connector line style: use solid 2px slate-700 lines (consistent with existing borders)
- Entity border colors: QMRL=amber-500, QMHQ-item=blue-500, QMHQ-expense=emerald-500, QMHQ-po=purple-500, PO=violet-500, Invoice=cyan-500, Stock=teal-500, Financial=lime-500, SOR=orange-500
- Spacing: 6-unit (mb-6) between nodes, 8-unit (ml-8) indent for sub-timelines
- Long chains: natural page scroll, no virtualization (admin page, rare usage)
- Loading state: simple skeleton pulse while data loads (using Suspense)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create flow tracking page with layout guard, search, and navigation</name>
  <files>
    app/(dashboard)/admin/flow-tracking/layout.tsx
    app/(dashboard)/admin/flow-tracking/page.tsx
    components/flow-tracking/flow-search.tsx
    components/layout/sidebar.tsx
    lib/hooks/use-permissions.ts
  </files>
  <action>
**1. Layout guard** (`app/(dashboard)/admin/flow-tracking/layout.tsx`):
Follow the exact pattern from `app/(dashboard)/qmhq/layout.tsx` but restrict to admin only:
```typescript
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function FlowTrackingLayout({ children }: { children: React.ReactNode }) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect("/login");

  const { data: profile } = await supabase
    .from("users")
    .select("role")
    .eq("id", user.id)
    .single();

  if (profile?.role !== "admin") {
    redirect("/dashboard");
  }

  return <>{children}</>;
}
```

**2. Page** (`app/(dashboard)/admin/flow-tracking/page.tsx`):
This is a server component. It reads `searchParams` to get the `qmrl_id` query parameter.

- Import `fetchFlowChain` from `@/lib/supabase/flow-tracking-queries`
- Import `FlowSearch` from `@/components/flow-tracking/flow-search`
- Import `FlowChainTimeline` from `@/components/flow-tracking/flow-chain-timeline`

Logic:
- If no `searchParams.qmrl_id`, render page title "Flow Tracking" + FlowSearch + empty state message ("Enter a QMRL ID to view its complete downstream chain")
- If `searchParams.qmrl_id` provided, call `fetchFlowChain(supabase, searchParams.qmrl_id)`
- If data is null (not found), render FlowSearch with `defaultValue` + error message: "No QMRL found with ID: {searchParams.qmrl_id}"
- If data exists, render FlowSearch with `defaultValue` + `<FlowChainTimeline chain={data} />`

Page styling: `max-w-5xl mx-auto` container within the standard dashboard padding. Page title uses `text-2xl font-bold text-white` consistent with other admin pages.

**3. Search component** (`components/flow-tracking/flow-search.tsx`):
Client component (`'use client'`). Props: `defaultValue?: string`.

- Uses `useState` for input value, `useRouter` and `useSearchParams` from next/navigation
- On form submit, `router.push(\`/admin/flow-tracking?qmrl_id=\${encodeURIComponent(value.trim())}\`)`
- Input auto-uppercases value on change
- Placeholder: "Enter QMRL ID (e.g., QMRL-2026-00001)"
- Search icon (lucide `Search`) positioned absolute-left inside input
- Styling: dark input matching existing form inputs (bg-slate-900, border-slate-700, text-slate-200, focus:ring-amber-500)

**4. Sidebar navigation** (`components/layout/sidebar.tsx`):
Add "Flow Tracking" to the `adminNavigation` children array. Add it after "Statuses":
```typescript
{ label: "Flow Tracking", href: "/admin/flow-tracking" },
```

Import `GitBranch` or `Workflow` icon from lucide-react? No â€” admin navigation uses children under the Admin expandable section (Settings icon), so no separate icon needed. Just add the child item.

**5. Role navigation** (`lib/hooks/use-permissions.ts`):
Add `/admin/flow-tracking` to the admin role's allowed routes in `roleNavigation`:
```typescript
admin: [
  "/dashboard",
  "/qmrl",
  "/qmhq",
  "/po",
  "/invoice",
  "/inventory",
  "/inventory/stock-out-requests",
  "/warehouse",
  "/item",
  "/admin",
  "/admin/flow-tracking",  // Add this
],
```

Wait - `/admin` already covers `/admin/flow-tracking` via the `path.startsWith(route + "/")` check in `canAccessRoute`. So adding it is redundant but explicit. Add it for clarity since other admin subroutes aren't explicitly listed (they're covered by `/admin`). Actually, since `/admin` already covers all `/admin/*` routes, no change is needed in `roleNavigation`. Skip this change.
  </action>
  <verify>
    Run `npm run type-check` to confirm all files compile. Check that the layout guard redirects non-admin users. Check sidebar.tsx has "Flow Tracking" in admin navigation.
  </verify>
  <done>
    - Admin can access /admin/flow-tracking from sidebar under Admin section
    - Non-admin users are redirected to /dashboard by layout guard
    - Empty state shows search box with instructions
    - Search submits QMRL ID as URL param for server-side fetch
    - Not-found shows inline error message
    - Found QMRL renders FlowChainTimeline component
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timeline and entity node components</name>
  <files>
    components/flow-tracking/flow-chain-timeline.tsx
    components/flow-tracking/flow-qmrl-node.tsx
    components/flow-tracking/flow-qmhq-node.tsx
    components/flow-tracking/flow-po-node.tsx
    components/flow-tracking/flow-invoice-node.tsx
    components/flow-tracking/flow-stock-node.tsx
    components/flow-tracking/flow-financial-node.tsx
    components/flow-tracking/flow-sor-node.tsx
  </files>
  <action>
All components are client components (`'use client'`) since they use Link navigation and potential hover interactions.

**Entity type visual design (discretion choices):**

| Entity | Left Border | Icon (lucide) | Circle Color |
|--------|-------------|---------------|-------------|
| QMRL | border-l-amber-500 | FileText | amber |
| QMHQ Item | border-l-blue-500 | Package | blue |
| QMHQ Expense | border-l-emerald-500 | DollarSign | emerald |
| QMHQ PO | border-l-purple-500 | ShoppingCart | purple |
| PO | border-l-violet-500 | ClipboardCheck | violet |
| Invoice | border-l-cyan-500 | FileSpreadsheet | cyan |
| Stock | border-l-teal-500 | Warehouse | teal |
| Financial | border-l-lime-500 | ArrowRightLeft | lime |
| SOR | border-l-orange-500 | PackageCheck | orange |

**1. FlowChainTimeline** (`components/flow-tracking/flow-chain-timeline.tsx`):
Props: `{ chain: FlowChain }` from `@/types/flow-tracking`.

Structure (always fully expanded, no collapse):
```
<div className="mt-8 space-y-0">
  {/* QMRL root */}
  <FlowQMRLNode qmrl={chain} />

  {/* QMHQ branches - indented under QMRL */}
  {chain.qmhqs.length > 0 && (
    <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
      {chain.qmhqs.map(qmhq => (
        <div key={qmhq.id}>
          <FlowQMHQNode qmhq={qmhq} />

          {/* Route-specific children - indented under QMHQ */}
          {/* Item route: SOR nodes + stock transactions */}
          {qmhq.route_type === 'item' && (qmhq.stock_out_requests.length > 0 || qmhq.stock_transactions.length > 0) && (
            <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
              {qmhq.stock_out_requests.map(sor => <FlowSORNode key={sor.id} sor={sor} />)}
              {qmhq.stock_transactions.map(st => <FlowStockNode key={st.id} stock={st} />)}
            </div>
          )}

          {/* Expense route: financial transactions */}
          {qmhq.route_type === 'expense' && qmhq.financial_transactions.length > 0 && (
            <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
              {qmhq.financial_transactions.map(ft => <FlowFinancialNode key={ft.id} transaction={ft} />)}
            </div>
          )}

          {/* PO route: POs -> Invoices -> Stock */}
          {qmhq.route_type === 'po' && qmhq.pos.length > 0 && (
            <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
              {qmhq.pos.map(po => (
                <div key={po.id}>
                  <FlowPONode po={po} />

                  {/* Invoices under PO */}
                  {po.invoices.length > 0 && (
                    <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
                      {po.invoices.map(inv => (
                        <div key={inv.id}>
                          <FlowInvoiceNode invoice={inv} />

                          {/* Stock under Invoice */}
                          {inv.stock_transactions.length > 0 && (
                            <div className="ml-8 border-l-2 border-slate-700 pl-6 space-y-0">
                              {inv.stock_transactions.map(st => <FlowStockNode key={st.id} stock={st} />)}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  )}

  {/* No QMHQs message */}
  {chain.qmhqs.length === 0 && (
    <div className="ml-8 py-4 text-sm text-slate-500">No linked QMHQs</div>
  )}
</div>
```

**2. FlowQMRLNode** (`components/flow-tracking/flow-qmrl-node.tsx`):
Props: `{ qmrl: FlowQMRL }`. Wraps in `<Link href={/qmrl/${qmrl.id}}>`.

Card structure:
- Left border: `border-l-4 border-l-amber-500`
- Background: `bg-slate-900/50 rounded-lg p-4 hover:bg-slate-800/50 transition-colors`
- Top row: QMRL icon circle (amber bg, FileText icon white) + `<code className="text-amber-400 text-xs font-mono">{request_id}</code>` + status badge (use Badge component with inline color style matching existing ClickableStatusBadge pattern: `style={{ borderColor: color, color: color, backgroundColor: color + '15' }}`)
- Title: `text-sm font-medium text-slate-200`
- Priority badge: small colored badge (low=slate, medium=amber, high=orange, critical=red)
- People section: requester with avatar+name (use small avatar pattern: 5x5 rounded-full or fallback initial), assigned_to with avatar+name
- Contact: text name only (no avatar)
- Dates: request_date, created_at formatted with `toLocaleDateString()`

Use lucide `Calendar`, `User`, `UserCheck` icons for dates/people labels.

**3. FlowQMHQNode** (`components/flow-tracking/flow-qmhq-node.tsx`):
Props: `{ qmhq: FlowQMHQ }`. Wraps in `<Link href={/qmhq/${qmhq.id}}>`.

Route type determines border color and icon:
- item: `border-l-blue-500`, Package icon, blue circle
- expense: `border-l-emerald-500`, DollarSign icon, emerald circle
- po: `border-l-purple-500`, ShoppingCart icon, purple circle

Card shows:
- Top: icon circle + request_id code + route type badge (`uppercase text-xs px-2 py-0.5 rounded`) + status badge
- Line name: `text-sm font-medium text-slate-200`
- People: assigned_to (avatar+name), contact_person (text only)
- Date: created_at

**4. FlowPONode** (`components/flow-tracking/flow-po-node.tsx`):
Props: `{ po: FlowPO }`. Wraps in `<Link href={/po/${po.id}}>`.

- Left border: `border-l-violet-500`
- Apply faded styling if cancelled: `cn(baseClasses, po.is_cancelled && "opacity-50")`
- Show: po_number, status, po_date, expected_delivery_date, supplier_name (text), created_at

**5. FlowInvoiceNode** (`components/flow-tracking/flow-invoice-node.tsx`):
Props: `{ invoice: FlowInvoice }`. Wraps in `<Link href={/invoice/${invoice.id}}>`.

- Left border: `border-l-cyan-500`
- Apply voided styling: `cn(baseClasses, invoice.is_voided && "opacity-50 [&_*]:line-through")`
- Show: invoice_number, status, invoice_date, due_date, created_at

**6. FlowStockNode** (`components/flow-tracking/flow-stock-node.tsx`):
Props: `{ stock: FlowStockTransaction }`. No link (stock transactions don't have their own detail page; they're viewed within inventory/warehouse pages).

- Left border: `border-l-teal-500`
- Compact card: movement_type badge (inventory_in=emerald, inventory_out=amber) + status indicator + transaction_date
- Status as simple text badge: "Completed"/"Pending"/"Cancelled"

**7. FlowFinancialNode** (`components/flow-tracking/flow-financial-node.tsx`):
Props: `{ transaction: FlowFinancialTransaction }`. No link.

- Left border: `border-l-lime-500`
- Apply voided styling if `is_voided`: opacity-50 + line-through
- Show: transaction_type badge (money_in=emerald, money_out=amber) + transaction_date
- NO financial amounts (user constraint)

**8. FlowSORNode** (`components/flow-tracking/flow-sor-node.tsx`):
Props: `{ sor: FlowStockOutRequest }`. Wraps in `<Link href={/inventory/stock-out-requests}>` (or just no link if SOR doesn't have individual detail page).

- Left border: `border-l-orange-500`
- Show: request_number, status badge, created_at
- This is the "combined stock-out request and execution" node per user constraint

**Shared patterns across all nodes:**

Each node card has consistent structure:
```
<div className="my-3">
  <[Link|div]>
    <div className={cn("border-l-4 rounded-lg bg-slate-900/50 p-3 sm:p-4", borderColorClass, fadedClass)}>
      {/* Header: icon + ID + status */}
      <div className="flex items-center justify-between gap-2 mb-2">
        <div className="flex items-center gap-2">
          <div className="flex h-6 w-6 items-center justify-center rounded-full bg-{color}-500/20">
            <Icon className="h-3 w-3 text-{color}-400" />
          </div>
          <code className="text-xs font-mono text-{color}-400">{id}</code>
        </div>
        <Badge ...>{status}</Badge>
      </div>

      {/* Title/name if applicable */}

      {/* Details: people + dates */}
      <div className="mt-2 space-y-1 text-xs text-slate-400">
        {/* People with icons */}
        {/* Dates with Calendar icon */}
      </div>
    </div>
  </[Link|div]>
</div>
```

For user avatar display, create a small inline helper (or just inline the JSX):
```typescript
function UserAvatar({ user }: { user: FlowPerson }) {
  return (
    <div className="flex items-center gap-1.5">
      {user.avatar_url ? (
        <img src={user.avatar_url} alt="" className="h-5 w-5 rounded-full" />
      ) : (
        <div className="flex h-5 w-5 items-center justify-center rounded-full bg-slate-700 text-[10px] text-slate-300">
          {user.full_name.charAt(0).toUpperCase()}
        </div>
      )}
      <span>{user.full_name}</span>
    </div>
  );
}
```

Import `cn` from `@/lib/utils`, `Link` from `next/link`, `Badge` from `@/components/ui/badge`, lucide icons as needed.
  </action>
  <verify>
    Run `npm run type-check` to confirm all components compile. Run `npm run build` to check for SSR issues. Verify the timeline renders all entity types with correct nesting by reviewing the component structure.
  </verify>
  <done>
    - FlowChainTimeline renders complete nested chain with correct indentation
    - Each entity type has distinct color-coded left border and icon
    - QMHQ nodes use route-specific accent colors (blue/emerald/purple)
    - All nodes show ID, status badge, dates, and people (no financial amounts)
    - Voided invoices and cancelled POs have faded/strikethrough styling
    - Clicking entity nodes navigates to their detail pages
    - Timeline is always fully expanded with no collapsible sections
    - Users shown with avatar+name, contacts/suppliers as text only
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with zero errors
2. `npm run build` succeeds
3. Flow tracking page accessible at /admin/flow-tracking
4. Non-admin users redirected away from flow tracking page
5. "Flow Tracking" visible in sidebar under Admin section for admin users
6. Search by QMRL ID returns chain or shows not-found message
7. All entity types rendered with correct colors, icons, and data
8. Voided/cancelled entities have faded styling
9. Node clicks navigate to correct detail pages
</verification>

<success_criteria>
- Admin can navigate to flow tracking from sidebar
- Admin can search QMRL ID and see full downstream chain
- Timeline correctly nests: QMRL -> QMHQs -> (POs -> Invoices -> Stock) | Financial | Stock | SOR
- Each entity visually distinct with color-coded borders and icons
- Only admin role can access the page
</success_criteria>

<output>
After completion, create `.planning/phases/39-end-to-end-flow-tracking/39-02-SUMMARY.md`
</output>
