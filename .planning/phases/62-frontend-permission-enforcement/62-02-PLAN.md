---
phase: 62-frontend-permission-enforcement
plan: "02"
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmrl/new/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/edit/page.tsx
  - app/(dashboard)/qmhq/new/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
  - app/(dashboard)/admin/departments/page.tsx
  - app/(dashboard)/admin/contacts/page.tsx
  - app/(dashboard)/admin/suppliers/page.tsx
  - app/(dashboard)/admin/categories/page.tsx
  - app/(dashboard)/admin/statuses/page.tsx
  - app/(dashboard)/admin/standard-units/page.tsx
  - app/(dashboard)/admin/users/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/page.tsx
  - components/status/clickable-status-badge.tsx
  - app/api/admin/deactivate-user/route.ts
  - app/api/admin/reactivate-user/route.ts
  - lib/actions/po-actions.ts
  - components/layout/header.tsx
  - types/database.ts
autonomous: true
requirements: [PERM-07, PERM-08]

must_haves:
  truths:
    - "Create/edit/delete buttons are not rendered when user has View-only permission on the resource"
    - "Server actions reject mutations when the caller has View or Block permission"
    - "The legacy role-based usePermissions() hook calls are replaced with permission-matrix checks"
    - "All TODO Phase 62 markers are resolved"
  artifacts:
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "Permission-gated QMRL detail with edit/create buttons based on DB permissions"
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "Permission-gated SOR detail with approve/execute based on sor_l1/sor_l2/sor permissions"
    - path: "components/status/clickable-status-badge.tsx"
      provides: "Permission-gated status badge using useResourcePermissions() instead of legacy can()"
      contains: "useResourcePermissions"
    - path: "app/api/admin/deactivate-user/route.ts"
      provides: "Server-side admin permission check via user_permissions table"
      contains: "user_permissions"
    - path: "lib/actions/po-actions.ts"
      provides: "Server-side admin permission check for PO cancel/unlock"
      contains: "user_permissions"
  key_links:
    - from: "app/(dashboard)/qmrl/[id]/page.tsx"
      to: "useResourcePermissions()"
      via: "canEdit('qmrl') replaces can('update', 'qmrl')"
      pattern: "canEdit.*qmrl"
    - from: "app/api/admin/deactivate-user/route.ts"
      to: "user_permissions table"
      via: "Server-side permission query"
      pattern: "from.*user_permissions"
---

<objective>
Replace all legacy role-based permission checks with DB-backed permission-matrix checks — hiding mutation buttons for View-only users and rejecting server-side mutations for unauthorized callers.

Purpose: PERM-07 (button gating) requires that Create/Edit/Delete buttons are invisible to View-only users. PERM-08 (server-action rejection) requires that server actions reject mutations from unauthorized callers even if the request is crafted manually (defense in depth beyond RLS).

Output: All `usePermissions()` calls replaced with `useResourcePermissions()`, all TODO Phase 62 markers resolved, server actions enforce permission checks, legacy UserRole type usage cleaned up.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-frontend-permission-enforcement/62-01-SUMMARY.md
@lib/hooks/use-permissions.ts
@components/providers/auth-provider.tsx
@types/database.ts (lines 2297-2301 for deprecated UserRole; lines 2421-2515 for PermissionResource)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace legacy usePermissions() with useResourcePermissions() on all detail/list pages</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmrl/new/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/edit/page.tsx
    app/(dashboard)/qmhq/new/page.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
    app/(dashboard)/inventory/stock-out-requests/page.tsx
    app/(dashboard)/po/[id]/page.tsx
    app/(dashboard)/invoice/[id]/page.tsx
    app/(dashboard)/admin/departments/page.tsx
    app/(dashboard)/admin/contacts/page.tsx
    app/(dashboard)/admin/suppliers/page.tsx
    app/(dashboard)/admin/categories/page.tsx
    app/(dashboard)/admin/statuses/page.tsx
    app/(dashboard)/admin/standard-units/page.tsx
    app/(dashboard)/admin/users/page.tsx
    components/status/clickable-status-badge.tsx
  </files>
  <action>
For each page that imports `usePermissions` from `@/lib/hooks/use-permissions`, replace it with `useResourcePermissions`. The mapping from old role-matrix checks to new DB permission checks is:

**Old pattern:**
```typescript
const { can } = usePermissions();
const canCreate = can("create", "departments");
const canUpdate = can("update", "departments");
const canDelete = can("delete", "departments");
```

**New pattern:**
```typescript
const { canEdit, canView } = useResourcePermissions();
const canModify = canEdit("admin"); // admin resource covers departments
// canModify replaces canCreate, canUpdate, canDelete — edit = full CRUD
```

**Resource mapping for old PermissionResource -> new DB PermissionResource:**

| Old resource name | New DB resource | Logic |
|---|---|---|
| `"departments"` | `"admin"` | Admin page entity |
| `"users"` | `"admin"` | Admin page entity |
| `"suppliers"` | `"admin"` | Admin page entity |
| `"contact_persons"` | `"admin"` | Admin page entity |
| `"categories"` | `"admin"` | Admin page entity |
| `"statuses"` | `"admin"` | Admin page entity |
| `"qmrl"` | `"qmrl"` | Same name |
| `"qmhq"` | `"qmhq"` | Same name |
| `"financial_transactions"` | `"money_transactions"` | Renamed |
| `"inventory_transactions"` | `"inv_transactions"` | Renamed |
| `"purchase_orders"` | `"po"` | Shortened |
| `"invoices"` | `"invoice"` | Shortened |
| `"items"` | `"item"` | Shortened |
| `"warehouses"` | `"warehouse"` | Shortened |
| `"stock_out_requests"` | `"sor"` | Shortened |

**Per-file specifics:**

1. **admin/departments/page.tsx** — Replace `const { can } = usePermissions()` with `const { canEdit } = useResourcePermissions()`. Replace `can("create/update/delete", "departments")` with `canEdit("admin")`. Button visibility: show create/edit/delete only when `canEdit("admin")`.

2. **admin/contacts/page.tsx** — Same as departments: `canEdit("admin")` for all CRUD.

3. **admin/suppliers/page.tsx** — Same as departments.

4. **admin/categories/page.tsx** — Same as departments.

5. **admin/statuses/page.tsx** — Same as departments.

6. **admin/standard-units/page.tsx** — Same as departments.

7. **admin/users/page.tsx** — Replace `can("create/update/delete", "users")` with `canEdit("admin")`.

8. **qmrl/[id]/page.tsx** —
   - Replace `const { can } = usePermissions()` with `const { canEdit, canView } = useResourcePermissions()`.
   - Replace `can("update", "qmrl")` with `canEdit("qmrl")` for edit button.
   - Replace `can("create", "qmhq")` with `canEdit("qmhq")` for "Create QMHQ" button.
   - Replace `can("read", "qmhq")` with `canView("qmhq")` for QMHQ tab visibility.
   - Fix the `canDeleteFile` callback: replace the commented-out role check with `canEdit("qmrl")` — if user has edit on qmrl, they can delete any file; otherwise only their own uploads.
   - Fix all TODO Phase 62 comments in this file:
     - Line ~86: replace role check for admin status click with `canEdit("qmrl")`
     - Line ~119: replace QMHQ visibility check with `canView("qmhq")`
     - Lines ~447, ~463, ~467: remove the role display labels or replace with permission-based label

9. **qmrl/new/page.tsx** —
   - Replace any `TODO Phase 62` role display comments.
   - Assignee user select: remove the role column from the user select query (line ~463). The select already works without role since Phase 60 dropped it. Just clean up the TODO comment.

10. **qmhq/[id]/page.tsx** — This file has 6 `can()` calls that ALL must be replaced:
    - Replace `const { can } = usePermissions()` with `const { canEdit } = useResourcePermissions()`.
    - Replace `can("update", "qmhq")` (line ~636) with `canEdit("qmhq")` for edit button.
    - Replace `can("create", "stock_out_requests")` (lines ~1039, ~1066) with `canEdit("sor")` for SOR create button.
    - Replace `can("create", "financial_transactions")` (line ~1103) with `canEdit("money_transactions")` for transaction create button.
    - Replace `can("create", "purchase_orders")` (line ~1231) with `canEdit("po")` for PO create button.
    - Fix `canDeleteFile`: replace commented-out role check with `canEdit("qmhq")`.
    - Remove the TODO Phase 62 comment at line ~143.

11. **qmhq/[id]/edit/page.tsx** —
    - Remove the `// TODO Phase 62: role column dropped` comment at line ~132.
    - If the user select query still references `role`, remove that field from the select.

12. **qmhq/new/page.tsx** —
    - Remove the `// TODO Phase 62: role column dropped` comment at line ~301.
    - If the user select query still references `role`, remove that field from the select.
    - Remove the TODO Phase 62 role display comment at line ~680.

13. **inventory/stock-out-requests/[id]/page.tsx** —
    - Replace `canApprove = false` with: `const { canEdit } = useResourcePermissions(); const canApprove = canEdit("sor_l1");`
    - Replace `canExecute = false` with: `const canExecute = canEdit("sor");`
    - Remove the TODO Phase 62 comments at lines ~179 and ~187.
    - Note: The SOR detail page currently has both set to `false` since Phase 60. The permission resources `sor_l1` (L1 approval), `sor_l2` (L2 assignment), and `sor` (general SOR access including execution) map to these capabilities.

14. **inventory/stock-out-requests/page.tsx** —
    - If `usePermissions()` is imported, replace with `useResourcePermissions()`.
    - Replace any `can("create/read/update", "stock_out_requests")` with `canEdit("sor")` / `canView("sor")`.

15. **po/[id]/page.tsx** —
    - Replace `const { can } = usePermissions()` with `const { canEdit, canView } = useResourcePermissions()`.
    - Replace `can("update", "purchase_orders")` with `canEdit("po")`.
    - Replace `can("create", "purchase_orders")` with `canEdit("po")`.

16. **invoice/[id]/page.tsx** —
    - Replace `const { can } = usePermissions()` with `const { canEdit } = useResourcePermissions()`.
    - Replace usage patterns accordingly with `canEdit("invoice")`.

**Import change pattern:**
```typescript
// OLD
import { usePermissions } from "@/lib/hooks/use-permissions";
// NEW
import { useResourcePermissions } from "@/lib/hooks/use-permissions";
```

17. **components/status/clickable-status-badge.tsx** — This component internally calls the legacy hook and MUST be updated:
    - Replace `import { usePermissions } from "@/lib/hooks/use-permissions"` with `import { useResourcePermissions } from "@/lib/hooks/use-permissions"` and add `import type { DbPermissionResource } from "@/types/database"`.
    - Replace `const { can } = usePermissions()` with `const { canEdit } = useResourcePermissions()`.
    - Replace `const canUpdate = can("update", entityType)` with `const canUpdate = canEdit(entityType as DbPermissionResource)`.
    - The rest of the component logic (using `canUpdate` to gate clickability) remains unchanged.
    - Without this fix, the status badge is non-clickable for ALL users (bug) because the legacy `can()` always returns false since the role column was dropped.

Also check `components/files/attachments-tab.tsx` — if it imports `usePermissions`, update similarly.
  </action>
  <verify>
1. `npm run type-check` passes
2. `npm run build` passes
3. Grep for `usePermissions()` (with parens, NOT `useResourcePermissions`) across `app/` AND `components/` directories — should return zero matches (only the definition in lib/hooks/use-permissions.ts should remain)
4. Grep for `TODO Phase 62` in all modified files — zero results
5. Grep for `canApprove = false` in stock-out-requests/[id]/page.tsx — zero results (replaced with actual check)
6. Grep for `can("update"` and `can("create"` across `components/` directory — zero results (clickable-status-badge.tsx updated)
  </verify>
  <done>
All detail and list pages use useResourcePermissions() for button visibility. Create/edit/delete buttons hidden for View-only users. SOR approve/execute capabilities restored with permission-based checks. All TODO Phase 62 markers in UI pages resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Server-action permission rejection and legacy cleanup</name>
  <files>
    app/api/admin/deactivate-user/route.ts
    app/api/admin/reactivate-user/route.ts
    lib/actions/po-actions.ts
    types/database.ts
  </files>
  <action>
**Server-side permission enforcement (PERM-08):**

For each server action / API route with a TODO Phase 62, replace the commented-out role check with a permission-based check using the Supabase server client to query `user_permissions`.

1. **app/api/admin/deactivate-user/route.ts:**
   Replace the commented-out role check at lines 15-18 with:
   ```typescript
   const { data: perm } = await serverClient
     .from("user_permissions")
     .select("level")
     .eq("user_id", currentUser.id)
     .eq("resource", "admin")
     .single();

   if (!perm || perm.level !== "edit") {
     return NextResponse.json({ error: "Forbidden - Admin permission required" }, { status: 403 });
   }
   ```
   Remove the TODO Phase 62 comment.

2. **app/api/admin/reactivate-user/route.ts:**
   Same pattern as deactivate-user. Check `admin` resource for `edit` level.
   Remove the TODO Phase 62 comment.

3. **lib/actions/po-actions.ts:**
   Two locations (cancel PO and unlock PO) have commented-out role checks:
   - For `cancelPO` (line ~77): Replace with:
     ```typescript
     const { data: perm } = await supabase
       .from("user_permissions")
       .select("level")
       .eq("user_id", user.id)
       .eq("resource", "po")
       .single();

     if (!perm || perm.level !== "edit") {
       return { success: false, error: "Only users with Edit permission on Purchase Orders can cancel POs" };
     }
     ```
   - For `unlockClosedPO` (line ~241): Same pattern, check `po` resource for `edit`.
   Remove the TODO Phase 62 comments and the commented-out role check code.

**Legacy cleanup:**

4. **types/database.ts:**
   - Remove the deprecated `UserRole` type (line ~2301): `export type UserRole = "admin" | "qmrl" | "qmhq";`
   - Remove the TODO Phase 62 comment at line ~2299.
   - IMPORTANT: Before removing, grep for all `UserRole` imports across the codebase. Expected consumers:
     - `lib/hooks/use-permissions.ts` — has `import type { UserRole } from "@/types"` used in the legacy `PermissionMatrix` type and `permissionMatrix` constant. These are the OLD hooks that should still be kept as deprecated fallback but the `UserRole` import needs updating.
     - `components/providers/auth-provider.tsx` — has `useUserRole()` that returns `null as UserRole | null`. Update to just return `null`.
   - If there are other files importing `UserRole`, update them. If the old `usePermissions()` hook in `lib/hooks/use-permissions.ts` still references `UserRole` in its matrix types, either:
     a. Inline the type as `"admin" | "qmrl" | "qmhq"` locally in that file, OR
     b. Keep the deprecated export but remove the TODO comment (since Phase 62 IS the cleanup phase).
   - The safest approach: keep the `usePermissions()` function and its matrix as-is but mark them `@deprecated`. After Task 1 above removes all call sites, the dead code can optionally be cleaned up. The key is removing the TODO comment and ensuring `UserRole` doesn't appear in the types/index.ts re-export if it's unused.
  </action>
  <verify>
1. `npm run type-check` passes
2. `npm run build` passes
3. Grep for `TODO Phase 62` across entire codebase (excluding .planning/ directory) — zero results
4. Grep for `role check` in deactivate-user/route.ts and reactivate-user/route.ts — zero results (replaced with permission check)
5. Server actions query `user_permissions` table for authorization
  </verify>
  <done>
Server actions enforce permission checks via user_permissions table. Admin API routes reject non-admin callers with 403. PO cancel/unlock reject callers without Edit on PO. All TODO Phase 62 markers in server code resolved. Legacy UserRole cleaned up.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` — zero TypeScript errors
2. `npm run build` — clean build
3. Grep for `TODO Phase 62` across codebase (excluding .planning/) — zero results
4. Grep for `usePermissions()` (legacy hook calls) across app/ AND components/ directories — zero results
5. Grep for `canApprove = false` and `canExecute = false` — zero results (SOR page now uses real permission checks)
6. Server actions in deactivate-user, reactivate-user, and po-actions all query user_permissions
7. All admin CRUD pages use `canEdit("admin")` for button gating
</verification>

<success_criteria>
- A user with View on QMRL can see QMRL records but cannot see Edit/Create buttons
- A user with Edit on QMRL can see and use Edit/Create buttons
- A user with Block on PO cannot cancel or unlock POs even via direct API call (403 returned)
- The admin deactivate/reactivate APIs reject non-admin callers with 403
- SOR approve/execute buttons appear based on sor_l1/sor permission levels
- No legacy TODO Phase 62 markers remain in runtime code
- Build and type-check pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/62-frontend-permission-enforcement/62-02-SUMMARY.md`
</output>
