---
phase: 08-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/038_currency_constraints.sql
  - supabase/migrations/039_security_definer_hardening.sql
autonomous: true

must_haves:
  truths:
    - "Database rejects invalid currency codes on inventory transactions"
    - "Database rejects negative or zero exchange rates"
    - "SECURITY DEFINER functions are protected against search_path attacks"
  artifacts:
    - path: "supabase/migrations/038_currency_constraints.sql"
      provides: "Currency and exchange rate validation constraints"
      contains: "CHECK (currency IN"
    - path: "supabase/migrations/039_security_definer_hardening.sql"
      provides: "SET search_path protection for SECURITY DEFINER functions"
      contains: "SET search_path"
  key_links:
    - from: "inventory_transactions table"
      to: "currency constraint"
      via: "CHECK constraint"
      pattern: "CHECK.*currency.*IN"
    - from: "auto_stockout_on_qmhq_fulfilled()"
      to: "search_path protection"
      via: "SET search_path"
      pattern: "SET search_path = pg_catalog"
---

<objective>
Add currency validation constraints and harden SECURITY DEFINER functions against privilege escalation.

Purpose: Ensure database-layer validation for financial data integrity and security best practices for 2026. Currency codes and exchange rates must be validated at the database level to prevent corrupt WAC calculations.

Output: Two migration files that add constraints and security hardening without changing existing functionality.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-database-foundation/08-CONTEXT.md
@.planning/phases/08-database-foundation/08-RESEARCH.md
@supabase/migrations/023_inventory_transactions.sql
@supabase/migrations/034_qmhq_auto_stockout.sql
@supabase/migrations/026_audit_triggers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add currency validation constraints</name>
  <files>supabase/migrations/038_currency_constraints.sql</files>
  <action>
Create migration 038_currency_constraints.sql that adds:

1. CHECK constraint on inventory_transactions.currency:
   - Allowed values: 'USD', 'MMK', 'CNY', 'THB' (from CONTEXT.md decisions)
   - Use format: `CHECK (currency IN ('USD', 'MMK', 'CNY', 'THB'))`

2. CHECK constraint on inventory_transactions.exchange_rate:
   - Must be positive: `CHECK (exchange_rate > 0)`

3. ADD business rule constraint:
   - USD transactions must have exchange_rate = 1.0
   - Format: `CHECK (currency != 'USD' OR exchange_rate = 1.0)`

Use `ALTER TABLE ... ADD CONSTRAINT` syntax since table already exists.
Include `DROP CONSTRAINT IF EXISTS` before ADD to make migration idempotent.

Add comments explaining each constraint's purpose.
  </action>
  <verify>
Run `npx supabase db reset` to apply migrations. Verify constraints exist:
```sql
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name LIKE '%currency%' OR constraint_name LIKE '%exchange%';
```
  </verify>
  <done>
- Migration file exists with correct constraint syntax
- Constraints enforce: currency in (USD, MMK, CNY, THB), exchange_rate > 0, USD has rate 1.0
- Migration is idempotent (can run multiple times)
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden SECURITY DEFINER functions</name>
  <files>supabase/migrations/039_security_definer_hardening.sql</files>
  <action>
Create migration 039_security_definer_hardening.sql that updates existing SECURITY DEFINER functions to include `SET search_path` protection.

Functions to update:
1. `auto_stockout_on_qmhq_fulfilled()` from migration 034
2. `create_audit_log()` from migration 026

For each function:
- Use `CREATE OR REPLACE FUNCTION` (preserves existing behavior)
- Add `SET search_path = pg_catalog, public` as function attribute
- Keep all existing function body code identical
- The SET clause goes AFTER the language declaration:

```sql
CREATE OR REPLACE FUNCTION function_name()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
AS $$
BEGIN
  -- existing function body
END;
$$;
```

Read the existing function definitions from migrations 034 and 026 to copy the exact function bodies.

Include comment explaining why this security measure is important (2026 best practice to prevent privilege escalation via malicious schema objects).
  </action>
  <verify>
Run `npx supabase db reset`. Verify functions have search_path set:
```sql
SELECT proname, prosecdef, proconfig
FROM pg_proc
WHERE proname IN ('auto_stockout_on_qmhq_fulfilled', 'create_audit_log')
  AND prosecdef = true;
```
The proconfig column should show 'search_path=pg_catalog, public'.
  </verify>
  <done>
- Migration file exists with updated function definitions
- Both functions have `SET search_path = pg_catalog, public`
- Existing functionality unchanged (trigger behaviors work as before)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Currency constraint test:
```sql
-- This should fail:
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, currency, exchange_rate)
VALUES ('inventory_in', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 10, 'INVALID', 1.0);
-- Error: check constraint violated

-- This should succeed (with valid item/warehouse IDs):
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, currency, exchange_rate)
VALUES ('inventory_in', valid_item_id, valid_warehouse_id, 10, 'MMK', 4500.00);
```

2. Exchange rate constraint test:
```sql
-- This should fail:
INSERT INTO inventory_transactions (..., exchange_rate) VALUES (..., -1.0);
-- Error: check constraint violated
```

3. USD rate constraint test:
```sql
-- This should fail:
INSERT INTO inventory_transactions (..., currency, exchange_rate) VALUES (..., 'USD', 4500.00);
-- Error: USD must have exchange_rate = 1.0
```

4. SECURITY DEFINER functions still work:
- QMHQ item route status change to 'done' still triggers auto stock-out
- Audit logs still created on table changes
</verification>

<success_criteria>
- [ ] Migration 038 adds three CHECK constraints to inventory_transactions
- [ ] Migration 039 hardens two SECURITY DEFINER functions with search_path
- [ ] All migrations run without error on `npx supabase db reset`
- [ ] Invalid currency codes rejected at database level
- [ ] Invalid exchange rates rejected at database level
- [ ] USD with non-1.0 exchange rate rejected
- [ ] Auto stock-out trigger still works correctly
- [ ] Audit triggers still work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-foundation/08-01-SUMMARY.md`
</output>
