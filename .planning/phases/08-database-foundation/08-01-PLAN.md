---
phase: 08-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/038_inventory_currency_constraints.sql
autonomous: true

must_haves:
  truths:
    - "Manual stock-in requires valid currency code"
    - "Manual stock-in requires positive exchange rate"
    - "SECURITY DEFINER functions have protected search_path"
  artifacts:
    - path: "supabase/migrations/038_inventory_currency_constraints.sql"
      provides: "Currency validation constraints and security fixes"
      contains: "check_valid_currency"
  key_links:
    - from: "inventory_transactions"
      to: "items.wac_*"
      via: "update_item_wac trigger"
      pattern: "UPDATE items.*wac_currency"
---

<objective>
Add database constraints for currency-aware manual stock-in and harden SECURITY DEFINER functions.

Purpose: Ensures manual stock-in operations include valid currency/exchange rate for accurate WAC calculation. Fixes security vulnerability in SECURITY DEFINER functions per 2026 PostgreSQL best practices.

Output: Migration file with CHECK constraints and search_path security fixes.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-database-foundation/08-RESEARCH.md

@supabase/migrations/024_inventory_wac_trigger.sql
@supabase/migrations/034_qmhq_auto_stockout.sql
@supabase/migrations/026_audit_triggers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency validation migration</name>
  <files>supabase/migrations/038_inventory_currency_constraints.sql</files>
  <action>
Create migration file with:

1. Add CHECK constraint for valid currency codes on inventory_transactions:
```sql
ALTER TABLE inventory_transactions
ADD CONSTRAINT check_valid_currency
CHECK (currency IS NULL OR currency IN ('MMK', 'USD', 'EUR', 'THB', 'SGD'));
```
Note: Allow NULL for backward compatibility with existing records, and exclude 'EUSD' since that's a calculated value not a source currency.

2. Add CHECK constraint for positive exchange rate:
```sql
ALTER TABLE inventory_transactions
ADD CONSTRAINT check_positive_exchange_rate
CHECK (exchange_rate IS NULL OR exchange_rate > 0);
```

3. Fix SECURITY DEFINER function `auto_stockout_on_qmhq_fulfilled` to include search_path:
```sql
CREATE OR REPLACE FUNCTION auto_stockout_on_qmhq_fulfilled()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
AS $$
-- Copy exact function body from migration 034
$$;
```

4. Fix SECURITY DEFINER function `create_audit_log` to include search_path:
```sql
CREATE OR REPLACE FUNCTION public.create_audit_log()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
AS $$
-- Copy exact function body from migration 026
$$;
```

Include appropriate comments explaining the security rationale.
  </action>
  <verify>
Run `npx supabase db reset` to apply migrations.
Check migration applies without errors.
Verify constraints exist: Query pg_constraint for check_valid_currency and check_positive_exchange_rate.
  </verify>
  <done>
Migration 038 exists with currency CHECK constraints and SECURITY DEFINER functions have SET search_path protection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test constraint enforcement</name>
  <files>supabase/migrations/038_inventory_currency_constraints.sql</files>
  <action>
Verify constraints work by attempting test inserts in Supabase SQL editor or via npx supabase db reset with test data:

1. Test valid insert should succeed:
```sql
-- Should work
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, currency, exchange_rate, status, transaction_date)
SELECT 'inventory_in', id, (SELECT id FROM warehouses LIMIT 1), 10, 'MMK', 1.0000, 'completed', CURRENT_DATE
FROM items LIMIT 1;
```

2. Test invalid currency should fail:
```sql
-- Should fail with check constraint violation
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, currency, exchange_rate, status, transaction_date)
SELECT 'inventory_in', id, (SELECT id FROM warehouses LIMIT 1), 10, 'INVALID', 1.0000, 'completed', CURRENT_DATE
FROM items LIMIT 1;
```

3. Test negative exchange rate should fail:
```sql
-- Should fail with check constraint violation
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, currency, exchange_rate, status, transaction_date)
SELECT 'inventory_in', id, (SELECT id FROM warehouses LIMIT 1), 10, 'USD', -0.5, 'completed', CURRENT_DATE
FROM items LIMIT 1;
```

4. Test NULL values (backward compatibility) should succeed:
```sql
-- Should work (NULL is allowed for backward compatibility)
INSERT INTO inventory_transactions (movement_type, item_id, warehouse_id, quantity, status, transaction_date)
SELECT 'inventory_in', id, (SELECT id FROM warehouses LIMIT 1), 5, 'completed', CURRENT_DATE
FROM items LIMIT 1;
```

Clean up test data after verification.
  </action>
  <verify>
Valid currency inserts succeed.
Invalid currency inserts fail with check constraint violation.
Negative/zero exchange rate inserts fail.
NULL currency/exchange_rate inserts succeed (backward compatibility).
  </verify>
  <done>
CHECK constraints correctly enforce valid currency codes and positive exchange rates while allowing NULL for backward compatibility.
  </done>
</task>

</tasks>

<verification>
- Migration 038 applies cleanly via `npx supabase db reset`
- pg_constraint shows check_valid_currency and check_positive_exchange_rate
- SECURITY DEFINER functions have search_path set
- Invalid currency/exchange_rate values are rejected
- NULL values are accepted for backward compatibility
</verification>

<success_criteria>
1. Database rejects invalid currency codes (not in MMK, USD, EUR, THB, SGD)
2. Database rejects non-positive exchange rates
3. Existing records with NULL currency/exchange_rate remain valid
4. SECURITY DEFINER functions are protected against search_path exploitation
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-foundation/08-01-SUMMARY.md`
</output>
