---
phase: 22-po-inline-creation-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/qmhq/new/page.tsx
  - app/(dashboard)/qmhq/new/[route]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Contact Person field shows required asterisk for Expense and PO routes"
    - "Form blocks submission if contact person is not selected for Expense route"
    - "Form blocks submission if contact person is not selected for PO route"
    - "Error message appears inline below the field after blur without selection"
    - "Page scrolls to contact person field on submit validation failure"
    - "Toast notification shows validation error on submit failure"
  artifacts:
    - path: "app/(dashboard)/qmhq/new/page.tsx"
      provides: "Contact person validation state and required indicator for financial routes"
      contains: "contactPersonError"
    - path: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      provides: "Submit validation with scroll-to-error for contact person"
      contains: "scrollIntoView"
  key_links:
    - from: "app/(dashboard)/qmhq/new/page.tsx"
      to: "sessionStorage qmhq_draft"
      via: "contact_person_id stored in draft"
      pattern: "contact_person_id"
    - from: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      to: "handleSubmit validation"
      via: "Contact person check before API call"
      pattern: "contact_person_id.*required"
---

<objective>
Add contact person validation for QMHQ Expense and PO routes with blur-triggered errors and scroll-to-error on submit.

Purpose: Ensure financial transactions have an accountable contact person for audit trail and communication purposes.
Output: QMHQ forms enforce contact person selection for Expense and PO routes with clear user feedback.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-po-inline-creation-validation/22-CONTEXT.md
@.planning/phases/22-po-inline-creation-validation/22-RESEARCH.md
@app/(dashboard)/qmhq/new/page.tsx
@app/(dashboard)/qmhq/new/[route]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contact person validation in QMHQ Step 1</name>
  <files>app/(dashboard)/qmhq/new/page.tsx</files>
  <action>
Add validation state and required indicator for contact person field when Expense or PO route is selected:

1. Add state for validation:
   ```tsx
   const [contactPersonTouched, setContactPersonTouched] = useState(false);
   const [contactPersonError, setContactPersonError] = useState<string | null>(null);
   const contactPersonRef = useRef<HTMLDivElement>(null);
   ```
   Add import: `import { useRef } from "react";` (add to existing import)

2. Add validation function:
   ```tsx
   const validateContactPerson = (): boolean => {
     // Only required for expense and po routes
     if (formData.route_type === 'expense' || formData.route_type === 'po') {
       if (!formData.contact_person_id) {
         setContactPersonError("Contact person is required for financial routes");
         return false;
       }
     }
     setContactPersonError(null);
     return true;
   };
   ```

3. Update the Contact Person label to show required asterisk conditionally:
   ```tsx
   <Label htmlFor="contact_person_id" className="data-label">
     Contact Person
     {(formData.route_type === 'expense' || formData.route_type === 'po') && (
       <span className="text-red-400"> *</span>
     )}
   </Label>
   ```

4. Wrap the contact person select in a div with ref:
   ```tsx
   <div ref={contactPersonRef} className="grid gap-2">
   ```

5. Update the Select for contact person to handle blur validation:
   - Add onOpenChange to detect when dropdown closes without selection:
     ```tsx
     onOpenChange={(open) => {
       if (!open && !formData.contact_person_id) {
         setContactPersonTouched(true);
         if (formData.route_type === 'expense' || formData.route_type === 'po') {
           validateContactPerson();
         }
       }
     }}
     ```
   - When value changes, re-validate if touched:
     ```tsx
     onValueChange={(value) => {
       setFormData({ ...formData, contact_person_id: value === "none" ? "" : value });
       if (contactPersonTouched) {
         // Clear error when user selects a value
         if (value && value !== "none") {
           setContactPersonError(null);
         } else if (formData.route_type === 'expense' || formData.route_type === 'po') {
           setContactPersonError("Contact person is required for financial routes");
         }
       }
     }}
     ```

6. Add error border to SelectTrigger when error exists:
   - Import cn: add to existing import from "@/lib/utils"
   ```tsx
   <SelectTrigger className={cn(
     "bg-slate-800/50 border-slate-700",
     contactPersonTouched && contactPersonError && "border-red-400"
   )}>
   ```

7. Add inline error message below the Select (inside the div with ref):
   ```tsx
   {contactPersonTouched && contactPersonError && (
     <p className="text-sm text-red-400 flex items-center gap-1 mt-1">
       <AlertCircle className="h-3 w-3" />
       {contactPersonError}
     </p>
   )}
   ```
   Note: AlertCircle is already imported.

8. Clear error when route type changes (in route card onClick):
   ```tsx
   onClick={() => {
     setFormData({ ...formData, route_type: route.value });
     // Clear contact person error when switching routes
     setContactPersonError(null);
     setContactPersonTouched(false);
   }}
   ```

9. Update handleNext to validate before navigation:
   ```tsx
   const handleNext = () => {
     // Existing validations...

     // Validate contact person for financial routes
     if (formData.route_type === 'expense' || formData.route_type === 'po') {
       setContactPersonTouched(true);
       const isValid = validateContactPerson();
       if (!isValid) {
         contactPersonRef.current?.scrollIntoView({
           behavior: 'smooth',
           block: 'center'
         });
         toast({
           title: "Validation Error",
           description: "Please select a contact person for financial routes.",
           variant: "destructive",
         });
         return;
       }
     }

     // Existing sessionStorage and navigation...
   };
   ```
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Run dev server, go to /qmhq/new
3. Select PO or Expense route - verify asterisk appears on Contact Person label
4. Click Next without selecting contact person - verify:
   - Error border appears on dropdown
   - Error message appears below field
   - Toast shows validation error
   - Page scrolls to contact person field
5. Select contact person, click Next - verify navigation proceeds
6. Switch to Item route - verify asterisk disappears and error clears
  </verify>
  <done>
QMHQ Step 1 form shows required indicator for contact person on financial routes and validates before proceeding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add contact person validation in QMHQ Step 2</name>
  <files>app/(dashboard)/qmhq/new/[route]/page.tsx</files>
  <action>
Add server-side style validation in the route details page to double-check contact person before submit:

1. The contact person is stored in draftData from sessionStorage. Add validation in handleSubmit:

   Find the handleSubmit function and add validation after the existing route-specific validation:
   ```tsx
   const handleSubmit = async () => {
     if (!draftData || !user?.id) {
       // existing code...
       return;
     }

     // Existing route validations...

     // Contact person validation for financial routes
     if (route === "expense" || route === "po") {
       if (!draftData.contact_person_id) {
         toast({
           title: "Validation Error",
           description: "Contact person is required for financial routes. Please go back and select one.",
           variant: "destructive",
         });
         return;
       }
     }

     setIsSubmitting(true);
     // rest of existing submit logic...
   };
   ```

2. This is a guard against edge cases (direct URL navigation, tampered sessionStorage). The primary validation happens in Step 1, but this ensures data integrity.

Note: No UI changes needed in Step 2 since contact person is selected in Step 1. This is just a backend validation guard.
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Manual test: Go through flow normally - should work as before
3. Edge case test:
   - Start QMHQ creation with Expense route
   - Select contact person, proceed to Step 2
   - Go back to Step 1, change to remove contact person, navigate directly to /qmhq/new/expense
   - Try to submit - should show validation error toast
  </verify>
  <done>
QMHQ Step 2 validates contact person presence before submission for financial routes as a safety guard.
  </done>
</task>

</tasks>

<verification>
1. Full workflow test for Expense route:
   - Create new QMHQ, select Expense route
   - Try to proceed without contact person - blocked with error
   - Select contact person, proceed to Step 2
   - Complete expense details and submit - succeeds
2. Full workflow test for PO route:
   - Create new QMHQ, select PO route
   - Try to proceed without contact person - blocked with error
   - Select contact person, proceed to Step 2
   - Complete PO budget details and submit - succeeds
3. Item route unaffected:
   - Create new QMHQ, select Item route
   - No asterisk on contact person, can proceed without selection
4. Type checking passes: `npm run type-check`
</verification>

<success_criteria>
1. Contact Person field shows asterisk (*) when Expense or PO route is selected
2. Blur on contact person field without selection shows inline error for financial routes
3. Submit blocked with toast + scroll-to-error when contact person missing
4. Error clears when valid contact person is selected
5. Error clears when switching to Item route (non-financial)
6. Step 2 has guard validation preventing submission without contact person
</success_criteria>

<output>
After completion, create `.planning/phases/22-po-inline-creation-validation/22-02-SUMMARY.md`
</output>
