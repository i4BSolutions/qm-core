---
phase: 22-po-inline-creation-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/item/item-dialog.tsx
  - components/po/po-line-items-table.tsx
  - app/(dashboard)/po/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click [+] button next to item selector in PO line item row"
    - "Dialog opens with full item creation form (name, category, price reference, photo)"
    - "After item creation, dialog closes and new item is auto-selected in the line"
    - "Toast success message appears after item creation"
    - "Available items list refreshes to include newly created item"
  artifacts:
    - path: "app/(dashboard)/item/item-dialog.tsx"
      provides: "Modified onClose callback that returns created item"
      contains: "onClose: (refresh?: boolean, newItem?: Item)"
    - path: "components/po/po-line-items-table.tsx"
      provides: "Plus button trigger and ItemDialog integration"
      contains: "ItemDialog"
    - path: "app/(dashboard)/po/new/page.tsx"
      provides: "Item list refresh after creation"
      contains: "onItemCreated"
  key_links:
    - from: "components/po/po-line-items-table.tsx"
      to: "app/(dashboard)/item/item-dialog.tsx"
      via: "ItemDialog component with onClose callback"
      pattern: "onClose.*newItem"
    - from: "components/po/po-line-items-table.tsx"
      to: "app/(dashboard)/po/new/page.tsx"
      via: "onItemCreated callback prop"
      pattern: "onItemCreated\\?\\."
---

<objective>
Add inline item creation capability to PO line items table via [+] button that opens existing ItemDialog.

Purpose: Users can create new items during PO entry without leaving the form, improving workflow efficiency.
Output: Modified ItemDialog with return value, enhanced PO line items table with create button and dialog integration.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-po-inline-creation-validation/22-CONTEXT.md
@.planning/phases/22-po-inline-creation-validation/22-RESEARCH.md
@app/(dashboard)/item/item-dialog.tsx
@components/po/po-line-items-table.tsx
@app/(dashboard)/po/new/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify ItemDialog to return created item</name>
  <files>app/(dashboard)/item/item-dialog.tsx</files>
  <action>
Update ItemDialog component to pass the newly created item back via onClose callback:

1. Update ItemDialogProps interface:
   - Change `onClose: (refresh?: boolean) => void` to `onClose: (refresh?: boolean, newItem?: Item) => void`

2. Modify handleSubmit for CREATE case (not update):
   - After successful insert, fetch the created item with `.select().single()` (change from just `.insert(data)`)
   - Pass the created item to onClose: `onClose(true, newItem as Item)`

3. Keep UPDATE case unchanged - still calls `onClose(true)` without newItem

4. Add discard confirmation per user decision:
   - Add state: `const [hasChanges, setHasChanges] = useState(false)`
   - Track changes in formData by comparing to initial state
   - Before closing (cancel button or X), if hasChanges is true and not submitting, show confirm dialog: "You have unsaved changes. Discard them?"
   - Use window.confirm() for simplicity (no need for custom modal)

Note: SKU is auto-generated by database trigger, so hide SKU field in create mode (already handled - item?.sku check).
  </action>
  <verify>
1. TypeScript compiles without errors: `npm run type-check`
2. Grep for new signature: `grep -n "newItem?: Item" app/(dashboard)/item/item-dialog.tsx`
3. Verify .select().single() is used: `grep -n "select.*single" app/(dashboard)/item/item-dialog.tsx`
  </verify>
  <done>
ItemDialog onClose callback includes optional newItem parameter, and successful creation passes the item back to caller.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline creation to PO line items table</name>
  <files>components/po/po-line-items-table.tsx, app/(dashboard)/po/new/page.tsx</files>
  <action>
Update EditableLineItemsTable component to add [+] button and ItemDialog trigger:

1. In po-line-items-table.tsx:
   - Add import: `import { ItemDialog } from "@/app/(dashboard)/item/item-dialog";`
   - Add import: `import { Plus as PlusIcon } from "lucide-react";` (rename to avoid conflict with existing Plus for quantity)
   - Add props: `onItemCreated?: (newItem: Item) => void;` to EditableLineItemsTableProps
   - Add state: `const [createDialogOpen, setCreateDialogOpen] = useState(false);`
   - Add state: `const [pendingLineId, setPendingLineId] = useState<string | null>(null);`

2. Add handler function:
   ```tsx
   const handleItemCreated = (newItem: Item) => {
     if (pendingLineId) {
       onUpdateItem(pendingLineId, "item_id", newItem.id);
       onUpdateItem(pendingLineId, "item_name", newItem.name);
       onUpdateItem(pendingLineId, "item_sku", newItem.sku || "");
       onUpdateItem(pendingLineId, "item_unit", newItem.default_unit || "");
     }
     onItemCreated?.(newItem);
     setCreateDialogOpen(false);
     setPendingLineId(null);
   };

   const handleCreateDialogClose = (refresh?: boolean, newItem?: Item) => {
     if (newItem) {
       handleItemCreated(newItem);
     } else {
       setCreateDialogOpen(false);
       setPendingLineId(null);
     }
   };
   ```

3. In the item selector cell (where Select is), wrap in a flex container with [+] button:
   - Only show when item is NOT yet selected (inside the else branch where Select is rendered)
   - Add flex container: `<div className="flex gap-2">`
   - Keep existing Select, add Button after:
     ```tsx
     <Button
       type="button"
       variant="outline"
       size="icon"
       onClick={() => {
         setPendingLineId(item.id);
         setCreateDialogOpen(true);
       }}
       disabled={disabled}
       className="shrink-0 border-slate-700 hover:border-amber-500/50 hover:bg-amber-500/10"
       title="Create new item"
     >
       <PlusIcon className="h-4 w-4" />
     </Button>
     ```

4. Add ItemDialog at end of component (inside the fragment, after the Add Line Item button):
   ```tsx
   <ItemDialog
     open={createDialogOpen}
     onClose={handleCreateDialogClose}
     item={null}
   />
   ```

5. In po/new/page.tsx:
   - Add handler to refresh items list after creation:
     ```tsx
     const handleItemCreated = async (newItem: Item) => {
       // Add new item to available items list
       setItems(prev => [...prev, {
         id: newItem.id,
         name: newItem.name,
         sku: newItem.sku || null,
         default_unit: newItem.default_unit || null,
         price_reference: newItem.price_reference || null,
       }]);
     };
     ```
   - Pass to EditableLineItemsTable: `onItemCreated={handleItemCreated}`
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Run dev server and navigate to /po/new
3. Add a line item, verify [+] button appears next to item selector
4. Click [+], verify ItemDialog opens with title "Add Item"
5. Fill form (name required, category required, price reference required for new items)
6. Submit - verify toast shows, dialog closes, item is auto-selected in line
7. Verify new item appears in selector dropdown for other lines
  </verify>
  <done>
PO line items table has [+] button next to item selector that opens ItemDialog, and created items are auto-selected and added to available items list.
  </done>
</task>

</tasks>

<verification>
1. Full workflow test:
   - Go to /po/new
   - Select a QMHQ with balance
   - Fill required header fields (supplier, currency)
   - In line items, click [+] next to item selector
   - Create item with: Name, Category, Price Reference
   - Verify: Toast success, dialog closes, item selected in line, item in dropdown
2. Type checking passes: `npm run type-check`
3. Build succeeds: `npm run build`
</verification>

<success_criteria>
1. [+] button visible next to item selector in PO line item rows
2. Clicking [+] opens ItemDialog modal with "Add Item" title
3. Creating item shows toast and auto-selects in triggering line
4. New item immediately available in item selector for other lines
5. Discard confirmation appears when closing dialog with unsaved changes
</success_criteria>

<output>
After completion, create `.planning/phases/22-po-inline-creation-validation/22-01-SUMMARY.md`
</output>
