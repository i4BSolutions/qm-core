---
phase: 61-permission-management-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/admin/permission-matrix.tsx
  - app/(dashboard)/admin/users/page.tsx
  - app/(dashboard)/admin/users/user-dialog.tsx
  - app/(dashboard)/admin/users/permissions-tab.tsx
autonomous: true
requirements:
  - PERM-02
  - PERM-04
  - PERM-11

must_haves:
  truths:
    - "Admin can open a user's detail and see a Permissions tab showing all 16 resources with Edit/View/Block radio buttons"
    - "Admin can change any permission level and click Save All to atomically update all 16 rows in user_permissions"
    - "When admin edits their own profile, the Admin resource row has disabled radio buttons with a tooltip explaining lockout prevention"
    - "Changed rows show a dirty state indicator before saving"
    - "Set All Edit / Set All View / Set All Block buttons above the matrix overwrite all resources with confirmation"
    - "Unsaved changes trigger a warning dialog when navigating away"
    - "Toast notification shows on successful save"
  artifacts:
    - path: "components/admin/permission-matrix.tsx"
      provides: "Reusable permission matrix component with radio button grid"
      min_lines: 100
    - path: "app/(dashboard)/admin/users/permissions-tab.tsx"
      provides: "Permissions tab wired to user detail page"
      min_lines: 50
  key_links:
    - from: "components/admin/permission-matrix.tsx"
      to: "types/database.ts"
      via: "PERMISSION_RESOURCES, PERMISSION_RESOURCE_LABELS, PermissionResource, PermissionLevel"
      pattern: "import.*PERMISSION_RESOURCES.*from.*types/database"
    - from: "app/(dashboard)/admin/users/permissions-tab.tsx"
      to: "components/admin/permission-matrix.tsx"
      via: "PermissionMatrix component import"
      pattern: "import.*PermissionMatrix.*from"
    - from: "app/(dashboard)/admin/users/permissions-tab.tsx"
      to: "supabase user_permissions table"
      via: "fetch and upsert via createClient()"
      pattern: "from.*user_permissions"
---

<objective>
Build the permission matrix component and wire it into the existing user management page as a Permissions tab, enabling admins to view and edit per-user permissions for all 16 resources.

Purpose: PERM-02 (admin manages permissions via matrix UI), PERM-04 (edit existing user permissions), and PERM-11 (lockout prevention for own Admin Edit permission).

Output: Reusable PermissionMatrix component + PermissionsTab page component + updated user list page with edit flow that opens permissions.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-permission-schema-migration/59-01-SUMMARY.md
@.planning/phases/61-permission-management-ui/61-CONTEXT.md

@types/database.ts — PermissionResource, PermissionLevel, PERMISSION_RESOURCES, PERMISSION_RESOURCE_LABELS, PERMISSION_LEVEL_LABELS, UserPermission
@app/(dashboard)/admin/users/page.tsx — existing user management page
@app/(dashboard)/admin/users/user-dialog.tsx — existing user edit dialog (will be modified)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable PermissionMatrix component</name>
  <files>components/admin/permission-matrix.tsx</files>
  <action>
Create a client component at `components/admin/permission-matrix.tsx` that renders the 16-resource permission matrix grid.

**Props interface:**
```typescript
interface PermissionMatrixProps {
  permissions: Record<PermissionResource, PermissionLevel>;  // current state
  onChange: (resource: PermissionResource, level: PermissionLevel) => void;
  dirtyResources?: Set<PermissionResource>;  // which rows have been changed
  disabledResources?: Set<PermissionResource>;  // which rows are read-only (lockout)
  disabledTooltip?: string;  // tooltip text for disabled rows
  mode: 'edit' | 'create';  // edit = existing user, create = new user
}
```

**Layout (per CONTEXT.md locked decisions):**
- Flat list of all 16 resources from `PERMISSION_RESOURCES` array (NOT grouped by module)
- Resources ordered by the existing `PERMISSION_RESOURCES` array (logical workflow order: QMRL -> QMHQ -> PO -> Invoice -> Inventory -> Admin)
- Each row: human-friendly label from `PERMISSION_RESOURCE_LABELS` + 3 radio buttons (Edit / View / Block)
- Sticky header row with Edit / View / Block column labels
- In create mode, unset resources have no radio selected; in edit mode, all should have a value

**Visual treatment:**
- Radio button group per row using native `<input type="radio">` styled with Tailwind (or shadcn RadioGroup if available — check components/ui)
- Minimal color coding: only Block highlighted in red (text-red-400), Edit and View are neutral
- Changed (dirty) rows show subtle highlight: `bg-amber-500/5 border-l-2 border-l-amber-500` (Claude's discretion on exact styling)
- Disabled rows (lockout): radio inputs have `disabled` attribute, row has `opacity-60`, show Tooltip on hover with `disabledTooltip` text
- In create mode, unset resource rows: slightly muted opacity (`opacity-70`) until a selection is made

**Set All buttons:**
- Render 3 buttons above the matrix: "Set All Edit", "Set All View", "Set All Block"
- Clicking any Set All triggers the `onChange` callback for every resource (the parent handles confirmation dialog)
- These are small outline-style buttons

**Implementation notes:**
- Import `PERMISSION_RESOURCES`, `PERMISSION_RESOURCE_LABELS`, `PERMISSION_LEVEL_LABELS` from `@/types/database`
- Import `Tooltip` from `@/components/ui/tooltip` for disabled row explanation
- Use `overflow-x-auto` wrapper for responsive table on narrow screens
- The header row with Edit/View/Block should use `sticky top-0 z-10 bg-slate-900` (matching dark theme)
- No Supabase calls in this component — it is purely presentational/controlled

Check if shadcn RadioGroup exists at `components/ui/radio-group.tsx`. If not, use native HTML radio inputs with Tailwind styling:
```tsx
<input type="radio" name={`perm-${resource}`} checked={level === 'edit'} onChange={...}
  className="h-4 w-4 accent-slate-400" />
```
  </action>
  <verify>
Run `npm run type-check` — no TypeScript errors. Visually confirm the component file exists and exports PermissionMatrix.
  </verify>
  <done>
A PermissionMatrix component exists that renders all 16 resources with radio buttons for Edit/View/Block, supports dirty state indicators, disabled rows with tooltips, and Set All buttons. It is a controlled component accepting permissions state and onChange callback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionsTab and integrate into user management page</name>
  <files>
    app/(dashboard)/admin/users/permissions-tab.tsx
    app/(dashboard)/admin/users/page.tsx
    app/(dashboard)/admin/users/user-dialog.tsx
  </files>
  <action>
**Create `permissions-tab.tsx`:**

A client component that wraps PermissionMatrix with data fetching, saving, and lockout logic.

Props: `{ userId: string; userName: string; isSelf: boolean; onClose: () => void }`

**Behavior:**
1. On mount, fetch from `supabase.from('user_permissions').select('*').eq('user_id', userId)`
2. Build a `Record<PermissionResource, PermissionLevel>` from the fetched rows (16 rows)
3. Track `initialPermissions` (snapshot at load) and `currentPermissions` (live edits)
4. Track `dirtyResources: Set<PermissionResource>` — computed by comparing initial vs current
5. If `isSelf` is true, add `'admin'` to `disabledResources` set and pass `disabledTooltip="You cannot remove your own admin access"`

**Set All with confirmation:**
- When user clicks any Set All button in PermissionMatrix, show a `window.confirm()` dialog: "Set all 16 resources to [Level]? This will overwrite all current selections."
- On confirm, update all resources in currentPermissions (except disabled ones if isSelf — admin stays as-is)

**Save All button:**
- Single "Save All" button below the matrix
- Disabled when `dirtyResources.size === 0`
- On click: upsert all 16 permission rows atomically using `supabase.from('user_permissions').upsert(rows, { onConflict: 'user_id,resource' })`
- The upsert payload: map all 16 resources to `{ user_id: userId, resource, level: currentPermissions[resource] }`
- On success: toast "Permissions updated for [userName]", reset dirty state
- On error: toast destructive with error message

**Lockout prevention (PERM-11):**
- When `isSelf` is true and admin tries to change Admin resource to View or Block via Set All, skip the admin resource (keep it at current level)
- The PermissionMatrix already handles disabling the row visually

**Unsaved changes warning:**
- Use `useEffect` with `beforeunload` event listener when `dirtyResources.size > 0`
- Return cleanup function to remove listener

**Update `page.tsx`:**
- Replace the static Role column in the DataTable with a "Permissions" column that shows a small summary (e.g., count of Edit/View/Block permissions, or just a "Manage" link)
- Add a `selectedUser` state and `permissionsOpen` state
- When user clicks "Permissions" in the dropdown menu (add new DropdownMenuItem with Shield icon), set selectedUser and open the permissions panel
- Render PermissionsTab conditionally when `permissionsOpen && selectedUser` — display it in a full-width panel below the table (or as a slide-over panel using a Dialog with larger width `sm:max-w-[700px]`)
- Use a Dialog (existing pattern) to show the permissions tab as a modal with the user's name in the header

**Update `user-dialog.tsx`:**
- Remove the role dropdown entirely (it was already non-functional after Phase 60)
- Remove the `role` field from formData state
- Remove the `roles` constant and role-related imports
- Remove the role from the invite-user API call body
- The department field now spans the full width instead of grid-cols-2
- Keep the rest of the form (email, name, department, phone) as-is — permission assignment for new users is handled in Plan 02

**Remove stale role stats from `page.tsx`:**
- Remove the 3 role-count stat cards (Admin, QMRL Users, QMHQ Users) — they show 0 since Phase 60 dropped the role column
- Keep only the Total Users card with Active/Inactive split
- The stats grid changes from `grid-cols-4` to a single card (or simple display)
  </action>
  <verify>
Run `npm run type-check` — no TypeScript errors. Run `npm run build` — no build errors. Confirm that:
1. `permissions-tab.tsx` exists and imports PermissionMatrix
2. `page.tsx` has a Permissions menu item in the dropdown
3. `user-dialog.tsx` no longer has a role dropdown
  </verify>
  <done>
Admin can click "Permissions" on any user row to open a dialog showing all 16 resources with Edit/View/Block radio buttons. Changes are tracked with dirty state, saved atomically via upsert, and the Admin resource is locked when editing own profile. The old role dropdown is removed from the user edit dialog. Stale role stat cards are removed.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with zero errors
2. `npm run build` completes successfully
3. `components/admin/permission-matrix.tsx` exists and exports PermissionMatrix
4. `app/(dashboard)/admin/users/permissions-tab.tsx` exists and imports PermissionMatrix
5. `app/(dashboard)/admin/users/page.tsx` has a Permissions dropdown menu item
6. `app/(dashboard)/admin/users/user-dialog.tsx` has no role dropdown
7. The Admin resource row is disabled when editing own profile (lockout prevention)
</verification>

<success_criteria>
- PermissionMatrix renders 16 resource rows with radio buttons for Edit/View/Block
- PermissionsTab fetches, displays, and saves permissions atomically
- Dirty state tracking shows changed rows
- Set All buttons work with confirmation
- Lockout prevention disables Admin row for self-edit
- Role dropdown removed from user dialog
- Stale role stat cards removed from user list page
- TypeScript compiles clean, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/61-permission-management-ui/61-01-SUMMARY.md`
</output>
