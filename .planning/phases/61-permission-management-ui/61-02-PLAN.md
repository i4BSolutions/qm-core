---
phase: 61-permission-management-ui
plan: 02
type: execute
wave: 2
depends_on:
  - 61-01
files_modified:
  - app/(dashboard)/admin/users/user-dialog.tsx
  - app/api/admin/invite-user/route.ts
autonomous: true
requirements:
  - PERM-03

must_haves:
  truths:
    - "When creating a new user, the form shows user detail fields at top and a permission matrix below"
    - "No default permission values are pre-selected — admin must explicitly choose Edit/View/Block for every resource"
    - "The Save button is disabled until all 16 resources have a level selected"
    - "An 'X/16 configured' counter is visible near the save button"
    - "Set All buttons are available on the creation form and fill all resources at once with confirmation"
    - "The created user has exactly 16 permission rows in user_permissions table"
  artifacts:
    - path: "app/(dashboard)/admin/users/user-dialog.tsx"
      provides: "User creation form with embedded permission matrix"
      min_lines: 100
    - path: "app/api/admin/invite-user/route.ts"
      provides: "API route that saves permissions alongside user creation"
      min_lines: 30
  key_links:
    - from: "app/(dashboard)/admin/users/user-dialog.tsx"
      to: "components/admin/permission-matrix.tsx"
      via: "PermissionMatrix component import in create mode"
      pattern: "import.*PermissionMatrix.*from"
    - from: "app/api/admin/invite-user/route.ts"
      to: "supabase user_permissions table"
      via: "insert permissions after user creation"
      pattern: "from.*user_permissions.*insert"
---

<objective>
Integrate the permission matrix into the user creation form so every new user gets explicit permissions assigned at creation time.

Purpose: PERM-03 — All 16 permissions must be set when creating a new user account.

Output: Updated user creation dialog with mandatory permission matrix section + API route that saves permissions atomically with user creation.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-permission-management-ui/61-CONTEXT.md
@.planning/phases/61-permission-management-ui/61-01-SUMMARY.md

@components/admin/permission-matrix.tsx — PermissionMatrix component (from Plan 01)
@app/(dashboard)/admin/users/user-dialog.tsx — modified in Plan 01 (role dropdown removed)
@app/api/admin/invite-user/route.ts — existing invite API
@types/database.ts — PermissionResource, PermissionLevel, PERMISSION_RESOURCES
</context>

<tasks>

<task type="auto">
  <name>Task 1: Embed permission matrix in user creation dialog</name>
  <files>app/(dashboard)/admin/users/user-dialog.tsx</files>
  <action>
Modify the existing `user-dialog.tsx` to include the PermissionMatrix component when in create mode (`isCreateMode === true`).

**Form structure (per CONTEXT.md: single-step form):**
- User detail fields at top (email, full_name, department, phone) — already exist
- Below the user fields, add a "Permissions" section header (`<h3 className="text-sm font-semibold text-slate-300 uppercase tracking-wider">Permissions</h3>`)
- Render `<PermissionMatrix mode="create" permissions={permissionState} onChange={handlePermissionChange} />` below the header
- No `disabledResources` or `dirtyResources` needed for create mode

**State management:**
- Add `permissions` state: `Record<PermissionResource, PermissionLevel | null>` initialized with all 16 resources set to `null` (unset)
- The PermissionMatrix in create mode should handle `null` values as "no radio selected"
- Update PermissionMatrix props if needed: the permissions Record should allow `null` in create mode to represent "not yet configured"
- Actually, simpler approach: use `Partial<Record<PermissionResource, PermissionLevel>>` — missing keys = unset
- Track `configuredCount`: count of resources that have a non-null level

**"X/16 configured" counter:**
- Display near the submit button: `<span className="text-xs text-slate-400">{configuredCount}/16 configured</span>`
- When all 16 are configured, show in green: `text-emerald-400`

**Save button disabled logic:**
- In create mode: disabled unless `configuredCount === 16 && email && full_name` (all resources configured + required fields filled)
- Button text: "Create User" (unchanged)

**Set All handling:**
- PermissionMatrix's Set All buttons call `onChange` for each resource
- In the dialog, wrap Set All in confirmation: `window.confirm("Set all 16 resources to [Level]? This will overwrite all current selections.")`
- Since PermissionMatrix calls onChange per-resource, the parent needs a way to intercept Set All. Two approaches:
  - Option A: Add `onSetAll?: (level: PermissionLevel) => void` prop to PermissionMatrix, which parent handles with confirmation
  - Option B: PermissionMatrix calls onChange 16 times, parent just accepts
  - Use Option A for cleaner UX: add `onSetAll` prop to PermissionMatrix. When user clicks Set All, PermissionMatrix calls `onSetAll(level)` instead of calling onChange 16 times. The parent shows confirmation, then loops and calls a bulk update.

**Submit handling:**
- On form submit, send permissions along with user data to the invite API:
  ```typescript
  body: JSON.stringify({
    email, full_name, department_id, phone,
    permissions: Object.entries(permissions)
      .filter(([_, level]) => level !== null)
      .map(([resource, level]) => ({ resource, level }))
  })
  ```

**Dialog sizing:**
- Increase dialog width for create mode to accommodate the matrix: `sm:max-w-[700px]` when `isCreateMode`, keep `sm:max-w-[500px]` for edit mode
- Add `max-h-[80vh] overflow-y-auto` to the dialog content body for scrolling when matrix is tall

**Edit mode:**
- In edit mode, do NOT show the permission matrix (permissions are managed via the separate Permissions dialog from Plan 01)
- The edit form stays compact with just user detail fields
  </action>
  <verify>
Run `npm run type-check` — no TypeScript errors. Confirm user-dialog.tsx imports PermissionMatrix and conditionally renders it in create mode.
  </verify>
  <done>
User creation form shows the permission matrix below user fields, requires all 16 resources to be configured before enabling the Create button, displays an X/16 counter, and sends permissions to the API on submit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update invite-user API to save permissions</name>
  <files>app/api/admin/invite-user/route.ts</files>
  <action>
Modify the invite-user API route to accept and save permission data when creating a new user.

**Request body changes:**
- Accept `permissions` array: `{ resource: PermissionResource; level: PermissionLevel }[]`
- Validate that permissions array has exactly 16 entries (one per resource from PERMISSION_RESOURCES)
- Validate that each resource is a valid PermissionResource and each level is a valid PermissionLevel
- If permissions are missing or incomplete, return 400 error: "All 16 permissions must be configured"

**After user invitation:**
1. After `supabaseAdmin.auth.admin.inviteUserByEmail(email, ...)` succeeds and `inviteData.user` exists
2. The `handle_new_user()` trigger already creates 16 Block rows for the new user
3. Upsert the permissions with the admin-specified levels:
   ```typescript
   const permissionRows = permissions.map(p => ({
     user_id: inviteData.user.id,
     resource: p.resource,
     level: p.level,
   }));

   const { error: permError } = await supabaseAdmin
     .from('user_permissions')
     .upsert(permissionRows, { onConflict: 'user_id,resource' });
   ```
4. If permission upsert fails, log the error but still return success (user is created, permissions can be fixed via the UI)
5. Include a warning in the response if permissions failed: `{ success: true, message: '...', permissionsSet: !permError }`

**Backward compatibility:**
- If `permissions` is not provided in the request body (e.g., called from an older client), skip the permission upsert and let the trigger's default Block values stand
- The `role` field in the request body should be ignored (it's no longer used)

**Remove stale code:**
- Remove the commented-out role check at the top of the function
- Remove the `role` destructuring from the request body
- Clean up TODO Phase 62 comments related to role (this IS the permission implementation)
  </action>
  <verify>
Run `npm run type-check` — no TypeScript errors. Run `npm run build` — no build errors. Confirm the route accepts permissions array and upserts to user_permissions table.
  </verify>
  <done>
The invite-user API accepts a permissions array with 16 entries, validates completeness, and upserts permission rows for the new user after invitation. Backward compatible if permissions are omitted.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with zero errors
2. `npm run build` completes successfully
3. User creation dialog shows permission matrix below user fields in create mode only
4. Save button is disabled until all 16 resources are configured + required fields filled
5. X/16 counter is visible near the save button
6. Set All buttons work with confirmation dialog
7. invite-user API accepts and saves 16 permissions alongside user creation
8. Edit mode dialog does NOT show the permission matrix (managed via separate Permissions dialog)
</verification>

<success_criteria>
- New user creation requires explicit configuration of all 16 permissions
- Permissions are saved atomically with user creation via API
- X/16 counter provides clear progress feedback
- Create dialog is wider to accommodate the matrix
- Edit dialog remains compact (permissions managed separately)
- TypeScript compiles clean, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/61-permission-management-ui/61-02-SUMMARY.md`
</output>
