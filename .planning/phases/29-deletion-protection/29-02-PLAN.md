---
phase: 29-deletion-protection
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - app/(dashboard)/item/page.tsx
  - app/(dashboard)/admin/statuses/page.tsx
  - app/(dashboard)/admin/categories/page.tsx
  - app/(dashboard)/admin/departments/page.tsx
  - app/(dashboard)/admin/contacts/page.tsx
  - app/(dashboard)/admin/suppliers/page.tsx
autonomous: true

must_haves:
  truths:
    - "Delete attempt on referenced entity shows error 'Cannot delete: this item is in use' in toast"
    - "Non-reference errors (e.g. network failure) still show original generic 'Failed to delete' message"
  artifacts:
    - path: "app/(dashboard)/item/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
    - path: "app/(dashboard)/admin/statuses/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
    - path: "app/(dashboard)/admin/categories/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
    - path: "app/(dashboard)/admin/departments/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
    - path: "app/(dashboard)/admin/contacts/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
    - path: "app/(dashboard)/admin/suppliers/page.tsx"
      provides: "Updated handleDelete with trigger error message display"
      contains: "Cannot delete"
  key_links:
    - from: "app/(dashboard)/item/page.tsx"
      to: "supabase/migrations/057_deletion_protection.sql"
      via: "Trigger error message surfaced through Supabase client error.message"
      pattern: "error\\.message.*Cannot delete"
---

<objective>
Update all 6 entity delete handlers to surface the database trigger error message ("Cannot delete: this item is in use") instead of showing generic "Failed to delete" text.

Purpose: Satisfy DPRT-07 by showing the user the exact reason their deletion was blocked.
Output: 6 updated page files with improved error handling in handleDelete functions.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-deletion-protection/29-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update handleDelete in all 6 entity pages to show trigger error messages</name>
  <files>
    app/(dashboard)/item/page.tsx
    app/(dashboard)/admin/statuses/page.tsx
    app/(dashboard)/admin/categories/page.tsx
    app/(dashboard)/admin/departments/page.tsx
    app/(dashboard)/admin/contacts/page.tsx
    app/(dashboard)/admin/suppliers/page.tsx
  </files>
  <action>
In each of the 6 pages, update the `handleDelete` function's error handling block to display `error.message` when it contains "Cannot delete", otherwise fall back to the generic message.

**Pattern to apply in each file:**

Replace this pattern:
```typescript
if (error) {
  toast({
    title: "Error",
    description: "Failed to delete {entity}.",
    variant: "destructive",
  });
}
```

With this pattern:
```typescript
if (error) {
  const isReferenceError = error.message?.includes("Cannot delete");
  toast({
    title: isReferenceError ? "Cannot Delete" : "Error",
    description: isReferenceError
      ? error.message
      : "Failed to delete {entity}.",
    variant: "destructive",
  });
}
```

Apply this change to exactly these files and their respective entity names:

1. **`app/(dashboard)/item/page.tsx`** — entity name: "item"
2. **`app/(dashboard)/admin/statuses/page.tsx`** — entity name: "status" (note: this function also has `isDefault` check before the Supabase call — keep that logic unchanged, only modify the `if (error)` block)
3. **`app/(dashboard)/admin/categories/page.tsx`** — entity name: "category"
4. **`app/(dashboard)/admin/departments/page.tsx`** — entity name: "department"
5. **`app/(dashboard)/admin/contacts/page.tsx`** — entity name: "contact person"
6. **`app/(dashboard)/admin/suppliers/page.tsx`** — entity name: "supplier"

Do NOT modify any other logic in these functions. Only change the error toast block.
  </action>
  <verify>
Run `npm run type-check` to ensure no TypeScript errors. Visually inspect each modified file to confirm only the error toast block changed.
  </verify>
  <done>
All 6 handleDelete functions display "Cannot delete: this item is in use" when the trigger blocks deactivation, and show the original generic error for other failures.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes
2. Each of the 6 files has updated error handling that checks `error.message?.includes("Cannot delete")`
3. Title changes to "Cannot Delete" for reference errors
4. Generic fallback message preserved for non-reference errors
5. No other logic in handleDelete functions was modified
</verification>

<success_criteria>
All 6 entity pages surface the trigger error message in the toast notification when deactivation is blocked by active references.
</success_criteria>

<output>
After completion, create `.planning/phases/29-deletion-protection/29-02-SUMMARY.md`
</output>
