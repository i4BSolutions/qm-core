---
phase: 40-ui-consistency-rollout
plan: 06
type: execute
wave: 4
depends_on: []
files_modified:
  - app/(dashboard)/invoice/new/page.tsx
  - app/(dashboard)/inventory/stock-in/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Invoice creation wizard uses FormSection composites for step content sections"
    - "Stock In form uses FormSection and FormField composites"
    - "Stock Out form uses FormSection and FormField composites with preserved quantity validation"
    - "Stock Out Request creation form uses FormSection and FormField composites"
    - "Multi-step wizard navigation and validation preserved in Invoice new"
    - "Dynamic warehouse stock validation preserved in Stock Out"
  artifacts:
    - path: "app/(dashboard)/invoice/new/page.tsx"
      provides: "Invoice wizard with FormSection composites"
      contains: "FormSection"
    - path: "app/(dashboard)/inventory/stock-in/page.tsx"
      provides: "Stock In form with composites"
      contains: "FormSection"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Stock Out form with composites"
      contains: "FormSection"
    - path: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      provides: "SOR create form with composites"
      contains: "FormSection"
  key_links:
    - from: "app/(dashboard)/invoice/new/page.tsx"
      to: "components/composite/form-section.tsx"
      via: "FormSection wrapping each wizard step content"
      pattern: "FormSection"
    - from: "app/(dashboard)/inventory/stock-out/page.tsx"
      to: "quantity validation logic"
      via: "validateQuantity preserved inside FormField children"
      pattern: "FormField.*error"
---

<objective>
Migrate 4 complex form pages (Invoice new wizard, Stock In, Stock Out, Stock Out Request new) to FormSection and FormField composites.

Purpose: Complete form migration coverage by tackling the highest-risk pages. These have multi-step wizards, dynamic validation, and complex state machines. Apply FormSection to step content and section panels while preserving all business logic.
Output: 4 complex form pages using composites with all wizards, validation, and domain logic preserved.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-ui-component-standardization/36-01-SUMMARY.md
@components/composite/form-section.tsx
@components/composite/form-field.tsx
@components/composite/page-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Invoice new wizard and Stock In form to FormSection composites</name>
  <files>
    app/(dashboard)/invoice/new/page.tsx
    app/(dashboard)/inventory/stock-in/page.tsx
  </files>
  <action>
**Invoice new - 3-step wizard** (~917 lines — HIGH RISK):
1. Read FULL file before any edits. Map out the step state machine:
   - Step 1: Invoice header (invoice no, dates, currency, exchange rate)
   - Step 2: PO selection (search open POs, available quantities)
   - Step 3: Line items (select items, quantity, unit price)
   - Step 4/Summary: Review and submit
2. Add import: `import { FormSection, FormField, PageHeader } from "@/components/composite";`
3. Replace the step page header with PageHeader:
   ```tsx
   <PageHeader
     title={`Step ${currentStep}: ${stepLabel}`}
     description="Create new invoice"
   />
   ```
4. For each step's content section, replace the command-panel wrapper with FormSection:
   ```tsx
   {currentStep === 1 && (
     <FormSection title="Invoice Header" icon={...}>
       <FormField label="Invoice Number" required>...</FormField>
       <FormField label="Invoice Date" required>...</FormField>
       {/* etc */}
     </FormSection>
   )}
   ```
5. CRITICAL PRESERVATION RULES:
   - Do NOT modify the step state machine (currentStep, setCurrentStep, handleNext, handleBack)
   - Do NOT modify step validation logic (validateStep1, validateStep2, etc.)
   - Do NOT modify the step indicator/progress bar JSX (keep as-is, or wrap in a div above PageHeader)
   - Do NOT modify PO selection search or available quantity display
   - Do NOT modify line items table (quantity inputs, unit price, subtotals)
   - Do NOT modify the summary review section
6. Only migrate: (a) The page title header, (b) Each step's content wrapper from command-panel to FormSection, (c) Simple field wrappers to FormField where the Label+Input pattern exists.
7. For line items tables within steps, use FormSection as wrapper but do NOT FormField-ify table cells.

**Stock In form** (~1107 lines — HIGH RISK):
1. Read FULL file. This form has:
   - Source selection (From Invoice or Manual)
   - Invoice selection mode: select invoice, auto-populate items/quantities
   - Manual mode: item selection, warehouse, quantity, unit cost
   - WAC calculation implications
2. Add import: `import { FormSection, FormField, PageHeader } from "@/components/composite";`
3. Replace page header with PageHeader.
4. Replace major form sections (source selection, invoice details, manual entry) with FormSection.
5. Replace simple field wrappers with FormField.
6. PRESERVE: Source mode toggle logic, invoice selection with auto-population, manual item/warehouse selection, quantity validation, unit cost input for WAC, submit handler, all conditional rendering based on source mode.
7. This file is 1107 lines — focus on structural wrappers only. Do NOT touch conditional rendering logic or data fetching.

After both edits, run `npx tsc --noEmit`.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Run `grep 'FormSection' app/\(dashboard\)/invoice/new/page.tsx app/\(dashboard\)/inventory/stock-in/page.tsx` — both files contain FormSection.
Verify invoice step navigation still has currentStep state management intact.
  </verify>
  <done>Invoice wizard and Stock In form use FormSection composites. Step state machine and all validation logic preserved. Source mode toggle in Stock In preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Stock Out and Stock Out Request new forms to FormSection composites</name>
  <files>
    app/(dashboard)/inventory/stock-out/page.tsx
    app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  </files>
  <action>
**Stock Out form** (~978 lines — HIGH RISK):
1. Read FULL file. This form has:
   - Item and warehouse selection
   - Dynamic quantity validation (max = available stock in selected warehouse)
   - Reason selection (request, consumption, damage, lost, transfer, adjustment)
   - Transfer destination warehouse (conditional on reason=transfer)
   - Multiple line items possible
2. Add import: `import { FormSection, FormField, PageHeader } from "@/components/composite";`
3. Replace page header with PageHeader.
4. Replace form sections with FormSection:
   - "Item Selection" section
   - "Warehouse & Quantity" section
   - "Transaction Details" section (reason, notes)
5. For quantity field, use FormField with error prop for validation:
   ```tsx
   <FormField label="Quantity" required error={quantityError}>
     <Input
       value={quantity}
       onChange={(e) => {
         setQuantity(e.target.value);
         validateQuantity(e.target.value); // PRESERVE
       }}
     />
   </FormField>
   ```
6. PRESERVE: ALL dynamic validation (warehouse stock check, available quantity), reason-dependent conditional fields (destination warehouse for transfer), line item management, submit handler with database transaction.

**Stock Out Request new** (~776 lines):
1. Read full file. This form creates a stock-out request with multiple line items.
2. Add import: `import { FormSection, FormField, PageHeader } from "@/components/composite";`
3. Replace page header with PageHeader.
4. Replace form sections with FormSection:
   - "Request Information" section (requestor, QMHQ reference)
   - "Line Items" section (items, quantities, warehouses)
5. Replace simple field wrappers with FormField.
6. PRESERVE: Line item add/remove, item search, warehouse selection per line, quantity inputs, approval flow references, submit handler.

After both edits, run `npx tsc --noEmit` and `npm run build`.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Run `npm run build` — production build succeeds.
Run `grep 'FormSection' app/\(dashboard\)/inventory/stock-out/page.tsx app/\(dashboard\)/inventory/stock-out-requests/new/page.tsx` — both files contain FormSection.
  </verify>
  <done>Stock Out and Stock Out Request new forms use FormSection and FormField composites. Dynamic quantity validation preserved in Stock Out. Line item management preserved in SOR new. Production build passes.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. All 4 pages import FormSection from "@/components/composite"
4. Invoice wizard step navigation (Next/Back) still functional
5. Stock Out quantity validation still shows errors for invalid quantities
6. Stock In source mode toggle (Invoice/Manual) still works
7. Line item tables in all forms still functional (add/remove/edit)
8. All submit handlers and database transactions unchanged
9. No remaining command-panel + section-header patterns in migrated files
</verification>

<success_criteria>
- 4 complex form pages migrated to FormSection composites
- Zero TypeScript errors
- Production build passes
- All wizard navigation, validation, and domain logic preserved
- Dynamic stock validation in Stock Out unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/40-ui-consistency-rollout/40-06-SUMMARY.md`
</output>
