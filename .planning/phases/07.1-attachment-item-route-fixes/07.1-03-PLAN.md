---
phase: 07.1-attachment-item-route-fixes
plan: 03
type: execute
wave: 2
depends_on: ["07.1-02"]
files_modified:
  - app/(dashboard)/qmhq/new/[route]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - types/database.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can add multiple items in QMHQ item route form"
    - "User can remove items from the multi-item list"
    - "Each item has quantity and optional warehouse selection"
    - "No unit price field appears in item route form"
    - "QMHQ detail page displays all items from qmhq_items table"
    - "Legacy single-item QMHQ records display correctly"
  artifacts:
    - path: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      provides: "Multi-item selection form for item route"
      contains: "selectedItems"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail showing multi-item display"
      contains: "qmhq_items"
    - path: "types/database.ts"
      provides: "QMHQItem type definition"
      contains: "QMHQItem"
  key_links:
    - from: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      to: "qmhq_items"
      via: "supabase insert after QMHQ creation"
      pattern: "from\\('qmhq_items'\\)"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "qmhq_items"
      via: "supabase select with QMHQ"
      pattern: "qmhq_items"
---

<objective>
Implement multi-item selection UI for QMHQ item route creation and display.

Purpose: Users need to request multiple items in a single QMHQ line without specifying unit prices (unit price comes from WAC at stock-out time).

Output: Updated item route form with multi-item support and detail page display.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-attachment-item-route-fixes/07.1-RESEARCH.md
@.planning/phases/07.1-attachment-item-route-fixes/07.1-02-SUMMARY.md
@app/(dashboard)/qmhq/new/[route]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QMHQItem Type Definition</name>
  <files>
    types/database.ts
  </files>
  <action>
    Add QMHQItem type to types/database.ts (after QMHQ type):

    ```typescript
    // QMHQ Items junction table (for multi-item requests)
    export interface QMHQItem {
      id: string;
      qmhq_id: string;
      item_id: string;
      quantity: number;
      warehouse_id: string | null;
      created_at: string;
      created_by: string | null;
    }

    // Extended type with relations for display
    export interface QMHQItemWithRelations extends QMHQItem {
      item?: Item | null;
      warehouse?: Warehouse | null;
    }
    ```

    Why: TypeScript types ensure type safety when working with the new junction table.
  </action>
  <verify>
    Run `npm run type-check` - should pass without errors
  </verify>
  <done>
    QMHQItem and QMHQItemWithRelations types added to database.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Multi-Item Form for Item Route</name>
  <files>
    app/(dashboard)/qmhq/new/[route]/page.tsx
  </files>
  <action>
    Update the item route form in app/(dashboard)/qmhq/new/[route]/page.tsx:

    1. Add new imports at top:
       ```tsx
       import { Trash2 } from "lucide-react";
       ```

    2. Define type for selected items (after route config):
       ```tsx
       type SelectedItem = {
         id: string;  // Client-side key (crypto.randomUUID())
         item_id: string;
         quantity: string;  // String for controlled input
         warehouse_id: string;
       };
       ```

    3. Replace item route state variables:
       ```tsx
       // Replace these:
       // const [selectedItemId, setSelectedItemId] = useState("");
       // const [quantity, setQuantity] = useState("");

       // With:
       const [selectedItems, setSelectedItems] = useState<SelectedItem[]>([
         { id: crypto.randomUUID(), item_id: '', quantity: '', warehouse_id: '' }
       ]);
       const [warehouses, setWarehouses] = useState<{id: string; name: string}[]>([]);
       ```

    4. Update fetchRouteData to also fetch warehouses:
       ```tsx
       if (route === "item") {
         const [itemsRes, warehousesRes] = await Promise.all([
           supabase
             .from("items")
             .select("id, name, sku, default_unit")
             .eq("is_active", true)
             .order("name")
             .limit(200),
           supabase
             .from("warehouses")
             .select("id, name")
             .eq("is_active", true)
             .order("name")
         ]);
         if (itemsRes.data) setItems(itemsRes.data as Item[]);
         if (warehousesRes.data) setWarehouses(warehousesRes.data);
       }
       ```

    5. Add item management handlers (after fetchRouteData):
       ```tsx
       const handleAddItem = () => {
         setSelectedItems([
           ...selectedItems,
           { id: crypto.randomUUID(), item_id: '', quantity: '', warehouse_id: '' }
         ]);
       };

       const handleRemoveItem = (id: string) => {
         if (selectedItems.length === 1) return; // Keep at least one
         setSelectedItems(selectedItems.filter(item => item.id !== id));
       };

       const handleUpdateItem = (id: string, field: keyof Omit<SelectedItem, 'id'>, value: string) => {
         setSelectedItems(selectedItems.map(item =>
           item.id === id ? { ...item, [field]: value } : item
         ));
       };
       ```

    6. Update validation in handleSubmit for item route:
       ```tsx
       if (route === "item") {
         // Validate at least one item with quantity
         const validItems = selectedItems.filter(
           item => item.item_id && parseFloat(item.quantity) > 0
         );
         if (validItems.length === 0) {
           toast({
             title: "Validation Error",
             description: "Please add at least one item with quantity.",
             variant: "destructive",
           });
           return;
         }
       }
       ```

    7. Update insert logic for item route:
       ```tsx
       if (route === "item") {
         // Create QMHQ without legacy item fields
         const { data: qmhqData, error: qmhqError } = await supabase
           .from("qmhq")
           .insert({
             ...baseData,
             // Legacy fields set to null for multi-item
             item_id: null,
             quantity: null,
             warehouse_id: null,
           })
           .select()
           .single();

         if (qmhqError) throw qmhqError;

         // Insert items into junction table
         const validItems = selectedItems.filter(
           item => item.item_id && parseFloat(item.quantity) > 0
         );

         const { error: itemsError } = await supabase
           .from("qmhq_items")
           .insert(
             validItems.map(item => ({
               qmhq_id: qmhqData.id,
               item_id: item.item_id,
               quantity: parseFloat(item.quantity),
               warehouse_id: item.warehouse_id || null,
               created_by: user.id,
             }))
           );

         if (itemsError) throw itemsError;

         // Clear draft and redirect
         sessionStorage.removeItem("qmhq_draft");
         sessionStorage.removeItem("qmhq_route_data");

         toast({
           title: "Success",
           description: "QMHQ line created successfully.",
           variant: "success",
         });

         router.push(`/qmhq/${qmhqData.id}`);
         return;
       }
       ```

    8. Replace the Item Route Form JSX (the entire {route === "item" && (...)} block):
       ```tsx
       {route === "item" && (
         <>
           <div className="command-panel corner-accents animate-slide-up" style={{ animationDelay: "100ms" }}>
             <div className="section-header">
               <Package className={`h-4 w-4 ${colors.icon}`} />
               <h2>Item Selection</h2>
             </div>

             <div className="space-y-4">
               {selectedItems.map((selectedItem, index) => (
                 <div key={selectedItem.id} className="grid grid-cols-12 gap-3 p-4 rounded-lg bg-slate-800/30 border border-slate-700/50">
                   {/* Item Number */}
                   <div className="col-span-12 sm:col-span-1 flex items-center">
                     <span className="text-xs font-mono text-slate-500 uppercase">#{index + 1}</span>
                   </div>

                   {/* Item Select */}
                   <div className="col-span-12 sm:col-span-5 space-y-1">
                     <Label className="data-label text-xs">Item</Label>
                     <Select
                       value={selectedItem.item_id}
                       onValueChange={(value) => handleUpdateItem(selectedItem.id, 'item_id', value)}
                     >
                       <SelectTrigger className="bg-slate-800/50 border-slate-700">
                         <SelectValue placeholder="Select item" />
                       </SelectTrigger>
                       <SelectContent>
                         {items.map((item) => (
                           <SelectItem key={item.id} value={item.id}>
                             <div className="flex items-center gap-2">
                               {item.sku && (
                                 <code className="text-amber-400 text-xs">{item.sku}</code>
                               )}
                               <span className="text-slate-200">{item.name}</span>
                             </div>
                           </SelectItem>
                         ))}
                       </SelectContent>
                     </Select>
                   </div>

                   {/* Quantity */}
                   <div className="col-span-6 sm:col-span-2 space-y-1">
                     <Label className="data-label text-xs">Qty</Label>
                     <Input
                       type="number"
                       min="1"
                       step="1"
                       value={selectedItem.quantity}
                       onChange={(e) => handleUpdateItem(selectedItem.id, 'quantity', e.target.value)}
                       placeholder="0"
                       className="bg-slate-800/50 border-slate-700 focus:border-blue-500/50 text-slate-200 font-mono [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                     />
                   </div>

                   {/* Warehouse (Optional) */}
                   <div className="col-span-6 sm:col-span-3 space-y-1">
                     <Label className="data-label text-xs">Warehouse</Label>
                     <Select
                       value={selectedItem.warehouse_id}
                       onValueChange={(value) => handleUpdateItem(selectedItem.id, 'warehouse_id', value)}
                     >
                       <SelectTrigger className="bg-slate-800/50 border-slate-700">
                         <SelectValue placeholder="Optional" />
                       </SelectTrigger>
                       <SelectContent>
                         <SelectItem value="">Any warehouse</SelectItem>
                         {warehouses.map((wh) => (
                           <SelectItem key={wh.id} value={wh.id}>
                             {wh.name}
                           </SelectItem>
                         ))}
                       </SelectContent>
                     </Select>
                   </div>

                   {/* Remove Button */}
                   <div className="col-span-12 sm:col-span-1 flex items-end justify-end sm:justify-center">
                     <Button
                       type="button"
                       variant="ghost"
                       size="icon"
                       onClick={() => handleRemoveItem(selectedItem.id)}
                       disabled={selectedItems.length === 1}
                       className="h-9 w-9 text-slate-400 hover:text-red-400 hover:bg-red-500/10"
                     >
                       <Trash2 className="h-4 w-4" />
                     </Button>
                   </div>
                 </div>
               ))}

               {/* Add Item Button */}
               <Button
                 type="button"
                 variant="outline"
                 onClick={handleAddItem}
                 className="w-full border-dashed border-slate-600 text-slate-400 hover:text-blue-400 hover:border-blue-500/50 hover:bg-blue-500/5"
               >
                 <Plus className="mr-2 h-4 w-4" />
                 Add Another Item
               </Button>
             </div>
           </div>

           {/* Info Panel */}
           <div className="command-panel animate-slide-up bg-blue-500/5 border-blue-500/20" style={{ animationDelay: "200ms" }}>
             <div className="flex items-start gap-3">
               <Info className="h-5 w-5 text-blue-400 mt-0.5" />
               <div>
                 <h3 className="font-medium text-slate-200 mb-1">Item Route Info</h3>
                 <p className="text-sm text-slate-400">
                   Add items to be issued from warehouse inventory. Stock will be automatically
                   deducted when this request is marked as fulfilled.
                 </p>
               </div>
             </div>
           </div>
         </>
       )}
       ```

    Key changes:
    - Multi-item state management with array of SelectedItem
    - Add/remove item functionality
    - Per-item warehouse selection (optional)
    - No unit price field (as specified)
    - Items inserted to qmhq_items table after QMHQ creation
  </action>
  <verify>
    1. Run npm run dev
    2. Navigate to QMHQ new -> select Item route
    3. Verify can add multiple items with quantity and optional warehouse
    4. Verify can remove items (but not the last one)
    5. Submit form and verify QMHQ + qmhq_items records created
  </verify>
  <done>
    Multi-item form for QMHQ item route with add/remove functionality, quantity input, and optional warehouse selection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update QMHQ Detail Page for Multi-Item Display</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
    Update QMHQ detail page to display multiple items:

    1. Add import for QMHQItemWithRelations type (at top with other imports):
       ```tsx
       import type { QMHQItem } from "@/types/database";

       // Add extended type inline
       type QMHQItemWithRelations = QMHQItem & {
         item?: { id: string; name: string; sku: string | null; default_unit: string | null } | null;
         warehouse?: { id: string; name: string } | null;
       };
       ```

    2. Add state for QMHQ items (after existing state declarations):
       ```tsx
       const [qmhqItems, setQmhqItems] = useState<QMHQItemWithRelations[]>([]);
       ```

    3. In the data fetch (fetchQMHQ function), add query for qmhq_items:
       ```tsx
       // After fetching QMHQ, fetch qmhq_items if route_type is 'item'
       if (qmhqData.route_type === 'item') {
         const { data: itemsData } = await supabase
           .from('qmhq_items')
           .select(`
             *,
             item:items(id, name, sku, default_unit),
             warehouse:warehouses(id, name)
           `)
           .eq('qmhq_id', qmhqData.id);

         if (itemsData && itemsData.length > 0) {
           setQmhqItems(itemsData as QMHQItemWithRelations[]);
         } else if (qmhqData.item_id) {
           // Fallback for legacy single-item QMHQ
           const { data: legacyItem } = await supabase
             .from('items')
             .select('id, name, sku, default_unit')
             .eq('id', qmhqData.item_id)
             .single();

           const { data: legacyWarehouse } = qmhqData.warehouse_id
             ? await supabase
                 .from('warehouses')
                 .select('id, name')
                 .eq('id', qmhqData.warehouse_id)
                 .single()
             : { data: null };

           if (legacyItem) {
             setQmhqItems([{
               id: 'legacy',
               qmhq_id: qmhqData.id,
               item_id: qmhqData.item_id,
               quantity: qmhqData.quantity || 0,
               warehouse_id: qmhqData.warehouse_id,
               created_at: qmhqData.created_at,
               created_by: qmhqData.created_by,
               item: legacyItem,
               warehouse: legacyWarehouse,
             }]);
           }
         }
       }
       ```

    4. Find the Item Route Details section in JSX (look for "Item Details" or route_type === "item").
       Replace the single-item display with multi-item table:
       ```tsx
       {/* Item Route Details */}
       {qmhq.route_type === "item" && qmhqItems.length > 0 && (
         <div className="command-panel corner-accents">
           <div className="section-header">
             <Package className="h-4 w-4 text-blue-400" />
             <h2>Requested Items ({qmhqItems.length})</h2>
           </div>

           <div className="space-y-3">
             {qmhqItems.map((item, index) => (
               <div key={item.id} className="flex items-center justify-between p-3 rounded-lg bg-slate-800/30 border border-slate-700/50">
                 <div className="flex items-center gap-4">
                   <span className="text-xs font-mono text-slate-500 w-6">#{index + 1}</span>
                   <div>
                     <div className="flex items-center gap-2">
                       {item.item?.sku && (
                         <code className="text-amber-400 text-xs">{item.item.sku}</code>
                       )}
                       <span className="text-slate-200 font-medium">{item.item?.name || 'Unknown Item'}</span>
                     </div>
                     {item.warehouse && (
                       <p className="text-xs text-slate-400 mt-0.5">
                         From: {item.warehouse.name}
                       </p>
                     )}
                   </div>
                 </div>
                 <div className="text-right">
                   <span className="text-lg font-mono text-blue-400">{item.quantity}</span>
                   {item.item?.default_unit && (
                     <span className="text-xs text-slate-400 ml-1">{item.item.default_unit}</span>
                   )}
                 </div>
               </div>
             ))}
           </div>
         </div>
       )}
       ```

    5. Remove or update the legacy single-item display (if it exists separately).
       The new display handles both multi-item and legacy single-item via the fallback.

    Why: The detail page must display items from qmhq_items table while maintaining backward compatibility with legacy single-item records.
  </action>
  <verify>
    1. View existing QMHQ with single item (legacy) - should display correctly
    2. Create new QMHQ with multiple items - should display all items
    3. Verify item name, SKU, quantity, and warehouse shown
  </verify>
  <done>
    QMHQ detail page displays multiple items from qmhq_items table with fallback for legacy single-item records.
  </done>
</task>

</tasks>

<verification>
1. npm run build - should complete without errors
2. npm run type-check - TypeScript passes
3. Create QMHQ item route with 3 items - all items saved
4. View QMHQ detail - all items displayed
5. View legacy single-item QMHQ - displays correctly
6. Change multi-item QMHQ status to 'done' - verify auto stock-out creates for each item (Note: trigger currently handles only legacy single-item; multi-item trigger enhancement is future work)
</verification>

<success_criteria>
- QMHQItem type exists in database.ts
- Item route form supports adding/removing multiple items
- No unit price field in item route form
- Each item has quantity and optional warehouse
- QMHQ creation inserts items to qmhq_items table
- QMHQ detail shows all items from junction table
- Legacy single-item QMHQ records display correctly
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-attachment-item-route-fixes/07.1-03-SUMMARY.md`
</output>
