---
phase: 07.1-attachment-item-route-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - components/ui/calendar.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin and Quartermaster users can see delete button on attachments"
    - "Other users cannot see delete button on attachments"
    - "Date picker calendar shows only arrow navigation (no month/year dropdowns)"
  artifacts:
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "QMRL detail with role-based attachment permissions"
      contains: "canEdit={canEditAttachments}"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail with role-based attachment permissions"
      contains: "canEdit={canEditAttachments}"
    - path: "components/ui/calendar.tsx"
      provides: "Simplified calendar navigation"
      contains: 'captionLayout="buttons"'
  key_links:
    - from: "app/(dashboard)/qmrl/[id]/page.tsx"
      to: "components/files/attachments-tab.tsx"
      via: "canEdit prop derived from user role"
      pattern: "canEdit.*admin.*quartermaster"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/files/attachments-tab.tsx"
      via: "canEdit prop derived from user role"
      pattern: "canEdit.*admin.*quartermaster"
---

<objective>
Fix attachment delete permissions and simplify date picker navigation.

Purpose: Users currently cannot delete attachments because canEdit is hardcoded to true instead of checking user roles. Additionally, the date picker shows unnecessary month/year dropdowns that complicate navigation.

Output: Permission-aware attachment delete buttons and simplified calendar UI.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-attachment-item-route-fixes/07.1-RESEARCH.md
@components/files/attachments-tab.tsx
@components/ui/calendar.tsx
@app/(dashboard)/qmrl/[id]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Attachment Delete Permissions</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
    In QMRL detail page (app/(dashboard)/qmrl/[id]/page.tsx):
    1. After the useAuth hook destructure, add permission calculation:
       ```tsx
       const { user } = useAuth();
       const canEditAttachments = user?.role === 'admin' || user?.role === 'quartermaster';
       ```
    2. Find the AttachmentsTab component usage (around line 581)
    3. Change `canEdit={true}` to `canEdit={canEditAttachments}`

    In QMHQ detail page (app/(dashboard)/qmhq/[id]/page.tsx):
    1. After the useAuth hook destructure, add permission calculation:
       ```tsx
       const { user } = useAuth();
       const canEditAttachments = user?.role === 'admin' || user?.role === 'quartermaster';
       ```
    2. Find the AttachmentsTab component usage (around line 851)
    3. Change `canEdit={true}` to `canEdit={canEditAttachments}`

    Why: RLS policies already enforce deletion permissions at database level, but the UI was not reflecting these permissions by always showing the delete button.
  </action>
  <verify>
    1. Login as admin user - should see delete icons on file cards
    2. Login as requester user - should NOT see delete icons on file cards
    3. Verify upload dropzone visibility follows same pattern (admin/quartermaster only)
  </verify>
  <done>
    AttachmentsTab canEdit prop is derived from user role, matching RLS policy permissions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify Date Picker Calendar Navigation</name>
  <files>
    components/ui/calendar.tsx
  </files>
  <action>
    In components/ui/calendar.tsx:
    1. Find the DayPicker component (around line 19)
    2. Change `captionLayout="dropdown-buttons"` to `captionLayout="buttons"`
    3. Remove `fromYear={2020}` prop (line 24)
    4. Remove `toYear={2030}` prop (line 25)
    5. Remove dropdown-related classNames (lines 32-35):
       - Remove `caption_dropdowns` classNames
       - Remove `dropdown` classNames
       - Remove `dropdown_month` classNames
       - Remove `dropdown_year` classNames

    Why: Users requested simpler calendar navigation with only left/right arrows instead of month/year dropdown selectors. The "buttons" captionLayout provides this simpler UX.
  </action>
  <verify>
    1. Run `npm run dev` and navigate to any page with date picker
    2. Click on date picker field to open calendar
    3. Verify only left/right arrow buttons appear for navigation
    4. Verify no month/year dropdown selectors appear
    5. Verify navigation between months works correctly
  </verify>
  <done>
    Calendar shows simplified buttons-only navigation without month/year dropdowns.
  </done>
</task>

</tasks>

<verification>
1. npm run build - should complete without errors
2. npm run lint - should pass without errors
3. Manual test: As admin, can see attachment delete buttons
4. Manual test: As requester, cannot see attachment delete buttons
5. Manual test: Date picker shows arrows-only navigation
</verification>

<success_criteria>
- AttachmentsTab receives role-based canEdit prop in both QMRL and QMHQ detail pages
- Calendar component uses captionLayout="buttons" without year constraints
- No TypeScript or build errors
- UI correctly reflects user permissions for file operations
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-attachment-item-route-fixes/07.1-01-SUMMARY.md`
</output>
