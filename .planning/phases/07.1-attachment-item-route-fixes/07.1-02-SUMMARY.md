---
phase: 07.1-attachment-item-route-fixes
plan: 02
subsystem: database
tags: [postgresql, triggers, junction-table, inventory, automation]

# Dependency graph
requires:
  - phase: 02-database-schema
    provides: inventory_transactions, qmhq tables
  - phase: 06-status-transaction-ux
    provides: status_config with status_group field
provides:
  - Auto stock-out trigger for QMHQ item route fulfillment
  - qmhq_items junction table for multi-item support
  - Idempotent inventory_out creation on status change to 'done'
affects: [07.1-03-item-route-frontend, inventory-management, qmhq-workflows]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Idempotent trigger pattern for preventing duplicate transactions
    - SECURITY DEFINER for system-generated transactions bypassing RLS
    - Junction table with per-item configuration (warehouse_id)

key-files:
  created:
    - supabase/migrations/034_qmhq_auto_stockout.sql
    - supabase/migrations/035_qmhq_items.sql
  modified: []

key-decisions:
  - "Trigger uses SECURITY DEFINER to bypass RLS for system transactions"
  - "Idempotency check prevents duplicate stock-outs on status toggle"
  - "Per-item warehouse selection allows flexible sourcing in multi-item QMHQ"
  - "Legacy qmhq.item_id preserved for backward compatibility"
  - "RESTRICT delete on items protects items with pending requests"

patterns-established:
  - "Idempotent trigger pattern: Check for existing transaction before INSERT"
  - "System transaction pattern: Use COALESCE(updated_by, created_by) for user tracking"
  - "Junction table RLS: Inherit visibility from parent entity via EXISTS subquery"

# Metrics
duration: 4min
completed: 2026-01-29
---

# Phase 7.1 Plan 02: Auto Stock-Out & Multi-Item QMHQ Summary

**PostgreSQL trigger auto-creates inventory_out on QMHQ item route fulfillment, plus qmhq_items junction table for multi-item support**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-29T21:54:23Z
- **Completed:** 2026-01-29T21:58:42Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Auto stock-out trigger creates inventory_out when QMHQ item route status changes to 'done' group
- Idempotent design prevents duplicate transactions on status toggle
- qmhq_items junction table enables multiple items per QMHQ request
- Per-item warehouse selection for flexible inventory sourcing
- RLS policies inherit from parent QMHQ visibility

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Auto Stock-Out Trigger** - `8852a92` (feat)
2. **Task 2: Create Multi-Item Junction Table** - `71f2c9b` (feat)

## Files Created/Modified
- `supabase/migrations/034_qmhq_auto_stockout.sql` - Trigger function for auto inventory_out on QMHQ status change to done
- `supabase/migrations/035_qmhq_items.sql` - Junction table for many-to-many QMHQ-Item relationship with per-item warehouse

## Decisions Made

**Trigger uses SECURITY DEFINER for system transactions**
- System-generated inventory transactions need to bypass RLS
- User's role might not have direct INSERT permission on inventory_transactions
- SECURITY DEFINER executes with function owner's privileges

**Idempotency check prevents duplicate stock-outs**
- Status can be toggled back and forth (done → in_progress → done)
- Check for existing inventory_out transaction before creating new one
- Prevents inventory discrepancies from repeated triggers

**Per-item warehouse selection in junction table**
- Different items in same QMHQ can come from different warehouses
- More flexible than single warehouse_id on parent QMHQ
- Optional field: can be set at fulfillment time

**Legacy qmhq.item_id preserved**
- Existing single-item QMHQ records continue to work
- Trigger checks for NEW.item_id IS NOT NULL for backward compatibility
- Future frontend can migrate to qmhq_items table exclusively

**RESTRICT delete on items**
- Cannot delete items that have pending requests
- Protects data integrity for in-flight QMHQ records
- Forces cleanup of requests before item deletion

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Docker Desktop not running**
- Could not test migrations with `npx supabase db reset`
- Resolution: SQL verified manually, migrations will be tested on remote instance or when Docker starts
- No blocking impact: migrations follow established patterns from phases 1-7

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for frontend implementation:**
- Auto stock-out trigger in place for QMHQ item route
- qmhq_items table ready for multi-item form UI
- RLS policies inherit from parent QMHQ

**Pending:**
- Frontend form for adding multiple items to QMHQ
- Trigger extension for qmhq_items junction table (currently only works with legacy item_id)
- Migration of existing single-item QMHQ to qmhq_items table (optional)

**No blockers:** Database infrastructure complete, ready for UI integration.

---
*Phase: 07.1-attachment-item-route-fixes*
*Completed: 2026-01-29*
