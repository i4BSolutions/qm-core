---
phase: 17-attachment-delete-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/files.ts
autonomous: true

must_haves:
  truths:
    - "User can delete own attachment on QMRL detail page without errors"
    - "User can delete own attachment on QMHQ detail page without errors"
    - "Admin/Quartermaster can delete any attachment without errors"
    - "Deleted attachments are removed from UI immediately"
  artifacts:
    - path: "lib/actions/files.ts"
      provides: "Fixed deleteFile server action"
      contains: "select.*entity_type.*entity_id.*before update"
  key_links:
    - from: "lib/actions/files.ts"
      to: "file_attachments table"
      via: "fetch before soft-delete pattern"
      pattern: "select.*eq.*id.*fileId.*single.*then.*update"
---

<objective>
Fix attachment deletion RLS error by refactoring the deleteFile server action query pattern.

Purpose: Users currently see RLS permission errors when deleting attachments because the chained `.select().single()` after UPDATE fails - once `deleted_at` is set, the row no longer passes the SELECT RLS policy (`deleted_at IS NULL`).

Output: Working deleteFile function that fetches entity info BEFORE the soft-delete update.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-attachment-delete-fixes/17-RESEARCH.md

@lib/actions/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix deleteFile query pattern</name>
  <files>lib/actions/files.ts</files>
  <action>
Refactor the deleteFile function (lines 151-192) to use fetch-before-update pattern:

1. BEFORE the update, fetch entity_type and entity_id:
```typescript
// Step 1: Fetch entity info first (row is still visible)
const { data: fileData, error: fetchError } = await supabase
  .from('file_attachments')
  .select('entity_type, entity_id')
  .eq('id', fileId)
  .single();

if (fetchError || !fileData) {
  return { success: false, error: 'File not found' };
}
```

2. Perform soft delete WITHOUT chained .select():
```typescript
// Step 2: Perform soft delete without returning data
const { error: updateError } = await supabase
  .from('file_attachments')
  .update({
    deleted_at: new Date().toISOString(),
    deleted_by: user.id,
    updated_at: new Date().toISOString(),
  })
  .eq('id', fileId);

if (updateError) {
  return { success: false, error: `Delete failed: ${updateError.message}` };
}
```

3. Use pre-fetched data for revalidation:
```typescript
// Step 3: Use pre-fetched data for revalidation
revalidatePath(`/${fileData.entity_type}/${fileData.entity_id}`);
return { success: true, data: undefined };
```

Key changes:
- Remove `.select('entity_type, entity_id').single()` from the UPDATE query
- Add separate SELECT query before the UPDATE
- Use pre-fetched fileData for revalidatePath call
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Manual test: Login as regular user, go to QMRL with own attachment, click delete - should succeed without RLS error
3. Manual test: Login as admin, go to any QMRL/QMHQ, delete attachment - should succeed
4. UI updates: Deleted file should disappear from list immediately
  </verify>
  <done>
- deleteFile function uses fetch-before-update pattern
- No more chained .select().single() after UPDATE
- Both owner and admin/QM deletion scenarios work
- UI reflects deletion immediately via revalidatePath
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Type check passes: `npm run type-check`
3. Manual verification:
   - As file owner: delete own attachment on QMRL detail page
   - As file owner: delete own attachment on QMHQ detail page
   - As admin: delete any attachment on QMRL page
   - As admin: delete any attachment on QMHQ page
4. All four scenarios complete without RLS/database errors
5. Deleted files disappear from UI immediately
</verification>

<success_criteria>
1. User can delete own attachment on QMRL detail page without RLS or database errors
2. User can delete own attachment on QMHQ detail page without RLS or database errors
3. Admin/Quartermaster can delete any attachment on both pages without errors
4. Deleted attachments are removed from UI immediately after successful deletion
</success_criteria>

<output>
After completion, create `.planning/phases/17-attachment-delete-fixes/17-01-SUMMARY.md`
</output>
