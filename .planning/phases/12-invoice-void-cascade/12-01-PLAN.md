---
phase: 12-invoice-void-cascade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/invoice-actions.ts
  - app/(dashboard)/invoice/[id]/page.tsx
  - components/history/history-tab.tsx
autonomous: true

must_haves:
  truths:
    - "User can void invoice and immediately see updated PO status in toast"
    - "User can void invoice and immediately see invoiced quantity changes in toast"
    - "User sees 'Cannot void: inventory has been received' error if stock-in exists"
    - "Voided invoice page shows void reason, voided by, and timestamp"
    - "History tab shows void cascade audit entries with before/after values"
  artifacts:
    - path: "lib/actions/invoice-actions.ts"
      provides: "voidInvoice server action with cascade feedback"
      exports: ["voidInvoice", "VoidInvoiceResult"]
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail page with server action integration"
      contains: "useToast"
    - path: "components/history/history-tab.tsx"
      provides: "Enhanced audit display for void cascade"
      contains: "void_cascade"
  key_links:
    - from: "app/(dashboard)/invoice/[id]/page.tsx"
      to: "lib/actions/invoice-actions.ts"
      via: "server action call"
      pattern: "voidInvoice"
    - from: "lib/actions/invoice-actions.ts"
      to: "revalidatePath"
      via: "cache invalidation"
      pattern: "revalidatePath.*invoice|po"
---

<objective>
Implement invoice void cascade UI feedback layer — server action with cascade data return, detailed toast notifications, and enhanced audit trail display.

Purpose: The database cascade infrastructure exists (Phase 8). This plan wires the UI to execute void, receive cascade results, and present feedback to users. Users need immediate confirmation that voiding an invoice triggered the expected PO status and quantity changes.

Output: Working void flow with detailed toast (PO status, invoiced qty changes), proper error handling for stock-in block, and enhanced history tab showing void cascade entries.
</objective>

<execution_context>
@C:\Users\User\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\User\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-invoice-void-cascade/12-CONTEXT.md
@.planning/phases/12-invoice-void-cascade/12-RESEARCH.md

# Key existing files
@lib/actions/files.ts (server action pattern reference)
@components/invoice/void-invoice-dialog.tsx (existing dialog)
@app/(dashboard)/invoice/[id]/page.tsx (current void handler)
@components/history/history-tab.tsx (audit display)
@components/ui/use-toast.tsx (toast hook)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voidInvoice server action with cascade feedback</name>
  <files>lib/actions/invoice-actions.ts</files>
  <action>
Create new server action file `lib/actions/invoice-actions.ts` following the pattern from `lib/actions/files.ts`:

1. Add 'use server' directive at top

2. Create VoidInvoiceResult type:
```typescript
export type VoidInvoiceResult =
  | {
      success: true;
      data: {
        invoiceNumber: string;
        poNumber: string | null;
        newPoStatus: string | null;
        invoicedQtyChanges: Array<{
          itemName: string;
          oldQty: number;
          newQty: number;
        }>;
      }
    }
  | { success: false; error: string };
```

3. Create voidInvoice server action:
- Accept invoiceId: string, reason: string
- Use createClient from '@/lib/supabase/server'
- Get authenticated user (return error if not authenticated)
- Execute UPDATE on invoices table:
  - is_voided: true
  - voided_at: new Date().toISOString()
  - voided_by: user.id
  - void_reason: reason
  - status: 'voided'
- Handle error: Check if error.message contains "Cannot void" (from aa_block_invoice_void_stockin trigger) — return user-friendly message: "Cannot void invoice. Inventory has already been received against this invoice."
- On success, query cascade results:
  - Fetch invoice with po_id relation for po_number and status
  - Fetch invoice_line_items with po_line_item relation for invoiced_quantity
  - Calculate old qty as: current invoiced_quantity + invoice_line_item.quantity
- Call revalidatePath for:
  - '/invoice'
  - `/invoice/${invoiceId}`
  - `/po/${poId}` (if PO exists)
  - '/po'
- Return success with cascade data

4. Export VoidInvoiceResult and voidInvoice
  </action>
  <verify>
- File exists at lib/actions/invoice-actions.ts
- TypeScript compiles: `npx tsc --noEmit lib/actions/invoice-actions.ts`
- Exports are correct: grep for "export.*voidInvoice"
  </verify>
  <done>
Server action exports voidInvoice function that executes void, catches stock-in block error, queries cascade results, invalidates caches, and returns structured data for toast display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate server action with invoice detail page and add toast feedback</name>
  <files>app/(dashboard)/invoice/[id]/page.tsx</files>
  <action>
Update invoice detail page to use server action and show detailed toast:

1. Add imports:
```typescript
import { voidInvoice } from '@/lib/actions/invoice-actions';
import { useToast } from '@/components/ui/use-toast';
```

2. In component, add toast hook:
```typescript
const { toast } = useToast();
```

3. Replace handleVoid function with server action integration:
```typescript
const handleVoid = async (reason: string) => {
  if (!invoice || !user) return;
  setIsVoiding(true);

  try {
    const result = await voidInvoice(invoiceId, reason);

    if (!result.success) {
      toast({
        variant: "destructive",
        title: "Void Failed",
        description: result.error,
      });
      setIsVoiding(false);
      return;
    }

    // Build detailed success toast
    const { data } = result;
    toast({
      variant: "success",
      title: "Invoice Voided",
      description: (
        <div className="space-y-1">
          <p>Invoice {data.invoiceNumber} has been voided.</p>
          {data.poNumber && data.newPoStatus && (
            <p className="text-sm">
              PO {data.poNumber} status: {data.newPoStatus.replace(/_/g, ' ')}
            </p>
          )}
          {data.invoicedQtyChanges.length > 0 && (
            <p className="text-sm">
              {data.invoicedQtyChanges.length} item(s) invoiced qty updated
            </p>
          )}
        </div>
      ),
    });

    setIsVoiding(false);
    setShowVoidDialog(false);
    // Data will refresh via revalidatePath, but fetchData for immediate local update
    fetchData();

  } catch (err) {
    toast({
      variant: "destructive",
      title: "Void Failed",
      description: "An unexpected error occurred. Please try again.",
    });
    setIsVoiding(false);
  }
};
```

4. Remove direct Supabase call from handleVoid (server action handles database operation)

5. Ensure VoidInvoiceDialog onConfirm still receives handleVoid (no change needed to props)

Note: The existing void metadata display (lines 355-376) already renders void_reason, voided_by_user.full_name, and voided_at in a banner when invoice.is_voided is true. No changes needed to this banner — just verify it renders correctly after void operation.
  </action>
  <verify>
- No TypeScript errors: `npm run type-check`
- Run dev server: `npm run dev`
- Navigate to an invoice detail page
- Void button should appear for non-voided invoices
- Voiding shows toast with PO status and qty changes
- After void, the red banner displays:
  - Void reason text
  - "Voided by [user name] on [date time]" text
- Page refreshes to show voided status badge
  </verify>
  <done>
Invoice detail page uses voidInvoice server action, displays detailed success toast with cascade effects (PO status, qty changes), handles stock-in block error gracefully, and the existing void metadata banner correctly displays void_reason, voided_by, and voided_at.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance history tab to display void cascade audit entries</name>
  <files>components/history/history-tab.tsx</files>
  <action>
Enhance HistoryTab component to display void cascade entries with special styling:

1. Add 'void_cascade' to ACTION_CONFIG (or reuse existing 'void'):
```typescript
// Update ACTION_CONFIG if needed - 'void' already exists with red styling
// The trigger logs action='update' with field_name='invoiced_quantity' for PO line items
// and action='status_change' for PO status changes
```

2. In parseChanges function, add special handling for void-related entries:
- Check if changes_summary contains "void of invoice"
- If so, parse it as a void cascade entry

3. In HistoryEntry component, add visual distinction for void-related entries:
```typescript
// Detect void cascade entry
const isVoidCascade = log.changes_summary?.includes('void of invoice');

// Add special border color for void cascade entries
<div className={cn(
  "relative flex gap-4",
  isVoidCascade && "border-l-2 border-red-500/50 pl-2 -ml-2"
)}>
```

4. For void cascade entries, show before/after values more prominently:
- If log.field_name === 'invoiced_quantity', show "Qty: X -> Y"
- If log.action === 'status_change', show "Status: X -> Y"

5. Add an icon indicator for cascade-related entries (use ChevronRight or similar to show "caused by"):
```typescript
{isVoidCascade && (
  <span className="text-xs text-red-400/70 flex items-center gap-1">
    <ArrowRightLeft className="h-3 w-3" />
    Cascade effect
  </span>
)}
```
  </action>
  <verify>
- No TypeScript errors: `npm run type-check`
- Run dev server: `npm run dev`
- Navigate to invoice detail > History tab
- Void an invoice (if test data allows)
- History tab should show void entry with cascade effects highlighted
- Navigate to related PO > History tab
- Should see cascade entries (status_change, invoiced_quantity updates) with red accent
  </verify>
  <done>
History tab displays void cascade audit entries with visual distinction (red border accent, "Cascade effect" label), clearly showing before/after values for invoiced quantity and PO status changes.
  </done>
</task>

</tasks>

<verification>
1. Server action works correctly:
   - Create test invoice linked to a PO
   - Void the invoice
   - Toast shows PO number, new status, and qty changes

2. Stock-in block error handled:
   - Create invoice, receive stock against it
   - Try to void
   - Should see "Cannot void invoice. Inventory has already been received" error

3. UI updates immediately:
   - After void, invoice detail shows voided status
   - Invoice list shows voided badge
   - PO detail shows updated status and invoiced quantities

4. Void metadata banner displays correctly:
   - Voided invoice shows red banner with void reason
   - Banner shows "Voided by [name] on [date time]"

5. Audit trail complete:
   - Invoice history shows void entry
   - PO history shows status_change and invoiced_quantity entries
   - Entries show before/after values and "Cascade effect" label
</verification>

<success_criteria>
- [ ] voidInvoice server action exports from lib/actions/invoice-actions.ts
- [ ] Invoice detail page uses server action (not direct Supabase call)
- [ ] Success toast shows: invoice number, PO number, new PO status, qty changes count
- [ ] Error toast shows user-friendly message for stock-in block
- [ ] revalidatePath called for invoice list, invoice detail, PO list, PO detail
- [ ] Voided invoice banner displays void_reason, voided_by name, and voided_at timestamp
- [ ] History tab shows void cascade entries with red accent styling
- [ ] TypeScript compiles without errors
- [ ] Manual testing confirms void flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/12-invoice-void-cascade/12-01-SUMMARY.md`
</output>
