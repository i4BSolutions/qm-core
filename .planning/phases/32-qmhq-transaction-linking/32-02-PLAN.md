---
phase: 32-qmhq-transaction-linking
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "When admin approves a stock-out request linked to a QMHQ, the created inventory transaction has qmhq_id populated"
    - "QMHQ item detail page shows stock-out transactions grouped by their parent SOR with compact headers"
    - "Manual stock-out requests (no QMHQ parent) create transactions with NULL qmhq_id"
    - "Items Summary shows the full qty breakdown per item using the stepped progress bar (Requested/Approved/Executed/Pending)"
    - "SOR group headers link to SOR detail page and show SOR ID + status badge + total qty"
    - "When no linked stock-out transactions exist, empty state shows 'Request Stock-Out' CTA button"
    - "Standalone SOR card is removed — SOR info now lives in the SOR group headers"
  artifacts:
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Enhanced QMHQ detail page with SOR-grouped Stock Out tab"
      contains: "SORTransactionGroup"
  key_links:
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/qmhq/sor-transaction-group.tsx"
      via: "import and render in Stock Out tab"
      pattern: "import.*SORTransactionGroup"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/qmhq/items-summary-progress.tsx"
      via: "import and render in Stock Out tab"
      pattern: "import.*ItemsSummaryProgress"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "inventory_transactions"
      via: "Supabase query with SOR join for grouping"
      pattern: "stock_out_approval.*stock_out_line_items.*stock_out_requests"
---

<objective>
Integrate the new SOR transaction group and items summary progress components into the QMHQ detail page's Stock Out tab. Enhance the stock-out data fetching to include SOR relationship data for grouping, replace the flat transaction list with SOR-grouped display, replace the simple Items Summary with stepped progress bar, and remove the standalone SOR card.

Purpose: This connects the FK propagation (already working in approval-dialog.tsx) to the QMHQ detail page UI, giving users a clear view of which stock-out transactions belong to which SOR, with full pipeline visibility.

Output: Enhanced QMHQ detail page with SOR-grouped Stock Out tab and stepped progress bar.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-qmhq-transaction-linking/32-RESEARCH.md
@.planning/phases/32-qmhq-transaction-linking/32-CONTEXT.md
@.planning/phases/32-qmhq-transaction-linking/32-01-SUMMARY.md

# The page being modified:
@app/(dashboard)/qmhq/[id]/page.tsx
# New components from Plan 01:
@components/qmhq/sor-transaction-group.tsx
@components/qmhq/items-summary-progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance stock-out data fetching with SOR relationship joins</name>
  <files>app/(dashboard)/qmhq/[id]/page.tsx</files>
  <action>
Modify the QMHQ detail page to enhance the stock-out transaction query to include SOR relationship data needed for grouping.

**1. Update the stock-out transaction query** (currently at ~lines 212-222).

Replace the current query:
```typescript
const { data: stockOutData, error: stockOutError } = await supabase
  .from('inventory_transactions')
  .select(`
    *,
    item:items(id, name, sku),
    warehouse:warehouses!inventory_transactions_warehouse_id_fkey(id, name)
  `)
  .eq('qmhq_id', qmhqData.id)
  .eq('movement_type', 'inventory_out')
  .eq('is_active', true)
  .order('created_at', { ascending: false });
```

With an enhanced query that includes the SOR join path:
```typescript
const { data: stockOutData, error: stockOutError } = await supabase
  .from('inventory_transactions')
  .select(`
    *,
    item:items(id, name, sku),
    warehouse:warehouses!inventory_transactions_warehouse_id_fkey(id, name),
    stock_out_approval:stock_out_approvals(
      id,
      approved_quantity,
      line_item:stock_out_line_items(
        id,
        requested_quantity,
        status,
        request:stock_out_requests(
          id,
          request_number,
          status
        )
      )
    )
  `)
  .eq('qmhq_id', qmhqData.id)
  .eq('movement_type', 'inventory_out')
  .eq('is_active', true)
  .order('created_at', { ascending: false });
```

**2. Update the StockOutTransaction type** (currently at ~line 93) to include the SOR join data:

```typescript
interface StockOutTransaction extends InventoryTransaction {
  item?: { id: string; name: string; sku: string | null } | null;
  warehouse?: { id: string; name: string } | null;
  stock_out_approval?: {
    id: string;
    approved_quantity: number;
    line_item?: {
      id: string;
      requested_quantity: number;
      status: string;
      request?: {
        id: string;
        request_number: string;
        status: string;
      } | null;
    } | null;
  } | null;
}
```

**3. Remove the debug console.log statements** at lines 224-226 (the ones starting with `[QMHQ Debug]`).

**4. Update the SOR fetch query** (currently at ~lines 233-244) to fetch ALL SORs linked to this QMHQ (use `.select()` without `.maybeSingle()`) since we'll use this for the Items Summary progress calculation:

Change:
```typescript
const { data: sorData } = await supabase
  .from('stock_out_requests')
  .select(`...`)
  .eq('qmhq_id', qmhqData.id)
  .eq('is_active', true)
  .maybeSingle();
```

To use an array response (even though 1:1 constraint exists, for robustness):
```typescript
const { data: sorDataArray } = await supabase
  .from('stock_out_requests')
  .select(`
    id, request_number, status,
    line_items:stock_out_line_items(
      id, item_id, requested_quantity, status,
      approvals:stock_out_approvals(approved_quantity, decision)
    )
  `)
  .eq('qmhq_id', qmhqData.id)
  .eq('is_active', true);

setStockOutRequest(sorDataArray?.[0] ?? null);
```

This keeps the existing state setter compatible while being more robust.

Do NOT change any other data fetching logic (financial transactions, POs, file count, etc.).
  </action>
  <verify>
Run `npm run type-check` to confirm TypeScript compiles. Check that the QMHQ detail page loads without console errors for an item-route QMHQ by running `npm run dev` and visiting a known QMHQ detail page.
  </verify>
  <done>
Stock-out transaction query includes SOR relationship joins. StockOutTransaction type updated to include approval -> line_item -> request chain. Debug logs removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace Stock Out tab content with SOR-grouped display and stepped progress bar</name>
  <files>app/(dashboard)/qmhq/[id]/page.tsx</files>
  <action>
Modify the QMHQ detail page Stock Out tab to use the new components from Plan 01.

**1. Add imports** at the top of the file:
```typescript
import { SORTransactionGroup } from "@/components/qmhq/sor-transaction-group";
import { ItemsSummaryProgress } from "@/components/qmhq/items-summary-progress";
import type { ItemProgressData } from "@/components/qmhq/items-summary-progress";
```

**2. Add a useMemo to compute SOR-grouped transactions** (after the existing `allItemsFullyIssued` memo):

```typescript
const sorGroupedTransactions = useMemo(() => {
  const groups: Record<string, {
    sorId: string;
    sorNumber: string;
    sorStatus: string;
    totalQty: number;
    transactions: StockOutTransaction[];
  }> = {};

  stockOutTransactions.forEach((tx) => {
    const sor = tx.stock_out_approval?.line_item?.request;
    const sorKey = sor?.request_number || '_ungrouped';

    if (!groups[sorKey]) {
      groups[sorKey] = {
        sorId: sor?.id || '',
        sorNumber: sor?.request_number || 'Unknown',
        sorStatus: sor?.status || 'unknown',
        totalQty: 0,
        transactions: [],
      };
    }

    groups[sorKey].transactions.push(tx);
    groups[sorKey].totalQty += tx.quantity || 0;
  });

  return Object.values(groups);
}, [stockOutTransactions]);
```

**3. Add a useMemo to compute items progress data** for the stepped progress bar:

```typescript
const itemsProgressData = useMemo((): ItemProgressData[] => {
  return qmhqItems.map((item) => {
    // Get requested qty from the QMHQ item
    const requested = item.quantity;

    // Calculate approved qty from SOR line items
    let approved = 0;
    let rejected = 0;
    if (stockOutRequest?.line_items) {
      for (const li of stockOutRequest.line_items) {
        if (li.item_id === item.item_id) {
          const approvedApprovals = li.approvals?.filter((a: any) => a.decision === 'approved') || [];
          const rejectedApprovals = li.approvals?.filter((a: any) => a.decision === 'rejected') || [];
          approved += approvedApprovals.reduce((sum: number, a: any) => sum + (a.approved_quantity || 0), 0);
          rejected += rejectedApprovals.length;  // Count rejections (qty is 0 for rejections)
        }
      }
    }

    // Calculate executed qty from completed transactions
    const executed = stockOutTransactions
      .filter(t => t.item_id === item.item_id && t.status === 'completed')
      .reduce((sum, t) => sum + (t.quantity || 0), 0);

    return {
      itemId: item.item_id,
      itemName: item.item?.name || 'Unknown Item',
      itemSku: item.item?.sku || null,
      requested,
      approved,
      executed,
      rejected,
    };
  });
}, [qmhqItems, stockOutRequest, stockOutTransactions]);
```

**4. Replace the Stock Out tab content** (the entire `<TabsContent value="stock-out">` block, currently ~lines 812-1023).

The new Stock Out tab structure should be:

```tsx
<TabsContent value="stock-out" className="mt-6">
  <div className="command-panel corner-accents">
    {/* Header with Request Stock-Out button */}
    <div className="flex items-center justify-between mb-6">
      <div className="section-header mb-0">
        <ArrowUpFromLine className="h-4 w-4 text-red-400" />
        <h2>Stock Out Transactions</h2>
      </div>
      {!stockOutRequest && can("create", "stock_out_requests") && (
        <Link href={`/inventory/stock-out-requests/new?qmhq=${qmhqId}`}>
          <Button className="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400">
            <Plus className="mr-2 h-4 w-4" />
            Request Stock-Out
          </Button>
        </Link>
      )}
    </div>

    {/* Items Summary with Stepped Progress Bar */}
    {qmhqItems.length > 0 && (
      <div className="mb-6">
        <ItemsSummaryProgress items={itemsProgressData} />
      </div>
    )}

    {/* SOR-Grouped Transactions or Empty State */}
    {stockOutTransactions.length === 0 ? (
      <div className="flex flex-col items-center justify-center py-12 text-center">
        <div className="w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4">
          <ArrowUpFromLine className="h-8 w-8 text-slate-500" />
        </div>
        <h3 className="text-lg font-medium text-slate-300 mb-2">No Items Issued Yet</h3>
        <p className="text-sm text-slate-400 max-w-md mb-4">
          Stock-out transactions will appear here once a stock-out request is approved and executed.
        </p>
        {!stockOutRequest && can("create", "stock_out_requests") && (
          <Link href={`/inventory/stock-out-requests/new?qmhq=${qmhqId}`}>
            <Button variant="outline" className="border-slate-700">
              <Plus className="mr-2 h-4 w-4" />
              Request Stock-Out
            </Button>
          </Link>
        )}
      </div>
    ) : (
      <div className="space-y-6">
        {sorGroupedTransactions.map((group) => (
          <SORTransactionGroup
            key={group.sorId || group.sorNumber}
            sorId={group.sorId}
            sorNumber={group.sorNumber}
            sorStatus={group.sorStatus}
            totalQty={group.totalQty}
            transactions={group.transactions}
          />
        ))}
      </div>
    )}
  </div>
</TabsContent>
```

**Key changes from the existing Stock Out tab:**
- **REMOVED:** The standalone Stock-Out Request Card (lines ~900-965) — per user decision: "Remove the standalone Stock-Out Request Card — SOR info now lives in the group headers"
- **REMOVED:** The old flat Items Summary section (lines ~842-898) — replaced with ItemsSummaryProgress
- **REMOVED:** The separate SOR status badge next to the header button (lines ~819-838) — SOR info is now in group headers
- **REPLACED:** The flat transaction list (lines ~980-1020) with SOR-grouped display using SORTransactionGroup
- **ADDED:** Empty state CTA button per user decision (when no transactions exist)

**5. Also update the Fulfillment Progress section** on the Details tab (currently ~lines 717-744) to use the new ItemsSummaryProgress component for consistency. Replace the existing Fulfillment Progress section:

```tsx
{/* Fulfillment Progress for item route */}
{qmhq.route_type === "item" && qmhqItems.length > 0 && (
  <div className="command-panel corner-accents lg:col-span-2">
    <div className="section-header">
      <CheckCircle2 className="h-4 w-4 text-emerald-400" />
      <h2>Fulfillment Progress</h2>
    </div>
    <ItemsSummaryProgress items={itemsProgressData} />
  </div>
)}
```

**6. Clean up unused imports** if the FulfillmentProgressBar is no longer used directly in this page. Check if it's still used — if NOT used anywhere in the file after the changes, remove the import. Do NOT delete the component file itself (it may be used elsewhere).

Do NOT modify any other tabs (Details basic info/assignment/financial, Transactions, Purchase Orders, History, Attachments, Comments).
  </action>
  <verify>
Run `npm run type-check` to confirm TypeScript compiles. Run `npm run build` to verify production build succeeds. Verify the QMHQ detail page for an item-route QMHQ:
1. Stock Out tab shows Items Summary with stepped progress bar
2. Transactions are grouped by SOR with compact headers
3. SOR headers link to SOR detail page
4. Empty state shows Request Stock-Out CTA when no transactions exist
5. No standalone SOR card visible
  </verify>
  <done>
QMHQ Stock Out tab shows SOR-grouped transactions with compact headers linking to SOR detail page. Items Summary uses stepped progress bar showing Requested/Approved/Executed/Pending. Standalone SOR card removed. Empty state shows Request Stock-Out CTA button.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes
2. `npm run build` succeeds
3. QMHQ item detail page loads without errors
4. Stock Out tab shows Items Summary with stepped progress bar (color-coded segments)
5. Stock Out tab shows transactions grouped by SOR with compact headers
6. SOR group headers link to `/inventory/stock-out-requests/{id}`
7. Empty state shows CTA button when no stock-out transactions exist
8. Standalone SOR card is removed from the Stock Out tab
9. Fulfillment Progress on Details tab uses new stepped progress bar
10. FK propagation already works (qmhq_id populated on approval) — verified by inspection
</verification>

<success_criteria>
- QMHQ detail page Stock Out tab renders SOR-grouped transactions
- Items Summary shows stepped progress bar with Requested/Approved/Executed segments
- Rejected items appear with Rejected badge
- Empty state has Request Stock-Out CTA button
- SOR group headers are compact, always-expanded, and link to SOR detail page
- Standalone SOR card is removed
- All three phase success criteria met:
  1. Approval creates inventory transaction with qmhq_id populated (already working)
  2. QMHQ item detail shows stock-out transactions via qmhq_id link
  3. Manual SORs create transactions with NULL qmhq_id (no change needed)
</success_criteria>

<output>
After completion, create `.planning/phases/32-qmhq-transaction-linking/32-02-SUMMARY.md`
</output>
