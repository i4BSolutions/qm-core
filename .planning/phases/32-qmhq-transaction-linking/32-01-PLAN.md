---
phase: 32-qmhq-transaction-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/sor-transaction-group.tsx
  - components/qmhq/items-summary-progress.tsx
autonomous: true

must_haves:
  truths:
    - "SOR transaction group component renders a compact header with SOR ID, status badge, and total qty, linking to SOR detail page"
    - "Items summary progress component renders a stepped progress bar per item showing Requested, Approved, Executed segments with correct colors"
    - "Rejected items appear in Items Summary with a Rejected badge for full transparency"
    - "Progress bar segments are color-coded: gray=requested baseline, blue=approved, green=executed"
  artifacts:
    - path: "components/qmhq/sor-transaction-group.tsx"
      provides: "SOR-grouped transaction display with compact header and transaction rows"
      contains: "SORTransactionGroup"
    - path: "components/qmhq/items-summary-progress.tsx"
      provides: "Multi-segment stepped progress bar for fulfillment pipeline visualization"
      contains: "ItemsSummaryProgress"
  key_links:
    - from: "components/qmhq/sor-transaction-group.tsx"
      to: "/inventory/stock-out-requests/{id}"
      via: "Next.js Link in SOR header"
      pattern: "href.*stock-out-requests"
    - from: "components/qmhq/items-summary-progress.tsx"
      to: "Badge component"
      via: "Rejected badge display"
      pattern: "Rejected"
---

<objective>
Create the two new presentational components for the QMHQ Stock Out tab: an SOR transaction group component that renders transactions grouped by their parent Stock-Out Request with compact headers, and an items summary progress component that shows a stepped/funnel progress bar per item (Requested -> Approved -> Executed -> Pending).

Purpose: These components are the building blocks for the enhanced Stock Out tab on the QMHQ detail page. They implement the user's locked decisions about SOR grouping and stepped progress bar visualization.

Output: Two new React components ready for integration into the QMHQ detail page.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-qmhq-transaction-linking/32-RESEARCH.md
@.planning/phases/32-qmhq-transaction-linking/32-CONTEXT.md

# Existing component to reference for style patterns:
@components/qmhq/fulfillment-progress-bar.tsx
# Badge component for status display:
@components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SOR Transaction Group component</name>
  <files>components/qmhq/sor-transaction-group.tsx</files>
  <action>
Create a new component `SORTransactionGroup` at `components/qmhq/sor-transaction-group.tsx`.

This component renders a single SOR group with:

1. **Compact header** (per user decision: "SOR group header should be compact"):
   - SOR request_number displayed as monospace amber link to `/inventory/stock-out-requests/{sorId}` with ExternalLink icon
   - Status badge next to the link using the existing Badge component. Use inline status color mapping:
     - pending: `bg-amber-500/20 text-amber-400 border-amber-500/30`
     - approved: `bg-blue-500/20 text-blue-400 border-blue-500/30`
     - partially_approved: `bg-blue-500/20 text-blue-400 border-blue-500/30`
     - executed: `bg-emerald-500/20 text-emerald-400 border-emerald-500/30`
     - partially_executed: `bg-purple-500/20 text-purple-400 border-purple-500/30`
     - rejected: `bg-red-500/20 text-red-400 border-red-500/30`
     - cancelled: `bg-slate-500/20 text-slate-400 border-slate-500/30`
   - Right side: "Total Qty: {N}" in slate-400 with the number in font-mono slate-200
   - Container: `p-3 bg-slate-800/30 rounded-lg border border-slate-700`

2. **Transaction rows** underneath (indented with `pl-4`):
   - Each transaction row shows:
     - Left: item name + SKU code (amber, text-xs) + warehouse name (slate-400)
     - Right: quantity (font-mono), status badge (completed=default, pending=secondary)
     - Date at bottom in text-xs slate-400
   - Container per row: `p-3 rounded bg-slate-800/20 border border-slate-700/50`

3. **Groups are always expanded** (no accordion/collapse per user decision).

**Props interface:**
```typescript
interface SORTransactionGroupProps {
  sorId: string;
  sorNumber: string;
  sorStatus: string;
  totalQty: number;
  transactions: Array<{
    id: string;
    quantity: number;
    status: string;
    created_at: string;
    transaction_date?: string | null;
    reason?: string | null;
    notes?: string | null;
    item?: { id: string; name: string; sku: string | null } | null;
    warehouse?: { id: string; name: string } | null;
  }>;
}
```

Use "use client" directive. Import Link from next/link, Badge from @/components/ui/badge, ExternalLink from lucide-react.

Follow existing project styling patterns (dark theme, slate backgrounds, amber accents for IDs).
  </action>
  <verify>
Run `npx tsc --noEmit components/qmhq/sor-transaction-group.tsx` (or full project type-check with `npm run type-check`) to confirm no TypeScript errors. Verify file exists and exports SORTransactionGroup.
  </verify>
  <done>
SORTransactionGroup component renders a compact SOR header with linked request number, status badge, total quantity, and always-expanded transaction rows underneath.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Items Summary Progress component with stepped progress bar</name>
  <files>components/qmhq/items-summary-progress.tsx</files>
  <action>
Create a new component `ItemsSummaryProgress` at `components/qmhq/items-summary-progress.tsx`.

This component replaces the current simple fulfillment progress bar with a richer "funnel-style" stepped progress bar per item, showing the full pipeline: Requested -> Approved -> Executed -> Pending.

**Props interface:**
```typescript
interface ItemProgressData {
  itemId: string;
  itemName: string;
  itemSku: string | null;
  requested: number;
  approved: number;
  executed: number;
  rejected: number;
}

interface ItemsSummaryProgressProps {
  items: ItemProgressData[];
}
```

**Per item, render:**

1. **Item header row** (flex, justify-between):
   - Left side: SKU code (amber, text-xs monospace) + item name (slate-200, text-sm)
   - If `rejected > 0`, show a Badge with variant="outline" and red styling: `border-red-500/30 text-red-400` with text "Rejected: {N}" (per user decision: rejected items visible with Rejected badge)
   - Right side: execution ratio `{executed}/{requested}` in text-xs slate-400

2. **Stepped progress bar** (the bar itself):
   - Container: `h-6 w-full bg-slate-800/50 rounded-lg overflow-hidden relative`
   - Three layered segments (absolute positioning, all left-aligned, stacked on top of each other so the smaller ones draw over larger):
     a. **Requested baseline** (full width): `bg-slate-600/30` — always 100% width
     b. **Approved segment**: `bg-blue-500/40` — width = `(approved / requested) * 100%`
     c. **Executed segment**: `bg-emerald-500` — width = `(executed / requested) * 100%`
   - Cap all percentages: `Math.min(100, ...)` to prevent overflow per research pitfall #4
   - Use `transition-all duration-500` on segments for smooth rendering

3. **Legend row** below the bar (flex, gap-4, text-xs):
   - Each label with a colored dot indicator:
     - Gray dot + "Requested: {N}" in slate-400
     - Blue dot + "Approved: {N}" in blue-400
     - Green dot + "Executed: {N}" in emerald-400
     - If `pending > 0` (pending = approved - executed): Amber dot + "Pending: {N}" in amber-400
   - Dot: `w-2 h-2 rounded-full inline-block mr-1` with the matching bg color

4. **Wrapper:** Section with heading "Items Summary" using `text-sm font-semibold text-slate-300 uppercase tracking-wider` at the top. Items in a `space-y-4` container.

Use "use client" directive. Import Badge from @/components/ui/badge, cn from @/lib/utils.

Handle edge cases:
- If `requested === 0`, render empty bar (0% for all segments)
- If `approved > requested` (data inconsistency), cap at `requested`
- If `executed > approved`, cap at `approved`
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify file exists and exports both `ItemsSummaryProgress` and `ItemProgressData` type.
  </verify>
  <done>
ItemsSummaryProgress component renders a stepped progress bar per item with color-coded segments (gray=requested, blue=approved, green=executed) and a legend row, with rejected items showing a Rejected badge for full pipeline visibility.
  </done>
</task>

</tasks>

<verification>
1. Both component files exist under components/qmhq/
2. `npm run type-check` passes with no errors in new files
3. SORTransactionGroup exports expected component with correct props interface
4. ItemsSummaryProgress exports expected component and ItemProgressData type
5. No new dependencies added (all imports from existing project packages)
</verification>

<success_criteria>
- Two new presentational components created and type-safe
- SOR group component renders compact header linking to SOR detail page with always-expanded transactions
- Items summary component renders stepped progress bar with Requested/Approved/Executed segments
- Rejected items display with Rejected badge in Items Summary
- Both components follow existing project styling patterns (dark theme, slate/amber accents)
</success_criteria>

<output>
After completion, create `.planning/phases/32-qmhq-transaction-linking/32-01-SUMMARY.md`
</output>
