---
phase: 33-dual-reference-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/sor-transaction-group.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - components/qmhq/qmhq-linked-transactions.tsx
autonomous: true

must_haves:
  truths:
    - "Stock-out transaction rows display SOR approval number as primary reference badge"
    - "When transaction is linked to a QMHQ, secondary reference shows 'via QMHQ-YYYY-NNNNN' text"
    - "SOR approval number badge links to the SOR detail page"
    - "QMHQ reference text links to the QMHQ detail page (suppressed when already on that page)"
    - "QMHQ item detail page shows a dedicated Linked Stock-Out Transactions table"
    - "Linked transactions table shows approval number, item, quantity, status, and date for each transaction"
  artifacts:
    - path: "components/qmhq/sor-transaction-group.tsx"
      provides: "Enhanced transaction rows with approval_number badge and QMHQ secondary reference"
      contains: "approval_number"
    - path: "components/qmhq/qmhq-linked-transactions.tsx"
      provides: "Dedicated table showing stock-out transactions linked to a QMHQ"
      contains: "QmhqLinkedTransactions"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Enhanced query with qmhq FK join, passes data to components, integrates linked transactions table"
      contains: "QmhqLinkedTransactions"
  key_links:
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/qmhq/sor-transaction-group.tsx"
      via: "passes approval_number and qmhq data in transaction objects"
      pattern: "approval_number.*qmhq"
    - from: "components/qmhq/sor-transaction-group.tsx"
      to: "/inventory/stock-out-requests/[id]"
      via: "Link component with SOR detail URL"
      pattern: "stock-out-requests"
    - from: "components/qmhq/sor-transaction-group.tsx"
      to: "/qmhq/[id]"
      via: "Link component with QMHQ detail URL"
      pattern: "href.*qmhq"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/qmhq/qmhq-linked-transactions.tsx"
      via: "renders QmhqLinkedTransactions in Stock Out tab"
      pattern: "QmhqLinkedTransactions"
---

<objective>
Add dual reference display to stock-out transactions showing both SOR approval number (primary) and parent QMHQ ID (secondary), with clickable links to respective detail pages. Create a dedicated linked transactions table on the QMHQ item detail page.

Purpose: Provides full traceability from any transaction back to its originating approval and parent QMHQ, completing the cross-entity reference chain established in Phase 32.
Output: Enhanced SOR transaction group component, new linked transactions table component, integrated into QMHQ detail page.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-dual-reference-display/33-RESEARCH.md
@.planning/phases/32-qmhq-transaction-linking/32-02-SUMMARY.md
@components/qmhq/sor-transaction-group.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance SOR transaction group with dual reference display</name>
  <files>
    components/qmhq/sor-transaction-group.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
**SOR Transaction Group component (`components/qmhq/sor-transaction-group.tsx`):**

1. Extend the `transactions` array type in `SORTransactionGroupProps` to include:
   - `approval_number?: string | null` — from stock_out_approval join
   - `qmhq?: { id: string; request_id: string } | null` — from qmhq FK join

2. Add a `currentQmhqId?: string` prop to `SORTransactionGroupProps`. This suppresses the QMHQ link when viewing the QMHQ's own detail page (prevents circular navigation).

3. Add `Link` import (already imported) and ensure ExternalLink icon is available.

4. In each transaction row, add BEFORE the item name:
   - **Approval number badge:** If `transaction.approval_number` exists, render a Badge with `variant="outline"` and classes `font-mono text-xs border-amber-500/30 text-amber-400 bg-amber-500/10`. Make it a Link to `/inventory/stock-out-requests/${sorId}` (reusing the SOR ID from the parent group header). If no approval_number, show nothing (legacy transactions).

5. AFTER the warehouse name line, add secondary QMHQ reference:
   - Only render when `transaction.qmhq` exists AND `transaction.qmhq.id !== currentQmhqId`
   - Display: `via ` followed by a Link to `/qmhq/${transaction.qmhq.id}` with text `{transaction.qmhq.request_id}` and an ExternalLink icon (w-3 h-3)
   - Styling: `text-xs text-slate-400 mt-1` for container, link uses `inline-flex items-center gap-1 text-blue-400 hover:text-blue-300 font-mono`

**QMHQ detail page query enhancement (`app/(dashboard)/qmhq/[id]/page.tsx`):**

1. In the `StockOutTransaction` interface (around line 96), add:
   - `approval_number?: string | null` at the top level (flattened from join for easier access)
   - Note: The stock_out_approval join already exists; approval_number will be extracted from it

2. In the stock-out transactions query (around line 229-253), add to the `stock_out_approvals` select: `approval_number` field (it may already be fetched via `id, approved_quantity` — verify and add if missing).

3. Also add a `qmhq` join to the query:
   ```
   qmhq:qmhq!inventory_transactions_qmhq_id_fkey(id, request_id)
   ```
   This fetches the QMHQ request_id for display as secondary reference.

4. Update the `StockOutTransaction` interface to include:
   ```typescript
   qmhq_ref?: { id: string; request_id: string } | null;
   ```

5. In the `sorGroupedTransactions` useMemo (around line 383-432), update the mapped transaction objects to include:
   - `approval_number: tx.stock_out_approval?.approval_number || null`
   - `qmhq: (tx as any).qmhq || null`

6. Update the SORTransactionGroup invocation (around line 953-960) to pass `currentQmhqId={qmhqId}` prop.

**Important considerations:**
- Handle NULL approval_number gracefully (legacy transactions have no approval link)
- The `sorId` from the group header is used for the approval badge link (links to SOR detail, not to individual approval)
- Suppress QMHQ link on QMHQ's own page to prevent circular navigation
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Run `npm run build` to confirm production build succeeds. Verify that sor-transaction-group.tsx accepts the new props (approval_number, qmhq, currentQmhqId).
  </verify>
  <done>
Stock-out transaction rows display approval_number as a styled badge linking to SOR detail page. When transaction has a qmhq link and is not on that QMHQ's page, "via QMHQ-YYYY-NNNNN" appears as clickable secondary reference. Both REF-01 and REF-02 requirements satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QMHQ linked transactions table and integrate into detail page</name>
  <files>
    components/qmhq/qmhq-linked-transactions.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
**New component (`components/qmhq/qmhq-linked-transactions.tsx`):**

Create a new client component that displays a table of stock-out transactions linked to a specific QMHQ.

1. Mark as `"use client"`.

2. Props interface:
   ```typescript
   interface QmhqLinkedTransactionsProps {
     qmhqId: string;
     qmhqRequestId: string;
   }
   ```

3. Fetch transactions on mount using `createClient()`:
   ```typescript
   supabase
     .from('inventory_transactions')
     .select(`
       id, quantity, status, transaction_date, created_at,
       item:items(name, sku),
       warehouse:warehouses(name),
       stock_out_approval:stock_out_approvals(
         approval_number,
         line_item:stock_out_line_items(
           request:stock_out_requests(id, request_number)
         )
       )
     `)
     .eq('qmhq_id', qmhqId)
     .eq('movement_type', 'inventory_out')
     .eq('is_active', true)
     .order('created_at', { ascending: false })
   ```

4. Define a `LinkedTransaction` interface matching the query shape.

5. Loading state: Show centered "Loading transactions..." text inside a `command-panel corner-accents p-6` container.

6. Empty state: Show Package icon (h-12 w-12, opacity-50), heading "No stock-out transactions linked to this QMHQ yet" in slate-500, wrapped in command-panel.

7. Table structure with columns: Reference, Item, Quantity (right-aligned), Status, Date.
   - **Reference column:**
     - Primary: Approval number as Link to `/inventory/stock-out-requests/${request.id}`, styled `font-mono text-sm text-amber-400 hover:text-amber-300` with ExternalLink icon
     - Secondary: "via {qmhqRequestId}" in `text-xs text-slate-400 mt-1`, font-mono text-blue-400 (NOT a link since user is already on this page)
     - Handle NULL approval_number with fallback text "No approval"
   - **Item column:** Item name + SKU in font-mono text-slate-400
   - **Quantity column:** font-mono right-aligned
   - **Status column:** Badge with variant default for "completed", secondary otherwise
   - **Date column:** Formatted with toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })

8. Wrap table in `overflow-x-auto` for responsive horizontal scroll.

9. Use project styling conventions: `command-panel corner-accents p-6`, `section-header` with Package icon, `border-b border-slate-700` for header rows, `hover:bg-slate-800/30` on body rows.

**Integration into QMHQ detail page (`app/(dashboard)/qmhq/[id]/page.tsx`):**

1. Import `QmhqLinkedTransactions` from `@/components/qmhq/qmhq-linked-transactions`.

2. In the Stock Out tab (around line 906-965), add the `QmhqLinkedTransactions` component AFTER the existing SOR-grouped transactions section (after the closing div of the `space-y-6` block around line 962).

3. Place it outside the existing command-panel, as a separate section below:
   ```tsx
   {/* Linked Transactions Table */}
   <div className="mt-6">
     <QmhqLinkedTransactions
       qmhqId={qmhqId}
       qmhqRequestId={qmhq.request_id}
     />
   </div>
   ```

4. This component fetches its own data independently (not dependent on parent state), which keeps the QMHQ page clean and the component reusable.

**Important considerations:**
- The linked transactions table is separate from the SOR-grouped display above it. The SOR-grouped display shows transactions organized by SOR with progress bars. The linked transactions table is a flat, scannable list optimized for the "show linked stock-out transactions" requirement (LINK-02).
- On the QMHQ's own detail page, the "via QMHQ-XXXX" reference in the table is NOT a link (user is already there), just a display text.
- Use `useEffect` with `[qmhqId]` dependency for fetch.
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors in the new component and QMHQ detail page. Run `npm run build` to confirm production build succeeds. Verify QmhqLinkedTransactions component exists and is imported in the QMHQ detail page.
  </verify>
  <done>
QMHQ item detail page displays a dedicated "Linked Stock-Out Transactions" table showing all stock-out executions linked to this QMHQ. Table shows approval number (clickable to SOR), item name/SKU, quantity, status badge, and date. LINK-02 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with no errors
2. `npm run build` succeeds (production build)
3. SOR transaction group component accepts and renders approval_number badge
4. SOR transaction group component shows "via QMHQ-XXXX" with Link when qmhq data present and not on that QMHQ's page
5. QMHQ detail page query includes qmhq FK join for request_id
6. QmhqLinkedTransactions component renders table with Reference, Item, Qty, Status, Date columns
7. Linked transactions table is integrated into QMHQ Stock Out tab
</verification>

<success_criteria>
- Stock-out transactions show SOR approval number as primary reference badge with link to SOR detail
- Transactions linked to QMHQ show "via QMHQ-YYYY-NNNNN" as clickable secondary reference
- Circular navigation prevented (QMHQ link suppressed when on that QMHQ's page)
- QMHQ item detail has dedicated linked transactions table below the SOR-grouped display
- All builds pass (type-check + production build)
</success_criteria>

<output>
After completion, create `.planning/phases/33-dual-reference-display/33-01-SUMMARY.md`
</output>
