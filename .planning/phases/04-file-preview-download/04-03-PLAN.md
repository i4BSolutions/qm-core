---
phase: 04-file-preview-download
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - components/files/download-all-button.tsx
  - components/files/attachments-tab.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can download all files as ZIP archive in one click"
    - "Download All button is visible above file list"
    - "ZIP file is named with entity ID (e.g., QMRL-2025-00001-attachments.zip)"
    - "Progress indicator shows during ZIP generation"
    - "Partial download success shows appropriate toast message"
  artifacts:
    - path: "components/files/download-all-button.tsx"
      provides: "ZIP download button with progress indicator"
      min_lines: 80
  key_links:
    - from: "components/files/attachments-tab.tsx"
      to: "DownloadAllButton"
      via: "component render"
      pattern: "DownloadAllButton.*files.*entityId"
    - from: "components/files/download-all-button.tsx"
      to: "JSZip"
      via: "zip generation"
      pattern: "JSZip.*generateAsync"
---

<objective>
Build the Download All as ZIP functionality

Purpose: Enable users to download all attached files as a single ZIP archive
Output: Download All button with progress indicator, entity-based ZIP naming, error handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-file-preview-download/04-CONTEXT.md
@.planning/phases/04-file-preview-download/04-RESEARCH.md
@.planning/phases/04-file-preview-download/04-01-SUMMARY.md
@components/files/attachments-tab.tsx
@lib/actions/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create download-all-button component</name>
  <files>
    components/files/download-all-button.tsx
  </files>
  <action>
Create `components/files/download-all-button.tsx`:

Imports:
```typescript
"use client";

import { useState, useCallback } from 'react';
import JSZip from 'jszip';
import { saveAs } from 'file-saver';
import { Download, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { getFileUrl, type FileAttachmentWithUploader } from '@/lib/actions/files';
import { toast } from '@/components/ui/use-toast';
```

Props:
```typescript
interface DownloadAllButtonProps {
  files: FileAttachmentWithUploader[];
  entityId: string; // Display ID like "QMRL-2025-00001"
}
```

State:
- isDownloading: boolean
- progress: number (0-100)

handleDownloadAll function:
1. Set isDownloading = true, progress = 0
2. Create new JSZip instance
3. Loop through files SEQUENTIALLY (not parallel - avoid overwhelming server):
   - Get signed URL via getFileUrl(file.storage_path)
   - If URL fails, increment failCount and continue
   - Fetch file content via fetch(signedUrl)
   - If fetch fails, increment failCount and continue
   - Add blob to zip: zip.file(file.filename, blob)
   - Update progress: Math.round(((i + 1) / files.length) * 100)
4. After loop:
   - If successCount === 0: show destructive toast "Download failed" + suggest individual downloads
   - Else: generate ZIP with zip.generateAsync({ type: 'blob' })
   - Download using saveAs(content, `${entityId}-attachments.zip`)
   - If failCount > 0: show warning toast "Partial download: X files, Y failed"
5. Set isDownloading = false, progress = 0

Button rendering:
- Disabled when isDownloading or files.length === 0
- Show Loader2 spinner + "Downloading... X%" when downloading
- Show Download icon + "Download All" when idle
- Use gap-2 for icon/text spacing
- variant="outline" to distinguish from primary actions

Error handling:
- Wrap entire function in try/catch
- On any unexpected error: toast + reset state
  </action>
  <verify>
- TypeScript compiles: npm run type-check
- DownloadAllButton component exports correctly
- Component handles empty files array
  </verify>
  <done>
Download All button component with sequential file fetching, progress indicator, ZIP generation, and error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate download button into attachments tab</name>
  <files>
    components/files/attachments-tab.tsx
  </files>
  <action>
Update `components/files/attachments-tab.tsx`:

Import DownloadAllButton:
```typescript
import { DownloadAllButton } from './download-all-button';
```

Add entityDisplayId prop to AttachmentsTabProps:
```typescript
interface AttachmentsTabProps {
  entityType: 'qmrl' | 'qmhq';
  entityId: string;
  entityDisplayId: string;  // NEW - e.g., "QMRL-2025-00001"
  canEdit?: boolean;
  onFileCountChange?: (count: number) => void;
}
```

Update header section to include Download All button:
Current:
```tsx
<div className="section-header">
  <Paperclip className="h-4 w-4 text-amber-500" />
  <h3>Attachments ({files.length})</h3>
</div>
```

New:
```tsx
<div className="flex items-center justify-between">
  <div className="section-header">
    <Paperclip className="h-4 w-4 text-amber-500" />
    <h3>Attachments ({files.length})</h3>
  </div>
  <DownloadAllButton files={files} entityId={entityDisplayId} />
</div>
```

Button is always visible (per CONTEXT.md) - even with 0 or 1 file. The button itself disables when files.length === 0.
  </action>
  <verify>
- Run dev server: npm run dev
- Navigate to QMRL detail page with attachments
- Download All button visible above file list
- Click Download All
- Progress percentage updates during download
- ZIP file downloads with correct name (e.g., QMRL-2025-00001-attachments.zip)
- Open ZIP to verify files are inside with correct names
- Test with single file - still works
- Test with 0 files - button is disabled
  </verify>
  <done>
Download All button integrated into attachments tab header, positioned prominently above file list
  </done>
</task>

<task type="auto">
  <name>Task 3: Update QMRL and QMHQ pages to pass entityDisplayId</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Update both detail pages to pass entityDisplayId to AttachmentsTab.

In `app/(dashboard)/qmrl/[id]/page.tsx`:
Find the AttachmentsTab component usage and add entityDisplayId:
```tsx
<AttachmentsTab
  entityType="qmrl"
  entityId={qmrl.id}
  entityDisplayId={qmrl.request_id}  // ADD THIS - uses the QMRL-YYYY-NNNNN format
  canEdit={hasEditPermission}
  onFileCountChange={setFileCount}
/>
```

In `app/(dashboard)/qmhq/[id]/page.tsx`:
Find the AttachmentsTab component usage and add entityDisplayId:
```tsx
<AttachmentsTab
  entityType="qmhq"
  entityId={qmhq.id}
  entityDisplayId={qmhq.line_id}  // ADD THIS - uses the QMHQ-YYYY-NNNNN format
  canEdit={hasEditPermission}
  onFileCountChange={setFileCount}
/>
```

Note: The exact field names (request_id, line_id) should match what's already used in the page to display the entity ID. Check the existing page code to confirm the correct field names.
  </action>
  <verify>
- TypeScript compiles: npm run type-check
- Navigate to QMRL detail page - Download All button works
- ZIP named with QMRL ID (e.g., QMRL-2025-00001-attachments.zip)
- Navigate to QMHQ detail page - Download All button works
- ZIP named with QMHQ ID (e.g., QMHQ-2025-00001-attachments.zip)
  </verify>
  <done>
QMRL and QMHQ detail pages pass entityDisplayId for proper ZIP naming
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm run build - successful production build
2. Click Download All on QMRL page - downloads QMRL-YYYY-NNNNN-attachments.zip
3. Click Download All on QMHQ page - downloads QMHQ-YYYY-NNNNN-attachments.zip
4. Progress indicator shows percentage during download
5. ZIP contains all files with original filenames
6. Partial failure shows appropriate toast (X files, Y failed)
7. Total failure shows error toast with individual download suggestion
8. Button disabled when no files attached
</verification>

<success_criteria>
- Users can download all files as single ZIP archive
- ZIP naming uses entity display ID
- Progress indicator visible during download
- Partial/total failure handled gracefully with toasts
- Works on both QMRL and QMHQ pages
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-preview-download/04-03-SUMMARY.md`
</output>
