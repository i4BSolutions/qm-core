---
phase: 04-file-preview-download
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - components/files/pdf-preview.tsx
  - components/files/attachments-tab.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can click PDF file to see in-app document viewer"
    - "User can navigate pages with Prev/Next buttons"
    - "User can jump to specific page via input field"
    - "User can zoom PDF using +/- buttons at fixed levels"
    - "Password-protected PDFs show error message with download fallback"
  artifacts:
    - path: "components/files/pdf-preview.tsx"
      provides: "PDF viewer with page navigation and zoom"
      min_lines: 120
  key_links:
    - from: "components/files/attachments-tab.tsx"
      to: "PDFPreview"
      via: "dynamic import"
      pattern: "dynamic.*pdf-preview"
    - from: "components/files/pdf-preview.tsx"
      to: "react-pdf"
      via: "Document/Page components"
      pattern: "Document.*Page.*pdfjs"
---

<objective>
Build the PDF preview component with page navigation and zoom controls

Purpose: Enable users to view PDF attachments inline without leaving the application
Output: PDF viewer with page navigation, zoom controls, and proper error handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-file-preview-download/04-CONTEXT.md
@.planning/phases/04-file-preview-download/04-RESEARCH.md
@.planning/phases/04-file-preview-download/04-01-SUMMARY.md
@components/files/attachments-tab.tsx
@components/files/image-preview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF preview component with react-pdf</name>
  <files>
    components/files/pdf-preview.tsx
  </files>
  <action>
Create `components/files/pdf-preview.tsx`:

CRITICAL: This component MUST be dynamically imported with ssr: false to avoid SSR crashes.

Configure PDF.js worker at top of file:
```typescript
"use client";

import { Document, Page, pdfjs } from 'react-pdf';

// Set up PDF.js worker
pdfjs.GlobalWorkerOptions.workerSrc = new URL(
  'pdfjs-dist/build/pdf.worker.min.mjs',
  import.meta.url,
).toString();

// Required CSS for text/annotation layers
import 'react-pdf/dist/Page/AnnotationLayer.css';
import 'react-pdf/dist/Page/TextLayer.css';
```

State:
- numPages: number (total pages, set on load)
- pageNumber: number (current page, 1-indexed)
- pageInput: string (for input field, may be invalid during typing)
- zoomIndex: number (0-3, maps to ZOOM_LEVELS)
- isLoading: boolean
- error: 'load' | 'password' | null

ZOOM_LEVELS: [0.5, 1, 1.5, 2] (same as image preview)

Toolbar (top of component):
Left side - Page navigation:
- ChevronLeft button (prev page) - disabled when pageNumber <= 1
- "Page [input] of [numPages]" - input is editable, validates on blur/Enter
- ChevronRight button (next page) - disabled when pageNumber >= numPages

Right side - Zoom controls:
- ZoomOut button (-) - disabled when zoomIndex <= 0
- Zoom level display: "100%"
- ZoomIn button (+) - disabled when zoomIndex >= 3

Document/Page rendering:
- Document component with file={url}
- onLoadSuccess: set numPages, isLoading = false
- onLoadError: set error = 'load', call onError callback
- onPassword: set error = 'password', call onPasswordRequired callback
- Page component with pageNumber, scale, renderTextLayer, renderAnnotationLayer

Loading state:
- Show Loader2 spinner with "Loading PDF..." text while isLoading

Error states:
- Password protected: Show Lock icon + "This PDF is password protected" + download button
- Load error: Show AlertCircle icon + "Failed to load PDF" + download button

Props:
```typescript
interface PDFPreviewProps {
  url: string;
  onError: () => void;
  onPasswordRequired: () => void;
}
```

Page input handling:
- handlePageInputChange: update pageInput string
- handlePageInputBlur: parse and validate, goToPage if valid, reset to current if invalid
- handlePageInputKeyDown: if Enter, trigger blur handler
  </action>
  <verify>
- TypeScript compiles: npm run type-check
- PDFPreview component exports correctly
- Component has page navigation and zoom controls
  </verify>
  <done>
PDF preview component with page navigation, zoom controls, worker configuration, and error states
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PDF preview into attachments tab</name>
  <files>
    components/files/attachments-tab.tsx
  </files>
  <action>
Update `components/files/attachments-tab.tsx`:

Add dynamic import for PDFPreview (CRITICAL - must use ssr: false):
```typescript
import dynamic from 'next/dynamic';

const PDFPreview = dynamic(() => import('./pdf-preview').then(mod => ({ default: mod.PDFPreview })), {
  ssr: false,
  loading: () => <PDFPreviewSkeleton />,
});
```

Create PDFPreviewSkeleton component (inline or separate):
- Dark background matching modal
- Skeleton toolbar at top
- Skeleton rectangle for PDF page area

Update preview modal content rendering logic:
```typescript
const isPdf = previewFile?.mime_type === 'application/pdf';
const isImage = previewFile?.mime_type.startsWith('image/');
const isPreviewable = isImage || isPdf;
```

In FilePreviewModal children slot:
- If isImage: render ImagePreview
- If isPdf: render PDFPreview with dynamic import
- If !isPreviewable: render NonPreviewablePlaceholder (existing placeholder)

Add handlePdfPasswordRequired function:
- Close modal
- Show toast: "This PDF is password protected. Download to view."
- Toast includes download action button

Add handlePdfError function:
- Close modal
- Show toast: "Failed to load PDF"

Pass callbacks to PDFPreview:
- onError={handlePdfError}
- onPasswordRequired={handlePdfPasswordRequired}
  </action>
  <verify>
- Run dev server: npm run dev
- Navigate to QMRL or QMHQ detail page
- Upload a PDF file (if none exist)
- Click PDF file card - preview modal opens
- PDF renders with page navigation
- Prev/Next buttons work
- Page input field works (type page number, press Enter)
- Zoom in/out works
- Metadata sidebar shows correct info
- Password-protected PDF shows error + download fallback
- Modal closes properly
  </verify>
  <done>
PDF preview integrated into attachments tab with dynamic import, page navigation, zoom, and error handling
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm run build - successful production build (no SSR errors from react-pdf)
2. Click PDF file card - preview modal opens with PDF viewer
3. Page navigation works (Prev/Next buttons, page input)
4. Zoom controls work at fixed levels (50%, 100%, 150%, 200%)
5. "Page X of Y" displays correctly
6. Password-protected PDF shows error message with download option
7. Failed PDF load closes modal and shows toast
8. Dynamic import loading skeleton shows briefly on first load
</verification>

<success_criteria>
- Users can click PDF file card to open in-app PDF viewer
- Page navigation with Prev/Next and input field works correctly
- Zoom controls work at fixed levels
- Password-protected PDFs show error with download fallback
- No SSR errors (dynamic import with ssr: false)
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-preview-download/04-02-SUMMARY.md`
</output>
