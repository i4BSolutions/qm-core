---
phase: 04-file-preview-download
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - components/files/file-preview-modal.tsx
  - components/files/image-preview.tsx
  - components/files/file-card.tsx
  - components/files/attachments-tab.tsx
  - app/globals.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can click file card to open preview modal"
    - "User can see image at full size in preview modal"
    - "User can zoom image using +/- buttons at fixed levels"
    - "User can see file metadata in collapsible sidebar"
    - "User can close modal via X button, outside click, or Escape"
  artifacts:
    - path: "components/files/file-preview-modal.tsx"
      provides: "Preview modal container with metadata sidebar"
      min_lines: 100
    - path: "components/files/image-preview.tsx"
      provides: "Image viewer with zoom controls"
      min_lines: 60
  key_links:
    - from: "components/files/file-card.tsx"
      to: "file-preview-modal.tsx"
      via: "onClick handler"
      pattern: "onClick.*onPreview"
    - from: "components/files/attachments-tab.tsx"
      to: "FilePreviewModal"
      via: "modal state management"
      pattern: "FilePreviewModal.*isOpen"
---

<objective>
Build the file preview modal foundation and image preview functionality

Purpose: Enable users to view attached images at full size without leaving the application
Output: Preview modal with metadata sidebar, image viewer with zoom controls, clickable file cards
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-file-preview-download/04-CONTEXT.md
@.planning/phases/04-file-preview-download/04-RESEARCH.md
@components/files/file-card.tsx
@components/files/attachments-tab.tsx
@lib/actions/files.ts
@components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create preview modal</name>
  <files>
    package.json
    components/files/file-preview-modal.tsx
    app/globals.css
  </files>
  <action>
Install preview dependencies:
```bash
npm install react-pdf react-zoom-pan-pinch jszip file-saver
npm install -D @types/file-saver
```

Create `components/files/file-preview-modal.tsx`:
- Use Radix Dialog (from existing ui/dialog.tsx) as base
- Large modal: max-w-[90vw] max-h-[90vh] w-full h-full p-0 overflow-hidden
- Two-column layout: main content area (flex-1) + metadata sidebar (w-80)
- Main content area: dark bg (bg-slate-950), centered content
- Sidebar: border-l, bg-slate-900, contains file metadata and download button
- Sidebar toggle button (collapse/expand icon) - use ChevronRight/ChevronLeft from lucide-react
- Sidebar state: starts visible (not persisted, always resets to visible)
- Close button (X icon) in top-right corner
- Header shows filename

Props interface:
```typescript
interface FilePreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  file: FileAttachmentWithUploader | null;
  fileUrl: string | null;
  children?: React.ReactNode; // Content slot for image/PDF viewer
}
```

Metadata sidebar displays:
- Filename (truncated with tooltip)
- File size (use formatFileSize from file-validation.ts)
- Upload date (formatted: "Jan 28, 2026")
- Uploader name (from file.uploaded_by_user.full_name)
- Download button (uses window.open with fileUrl)

Add checkerboard CSS to app/globals.css:
```css
.bg-checkerboard {
  background-color: #0f172a; /* slate-950 */
  background-image:
    linear-gradient(45deg, #1e293b 25%, transparent 25%),
    linear-gradient(-45deg, #1e293b 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #1e293b 75%),
    linear-gradient(-45deg, transparent 75%, #1e293b 75%);
  background-size: 20px 20px;
  background-position:
    0 0,
    0 10px,
    10px -10px,
    -10px 0px;
}
```
  </action>
  <verify>
- npm ls react-pdf react-zoom-pan-pinch jszip file-saver shows installed versions
- TypeScript compiles without errors: npm run type-check
- FilePreviewModal component exists and exports
  </verify>
  <done>
Preview modal component created with metadata sidebar, toggle functionality, and download button
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image preview component with zoom controls</name>
  <files>
    components/files/image-preview.tsx
  </files>
  <action>
Create `components/files/image-preview.tsx`:
- Use react-zoom-pan-pinch for zoom/pan
- Fixed zoom levels: 0.5, 1, 1.5, 2 (50%, 100%, 150%, 200%)
- Initial zoom: 100% (index 1)
- State: zoomIndex (number), isLoading (boolean)

Toolbar (positioned at top of image area):
- ZoomOut button (- icon) - disabled when zoomIndex <= 0
- Zoom level display: "100%" format
- ZoomIn button (+ icon) - disabled when zoomIndex >= 3
- Use existing Button component with variant="ghost" size="icon"

TransformWrapper configuration:
- initialScale: current scale from ZOOM_LEVELS[zoomIndex]
- minScale: 0.5
- maxScale: 2
- wheel: { disabled: true } - no scroll wheel zoom per CONTEXT.md
- panning: { disabled: scale <= 1 } - only pan when zoomed in

Image rendering:
- Check if PNG extension for transparent background (use bg-checkerboard class)
- Show loading spinner while image loads (onLoad sets isLoading false)
- img element with max-w-none to allow natural size

Props:
```typescript
interface ImagePreviewProps {
  url: string;
  filename: string;
  onError: () => void;
}
```

On image load error, call onError callback (parent will close modal and show toast).
  </action>
  <verify>
- TypeScript compiles: npm run type-check
- ImagePreview component exports correctly
- Component has zoom controls and loading state
  </verify>
  <done>
Image preview component with fixed zoom levels, loading state, and checkerboard background for transparent images
  </done>
</task>

<task type="auto">
  <name>Task 3: Make file cards clickable and integrate preview modal</name>
  <files>
    components/files/file-card.tsx
    components/files/attachments-tab.tsx
  </files>
  <action>
Update `components/files/file-card.tsx`:
- Add onPreview prop: `onPreview?: () => void`
- Make entire card clickable: wrap in button or add onClick to outer div
- Cursor pointer on hover
- Prevent click propagation from dropdown menu (stopPropagation)
- Keep existing delete functionality working

Updated props:
```typescript
interface FileCardProps {
  file: FileAttachmentWithUploader;
  thumbnailUrl?: string;
  onDelete?: () => void;
  onPreview?: () => void;  // NEW
  canDelete?: boolean;
}
```

Update `components/files/attachments-tab.tsx`:
- Add state for preview modal:
  - previewFile: FileAttachmentWithUploader | null
  - previewUrl: string | null
- Add handlePreviewOpen function:
  - Set previewFile to clicked file
  - Call getFileUrl to get signed URL
  - Set previewUrl
- Add handlePreviewClose function:
  - Set previewFile to null
  - Set previewUrl to null
- Pass onPreview to FileCard components
- Import and render FilePreviewModal at end of component
- Import and render ImagePreview inside modal for image files
- Detect image files: file.mime_type.startsWith('image/')
- For non-image files: show placeholder (icon + "Preview not available" + download button)
  - This is temporary until PDF preview in Plan 02

Error handling:
- If getFileUrl fails, show toast and don't open modal
- If image fails to load (onError), close modal and show toast
  </action>
  <verify>
- Run dev server: npm run dev
- Navigate to QMRL or QMHQ detail page with attachments
- Click file card - preview modal opens
- For images: see full-size image with zoom controls
- Zoom in/out works with buttons
- Sidebar shows correct metadata
- Download button opens file in new tab
- Sidebar toggle hides/shows sidebar
- Close modal via X, outside click, or Escape
  </verify>
  <done>
File cards are clickable, preview modal opens with image preview and metadata sidebar
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm run build - successful production build
2. Click image file card - preview modal opens with full-size image
3. Zoom controls work at fixed levels (50%, 100%, 150%, 200%)
4. Transparent PNG shows checkerboard background
5. Metadata sidebar shows file info and download button
6. Sidebar toggle collapses/expands sidebar
7. Modal closes via X, outside click, Escape key
8. Non-image files show placeholder (pending PDF support in Plan 02)
</verification>

<success_criteria>
- Users can click any file card to open preview modal
- Image files display at full size with zoom controls
- Metadata sidebar shows name, size, date, uploader, download button
- Modal has proper close behavior (X, outside click, Escape)
- TypeScript compiles without errors
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-preview-download/04-01-SUMMARY.md`
</output>
