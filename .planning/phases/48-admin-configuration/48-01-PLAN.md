---
phase: 48-admin-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260214210000_system_config.sql
  - types/database.ts
  - lib/hooks/use-standard-unit-name.ts
  - lib/hooks/index.ts
  - app/(dashboard)/admin/settings/page.tsx
  - components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/settings and see the standard unit name setting"
    - "Admin can change the standard unit name and save it"
    - "Standard unit name persists after page reload"
    - "System defaults to 'Standard Units' if no configuration row exists"
    - "Non-admin users cannot modify the standard unit name (RLS enforced)"
  artifacts:
    - path: "supabase/migrations/20260214210000_system_config.sql"
      provides: "system_config table with key-value storage and default standard_unit_name seed"
      contains: "CREATE TABLE.*system_config"
    - path: "types/database.ts"
      provides: "SystemConfig TypeScript types"
      contains: "system_config"
    - path: "lib/hooks/use-standard-unit-name.ts"
      provides: "Hook for components to retrieve the configured standard unit name"
      exports: ["useStandardUnitName"]
    - path: "app/(dashboard)/admin/settings/page.tsx"
      provides: "Admin settings page with standard unit name configuration form"
      min_lines: 50
  key_links:
    - from: "app/(dashboard)/admin/settings/page.tsx"
      to: "system_config table"
      via: "Supabase client query"
      pattern: "from.*system_config"
    - from: "lib/hooks/use-standard-unit-name.ts"
      to: "system_config table"
      via: "Supabase client query"
      pattern: "from.*system_config.*standard_unit_name"
    - from: "components/layout/sidebar.tsx"
      to: "/admin/settings"
      via: "Navigation link"
      pattern: "Settings.*admin/settings"
---

<objective>
Create the system configuration infrastructure and admin settings page for the standard unit name.

Purpose: SCONF-01 requires admin can set the global standard unit name. SCONF-02 requires all display components retrieve it dynamically. This plan creates the database table, TypeScript types, retrieval hook, and admin UI.

Output: Working admin settings page at /admin/settings where admin can view and edit the standard unit name, plus a reusable hook for Phase 50 display components.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-schema-data-foundation/47-01-SUMMARY.md

# Pattern references - follow these existing patterns exactly
@app/(dashboard)/admin/statuses/page.tsx
@components/ui/currency-display.tsx
@lib/hooks/use-permissions.ts
@types/database.ts
@components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: System config table, types, and standard unit hook</name>
  <files>
    supabase/migrations/20260214210000_system_config.sql
    types/database.ts
    lib/hooks/use-standard-unit-name.ts
    lib/hooks/index.ts
  </files>
  <action>
1. Create migration `supabase/migrations/20260214210000_system_config.sql`:
   - Create `system_config` table with columns:
     - `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
     - `key TEXT NOT NULL UNIQUE` (the config key name)
     - `value TEXT NOT NULL` (the config value, stored as text)
     - `description TEXT` (human-readable description of what this setting does)
     - `updated_at TIMESTAMPTZ DEFAULT now()`
     - `updated_by UUID REFERENCES users(id)`
   - Add RLS: Enable RLS on the table. Policy: admin role can SELECT, INSERT, UPDATE, DELETE. All authenticated users can SELECT (read-only for non-admins). Use the same RLS pattern as other tables -- check `auth.uid()` and join to `users` table to verify role.
   - Seed the default row: INSERT `key = 'standard_unit_name'`, `value = 'Standard Units'`, `description = 'Display name for the system-wide standard unit (shown alongside quantities)'`.
   - Add `updated_at` trigger: Create a trigger that updates `updated_at` on UPDATE (use the same pattern as other tables if one exists, or a simple `NEW.updated_at = now(); RETURN NEW;` trigger function).

2. Update `types/database.ts`:
   - Add `system_config` to the `Tables` section following the exact same pattern as other tables (Row, Insert, Update types).
   - Row type: `{ id: string; key: string; value: string; description: string | null; updated_at: string | null; updated_by: string | null }`
   - Insert type: `{ id?: string; key: string; value: string; description?: string | null; updated_at?: string | null; updated_by?: string | null }`
   - Update type: all fields optional with `?`
   - Add a convenience type alias: `export type SystemConfig = Database["public"]["Tables"]["system_config"]["Row"];`

3. Create `lib/hooks/use-standard-unit-name.ts`:
   - Export a `useStandardUnitName()` hook that:
     - Returns `{ unitName: string; isLoading: boolean }`
     - On mount, queries `system_config` table for `key = 'standard_unit_name'`
     - Returns the `value` field, or defaults to `"Standard Units"` if not found or on error
     - Uses `useState` and `useEffect` with `useCallback` pattern matching existing hooks
     - Caches in component state (no global cache needed -- this is a lightweight query)
   - Follow the exact import/export pattern from existing hooks (named export, JSDoc comment)

4. Update `lib/hooks/index.ts`:
   - Add export for `useStandardUnitName` from `"./use-standard-unit-name"`
  </action>
  <verify>
    - Run `npm run type-check` -- should compile (may still have Phase 47 breaking changes from conversion_rate, that is expected and not a regression)
    - Verify migration file exists and has CREATE TABLE, RLS policies, and seed INSERT
    - Verify types/database.ts has system_config section
    - Verify lib/hooks/use-standard-unit-name.ts exports useStandardUnitName
  </verify>
  <done>
    system_config table migration exists with RLS and seed data. TypeScript types updated. useStandardUnitName hook available for import from @/lib/hooks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin settings page and sidebar navigation</name>
  <files>
    app/(dashboard)/admin/settings/page.tsx
    components/layout/sidebar.tsx
  </files>
  <action>
1. Create `app/(dashboard)/admin/settings/page.tsx`:
   - "use client" directive at top
   - Follow the same visual pattern as `/admin/statuses/page.tsx` and `/admin/categories/page.tsx`:
     - Use `PageHeader` composite component with title "System Settings", description "Configure system-wide settings", and the same violet Admin badge pattern
     - Import and use `usePermissions`, `useToast`, `createClient` from existing locations
   - Page content:
     - A single "command-panel" card section titled "Standard Unit Configuration" with a Ruler icon (from lucide-react)
     - Inside the card: a description paragraph explaining "Configure the display name for the system-wide standard unit. This name appears alongside all quantity displays (e.g., 'Standard Units', 'SU', 'Base Units')."
     - Below: an Input field (from @/components/ui/input) with Label "Standard Unit Name", pre-populated with the current value from system_config
     - A "Save" Button that updates the system_config row via Supabase client
     - Loading state while fetching initial value
     - Toast notification on save success/failure
     - Show current value preview: "Quantities will display as: 120.00 {unitName}" in a muted info box below the input
   - Data flow:
     - On mount: fetch from `system_config` where `key = 'standard_unit_name'`, populate input
     - On save: upsert to `system_config` with `key = 'standard_unit_name'`, `value = inputValue`, `updated_by = user.id`
     - Use the same `useCallback` + `useEffect` data fetching pattern as other admin pages
   - Permission: Use `can("update", "statuses")` as a proxy for admin-only check (only admin has update on statuses). If not permitted, show a read-only view with the current value but no edit controls.
   - Do NOT add "system_config" to PermissionResource -- this is a simple admin-only page and checking admin status via existing permissions is sufficient. Avoid scope creep.

2. Update `components/layout/sidebar.tsx`:
   - Add `{ label: "Settings", href: "/admin/settings" }` to the `adminNavigation` children array, placing it as the LAST item (after "Flow Tracking")
  </action>
  <verify>
    - Run `npm run type-check` -- should compile (same caveat about Phase 47 breaking changes)
    - Verify admin/settings/page.tsx exists and has PageHeader, Input, save functionality
    - Verify sidebar.tsx has "Settings" entry pointing to /admin/settings
  </verify>
  <done>
    Admin settings page renders at /admin/settings with standard unit name configuration. Sidebar shows "Settings" link under Admin section. Admin can view, edit, and save the standard unit name with toast feedback.
  </done>
</task>

</tasks>

<verification>
1. Database: Migration file creates system_config table with proper schema, RLS, and seed data
2. Types: TypeScript types updated for system_config table
3. Hook: useStandardUnitName returns "Standard Units" default, queries system_config
4. UI: Admin settings page at /admin/settings shows standard unit name input
5. Navigation: Sidebar Admin section includes "Settings" link
6. Save flow: Updating the name persists to database and reloads correctly
</verification>

<success_criteria>
- SCONF-01: Admin can set the standard unit name via /admin/settings page
- SCONF-02 (partial): useStandardUnitName hook exists for Phase 50 display components to consume
- system_config table seeded with default "Standard Units" value
- Non-admin users can read but not modify settings (RLS enforced)
- Page follows existing admin page visual patterns (PageHeader, command-panel, toast notifications)
</success_criteria>

<output>
After completion, create `.planning/phases/48-admin-configuration/48-01-SUMMARY.md`
</output>
