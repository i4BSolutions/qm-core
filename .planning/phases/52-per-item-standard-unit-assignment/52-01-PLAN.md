---
phase: 52-per-item-standard-unit-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216200000_item_standard_unit_fk.sql
  - types/database.ts
autonomous: true

must_haves:
  truths:
    - "Every existing item has a standard_unit_id pointing to the 'pcs' standard unit"
    - "New items require a standard_unit_id (NOT NULL constraint)"
    - "Deleting a standard unit that has items assigned to it is blocked by ON DELETE RESTRICT"
  artifacts:
    - path: "supabase/migrations/20260216200000_item_standard_unit_fk.sql"
      provides: "standard_unit_id FK column on items table with backfill"
      contains: "standard_unit_id"
    - path: "types/database.ts"
      provides: "Updated Item type with standard_unit_id field"
      contains: "standard_unit_id"
  key_links:
    - from: "items.standard_unit_id"
      to: "standard_units.id"
      via: "FK constraint with ON DELETE RESTRICT"
      pattern: "REFERENCES.*standard_units"
---

<objective>
Add standard_unit_id foreign key column to the items table, backfill all existing items with 'pcs', and update TypeScript types.

Purpose: Items need a standard unit assignment before the UI can display and require it in forms.
Output: Migration file and updated types enabling per-item standard unit assignment.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-standard-unit-entity-admin/51-01-SUMMARY.md
@supabase/migrations/007_items.sql
@supabase/migrations/20260216100000_standard_units.sql
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to add standard_unit_id FK to items and update types</name>
  <files>
    supabase/migrations/20260216200000_item_standard_unit_fk.sql
    types/database.ts
  </files>
  <action>
Create the migration file `supabase/migrations/20260216200000_item_standard_unit_fk.sql`:

**Step 1: Add nullable column first**
```sql
ALTER TABLE public.items
  ADD COLUMN IF NOT EXISTS standard_unit_id UUID;
```

**Step 2: Backfill all existing items with 'pcs' unit**
Look up the 'pcs' unit by name from standard_units and assign it to ALL items:
```sql
UPDATE public.items
SET standard_unit_id = (SELECT id FROM public.standard_units WHERE name = 'pcs' LIMIT 1)
WHERE standard_unit_id IS NULL;
```

**Step 3: Add NOT NULL constraint**
```sql
ALTER TABLE public.items
  ALTER COLUMN standard_unit_id SET NOT NULL;
```

**Step 4: Add FK constraint with ON DELETE RESTRICT**
```sql
ALTER TABLE public.items
  ADD CONSTRAINT items_standard_unit_id_fkey
  FOREIGN KEY (standard_unit_id)
  REFERENCES public.standard_units(id)
  ON DELETE RESTRICT;
```

**Step 5: Add index for FK lookups**
```sql
CREATE INDEX IF NOT EXISTS idx_items_standard_unit_id ON public.items(standard_unit_id);
```

**Step 6: Add comment**
```sql
COMMENT ON COLUMN public.items.standard_unit_id IS 'Standard unit of measurement for this item (e.g., pcs, kg, L)';
```

Then update `types/database.ts`:
- Find the `items` table definition (around line 285) in the generated types
- Add `standard_unit_id: string` to the Row type (NOT NULL so no `| null`)
- Add `standard_unit_id?: string` to the Insert type (optional â€” database might default via backfill but UI should always supply)
- Add `standard_unit_id?: string` to the Update type
- Add a new relationship entry for `items_standard_unit_id_fkey` referencing `standard_units`

The generated types use `Database["public"]["Tables"]["items"]` structure. Add `standard_unit_id` field to Row, Insert, and Update.
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify the migration file exists and contains ALTER TABLE, UPDATE backfill, NOT NULL, FK constraint, and index creation. Verify types/database.ts includes standard_unit_id in items Row/Insert/Update types.
  </verify>
  <done>
Migration file creates standard_unit_id column on items, backfills all rows with 'pcs' unit, sets NOT NULL, adds FK with ON DELETE RESTRICT, and adds index. TypeScript types include the new column.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/20260216200000_item_standard_unit_fk.sql
- [ ] Migration adds standard_unit_id column to items table
- [ ] Migration backfills all existing items with 'pcs' standard unit
- [ ] Migration adds NOT NULL constraint after backfill
- [ ] Migration adds FK constraint with ON DELETE RESTRICT
- [ ] Migration adds index on standard_unit_id
- [ ] types/database.ts includes standard_unit_id in items Row type as string (not null)
- [ ] types/database.ts includes standard_unit_id in items Insert/Update types
- [ ] `npm run type-check` passes
</verification>

<success_criteria>
Database schema supports per-item standard unit assignment with all existing items assigned to 'pcs'. TypeScript types reflect the new column.
</success_criteria>

<output>
After completion, create `.planning/phases/52-per-item-standard-unit-assignment/52-01-SUMMARY.md`
</output>
