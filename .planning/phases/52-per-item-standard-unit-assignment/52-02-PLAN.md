---
phase: 52-per-item-standard-unit-assignment
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - app/(dashboard)/item/item-dialog.tsx
  - app/(dashboard)/item/page.tsx
  - app/(dashboard)/item/[id]/page.tsx
  - app/(dashboard)/admin/standard-units/page.tsx
autonomous: true

must_haves:
  truths:
    - "User must select a standard unit when creating a new item"
    - "User must select a standard unit when editing an item"
    - "Item list table shows a Unit column with the standard unit name"
    - "Item detail page shows Standard Unit as a label-value row in the details section"
    - "Admin standard-units page shows real item count per unit instead of placeholder 0"
    - "Inline item creation from PO/Invoice forms includes the standard unit selector"
  artifacts:
    - path: "app/(dashboard)/item/item-dialog.tsx"
      provides: "Item create/edit dialog with standard unit InlineCreateSelect"
      contains: "standard_unit"
    - path: "app/(dashboard)/item/page.tsx"
      provides: "Item list page with Unit column"
      contains: "standard_unit"
    - path: "app/(dashboard)/item/[id]/page.tsx"
      provides: "Item detail page with Standard Unit info row"
      contains: "standard_unit"
    - path: "app/(dashboard)/admin/standard-units/page.tsx"
      provides: "Admin page with real item usage counts per unit"
      contains: "item_count"
  key_links:
    - from: "app/(dashboard)/item/item-dialog.tsx"
      to: "components/forms/inline-create-select.tsx"
      via: "InlineCreateSelect with createType standard_unit"
      pattern: "createType.*standard_unit"
    - from: "app/(dashboard)/item/page.tsx"
      to: "items.standard_unit_id"
      via: "Supabase join query to standard_units"
      pattern: "standard_unit"
    - from: "app/(dashboard)/admin/standard-units/page.tsx"
      to: "items.standard_unit_id"
      via: "Count query grouped by standard_unit_id"
      pattern: "item_count"
---

<objective>
Wire standard unit selection into item forms, display unit name in item views, and show real usage counts on the admin page.

Purpose: Users can assign and see standard units on items, completing the per-item unit assignment feature.
Output: Updated item dialog, list, detail, and admin pages with standard unit integration.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-per-item-standard-unit-assignment/52-01-SUMMARY.md
@.planning/phases/51-standard-unit-entity-admin/51-02-SUMMARY.md
@app/(dashboard)/item/item-dialog.tsx
@app/(dashboard)/item/page.tsx
@app/(dashboard)/item/[id]/page.tsx
@app/(dashboard)/admin/standard-units/page.tsx
@components/forms/inline-create-select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add standard unit selector to item dialog and update item list</name>
  <files>
    app/(dashboard)/item/item-dialog.tsx
    app/(dashboard)/item/page.tsx
  </files>
  <action>
**ItemDialog (`app/(dashboard)/item/item-dialog.tsx`):**

1. Add state for standard units:
```typescript
const [standardUnits, setStandardUnits] = useState<StandardUnit[]>([]);
```

2. Add `standard_unit_id: ""` to the formData state (both initial and reset).

3. Fetch standard units on open (alongside categories fetch):
```typescript
const { data: unitsData } = await supabase
  .from("standard_units" as any)
  .select("id, name, display_order")
  .order("display_order");
if (unitsData) setStandardUnits(unitsData as unknown as StandardUnit[]);
```

4. When editing an existing item, populate `standard_unit_id` from `item.standard_unit_id || ""`.

5. Add InlineCreateSelect for standard unit **immediately after the Name field** (before Category), per the user decision that unit is a core property in the top section:
```tsx
<div className="grid gap-2">
  <Label>
    Standard Unit <span className="text-red-400">*</span>
  </Label>
  <InlineCreateSelect
    value={formData.standard_unit_id}
    onValueChange={(value) => setFormData({ ...formData, standard_unit_id: value })}
    options={standardUnits}
    onOptionsChange={setStandardUnits}
    placeholder="Select unit"
    entityType="item"
    createType="standard_unit"
  />
</div>
```
Note: Required on BOTH create and edit (always show asterisk, not conditional like category).

6. Include `standard_unit_id` in the data object sent to Supabase on save:
```typescript
const data = {
  name: formData.name,
  category_id: formData.category_id || null,
  standard_unit_id: formData.standard_unit_id,
  photo_url: photoUrl,
  price_reference: formData.price_reference || null,
};
```

7. Update the submit button disabled condition to also require `formData.standard_unit_id`:
```typescript
disabled={isLoading || !formData.name || !formData.standard_unit_id || !formData.price_reference || (!item && !formData.category_id)}
```

8. Import StandardUnit type from `@/types/database`.

**Item List Page (`app/(dashboard)/item/page.tsx`):**

1. Update the Supabase query to join standard_units:
```typescript
const { data, error: queryError } = await supabase
  .from("items")
  .select(`
    id, name, sku, photo_url, category_id, price_reference, standard_unit_id,
    category_rel:categories(id, name, color),
    standard_unit_rel:standard_units!items_standard_unit_id_fkey(id, name)
  `)
  .eq("is_active", true)
  .order("name")
  .limit(200);
```
Note: The FK hint `!items_standard_unit_id_fkey` may be needed for Supabase to resolve the join correctly. If the generated types don't recognize `standard_units`, cast with `as any` on the query.

2. Update `ItemWithCategory` interface to include the unit relation:
```typescript
interface ItemWithCategory extends Item {
  category_rel?: Category | null;
  standard_unit_rel?: { id: string; name: string } | null;
}
```

3. Add a "Unit" column to the columns array. Insert it **after the Name column** and **before Price Reference**:
```typescript
{
  accessorKey: "standard_unit_rel",
  header: "Unit",
  cell: ({ row }) => {
    const unit = row.original.standard_unit_rel;
    return unit ? (
      <span className="text-sm text-slate-300">{unit.name}</span>
    ) : (
      <span className="text-slate-500">—</span>
    );
  },
},
```
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify item-dialog.tsx contains InlineCreateSelect with createType="standard_unit". Verify page.tsx query includes standard_unit_rel join and columns array includes the Unit column.
  </verify>
  <done>
Item create/edit dialog requires standard unit selection via InlineCreateSelect. Item list page shows a Unit column with the unit name from the joined standard_units table. Standard unit is required for both new and existing items.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update item detail page and admin standard-units item count</name>
  <files>
    app/(dashboard)/item/[id]/page.tsx
    app/(dashboard)/admin/standard-units/page.tsx
  </files>
  <action>
**Item Detail Page (`app/(dashboard)/item/[id]/page.tsx`):**

1. Update the Supabase query to join standard_units alongside categories:
```typescript
const { data: itemData, error: itemError } = await supabase
  .from("items")
  .select(`
    *,
    category_rel:categories!items_category_id_fkey(id, name, color),
    standard_unit_rel:standard_units!items_standard_unit_id_fkey(id, name)
  `)
  .eq("id", itemId)
  .single();
```
If FK hint doesn't work with generated types, use `as any` cast.

2. Update the `ItemWithCategory` interface:
```typescript
interface ItemWithCategory extends Item {
  category_rel?: Category | null;
  standard_unit_rel?: { id: string; name: string } | null;
}
```

3. In the Details tab, Item Information section, replace the "Default Unit" grid cell with "Standard Unit":
Change:
```tsx
<div>
  <p className="text-xs text-slate-400 uppercase tracking-wider mb-1">
    Default Unit
  </p>
  <p className="text-slate-200">{item.default_unit || "pcs"}</p>
</div>
```
To:
```tsx
<div>
  <p className="text-xs text-slate-400 uppercase tracking-wider mb-1">
    Standard Unit
  </p>
  <p className="text-slate-200">{item.standard_unit_rel?.name || "—"}</p>
</div>
```

4. In the header area, replace the `default_unit` display with the standard_unit_rel name:
Change `item.default_unit && (...)` block to:
```tsx
{item.standard_unit_rel && (
  <span className="text-sm text-slate-500">
    Unit: {item.standard_unit_rel.name}
  </span>
)}
```

**Admin Standard Units Page (`app/(dashboard)/admin/standard-units/page.tsx`):**

1. Add item count fetching. After fetching units, also fetch the count of items per standard_unit_id:
```typescript
// Fetch item counts per unit
const { data: countData } = await supabase
  .from("items")
  .select("standard_unit_id")
  .eq("is_active", true);

// Build count map
const countMap = new Map<string, number>();
if (countData) {
  countData.forEach((item: any) => {
    if (item.standard_unit_id) {
      countMap.set(item.standard_unit_id, (countMap.get(item.standard_unit_id) || 0) + 1);
    }
  });
}
```

Store the count map in state:
```typescript
const [itemCounts, setItemCounts] = useState<Map<string, number>>(new Map());
```

2. Update the `item_count` column in the columns array to use real data:
```typescript
{
  accessorKey: "item_count",
  header: ({ column }) => <DataTableColumnHeader column={column} title="Item Count" />,
  cell: ({ row }) => {
    const count = itemCounts.get(row.original.id) || 0;
    return (
      <span className={count > 0 ? "text-slate-200 font-medium" : "text-slate-500"}>
        {count}
      </span>
    );
  },
},
```

Remove the old tooltip "Available after item assignment" and the hardcoded "0".

Note: The columns array uses `itemCounts` from component state. Since columns reference closure state, the DataTable will re-render when itemCounts updates. This is fine for the expected data size.
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify item detail page query includes standard_unit_rel join. Verify the details tab shows "Standard Unit" instead of "Default Unit". Verify admin standard-units page queries item counts and displays them in the table column.
  </verify>
  <done>
Item detail page shows Standard Unit as a label-value row in the details section and in the header. Admin standard-units page displays real item usage counts per unit instead of placeholder zeros.
  </done>
</task>

</tasks>

<verification>
- [ ] Item dialog has InlineCreateSelect with createType="standard_unit" positioned after Name
- [ ] Standard unit is required on both create and edit (submit button disabled without it)
- [ ] Item list page shows Unit column with unit name from joined query
- [ ] Item detail page shows "Standard Unit: {name}" in details section
- [ ] Item detail page header shows unit name
- [ ] Admin standard-units page shows real item count per unit
- [ ] Item selectors in PO/Invoice/Stock-out remain unchanged (no unit in dropdown)
- [ ] `npm run type-check` passes
</verification>

<success_criteria>
Users can select a standard unit when creating or editing items, see the unit in item list and detail views, and admins can see how many items reference each unit on the admin page.
</success_criteria>

<output>
After completion, create `.planning/phases/52-per-item-standard-unit-assignment/52-02-SUMMARY.md`
</output>
