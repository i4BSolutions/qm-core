---
phase: 05-management-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - app/(dashboard)/dashboard/page.tsx
  - app/(dashboard)/dashboard/components/dashboard-client.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin users see live dashboard when visiting /dashboard"
    - "Quartermaster users see live dashboard when visiting /dashboard"
    - "Finance users redirect to /po from /dashboard"
    - "Inventory users redirect to /inventory from /dashboard"
    - "Proposal users redirect to /qmhq from /dashboard"
    - "Frontline users redirect to /qmrl from /dashboard"
    - "Requester users redirect to /qmrl from /dashboard"
    - "Dashboard auto-refreshes every 60 seconds"
    - "Last updated timestamp displays and updates with each refresh"
  artifacts:
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Server Component with role check and data fetch"
      exports: ["default"]
    - path: "app/(dashboard)/dashboard/components/dashboard-client.tsx"
      provides: "Client Component with auto-refresh"
      exports: ["DashboardClient"]
  key_links:
    - from: "page.tsx"
      to: "redirect()"
      via: "role-based navigation"
      pattern: "redirect\\("
    - from: "dashboard-client.tsx"
      to: "useInterval"
      via: "60-second polling"
      pattern: "useInterval.*60000"
    - from: "dashboard-client.tsx"
      to: "getDashboardData"
      via: "data refresh"
      pattern: "getDashboardData"
---

<objective>
Integrate dashboard components with role-based access control and auto-refresh functionality. Replace the placeholder dashboard page with real data.

Purpose: Complete the management dashboard with proper access control and real-time updates.
Output: Working dashboard page accessible only to Admin and Quartermaster roles, with 60-second auto-refresh.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-management-dashboard/05-CONTEXT.md
@.planning/phases/05-management-dashboard/05-RESEARCH.md
@.planning/phases/05-management-dashboard/05-01-SUMMARY.md
@.planning/phases/05-management-dashboard/05-02-SUMMARY.md
@lib/actions/dashboard.ts
@lib/hooks/use-interval.ts
@app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DashboardClient component with auto-refresh</name>
  <files>app/(dashboard)/dashboard/components/dashboard-client.tsx</files>
  <action>
Create `app/(dashboard)/dashboard/components/dashboard-client.tsx`:

1. Client component setup:
   - 'use client' directive
   - Import useState from react
   - Import getDashboardData, DashboardData from @/lib/actions/dashboard
   - Import useInterval from @/lib/hooks/use-interval
   - Import formatDistanceToNow from date-fns
   - Import all dashboard components: KPICard, AlertList, ActivityTimeline, StockTimeline
   - Import FileText, ClipboardList from lucide-react for card icons

2. Props interface:
   ```typescript
   interface DashboardClientProps {
     initialData: DashboardData;
     userName: string;
   }
   ```

3. State:
   - data: DashboardData (initialized with initialData)
   - lastUpdated: Date (initialized with new Date())
   - isRefreshing: boolean (for subtle refresh indicator)

4. Auto-refresh with useInterval:
   - 60000ms (60 seconds)
   - Set isRefreshing true
   - Call getDashboardData()
   - Update data and lastUpdated
   - Set isRefreshing false
   - Wrap in try/catch, log errors to console

5. Greeting logic:
   - Get hour: new Date().getHours()
   - hour < 12: "Good morning"
   - hour < 17: "Good afternoon"
   - else: "Good evening"

6. Render layout per CONTEXT.md:
   - Header section:
     - Greeting: "{greeting}, {userName}" (text-3xl font-bold)
     - Date: today's date formatted nicely
     - Last updated timestamp (text-xs text-slate-500) with optional "Refreshing..." indicator

   - KPI cards row (grid lg:grid-cols-2 gap-6):
     - KPICard for QMRL (icon: FileText, href: /qmrl, title: "QMRL Requests")
     - KPICard for QMHQ (icon: ClipboardList, href: /qmhq, title: "QMHQ Orders")

   - Two-column section (grid lg:grid-cols-2 gap-6):
     - Left: AlertList with alerts
     - Right: Column with ActivityTimeline and StockTimeline (space-y-6)

7. Section wrappers:
   - Each section in a card container: rounded-xl border border-slate-800 bg-slate-900/50 p-6
   - Section headers: text-lg font-semibold text-white mb-4
  </action>
  <verify>
npm run type-check - no TypeScript errors.
Component properly imports and renders all dashboard sub-components.
  </verify>
  <done>
DashboardClient component renders full dashboard layout with greeting, KPI cards, alerts, and timelines. Auto-refresh implemented with 60-second interval.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update page.tsx with role-based access and data fetching</name>
  <files>app/(dashboard)/dashboard/page.tsx</files>
  <action>
Replace `app/(dashboard)/dashboard/page.tsx` entirely:

1. Server Component setup:
   - Remove 'use client' if present (this is a Server Component)
   - Import redirect from next/navigation
   - Import createClient from @/lib/supabase/server
   - Import getDashboardData from @/lib/actions/dashboard
   - Import DashboardClient from ./components/dashboard-client

2. Role-based redirect map:
   ```typescript
   const roleRedirectMap: Record<string, string> = {
     finance: '/po',
     inventory: '/inventory',
     proposal: '/qmhq',
     frontline: '/qmrl',
     requester: '/qmrl',
   };
   ```

3. Async function logic:
   a. Create Supabase client
   b. Get authenticated user:
      ```typescript
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) redirect('/login');
      ```
   c. Fetch user profile with role:
      ```typescript
      const { data: profile } = await supabase
        .from('users')
        .select('role, full_name')
        .eq('id', user.id)
        .single();
      ```
   d. Check role - redirect non-management:
      ```typescript
      if (profile?.role && profile.role !== 'admin' && profile.role !== 'quartermaster') {
        const redirectTo = roleRedirectMap[profile.role] || '/qmrl';
        redirect(redirectTo);
      }
      ```
   e. Fetch dashboard data (after role check passes):
      ```typescript
      const dashboardData = await getDashboardData();
      ```
   f. Return DashboardClient with initialData and userName:
      ```typescript
      return (
        <DashboardClient
          initialData={dashboardData}
          userName={profile?.full_name || 'User'}
        />
      );
      ```

4. Delete ALL placeholder code from the existing page (the stats array, recentActivity array, StatCard component, etc.)
  </action>
  <verify>
npm run type-check - no TypeScript errors.
npm run build - page compiles successfully.
Manual test: Login as admin/quartermaster -> see dashboard. Login as other role -> redirected.
  </verify>
  <done>
Dashboard page fetches user role, redirects non-management users, fetches data, and renders DashboardClient. Placeholder code removed.
  </done>
</task>

</tasks>

<verification>
1. npm run type-check passes
2. npm run build succeeds
3. Admin/Quartermaster users see dashboard with real data
4. Other roles are redirected to their primary page
5. Dashboard shows last updated timestamp
6. After 60 seconds, data refreshes automatically
</verification>

<success_criteria>
- Admin visiting /dashboard sees live dashboard
- Quartermaster visiting /dashboard sees live dashboard
- Finance visiting /dashboard redirects to /po
- Inventory visiting /dashboard redirects to /inventory
- Proposal visiting /dashboard redirects to /qmhq
- Frontline visiting /dashboard redirects to /qmrl
- Requester visiting /dashboard redirects to /qmrl
- Dashboard displays personalized greeting with user name
- Dashboard auto-refreshes every 60 seconds
- Last updated timestamp updates on each refresh
- All KPI cards, alerts, and timelines render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-management-dashboard/05-03-SUMMARY.md`
</output>
