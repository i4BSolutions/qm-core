---
phase: 57-two-layer-approval-ui-execution-page
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - app/(dashboard)/inventory/stock-out/page.tsx
  - components/layout/sidebar.tsx
autonomous: true
requirements: [EXEC-01, EXEC-02, EXEC-03, EXEC-04]

must_haves:
  truths:
    - "User can navigate to /inventory/stock-out and see a list of all L2 warehouse assignments"
    - "The list defaults to showing only 'Pending Execution' assignments"
    - "User can filter assignments by warehouse using a dropdown"
    - "User can filter assignments by status: Pending Execution / Executed / All"
    - "Each row shows SOR ID (display-only, not a link), Item name, Warehouse, Qty, Requester, Status"
    - "User can click Execute on a pending row to open a simple confirmation dialog"
    - "After execution, the row updates in-place (status changes to Executed, execute button disappears)"
    - "There is no 'New Request' button on the execution page (execution only, per CONTEXT.md)"
    - "Sidebar 'Stock Out' link under Inventory points to the execution page at /inventory/stock-out"
  artifacts:
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Dedicated stock-out execution page showing L2 warehouse assignments as a task queue"
      min_lines: 100
    - path: "components/layout/sidebar.tsx"
      provides: "Updated sidebar navigation with execution page link"
  key_links:
    - from: "app/(dashboard)/inventory/stock-out/page.tsx"
      to: "stock_out_approvals table"
      via: "query L2 approvals (layer='admin', decision='approved') with warehouse and line item joins"
      pattern: "layer.*admin.*decision.*approved"
    - from: "app/(dashboard)/inventory/stock-out/page.tsx"
      to: "inventory_transactions table"
      via: "execution updates pending transaction to completed"
      pattern: "update.*inventory_transactions.*status.*completed"
    - from: "components/layout/sidebar.tsx"
      to: "app/(dashboard)/inventory/stock-out/page.tsx"
      via: "sidebar navigation link"
      pattern: "stock-out"
---

<objective>
Build the dedicated stock-out execution page at `/inventory/stock-out` as a task-queue-style list of pending warehouse assignments, and update the sidebar navigation.

Purpose: Inventory staff need a centralized page to see all approved warehouse assignments ready for execution, filter by warehouse, and execute them one by one. The current stock-out page content is replaced entirely.

Output: Complete execution page with list view, warehouse filter, status filter, per-row execution dialog, sidebar update.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-CONTEXT.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-RESEARCH.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-01-SUMMARY.md

@app/(dashboard)/inventory/stock-out/page.tsx
@components/layout/sidebar.tsx
@components/stock-out-requests/execution-confirmation-dialog.tsx
@components/composite/index.ts
@lib/hooks/use-pagination-params.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dedicated stock-out execution page</name>
  <files>
    app/(dashboard)/inventory/stock-out/page.tsx
  </files>
  <action>
**Completely replace the content of `app/(dashboard)/inventory/stock-out/page.tsx` with the execution page.**

The current page has two modes: (1) an info page when no QMHQ param, and (2) a stock-out form when QMHQ param exists. Replace ALL of this with the execution page. Note: The QMHQ-based stock-out flow now goes through stock-out requests, not this page.

**Page structure:**

a) **Header** using `PageHeader` composite component:
- Title: "Stock-Out Execution"
- Description: "Execute approved warehouse assignments"
- No action buttons (no "New Request" per CONTEXT.md -- EXEC-03 is overridden by user decision)

b) **Filter bar** using `FilterBar` pattern (or inline filters):
- **Status filter** (Select dropdown): "Pending Execution" (default), "Executed", "All"
- **Warehouse filter** (Select dropdown): "All Warehouses" + list of all active warehouses
- Use the same FilterBar pattern from the standardized list pages (Phase 56)

c) **Data fetching:**
Query all L2 (admin layer) approvals with their related data:
```typescript
const { data: assignments } = await supabase
  .from('stock_out_approvals')
  .select(`
    id,
    approved_quantity,
    warehouse_id,
    line_item_id,
    parent_approval_id,
    decided_at,
    warehouses:warehouses!stock_out_approvals_warehouse_id_fkey(id, name),
    line_item:stock_out_line_items!stock_out_approvals_line_item_id_fkey(
      id, item_name, item_sku, item_id, conversion_rate,
      request:stock_out_requests!stock_out_line_items_request_id_fkey(
        id, request_number, reason, requester_id,
        requester:users!stock_out_requests_requester_id_fkey(id, full_name)
      )
    ),
    inventory_txns:inventory_transactions!inventory_transactions_stock_out_approval_id_fkey(
      id, status
    )
  `)
  .eq('layer', 'admin')
  .eq('decision', 'approved')
  .eq('is_active', true)
  .order('decided_at', { ascending: false });
```

Determine execution status per assignment:
```typescript
const isExecuted = (a.inventory_txns || []).some(tx => tx.status === 'completed');
const executionStatus = isExecuted ? 'executed' : 'pending_execution';
```

d) **Filtering logic:**
- Status filter: filter by `executionStatus`
- Warehouse filter: filter by `warehouse_id`
- Default: show only `pending_execution`

e) **Pagination:** Use `usePaginationParams` hook and `Pagination` component per Phase 56 pattern.

f) **List view table** (list only, no card view per CONTEXT.md):
Table columns:
| SOR ID | Item | Warehouse | Qty | Requester | Status | Action |

- **SOR ID**: Display `request_number` as plain text (NOT a link per CONTEXT.md decision -- "SOR ID is display-only -- not a link"). Use regular text-slate-300 styling, NOT the text-amber-400 font-mono link pattern.
- **Item**: Item name with SKU below in slate-400 font-mono
- **Warehouse**: Warehouse name
- **Qty**: Approved quantity in font-mono, with standard unit conversion below if available (using conversion_rate and item's standard unit)
- **Requester**: Requester full_name
- **Status**: Badge -- "Pending Execution" (amber bg, white text) or "Executed" (emerald bg, white text). Use solid style matching Phase 56 decision.
- **Action**: For pending rows, show "Execute" button (emerald, size=sm). For executed rows, no button (just the badge).

g) **Row styling:**
- No row click handler (rows are not clickable)
- Hover state: subtle bg-slate-800/30
- Executed rows: slightly dimmed (opacity-75 or text-slate-500)

h) **Execution flow (simple confirmation per CONTEXT.md):**
- From this page, execution uses **simple confirmation dialog** (no stock display). CONTEXT says: "Execution from stock-out page: simple confirmation (no stock display)"
- Reuse `ExecutionConfirmationDialog` with just item name, quantity, and warehouse name
- On confirm: update inventory_transaction from pending to completed
```typescript
const { error } = await supabase
  .from('inventory_transactions')
  .update({
    status: 'completed',
    transaction_date: new Date().toISOString(),
  })
  .eq('stock_out_approval_id', approvalId)
  .eq('status', 'pending');
```
- On success: toast, refetch data (row updates in-place -- status changes, button disappears)
- On error (e.g., insufficient stock from DB trigger): show error toast "Insufficient stock -- retry later. The assignment will remain for when stock is replenished." Per CONTEXT.md: "If execution fails due to insufficient stock, assignment stays -- admin retries later."
- BroadcastChannel sync: broadcast execution event, listen for events from other tabs to refetch

i) **Empty state:**
When no assignments match filters, show: "No assignments found" with appropriate icon (Package or CheckCircle2)
When filtered to "Pending Execution" and none exist: "All assignments have been executed" with emerald checkmark

j) **Responsive behavior:**
- On mobile (below md), hide Requester column
- Use overflow-x-auto on the table container
- Filters use the same responsive pattern from Phase 56 (hidden md:flex for desktop, Popover for mobile)
  </action>
  <verify>
- `npm run type-check` passes
- `npm run build` succeeds
- Navigating to `/inventory/stock-out` shows the execution page (not the old stock-out form)
- Default filter shows only pending execution items
- Warehouse filter narrows results
- Status filter toggles between Pending/Executed/All
- Clicking Execute opens simple confirmation dialog
- After execution, row updates in-place
- SOR IDs are display-only text (not links)
- No "New Request" button on the page
  </verify>
  <done>
Execution page completely replaces old stock-out form. Shows all L2 warehouse assignments as a task queue. Defaults to pending execution items. Warehouse and status filters work. Per-row execution via simple confirmation dialog. Row updates in-place after execution. SOR IDs display-only. No new request button. Responsive layout with mobile filter collapse.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar navigation for execution page</name>
  <files>
    components/layout/sidebar.tsx
  </files>
  <action>
**Update the Inventory children in sidebar.tsx:**

Current sidebar Inventory children (lines 67-72):
```typescript
children: [
  { label: "Dashboard", href: "/inventory" },
  { label: "Stock In", href: "/inventory/stock-in" },
  { label: "Stock Out", href: "/inventory/stock-out" },
  { label: "Stock-Out Requests", href: "/inventory/stock-out-requests" },
],
```

Update to:
```typescript
children: [
  { label: "Dashboard", href: "/inventory" },
  { label: "Stock In", href: "/inventory/stock-in" },
  { label: "Execution Queue", href: "/inventory/stock-out" },
  { label: "Stock-Out Requests", href: "/inventory/stock-out-requests" },
],
```

Changes:
- Rename "Stock Out" to "Execution Queue" -- the page at `/inventory/stock-out` is now the execution page per CONTEXT.md (EXEC-04). Using "Execution Queue" makes it clear this is for executing approved assignments, not creating stock-outs. The URL stays the same (`/inventory/stock-out`) but the label changes.
- Keep "Stock-Out Requests" pointing to `/inventory/stock-out-requests` -- this is the list/create flow which is unchanged.

Per CONTEXT.md: "The sidebar navigation 'Stock Out' link points to the new execution page" and EXEC-04: "Stock-out sidebar navigation item links to the new execution page (replaces old stock-out link)". The existing `/inventory/stock-out` URL is reused but with completely different content (execution page instead of stock-out form).
  </action>
  <verify>
- `npm run type-check` passes
- `npm run build` succeeds
- Sidebar under Inventory shows: Dashboard, Stock In, Execution Queue, Stock-Out Requests
- Clicking "Execution Queue" navigates to `/inventory/stock-out` (the execution page)
- Clicking "Stock-Out Requests" still navigates to `/inventory/stock-out-requests`
  </verify>
  <done>
Sidebar updated: "Stock Out" renamed to "Execution Queue" pointing to the execution page at `/inventory/stock-out`. "Stock-Out Requests" unchanged. Both links functional.
  </done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero errors
- `npm run build` succeeds
- `/inventory/stock-out` renders the execution page (not the old stock-out form)
- Default filter is "Pending Execution"
- Warehouse filter works
- Execution via simple confirmation dialog works
- Executed rows show "Executed" badge, no execute button
- SOR IDs are plain text, not links
- No "New Request" button anywhere on the page
- Sidebar shows "Execution Queue" under Inventory pointing to `/inventory/stock-out`
</verification>

<success_criteria>
User navigates to /inventory/stock-out via sidebar "Execution Queue" link, sees a filterable list of all L2 warehouse assignments. Defaults to pending items. Can filter by warehouse and status. Clicks Execute on a pending row, confirms in simple dialog, row updates to Executed status. No stock display in confirmation (that's only on SOR detail page). Page feels like a simple task queue. No new request button. All approved assignments visible.
</success_criteria>

<output>
After completion, create `.planning/phases/57-two-layer-approval-ui-execution-page/57-03-SUMMARY.md`
</output>
