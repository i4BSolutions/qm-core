---
phase: 57-two-layer-approval-ui-execution-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/stock-out-requests/l1-approval-dialog.tsx
  - components/stock-out-requests/line-item-table.tsx
  - components/stock-out-requests/line-item-progress-bar.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
autonomous: true
requirements: [APPR-01, APPR-05]

must_haves:
  truths:
    - "Admin can click 'Approve Qty' on a pending line item row and approve a partial or full quantity without selecting a warehouse"
    - "Admin can click 'Reject' on a pending line item row and reject with mandatory reason"
    - "After L1 approval, line item status badge shows 'Qty Approved' in blue"
    - "A 3-segment progress bar appears on each line item showing L1/L2/Executed progress"
    - "Progress bar tooltip shows exact numbers per layer on hover"
    - "Batch checkbox selection and floating action bar are fully removed"
    - "The old ApprovalDialog is no longer imported or used anywhere"
  artifacts:
    - path: "components/stock-out-requests/l1-approval-dialog.tsx"
      provides: "Layer 1 qty-only approval dialog with partial qty support and standard unit conversion display"
      exports: ["L1ApprovalDialog"]
    - path: "components/stock-out-requests/line-item-progress-bar.tsx"
      provides: "3-segment progress bar with tooltip showing L1/L2/Executed breakdown"
      exports: ["LineItemProgressBar"]
    - path: "components/stock-out-requests/line-item-table.tsx"
      provides: "Rewritten line item table with per-row action buttons replacing batch checkbox selection"
      exports: ["LineItemTable", "LineItemWithApprovals"]
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "SOR detail page wired to L1 dialog with per-row buttons"
  key_links:
    - from: "components/stock-out-requests/l1-approval-dialog.tsx"
      to: "stock_out_approvals table"
      via: "supabase insert with no parent_approval_id, no warehouse_id"
      pattern: "insert.*stock_out_approvals.*decision.*approved"
    - from: "components/stock-out-requests/line-item-table.tsx"
      to: "components/stock-out-requests/l1-approval-dialog.tsx"
      via: "per-row 'Approve Qty' button opens L1 dialog for that single line item"
      pattern: "L1ApprovalDialog"
    - from: "components/stock-out-requests/line-item-table.tsx"
      to: "components/stock-out-requests/line-item-progress-bar.tsx"
      via: "rendered in each row showing approval lifecycle"
      pattern: "LineItemProgressBar"
---

<objective>
Replace the existing batch-selection approval flow with per-row L1 (qty-only) approval and rejection, add a 3-segment progress bar to each line item, and update status badges to reflect the two-layer flow.

Purpose: Admins need to approve stock-out quantities one line item at a time without selecting a warehouse (Layer 1). The old batch-selection + single-step approval dialog must be entirely replaced.

Output: L1 approval dialog component, progress bar component, rewritten line item table with per-row buttons, updated SOR detail page wiring.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-CONTEXT.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-RESEARCH.md
@.planning/phases/55-database-foundation-useravatar/55-01-SUMMARY.md

@components/stock-out-requests/approval-dialog.tsx
@components/stock-out-requests/rejection-dialog.tsx
@components/stock-out-requests/line-item-table.tsx
@components/stock-out-requests/execution-confirmation-dialog.tsx
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create L1 approval dialog, progress bar component, and rewrite line-item-table</name>
  <files>
    components/stock-out-requests/l1-approval-dialog.tsx
    components/stock-out-requests/line-item-progress-bar.tsx
    components/stock-out-requests/line-item-table.tsx
  </files>
  <action>
**1. Create `components/stock-out-requests/l1-approval-dialog.tsx`:**

New L1 approval dialog for a SINGLE line item (not batch). Props:
- `open`, `onOpenChange`, `lineItem: LineItemWithApprovals`, `onSuccess: () => void`

Dialog content:
- Header: "Approve Quantity" with item name and SKU
- Show Requested qty, Already Approved qty, Already Rejected qty, Remaining qty (all from lineItem)
- Approved Quantity input (AmountInput, decimalScale=0, max=lineItem.remaining_quantity, pre-filled with remaining_quantity)
- Standard unit conversion display below qty: e.g., "40 boxes = 480 pieces" using `lineItem.conversion_rate` and `lineItem.unit_name`. Show only when unit_name exists
- Optional notes Textarea
- Footer: Cancel + "Approve Qty" button (emerald)

On submit:
- Insert into `stock_out_approvals`: `{ line_item_id, approved_quantity, decision: 'approved', decided_by: user.id, created_by: user.id }`. Do NOT set `layer`, `parent_approval_id`, or `warehouse_id` -- the DB trigger auto-sets layer='quartermaster'.
- Do NOT create an inventory_transaction (that happens at L2 when warehouse is known). This is critical -- the old dialog created a pending transaction, but L1 has no warehouse.
- On success: toast, call onSuccess, close dialog

Validation: qty must be > 0 and <= remaining_quantity.

**2. Create `components/stock-out-requests/line-item-progress-bar.tsx`:**

Props: `{ requestedQty: number, l1ApprovedQty: number, l2AssignedQty: number, executedQty: number }`

Render a horizontal bar (h-2, rounded-full, bg-slate-700 background) with 3 stacked segments:
- Executed segment: bg-emerald-500, width = (executedQty / requestedQty) * 100%
- L2 assigned but not executed: bg-purple-500, width = ((l2AssignedQty - executedQty) / requestedQty) * 100%
- L1 approved but not L2 assigned: bg-blue-500, width = ((l1ApprovedQty - l2AssignedQty) / requestedQty) * 100%

Wrap in Tooltip (from `@/components/ui/tooltip`):
```
L1 Approved: {l1ApprovedQty}/{requestedQty}
L2 Assigned: {l2AssignedQty}/{l1ApprovedQty}
Executed: {executedQty}/{l2AssignedQty}
```

Handle edge cases: if requestedQty is 0, show empty bar. If any segment would be negative, clamp to 0.

**3. Rewrite `components/stock-out-requests/line-item-table.tsx`:**

Major changes from current implementation:

a) **Remove all batch selection logic**: Remove `selectedIds`, `onSelectionChange`, `onApproveClick`, `onRejectClick` from props. Remove checkbox column, select-all, floating action bar. Remove `canSelectForApproval`, `canSelectForRejection` functions.

b) **New props interface:**
```typescript
interface LineItemTableProps {
  items: LineItemWithApprovals[];
  canApprove: boolean;
  onApproveItem: (item: LineItemWithApprovals) => void;
  onRejectItem: (item: LineItemWithApprovals) => void;
}
```

c) **Update `LineItemWithApprovals` interface** to include L2 approval data:
```typescript
export interface LineItemWithApprovals {
  id: string;
  item_id: string;
  item_name: string | null;
  item_sku: string | null;
  requested_quantity: number;
  conversion_rate: number;
  status: SorLineItemStatus;
  total_approved_quantity: number;      // L1 approved total
  total_rejected_quantity: number;
  remaining_quantity: number;           // requested - L1 approved - rejected
  l2_assigned_quantity: number;         // total qty assigned to warehouses via L2
  executed_quantity: number;            // total qty executed
  assigned_warehouse_name: string | null;
  unit_name?: string;
}
```

d) **Update STATUS_CONFIG** to match CONTEXT.md badge labels:
- `pending`: label "Pending", amber
- `awaiting_admin`: label "Qty Approved", blue (per CONTEXT: "Pending" -> "Qty Approved")
- `fully_approved`: label "Ready to Execute", emerald (per CONTEXT)
- `rejected`: label "Rejected", red
- `cancelled`: label "Cancelled", slate
- `partially_executed`: label "Partially Executed", purple
- `executed`: label "Executed", emerald
- Keep the `approved` legacy status entry for backward compatibility: label "Approved", emerald

Note: The CONTEXT says badge progression is "Pending" -> "Qty Approved" -> "Warehouse Assigned" -> "Ready to Execute". However, `awaiting_admin` covers both "Qty Approved" and "Warehouse Assigned" states. When rendering the badge, check: if status is `awaiting_admin` AND `l2_assigned_quantity > 0`, show "Warehouse Assigned" (purple). If `awaiting_admin` AND `l2_assigned_quantity === 0`, show "Qty Approved" (blue).

e) **Per-row action button column** (rightmost column):
Use a function to determine which button to show:
- `pending` + canApprove: Show "Approve Qty" button (emerald/outline, size=sm) AND "Reject" button (destructive/outline, size=sm, icon only X)
- `awaiting_admin` + canApprove + has remaining unassigned L1 qty: Show "Assign Warehouse" button (purple/outline, size=sm) -- this will be wired in Plan 02; for now render a placeholder disabled button with text "Assign WH" since the L2 dialog doesn't exist yet
- `awaiting_admin` + all L1 qty covered by L2: Show "Ready to Execute" badge (emerald, not a button)
- `fully_approved`: Show "Ready to Execute" badge
- `executed`: Show "Executed" badge
- `rejected`: Show "Rejected" badge
- No canApprove: Don't show buttons, just status badge

f) **Add progress bar** to each row: Below the status badge or in a dedicated "Progress" column, render `LineItemProgressBar` with the item's quantities.

g) **Remove the Warehouse column** -- warehouse info will be in the expandable section (Plan 02). For now, just remove it.

h) **Table columns** (in order): Item | SKU | Requested | Approved | Rejected | Remaining | Status | Progress | Action
  </action>
  <verify>
- `npm run type-check` passes with zero errors
- `npm run build` succeeds
- The L1ApprovalDialog component exports correctly from its file
- LineItemProgressBar component exports correctly
- LineItemTable no longer has checkbox/selection props or floating action bar
- STATUS_CONFIG has entries for all 8 sor_line_item_status enum values
  </verify>
  <done>
L1 approval dialog created with qty-only flow (no warehouse, no inventory_transaction). Progress bar component created with 3 segments and tooltip. Line item table fully rewritten with per-row action buttons replacing batch selection. Standard unit conversion displayed in L1 dialog. All TypeScript types pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire L1 dialog and per-row actions into SOR detail page</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
**Update the SOR detail page to use the new L1 dialog and per-row actions:**

a) **Remove old imports and state:**
- Remove import of `ApprovalDialog` from `./approval-dialog`
- Remove `selectedIds`, `setSelectedIds` state
- Remove `isApprovalDialogOpen`, `setIsApprovalDialogOpen` state
- Remove `handleApproveClick`, `handleRejectClick` functions that opened old dialogs
- Remove the `<ApprovalDialog>` JSX at the bottom
- Keep `RejectionDialog` but change how it's used (per-item, not batch)

b) **Add new state for L1 and rejection per-row:**
```typescript
const [l1DialogItem, setL1DialogItem] = useState<LineItemWithApprovals | null>(null);
const [rejectionItem, setRejectionItem] = useState<LineItemWithApprovals | null>(null);
```

c) **Update LineItemTable usage:**
Replace the old props:
```tsx
<LineItemTable
  items={lineItems}
  canApprove={canApprove}
  onApproveItem={(item) => setL1DialogItem(item)}
  onRejectItem={(item) => setRejectionItem(item)}
/>
```

d) **Wire L1 dialog:**
```tsx
{l1DialogItem && (
  <L1ApprovalDialog
    open={!!l1DialogItem}
    onOpenChange={(open) => { if (!open) setL1DialogItem(null); }}
    lineItem={l1DialogItem}
    onSuccess={handleDialogSuccess}
  />
)}
```

e) **Update RejectionDialog usage** to pass a single-item array:
```tsx
{rejectionItem && (
  <RejectionDialog
    open={!!rejectionItem}
    onOpenChange={(open) => { if (!open) setRejectionItem(null); }}
    lineItems={[rejectionItem]}
    onSuccess={handleDialogSuccess}
  />
)}
```

f) **Update `handleDialogSuccess`** -- no longer needs to clear selectedIds:
```typescript
const handleDialogSuccess = async () => {
  await fetchData();
};
```

g) **Update the data fetching for line items** to compute L2 quantities. In the `fetchData` function, when querying `stock_out_line_items`, expand the approvals join to include `layer` and `warehouse_id`:
```
approvals:stock_out_approvals(
  id,
  approved_quantity,
  decision,
  layer,
  warehouse_id,
  parent_approval_id
)
```

Then when computing `itemsWithTotals`, calculate:
- `total_approved_quantity`: sum of `approved_quantity` where `decision='approved' AND layer='quartermaster'` (L1 qty)
- `total_rejected_quantity`: sum of `approved_quantity` where `decision='rejected'`
- `remaining_quantity`: `requested_quantity - total_approved_quantity - total_rejected_quantity`
- `l2_assigned_quantity`: sum of `approved_quantity` where `decision='approved' AND layer='admin'` (L2 warehouse assignments)
- `executed_quantity`: This requires checking inventory_transactions. Query them where `stock_out_approval_id` is in the L2 approval ids AND `status='completed'`, sum the quantities. (This can be done in a separate query or joined.)

For `executed_quantity` calculation: After fetching approvals, collect all L2 approval IDs, then query inventory_transactions for those IDs where status='completed'. Sum quantities per line item.

h) **Update the Approvals tab** to show layer information on each approval card. Add a layer badge:
- If `layer === 'quartermaster'`: Badge "L1 Qty Approval" in blue
- If `layer === 'admin'`: Badge "L2 Warehouse Assignment" in purple, and show warehouse name

i) **Update REQUEST_STATUS_CONFIG** to show "Awaiting Warehouse" label for `partially_approved`:
```typescript
partially_approved: {
  label: "Awaiting Warehouse",
  color: "text-blue-400",
  bgColor: "bg-blue-500/10 border-blue-500/30",
},
```

Also update `approved` label to "Ready to Execute":
```typescript
approved: {
  label: "Ready to Execute",
  color: "text-emerald-400",
  bgColor: "bg-emerald-500/10 border-emerald-500/30",
},
```

j) **Remove the old execution button logic from the Approvals tab** -- execution will be handled via Plan 02's Warehouse Assignments tab and Plan 03's execution page. For now, keep the Approvals tab as a read-only approval history display without execute buttons.
  </action>
  <verify>
- `npm run type-check` passes
- `npm run build` succeeds
- Opening the SOR detail page renders the line items tab with per-row buttons (no checkboxes)
- Clicking "Approve Qty" on a pending item opens the L1 dialog
- Clicking "Reject" on a pending item opens the rejection dialog
- After L1 approval, the line item status changes and progress bar updates
- Approvals tab shows layer labels (L1/L2)
- SOR header badge shows updated labels ("Awaiting Warehouse", "Ready to Execute")
  </verify>
  <done>
SOR detail page fully wired to L1 per-row approval flow. Old batch selection and ApprovalDialog completely removed. Line items fetch includes layer-aware quantity calculations. Approvals tab shows layer badges. SOR request status labels updated to match two-layer flow terminology.
  </done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero errors
- `npm run build` succeeds
- No import references to the old `ApprovalDialog` component remain in any file
- The L1 dialog inserts into stock_out_approvals WITHOUT parent_approval_id, warehouse_id, or inventory_transaction
- Line item table renders per-row "Approve Qty" and "Reject" buttons for pending items
- Progress bar renders 3 segments with correct colors and tooltip
- STATUS_CONFIG covers all 8 enum values including awaiting_admin and fully_approved
</verification>

<success_criteria>
Admin can open the SOR detail page, see per-row action buttons on pending line items, click "Approve Qty" to open the L1 dialog, approve a partial quantity, and see the line item status change to "Qty Approved" with the progress bar updating to show L1 progress. The old batch checkbox + floating bar approval flow is completely gone.
</success_criteria>

<output>
After completion, create `.planning/phases/57-two-layer-approval-ui-execution-page/57-01-SUMMARY.md`
</output>
