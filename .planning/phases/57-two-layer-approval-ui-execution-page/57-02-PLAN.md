---
phase: 57-two-layer-approval-ui-execution-page
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - components/stock-out-requests/l2-warehouse-dialog.tsx
  - components/stock-out-requests/warehouse-assignments-tab.tsx
  - components/stock-out-requests/line-item-table.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
autonomous: true
requirements: [APPR-02, APPR-03, APPR-04, APPR-05]

must_haves:
  truths:
    - "Admin can click 'Assign Warehouse' on an awaiting_admin line item and assign a warehouse with a capped quantity"
    - "L2 dialog quantity cannot exceed L1 approved quantity minus already-assigned L2 quantity"
    - "L2 dialog quantity cannot exceed available warehouse stock (hard cap, input max attribute)"
    - "L2 dialog shows real-time available stock text below warehouse dropdown"
    - "L2 dialog shows both limits in error message: remaining approved qty AND warehouse stock"
    - "Standard unit conversion shown in L2 dialog"
    - "Multiple L2 approvals on same line item split qty across warehouses"
    - "Second+ L2 dialog pre-fills with remaining unassigned qty"
    - "Warehouse Assignments tab on SOR detail shows assignments grouped by line item"
    - "Execution available from Warehouse Assignments tab with before/after stock display"
    - "Expandable section under each line item on Line Items tab shows warehouse assignments"
    - "Execute button is disabled until both L1 and L2 are complete (status is fully_approved)"
  artifacts:
    - path: "components/stock-out-requests/l2-warehouse-dialog.tsx"
      provides: "Layer 2 warehouse assignment dialog with real-time stock validation and hard qty cap"
      exports: ["L2WarehouseDialog"]
    - path: "components/stock-out-requests/warehouse-assignments-tab.tsx"
      provides: "Warehouse Assignments tab content grouped by line item with execution capability"
      exports: ["WarehouseAssignmentsTab"]
  key_links:
    - from: "components/stock-out-requests/l2-warehouse-dialog.tsx"
      to: "stock_out_approvals table"
      via: "supabase insert with parent_approval_id and warehouse_id"
      pattern: "insert.*stock_out_approvals.*parent_approval_id.*warehouse_id"
    - from: "components/stock-out-requests/l2-warehouse-dialog.tsx"
      to: "inventory_transactions table"
      via: "creates pending inventory_transaction at L2 time (warehouse now known)"
      pattern: "insert.*inventory_transactions.*status.*pending"
    - from: "components/stock-out-requests/warehouse-assignments-tab.tsx"
      to: "inventory_transactions table"
      via: "execution updates pending transaction to completed"
      pattern: "update.*inventory_transactions.*status.*completed"
---

<objective>
Build the Layer 2 warehouse assignment dialog with real-time stock validation and hard quantity caps, add the Warehouse Assignments tab to SOR detail page with execution capability, and add expandable warehouse assignment sections under each line item.

Purpose: After L1 quantity approval, admins need to assign approved quantities to specific warehouses. The L2 dialog enforces that assigned qty cannot exceed L1 approved qty or available warehouse stock. Execution is only possible after L2 is complete.

Output: L2 warehouse dialog, Warehouse Assignments tab, expandable line item sections, execution from SOR detail with before/after stock display.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-CONTEXT.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-RESEARCH.md
@.planning/phases/57-two-layer-approval-ui-execution-page/57-01-SUMMARY.md

@components/stock-out-requests/l1-approval-dialog.tsx
@components/stock-out-requests/line-item-table.tsx
@components/stock-out-requests/line-item-progress-bar.tsx
@components/stock-out-requests/execution-confirmation-dialog.tsx
@components/stock-out-requests/rejection-dialog.tsx
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create L2 warehouse assignment dialog with real-time stock validation</name>
  <files>
    components/stock-out-requests/l2-warehouse-dialog.tsx
  </files>
  <action>
**Create `components/stock-out-requests/l2-warehouse-dialog.tsx`:**

Props:
```typescript
interface L2WarehouseDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  lineItem: LineItemWithApprovals;
  l1Approval: {
    id: string;
    approved_quantity: number;
    total_l2_assigned: number;  // sum of existing L2 for this L1
  };
  requestReason: string;
  qmhqId?: string | null;
  onSuccess: () => void;
}
```

Dialog content:
- Header: "Assign Warehouse" with item name and SKU
- Info section showing:
  - L1 Approved Qty: `l1Approval.approved_quantity`
  - Already Assigned: `l1Approval.total_l2_assigned`
  - Remaining to Assign: `l1Approval.approved_quantity - l1Approval.total_l2_assigned`
- Standard unit conversion display: "X boxes = Y pieces" using lineItem.conversion_rate and lineItem.unit_name

**Warehouse Select dropdown:**
- Fetch all warehouses from `warehouses` table (active only)
- When a warehouse is selected, immediately fetch stock for that warehouse + item using the `fetchWarehouseStockForItem` pattern from the existing `approval-dialog.tsx` (query `inventory_transactions` for that item + warehouse, sum in/out to get available stock)
- Show "Available: N units" text below the dropdown (text-emerald-400 if sufficient, text-red-400 if insufficient)
- Loading spinner while fetching stock

**Quantity input (AmountInput):**
- Pre-fill with `remaining_to_assign` (which is `l1Approval.approved_quantity - l1Approval.total_l2_assigned`)
- Hard cap via `max` attribute: `Math.min(remaining_to_assign, availableWarehouseStock)`
- If no warehouse selected yet, max = remaining_to_assign
- Below the input, show help text: "Max: min(Remaining: {remaining}, Stock: {stock})"
- If qty exceeds either limit, show inline field error in red below input, disable submit button
- Error messages show BOTH limits: "Cannot exceed remaining approved qty ({remaining}) or warehouse stock ({stock})"

**Conversion Rate input:**
- Pre-fill with the line item's conversion_rate (from the stock_out_line_items record)
- This is needed for the inventory_transaction. It should be pre-filled and editable (matches existing pattern from old approval dialog)
- Use `ConversionRateInput` component

**On submit:**
1. Insert into `stock_out_approvals`:
```typescript
{
  line_item_id: lineItem.id,
  approved_quantity: assignedQty,
  decision: 'approved',  // always approved at L2
  parent_approval_id: l1Approval.id,  // references the L1 parent
  warehouse_id: selectedWarehouseId,
  decided_by: user.id,
  created_by: user.id,
  // layer auto-set by trigger to 'admin'
}
```

2. Insert pending `inventory_transaction` (because L2 knows the warehouse):
```typescript
{
  movement_type: 'inventory_out',
  item_id: lineItem.item_id,
  warehouse_id: selectedWarehouseId,
  quantity: assignedQty,
  conversion_rate: parseFloat(conversionRate) || 1,
  reason: requestReason,
  stock_out_approval_id: l2ApprovalRecord.id,  // link to L2 approval
  qmhq_id: qmhqId || null,
  status: 'pending',  // pending until execution
  created_by: user.id,
}
```

3. Toast success, call onSuccess, close dialog

**Validation:**
- Warehouse must be selected
- Qty must be > 0
- Qty must be <= remaining_to_assign
- Qty must be <= availableWarehouseStock
- Conversion rate must be > 0

**Loading states:**
- Show Loader2 spinner while fetching warehouse stock
- Disable submit while submitting
  </action>
  <verify>
- `npm run type-check` passes
- `npm run build` succeeds
- L2WarehouseDialog exports correctly
- Dialog inserts into stock_out_approvals WITH parent_approval_id and warehouse_id
- Dialog creates a pending inventory_transaction at L2 time
- Hard cap logic: qty input max = min(remaining, stock)
  </verify>
  <done>
L2 warehouse dialog created with real-time stock validation, hard qty cap at min(remaining_l1_qty, warehouse_stock), pending inventory_transaction creation, standard unit conversion display, and both-limits error messaging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Warehouse Assignments tab, expandable line item sections, and wire L2 dialog into SOR detail page</name>
  <files>
    components/stock-out-requests/warehouse-assignments-tab.tsx
    components/stock-out-requests/line-item-table.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
**1. Create `components/stock-out-requests/warehouse-assignments-tab.tsx`:**

Props:
```typescript
interface WarehouseAssignment {
  id: string;  // L2 approval id
  line_item_id: string;
  item_name: string;
  item_sku: string | null;
  item_id: string;
  warehouse_name: string;
  warehouse_id: string;
  approved_quantity: number;
  conversion_rate: number;
  unit_name?: string;
  is_executed: boolean;
  inventory_transaction_id?: string;
}

interface WarehouseAssignmentsTabProps {
  assignments: WarehouseAssignment[];
  lineItems: LineItemWithApprovals[];
  canExecute: boolean;
  onExecute: (assignment: WarehouseAssignment) => void;
  isExecuting: boolean;
}
```

Layout per CONTEXT.md:
- **Grouped by line item**: Show each item as a section header (item name + SKU)
- Under each item, show its warehouse assignments as rows: Warehouse name | Qty | Status badge ("Executed" green or "Pending Execution" amber) | Execute button
- Execute button: emerald, size=sm, only shown on Pending Execution rows when canExecute is true
- When `assignments` is empty, show "No warehouse assignments yet" placeholder

**Execution from this tab uses confirmation with before/after stock display** per CONTEXT.md. The parent page handles the actual execution; this component just calls `onExecute(assignment)`.

**2. Update `components/stock-out-requests/line-item-table.tsx`:**

Add expandable sections under each line item row:

a) Add `l1Approvals` to `LineItemWithApprovals`:
```typescript
l1Approvals?: Array<{
  id: string;
  approved_quantity: number;
  total_l2_assigned: number;
  l2_assignments: Array<{
    id: string;
    warehouse_name: string;
    approved_quantity: number;
    is_executed: boolean;
  }>;
}>;
```

b) Add expandable row: When a line item row is clicked (or a chevron toggle button is clicked), expand a section below the row showing warehouse assignments for that item:
- Use a `expandedItemIds` state (Set<string>) to track which items are expanded
- Toggle button: ChevronDown icon that rotates when expanded
- Expanded section: Shows each L2 assignment as a sub-row: "WH-A: 40 units [Executed]" or "WH-B: 20 units [Pending]"
- If no L2 assignments: "No warehouse assignments yet"

c) Update the "Assign Warehouse" button behavior:
- Remove the placeholder disabled button from Plan 01
- Make it a real button that calls a new prop `onAssignWarehouse: (item: LineItemWithApprovals, l1Approval: {...}) => void`
- If a line item has multiple L1 approvals with remaining unassigned qty, show "Assign Warehouse" for each one. In practice, there's usually one L1 per line item, but the data model allows multiple. Show the button on the line item row; when clicked, if there's only one L1 with remaining, use it. If multiple, pick the first one with remaining unassigned qty.

d) New props additions:
```typescript
interface LineItemTableProps {
  items: LineItemWithApprovals[];
  canApprove: boolean;
  onApproveItem: (item: LineItemWithApprovals) => void;
  onRejectItem: (item: LineItemWithApprovals) => void;
  onAssignWarehouse?: (item: LineItemWithApprovals, l1Approval: { id: string; approved_quantity: number; total_l2_assigned: number }) => void;
}
```

**3. Update `app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx`:**

a) Add L2 dialog state:
```typescript
const [l2DialogState, setL2DialogState] = useState<{
  lineItem: LineItemWithApprovals;
  l1Approval: { id: string; approved_quantity: number; total_l2_assigned: number };
} | null>(null);
```

b) Update Tabs from 4 to 5: Details (now "Line Items"), Warehouse Assignments, Approvals, Transactions, History.
Actually per CONTEXT.md, keep the existing tabs but: rename "Details" tab to "Line Items" since that's what it shows, and add "Warehouse Assignments" tab between "Line Items" and "Approvals".

Tab structure: Line Items | Warehouse Assignments | Approvals | Transactions | History
Use `grid-cols-5` for TabsList.

c) Wire "Assign Warehouse" button from LineItemTable to open L2 dialog:
```tsx
<LineItemTable
  items={lineItems}
  canApprove={canApprove}
  onApproveItem={(item) => setL1DialogItem(item)}
  onRejectItem={(item) => setRejectionItem(item)}
  onAssignWarehouse={(item, l1) => setL2DialogState({ lineItem: item, l1Approval: l1 })}
/>
```

d) Render L2 dialog:
```tsx
{l2DialogState && (
  <L2WarehouseDialog
    open={!!l2DialogState}
    onOpenChange={(open) => { if (!open) setL2DialogState(null); }}
    lineItem={l2DialogState.lineItem}
    l1Approval={l2DialogState.l1Approval}
    requestReason={request.reason}
    qmhqId={request.qmhq_id}
    onSuccess={handleDialogSuccess}
  />
)}
```

e) Update fetchData to include L1 approval details with L2 sub-approvals per line item. Query stock_out_approvals with self-join:
```
approvals:stock_out_approvals(
  id, approved_quantity, decision, layer, warehouse_id, parent_approval_id,
  warehouses:warehouses!stock_out_approvals_warehouse_id_fkey(id, name)
)
```

Then for each line item, compute:
- L1 approvals: filter where `layer='quartermaster' AND decision='approved'`
- For each L1, find its L2 children: approvals where `parent_approval_id === l1.id`
- Compute `total_l2_assigned` for each L1
- Set `l1Approvals` on the line item

f) Build `warehouseAssignments` array for the Warehouse Assignments tab from the L2 approvals data. Each L2 approval becomes a WarehouseAssignment entry with execution status determined by checking inventory_transactions.

g) **Execution from Warehouse Assignments tab** with before/after stock:
- Create an execution handler that opens the existing `ExecutionConfirmationDialog` but enhanced with stock levels
- Or modify ExecutionConfirmationDialog to accept optional `currentStock` and `afterStock` props
- When executing from the Warehouse Assignments tab: fetch current warehouse stock first, then show the dialog with "Current: X -> After: Y"
- Reuse the existing execution logic: update inventory_transaction from pending to completed

Modify `ExecutionConfirmationDialog` to accept optional stock level props:
```typescript
interface ExecutionConfirmationDialogProps {
  // ... existing props
  currentStock?: number;
  afterStock?: number;
}
```
Show a "Stock Levels" section in the dialog only when these are provided:
```
WH-A current: 45 -> After: 5
```

h) **SOR auto-status display**: The `compute_sor_request_status` DB trigger already handles status transitions. The UI just reads the status and displays the correct label via the updated REQUEST_STATUS_CONFIG (done in Plan 01). Verify the labels match:
- `pending` = "Pending" (any line item pending)
- `partially_approved` = "Awaiting Warehouse" (all L1 approved, some unassigned)
- `approved` = "Ready to Execute" (all fully warehouse-assigned)
- `partially_executed` = "Partially Fulfilled"
- `executed` = "Fulfilled"
- `rejected` = "Rejected"
- `cancelled` = "Cancelled"
  </action>
  <verify>
- `npm run type-check` passes
- `npm run build` succeeds
- SOR detail page has 5 tabs: Line Items, Warehouse Assignments, Approvals, Transactions, History
- Clicking "Assign Warehouse" on an awaiting_admin line item opens the L2 dialog
- L2 dialog shows warehouse select with available stock, qty hard-capped
- After L2 assignment, the assignment appears in the Warehouse Assignments tab
- Expandable section under line items shows warehouse assignments
- Execute button on Warehouse Assignments tab opens confirmation with stock levels
- After execution, assignment status updates to Executed
  </verify>
  <done>
L2 warehouse dialog fully functional with real-time stock validation and hard caps. Warehouse Assignments tab shows all assignments grouped by line item with execution capability and before/after stock display. Line item table has expandable sections showing per-item warehouse assignments. L2 assignment creates pending inventory_transaction. Execute button disabled until fully_approved status. SOR auto-status labels display correctly.
  </done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero errors
- `npm run build` succeeds
- L2 dialog enforces qty <= min(remaining_l1_qty, warehouse_stock) with hard input cap
- L2 dialog creates both stock_out_approvals record (with parent_approval_id + warehouse_id) AND pending inventory_transaction
- Warehouse Assignments tab shows assignments grouped by line item
- Execution from Warehouse Assignments tab shows before/after stock levels
- Multiple L2 assignments possible on same line item (split across warehouses)
- Second+ L2 dialog pre-fills with remaining unassigned qty
</verification>

<success_criteria>
Admin can approve qty at L1 (Plan 01), then assign warehouse at L2 with stock validation. Multiple L2 assignments split qty across warehouses. The Warehouse Assignments tab shows all assignments with execution capability. Execution from SOR detail shows before/after stock levels. Line item expandable sections show warehouse breakdown. The full L1 -> L2 -> Execute lifecycle works end-to-end from the SOR detail page.
</success_criteria>

<output>
After completion, create `.planning/phases/57-two-layer-approval-ui-execution-page/57-02-SUMMARY.md`
</output>
