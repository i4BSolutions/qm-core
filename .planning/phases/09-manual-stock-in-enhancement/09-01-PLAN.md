---
phase: 09-manual-stock-in-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/inventory/stock-in/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select currency (MMK, USD, CNY, THB) when creating manual stock-in"
    - "User can enter exchange rate with 4 decimal precision"
    - "User sees real-time EUSD equivalent as they type amounts"
    - "When USD is selected, exchange rate is auto-set to 1.0 and input is disabled"
    - "Manual stock-in saves currency and exchange rate to database"
  artifacts:
    - path: "app/(dashboard)/inventory/stock-in/page.tsx"
      provides: "Currency selector, exchange rate input, EUSD calculation for manual mode"
      contains: "SUPPORTED_CURRENCIES"
  key_links:
    - from: "Currency selector"
      to: "handleCurrencyChange"
      via: "onValueChange handler"
      pattern: "handleCurrencyChange"
    - from: "calculatedEusd"
      to: "EUSD panel display"
      via: "useMemo calculation"
      pattern: "calculatedEusd.*manualQuantity.*manualUnitCost.*exchangeRate"
---

<objective>
Enhance the manual stock-in form with currency selection, exchange rate input, and real-time EUSD calculation.

Purpose: Enable users to record stock-in transactions in multiple currencies (MMK, USD, CNY, THB) with accurate EUSD conversion for WAC calculations.

Output: Modified stock-in page with currency/exchange rate inputs and EUSD display for manual mode.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-manual-stock-in-enhancement/09-RESEARCH.md
@.planning/phases/08-database-foundation/08-01-SUMMARY.md

Source files:
@app/(dashboard)/inventory/stock-in/page.tsx
@app/(dashboard)/qmhq/new/[route]/page.tsx (lines 42-48, 89-100, 543-620 for patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add currency, exchange rate, and EUSD calculation to manual stock-in</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx</files>
  <action>
Modify the manual stock-in form to add currency selection, exchange rate input, and real-time EUSD calculation.

**1. Add Calculator import to lucide-react imports (around line 15):**
Add `Calculator` to the existing lucide-react import.

**2. Add SUPPORTED_CURRENCIES constant after the SourceMode type (around line 70):**
```typescript
// Currency options aligned with database constraint (Phase 8)
const SUPPORTED_CURRENCIES = [
  { value: 'MMK', label: 'MMK - Myanmar Kyat' },
  { value: 'USD', label: 'USD - US Dollar' },
  { value: 'CNY', label: 'CNY - Chinese Yuan' },
  { value: 'THB', label: 'THB - Thai Baht' },
];
```

**3. Add currency and exchange rate state after manualUnitCost state (around line 106):**
```typescript
// Currency and exchange rate for manual mode
const [currency, setCurrency] = useState('MMK');
const [exchangeRate, setExchangeRate] = useState('1');
```

**4. Add calculatedEusd useMemo after selectedManualItem useMemo (around line 232):**
```typescript
// Calculate EUSD for manual mode in real-time
const calculatedEusd = useMemo(() => {
  const cost = parseFloat(manualUnitCost) || 0;
  const qty = parseFloat(manualQuantity) || 0;
  const rate = parseFloat(exchangeRate) || 1;
  const totalValue = cost * qty;
  if (rate <= 0) return 0;
  return Math.round((totalValue / rate) * 100) / 100;
}, [manualUnitCost, manualQuantity, exchangeRate]);

// Total value for display
const manualTotalValue = useMemo(() => {
  return (parseFloat(manualQuantity) || 0) * (parseFloat(manualUnitCost) || 0);
}, [manualQuantity, manualUnitCost]);
```

**5. Add handleCurrencyChange handler after handleUpdateLineUnitCost (around line 300):**
```typescript
// Handle currency change - auto-set USD rate to 1.0 per database constraint
const handleCurrencyChange = (value: string) => {
  setCurrency(value);
  if (value === 'USD') {
    setExchangeRate('1');
  }
};
```

**6. Update the manual mode database insert (around lines 353-354):**
Change from:
```typescript
currency: "MMK",
exchange_rate: 1,
```
To:
```typescript
currency: currency,
exchange_rate: parseFloat(exchangeRate) || 1,
```

**7. Add Currency & Exchange Rate section in manual mode form (after the existing grid with Item/Quantity/Unit Cost, around line 850):**
Add a new grid section with currency selector, exchange rate input, and EUSD panel:

```tsx
{/* Currency and Exchange Rate */}
<div className="grid gap-4 md:grid-cols-3 mt-4 pt-4 border-t border-slate-700">
  <div>
    <label className="text-xs text-slate-400 uppercase tracking-wider mb-2 block">
      Currency *
    </label>
    <Select value={currency} onValueChange={handleCurrencyChange}>
      <SelectTrigger className="bg-slate-800/50 border-slate-700">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {SUPPORTED_CURRENCIES.map((c) => (
          <SelectItem key={c.value} value={c.value}>
            {c.label}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>

  <div>
    <label className="text-xs text-slate-400 uppercase tracking-wider mb-2 block">
      Exchange Rate *
    </label>
    <Input
      type="number"
      min="0.0001"
      step="0.0001"
      value={exchangeRate}
      onChange={(e) => setExchangeRate(e.target.value)}
      disabled={currency === 'USD'}
      placeholder="1.0000"
      className={`bg-slate-800/50 border-slate-700 font-mono [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none ${currency === 'USD' ? 'opacity-50 cursor-not-allowed' : ''}`}
    />
    <p className="text-xs text-slate-500 mt-1">
      {currency === 'USD' ? 'USD rate is always 1.0' : `1 EUSD = ${exchangeRate || '1'} ${currency}`}
    </p>
  </div>

  <div>
    <label className="text-xs text-slate-400 uppercase tracking-wider mb-2 block">
      Total Value
    </label>
    <div className="p-2 rounded bg-slate-800/50 border border-slate-700 text-right">
      <span className="font-mono text-lg text-amber-400">
        {formatCurrency(manualTotalValue)} {currency}
      </span>
    </div>
  </div>
</div>

{/* EUSD Calculation Panel */}
{manualItemId && (parseFloat(manualQuantity) || 0) > 0 && (parseFloat(manualUnitCost) || 0) > 0 && (
  <div className="p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/20 mt-4">
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-2">
        <Calculator className="h-5 w-5 text-emerald-400" />
        <span className="text-sm text-slate-300">Calculated EUSD Value</span>
      </div>
      <div className="flex items-center gap-1">
        <span className="text-2xl font-mono font-bold text-emerald-400">
          {formatCurrency(calculatedEusd)}
        </span>
        <span className="text-emerald-400 font-medium">EUSD</span>
      </div>
    </div>
    <p className="text-xs text-slate-400 mt-2">
      Formula: {formatCurrency(manualTotalValue)} {currency} รท {exchangeRate || '1'} = {formatCurrency(calculatedEusd)} EUSD
    </p>
  </div>
)}
```

**8. Update the summary panel Total Value display (around line 960):**
Change the hardcoded "MMK" to use the selected currency for manual mode:
```tsx
<p className="text-xs text-slate-400 mt-1">
  {sourceMode === "invoice" ? selectedInvoice?.currency || "MMK" : currency}
</p>
```

**9. Remove the inline Total display from Unit Cost field (around lines 843-848):**
The Total is now shown in the Currency section, so remove the duplicate:
```tsx
<p className="text-xs text-slate-500 mt-1">
  Total:{" "}
  <span className="font-mono text-emerald-400">
    {formatCurrency((parseFloat(manualQuantity) || 0) * (parseFloat(manualUnitCost) || 0))}
  </span>
</p>
```
Remove these lines as the total is now displayed more prominently in the Currency section.
  </action>
  <verify>
1. Run `npm run type-check` - should pass with no TypeScript errors
2. Run `npm run lint` - should pass with no ESLint errors
3. Run `npm run build` - should complete successfully
  </verify>
  <done>
- SUPPORTED_CURRENCIES constant exists with MMK, USD, CNY, THB options
- Currency state initialized to 'MMK'
- Exchange rate state initialized to '1'
- calculatedEusd useMemo computes total value / exchange rate
- handleCurrencyChange auto-sets USD rate to 1
- Exchange rate input disabled when USD selected
- EUSD calculation panel displays with formula
- Database insert uses selected currency and exchange rate
- Summary panel shows selected currency
  </done>
</task>

<task type="auto">
  <name>Task 2: Commit changes with atomic commit</name>
  <files>app/(dashboard)/inventory/stock-in/page.tsx</files>
  <action>
Stage and commit the changes with a descriptive commit message.

```bash
git add app/(dashboard)/inventory/stock-in/page.tsx
git commit -m "feat(09): add currency selection and EUSD calculation to manual stock-in

- Add currency selector with MMK, USD, CNY, THB options (Phase 8 constraint)
- Add exchange rate input with 4 decimal precision
- Auto-set and disable exchange rate when USD selected (rate must be 1.0)
- Add real-time EUSD calculation panel with formula display
- Update database insert to use selected currency/exchange_rate

Closes: STCK-01, STCK-02, STCK-03
Depends: STCK-04 already handled by WAC trigger (Phase 8)"
```
  </action>
  <verify>
1. `git log -1` shows the new commit with proper message
2. `git status` shows clean working tree for the modified file
  </verify>
  <done>
Changes committed with descriptive message referencing requirements STCK-01, STCK-02, STCK-03.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Type safety:** `npm run type-check` passes
2. **Lint:** `npm run lint` passes
3. **Build:** `npm run build` succeeds
4. **Commit:** Changes committed atomically

Manual testing (deferred to /gsd:verify-work):
- Start dev server, navigate to /inventory/stock-in
- Select "Manual Entry" mode
- Verify currency dropdown shows MMK, USD, CNY, THB
- Select USD, verify exchange rate auto-sets to 1.0 and input is disabled
- Select MMK, verify exchange rate input is enabled
- Enter quantity and unit cost, verify EUSD panel appears with correct calculation
- Submit form, verify database record has correct currency and exchange_rate
</verification>

<success_criteria>
- [ ] Currency selector added to manual stock-in form with 4 currency options
- [ ] Exchange rate input added with 4 decimal precision support
- [ ] USD selection auto-sets exchange rate to 1.0 and disables input
- [ ] EUSD calculation panel displays real-time total with formula
- [ ] Database insert uses selected currency and exchange rate
- [ ] Summary panel shows selected currency instead of hardcoded "MMK"
- [ ] All changes committed atomically
</success_criteria>

<output>
After completion, create `.planning/phases/09-manual-stock-in-enhancement/09-01-SUMMARY.md`
</output>
