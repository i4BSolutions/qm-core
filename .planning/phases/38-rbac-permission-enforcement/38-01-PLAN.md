---
phase: 38-rbac-permission-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types/database.ts
  - lib/hooks/use-permissions.ts
  - components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "UserRole TypeScript type has exactly 3 values: admin, qmrl, qmhq"
    - "Permission matrix maps each of the 15 resources to exactly 3 roles"
    - "roleNavigation maps exactly 3 roles to their allowed route arrays (qmrl has NO /qmhq route)"
    - "canAccessRoute() works correctly for all 3 roles"
    - "usePermissions() returns isAdmin, isQmrl, isQmhq role booleans"
    - "Sidebar navigation shows correct items per role"
    - "npm run type-check passes with no errors"
  artifacts:
    - path: "types/database.ts"
      provides: "UserRole enum with 3 values"
      contains: "\"admin\" | \"qmrl\" | \"qmhq\""
    - path: "lib/hooks/use-permissions.ts"
      provides: "3-role permission matrix, roleNavigation, updated hook"
      contains: "isQmrl"
    - path: "components/layout/sidebar.tsx"
      provides: "Navigation with 3-role filtering"
      contains: "\"qmhq\""
  key_links:
    - from: "lib/hooks/use-permissions.ts"
      to: "types/database.ts"
      via: "UserRole import"
      pattern: "import.*UserRole.*from.*types"
    - from: "components/layout/sidebar.tsx"
      to: "lib/hooks/use-permissions.ts"
      via: "canAccessRoute import"
      pattern: "import.*canAccessRoute.*from.*use-permissions"
---

<objective>
Update the core RBAC infrastructure to enforce the 3-role model (admin, qmrl, qmhq) across TypeScript types, permission matrix, route navigation map, and sidebar navigation.

Purpose: Replace old 7-role permission system with the 3-role system established by Phase 37's database migration. This is the foundation that all page-level checks depend on.
Output: Updated types, permission hook, and sidebar — the three files that form the permission infrastructure.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-rbac-database-migration/37-02-SUMMARY.md
@.planning/phases/38-rbac-permission-enforcement/38-RESEARCH.md

Key context from Phase 37:
- Database enum is now `admin | qmrl | qmhq` (old 7 roles dropped)
- 92 RLS policies recreated with new role values
- QMRL/QMHQ SELECT policies use USING(true) — all authenticated users can read
- Stock-out UPDATE restricted to admin only (RBAC-15)
- has_role() dropped, get_user_role() returns new enum
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types and permission infrastructure</name>
  <files>
    types/database.ts
    lib/hooks/use-permissions.ts
  </files>
  <action>
  **Step 1: Update types/database.ts**

  Find the `user_role` enum definition (around line 1984) and replace the 7-role union:
  ```
  user_role:
    | "admin"
    | "quartermaster"
    | "finance"
    | "inventory"
    | "proposal"
    | "frontline"
    | "requester"
  ```
  With the 3-role union:
  ```
  user_role: "admin" | "qmrl" | "qmhq"
  ```

  **Step 2: Update lib/hooks/use-permissions.ts**

  2a. Update the permission matrix comment block (lines 33-47) to reflect the new 3-role matrix.

  2b. Replace the entire `permissionMatrix` object (lines 56-192). For each of the 15 resources, provide exactly 3 role keys: `admin`, `qmrl`, `qmhq`. Use the research document's Example 1 as the definitive mapping:

  - `users`: admin=CRUD, qmrl=[], qmhq=[]
  - `qmrl`: admin=CRUD, qmrl=CRU, qmhq=R
  - `qmhq`: admin=CRUD, qmrl=[], qmhq=CRUD
  - `financial_transactions`: admin=CRUD, qmrl=[], qmhq=CRUD
  - `inventory_transactions`: admin=CRUD, qmrl=[], qmhq=R
  - `purchase_orders`: admin=CRUD, qmrl=[], qmhq=CRUD
  - `invoices`: admin=CRUD, qmrl=[], qmhq=CRUD
  - `items`: admin=CRUD, qmrl=R, qmhq=RU
  - `warehouses`: admin=CRUD, qmrl=R, qmhq=RU
  - `suppliers`: admin=CRUD, qmrl=R, qmhq=CRUD
  - `contact_persons`: admin=CRUD, qmrl=CRU, qmhq=CRUD
  - `departments`: admin=CRUD, qmrl=R, qmhq=R
  - `categories`: admin=CRUD, qmrl=R, qmhq=CR
  - `statuses`: admin=CRUD, qmrl=R, qmhq=CR
  - `stock_out_requests`: admin=CRUD, qmrl=R, qmhq=CR (RBAC-15: only admin can approve/update)

  2c. Replace the `roleNavigation` object (lines 266-328) with exactly 3 keys:
  - `admin`: All routes including /admin
  - `qmrl`: /dashboard, /qmrl, /item (RBAC-07: NO access to /qmhq, /po, /invoice, /inventory)
  - `qmhq`: /dashboard, /qmrl, /qmhq, /po, /invoice, /inventory/stock-out-requests, /warehouse, /item

  2d. Update the `usePermissions()` hook return object (lines 247-260). Replace the 7 role booleans with 3:
  ```typescript
  isAdmin: role === "admin",
  isQmrl: role === "qmrl",
  isQmhq: role === "qmhq",
  ```
  Remove: isQuartermaster, isFinance, isInventory, isProposal, isFrontline, isRequester.
  </action>
  <verify>
  Run `npm run type-check` — should pass (other files may have errors from old role strings, but they will be addressed in Plan 02; this task's files must be internally consistent).

  Verify with grep:
  - `grep -c "quartermaster\|frontline\|requester\|\"finance\"\|\"inventory\"\|\"proposal\"" lib/hooks/use-permissions.ts` should return 0
  - `grep -c "isQmrl\|isQmhq\|isAdmin" lib/hooks/use-permissions.ts` should return 3+
  </verify>
  <done>
  TypeScript UserRole type has exactly 3 values. Permission matrix has 15 resources x 3 roles. roleNavigation has 3 role keys with correct routes per RBAC requirements. Hook returns isAdmin/isQmrl/isQmhq booleans.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar navigation role arrays</name>
  <files>
    components/layout/sidebar.tsx
  </files>
  <action>
  Update the `allNavigation` array's `roles` properties to use new 3-role values:

  1. Dashboard, QMRL, Items — keep no `roles` (visible to all, same as current)

  2. QMHQ: add `roles: ["admin", "qmhq"]` (RBAC-07: hide from QMRL users)

  3. Purchase Orders: change `roles: ["admin", "quartermaster", "finance", "proposal"]` to `roles: ["admin", "qmhq"]`

  4. Invoices: change `roles: ["admin", "quartermaster", "finance", "inventory", "proposal"]` to `roles: ["admin", "qmhq"]`

  5. Inventory: change `roles: ["admin", "quartermaster", "inventory"]` to `roles: ["admin"]` (admin-only for stock management; QMHQ accesses stock-out-requests via direct URL, not inventory nav)

  6. Warehouses: change `roles: ["admin", "quartermaster", "inventory", "proposal"]` to `roles: ["admin", "qmhq"]`

  7. Admin section: keep `roles: ["admin"]` (unchanged)

  The `NavItem` interface, `NavItemComponent`, `Sidebar` component, and filtering logic remain unchanged — only the role arrays in the data need updating.

  RBAC-07: QMRL users cannot access QMHQ pages at all. The QMHQ nav item MUST have `roles: ["admin", "qmhq"]` to hide it from QMRL users. Server-side page guards in Plan 02 will enforce this for direct URL access.

  Nav roles:
  - Dashboard: no roles (all)
  - QMRL: no roles (all)
  - QMHQ: `["admin", "qmhq"]`
  - Purchase Orders: `["admin", "qmhq"]`
  - Invoices: `["admin", "qmhq"]`
  - Inventory: `["admin"]`
  - Warehouses: `["admin", "qmhq"]`
  - Items: no roles (all)
  - Admin: `["admin"]`
  </action>
  <verify>
  Run `npm run type-check` to verify no type errors in sidebar.tsx.

  Verify with grep:
  - `grep -c "quartermaster\|frontline\|requester\|\"finance\"\|\"inventory\"\|\"proposal\"" components/layout/sidebar.tsx` should return 0
  - `grep "roles:" components/layout/sidebar.tsx` should show only "admin" and "qmhq" values
  </verify>
  <done>
  Sidebar navigation items use only "admin" and "qmhq" role values. QMRL users see: Dashboard, QMRL, Items (NO QMHQ link). QMHQ users see: Dashboard, QMRL, QMHQ, Purchase Orders, Invoices, Warehouses, Items. Admin sees all including Admin section.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes
2. `grep -rn "quartermaster\|frontline\|requester" lib/hooks/use-permissions.ts components/layout/sidebar.tsx types/database.ts` returns 0 results
3. Permission matrix has exactly 15 resources, each with exactly 3 roles (admin, qmrl, qmhq)
4. roleNavigation has exactly 3 keys (admin, qmrl, qmhq)
5. QMRL roleNavigation includes /qmrl but NOT /qmhq, /po, /invoice, /inventory
6. QMHQ roleNavigation includes /qmrl, /qmhq, /po, /invoice but NOT /inventory (only /inventory/stock-out-requests)
</verification>

<success_criteria>
- TypeScript compilation succeeds with updated UserRole type
- Permission matrix correctly enforces 3-role model across all 15 resources
- Sidebar shows role-appropriate navigation items
- All old role string references removed from infrastructure files
</success_criteria>

<output>
After completion, create `.planning/phases/38-rbac-permission-enforcement/38-01-SUMMARY.md`
</output>
