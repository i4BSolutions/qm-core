---
phase: 38-rbac-permission-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - app/(dashboard)/dashboard/page.tsx
  - app/(dashboard)/admin/users/page.tsx
  - app/(dashboard)/admin/users/user-dialog.tsx
  - app/api/admin/invite-user/route.ts
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/qmhq/layout.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMRL users navigating to /qmhq/* URLs are redirected to /dashboard (server-side page guard)"
    - "Dashboard page redirects qmrl users to /qmrl and qmhq users to /qmhq"
    - "Admin users page shows 3-role badges (Admin, QMRL, QMHQ) and stats cards"
    - "User create/edit dialog offers exactly 3 role options"
    - "Invite user API defaults to qmrl role (not requester)"
    - "QMRL detail file delete checks admin role (not quartermaster)"
    - "QMHQ detail file delete checks admin role (not quartermaster)"
    - "Stock-out approval restricted to admin only (not quartermaster/inventory)"
    - "npm run type-check passes with zero errors"
  artifacts:
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "3-role redirect logic"
      contains: "qmrl"
    - path: "app/(dashboard)/admin/users/page.tsx"
      provides: "3-role display config"
      contains: "qmhq"
    - path: "app/(dashboard)/admin/users/user-dialog.tsx"
      provides: "3-role selection options"
      contains: "qmhq"
    - path: "app/(dashboard)/qmhq/layout.tsx"
      provides: "Server-side QMRL page guard for all /qmhq/* routes"
      contains: "redirect"
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "Admin-only approval check"
      contains: "admin"
  key_links:
    - from: "app/(dashboard)/qmhq/layout.tsx"
      to: "RBAC-07 enforcement"
      via: "Server-side redirect for qmrl users on all /qmhq/* routes"
      pattern: "role.*qmrl.*redirect"
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "Role-based redirects"
      via: "roleRedirectMap with 3 roles"
      pattern: "qmrl.*qmrl|qmhq.*qmhq"
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "RBAC-15 enforcement"
      via: "canApprove check"
      pattern: "role.*===.*admin"
---

<objective>
Update all page-level role checks, role display configurations, and hardcoded role strings to use the 3-role model (admin, qmrl, qmhq).

Purpose: Align all page components with the new permission infrastructure from Plan 01. Removes all remaining old role references (quartermaster, finance, inventory, proposal, frontline, requester) from the application code.
Output: All page components use 3-role system, TypeScript compiles cleanly, and `npm run type-check` passes.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-rbac-permission-enforcement/38-RESEARCH.md
@.planning/phases/38-rbac-permission-enforcement/38-01-SUMMARY.md

Key requirements:
- RBAC-07: QMRL cannot access QMHQ/PO/Invoice/Inventory pages
- RBAC-14: Admin retains full CRUD
- RBAC-15: Stock-out approvals admin-only
- Phase 37: Default role for new signups is 'qmrl' (was 'requester')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard redirect and admin user management pages</name>
  <files>
    app/(dashboard)/dashboard/page.tsx
    app/(dashboard)/admin/users/page.tsx
    app/(dashboard)/admin/users/user-dialog.tsx
    app/api/admin/invite-user/route.ts
  </files>
  <action>
  **1a. app/(dashboard)/dashboard/page.tsx**

  Replace the `roleRedirectMap` (lines 15-21) and redirect logic (lines 39-43):

  OLD:
  ```typescript
  const roleRedirectMap: Record<string, string> = {
    finance: '/po',
    inventory: '/inventory',
    proposal: '/qmhq',
    frontline: '/qmrl',
    requester: '/qmrl',
  };
  // ...
  if (profile?.role && profile.role !== 'admin' && profile.role !== 'quartermaster') {
    const redirectTo = roleRedirectMap[profile.role] || '/qmrl';
    redirect(redirectTo);
  }
  ```

  NEW:
  ```typescript
  // Redirect non-admin users to their primary page
  if (profile?.role && profile.role !== 'admin') {
    redirect(profile.role === 'qmhq' ? '/qmhq' : '/qmrl');
  }
  ```

  Remove the `roleRedirectMap` const entirely. Update the component comment at the top to say "Admin users see the live dashboard" (remove "and Quartermaster").

  **1b. app/(dashboard)/admin/users/page.tsx**

  Replace the `roleConfig` object (lines 27-35):
  ```typescript
  const roleConfig: Record<string, { label: string; color: string }> = {
    admin: { label: "Admin", color: "bg-red-500" },
    qmrl: { label: "QMRL", color: "bg-blue-500" },
    qmhq: { label: "QMHQ", color: "bg-amber-500" },
  };
  ```

  Update the fallback role in the role column cell renderer (line 216):
  Change `const role = roleConfig[row.original.role || "requester"];` to `const role = roleConfig[row.original.role || "qmrl"];`

  Update the fallback role in the roleCounts reducer (line 305):
  Change `const role = user.role || "requester";` to `const role = user.role || "qmrl";`

  Update the Stats section (lines 354-383). Replace the 4 stat cards with 4 new ones:
  1. Total Users (keep as-is)
  2. Admins: `{roleCounts.admin || 0}` with "Admins" label (keep as-is)
  3. QMRL Users: `{roleCounts.qmrl || 0}` with "QMRL Users" label (replaces Quartermasters)
  4. QMHQ Users: `{roleCounts.qmhq || 0}` with "QMHQ Users" label (replaces Staff count)

  Remove the old `quartermaster` stat card and the `finance + inventory + proposal` sum calculation.

  **1c. app/(dashboard)/admin/users/user-dialog.tsx**

  Replace the `UserRole` type (line 30):
  ```typescript
  type UserRole = "admin" | "qmrl" | "qmhq";
  ```

  Replace the `roles` array (lines 40-48):
  ```typescript
  const roles = [
    { value: "admin", label: "Admin", description: "Full system access" },
    { value: "qmrl", label: "QMRL", description: "Create and manage request letters" },
    { value: "qmhq", label: "QMHQ", description: "HQ operations, POs, invoices, inventory requests" },
  ];
  ```

  Update default role values (lines 55, 66, 74):
  - Line 55: Change `role: "requester" as UserRole` to `role: "qmrl" as UserRole`
  - Line 66: Change `role: (user.role || "requester") as UserRole` to `role: (user.role || "qmrl") as UserRole`
  - Line 74: Change `role: "requester"` to `role: "qmrl"`

  **1d. app/api/admin/invite-user/route.ts**

  Update default role (line 60):
  Change `role: role || "requester"` to `role: role || "qmrl"`
  </action>
  <verify>
  Run `npm run type-check` to check for TypeScript errors in these files.

  Verify with grep:
  - `grep -rn "quartermaster\|frontline\|\"requester\"\|\"finance\"\|\"inventory\"\|\"proposal\"" app/(dashboard)/dashboard/page.tsx app/(dashboard)/admin/users/page.tsx app/(dashboard)/admin/users/user-dialog.tsx app/api/admin/invite-user/route.ts` should return 0 results
  - `grep "qmrl\|qmhq" app/(dashboard)/admin/users/user-dialog.tsx` should show new role values
  </verify>
  <done>
  Dashboard redirects non-admin users correctly (qmrl to /qmrl, qmhq to /qmhq). Admin users page shows 3 role badges (Admin, QMRL, QMHQ) with correct colors and stat cards. User dialog offers 3 role options. Invite API defaults to "qmrl" role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add server-side page guard to block QMRL users from /qmhq/* pages</name>
  <files>
    app/(dashboard)/qmhq/layout.tsx
  </files>
  <action>
  Create a new server-component layout at `app/(dashboard)/qmhq/layout.tsx` that acts as a page guard for ALL /qmhq/* routes (list, detail, new, edit).

  **Why a layout (not per-page guards):** A Next.js layout wraps all child pages. By placing the guard here, every /qmhq route is protected without modifying individual page files. This is the cleanest server-side enforcement.

  **Implementation:**

  Create `app/(dashboard)/qmhq/layout.tsx`:
  ```typescript
  import { redirect } from "next/navigation";
  import { createClient } from "@/lib/supabase/server";

  export default async function QmhqLayout({
    children,
  }: {
    children: React.ReactNode;
  }) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      redirect("/login");
    }

    const { data: profile } = await supabase
      .from("users")
      .select("role")
      .eq("id", user.id)
      .single();

    // RBAC-07: QMRL users cannot access any QMHQ pages
    if (profile?.role === "qmrl") {
      redirect("/dashboard");
    }

    return <>{children}</>;
  }
  ```

  This follows the same pattern as `app/(dashboard)/dashboard/page.tsx` for fetching user profile and redirecting. The key difference: this is a layout that wraps all QMHQ child routes.

  Note: Admin and QMHQ roles pass through. The redirect goes to /dashboard which will then redirect QMRL users to /qmrl (defense-in-depth).
  </action>
  <verify>
  Verify the file exists: `ls app/(dashboard)/qmhq/layout.tsx`

  Run `npm run type-check` to verify no TypeScript errors.

  Verify with grep:
  - `grep "qmrl" app/(dashboard)/qmhq/layout.tsx` should show the role check
  - `grep "redirect" app/(dashboard)/qmhq/layout.tsx` should show the redirect call
  </verify>
  <done>
  Server-side layout guard exists at app/(dashboard)/qmhq/layout.tsx. QMRL users navigating directly to any /qmhq/* URL (list, detail, new, edit) are redirected to /dashboard. Admin and QMHQ users pass through normally.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update page-level hardcoded role checks for file deletion and stock-out approval</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
  **2a. app/(dashboard)/qmrl/[id]/page.tsx (around line 86)**

  Replace the file delete permission check:
  ```typescript
  // OLD
  if (user.role === 'admin' || user.role === 'quartermaster') return true;

  // NEW
  if (user.role === 'admin') return true;
  ```

  Update the comment to: "Admin can delete any file"

  **2b. app/(dashboard)/qmhq/[id]/page.tsx (around line 142)**

  Same change as 2a:
  ```typescript
  // OLD
  if (user.role === 'admin' || user.role === 'quartermaster') return true;

  // NEW
  if (user.role === 'admin') return true;
  ```

  Update the comment to: "Admin can delete any file"

  **2c. app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx (around lines 158-159)**

  Replace the approval and execution permission checks:
  ```typescript
  // OLD
  const canApprove = user?.role === "admin" || user?.role === "quartermaster" || user?.role === "inventory";
  const canExecute = user?.role === "admin" || user?.role === "inventory";

  // NEW (RBAC-15: stock-out approvals restricted to Admin only)
  const canApprove = user?.role === "admin";
  const canExecute = user?.role === "admin";
  ```

  Note: The `isRequester` check on line 160 (`user?.id === request?.requester_id`) uses the database field name `requester_id` which is a column name, NOT a role name. Do NOT change this — it refers to the person who created the request, regardless of their role.

  Similarly, do NOT change other `requester` references that refer to database column names (requester_id, requester?.full_name) — these are entity field names, not role values.

  **Final: Run comprehensive grep to find any remaining old role strings**

  After making changes, run:
  ```bash
  grep -rn '"quartermaster"\|"frontline"' app/ lib/ components/ types/ --include="*.ts" --include="*.tsx"
  ```

  If any results found in TypeScript files (excluding `requester_id` field references, `requester:users!` join syntax, and `requester?.` property access), fix them.

  Note: `"requester"` as a string will still appear in database query joins like `requester:users!qmrl_requester_id_fkey(...)` — these are Supabase query aliases for the requester_id foreign key relationship, NOT role values. Do not change them.
  </action>
  <verify>
  Run `npm run type-check` — must pass with ZERO errors across the entire project.

  Run `npm run build` to verify the build succeeds.

  Verify RBAC-15:
  - `grep "canApprove" app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx` should show only admin check

  Verify no old role values remain:
  - `grep -rn '"quartermaster"\|"frontline"' app/ lib/ components/ types/ --include="*.ts" --include="*.tsx"` should return 0 results
  - `grep -rn '"requester"' app/ lib/ components/ types/ --include="*.ts" --include="*.tsx"` should return ONLY database field references (requester_id, requester:users!), NOT role assignments
  </verify>
  <done>
  All hardcoded old role checks replaced with new 3-role values. File delete permission checks use admin-only. Stock-out approval restricted to admin per RBAC-15. `npm run type-check` passes with zero errors. No old role string values remain in application code (excluding database column names).
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with zero errors
2. `npm run build` succeeds
3. Zero instances of old role strings in TypeScript code:
   - `grep -rn '"quartermaster"\|"frontline"' app/ lib/ components/ types/` returns nothing
   - `grep -rn '"finance"' app/ lib/ components/ types/ --include="*.ts" --include="*.tsx"` returns only non-role references (if any)
4. RBAC-07 verified: Server-side page guard at app/(dashboard)/qmhq/layout.tsx redirects QMRL users away from /qmhq/* routes
5. RBAC-07 verified: QMRL role's roleNavigation excludes /qmhq, /po, /invoice, /inventory (enforced in Plan 01)
6. RBAC-15 verified: canApprove and canExecute for stock-out requests check admin-only
7. All role fallback defaults use "qmrl" (not "requester")
8. Dashboard redirects qmrl to /qmrl, qmhq to /qmhq, admin stays on /dashboard
</verification>

<success_criteria>
- All page-level role checks updated to 3-role model
- QMRL users blocked from all /qmhq/* pages via server-side layout guard (RBAC-07)
- Admin users page displays correct role badges and statistics
- User create/edit dialog shows 3 role options
- Stock-out approvals restricted to admin only (RBAC-15)
- Full TypeScript compilation succeeds
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/38-rbac-permission-enforcement/38-02-SUMMARY.md`
</output>
