---
phase: 16-audit-notes-feature
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/048_status_update_with_note.sql
  - components/status/status-change-dialog.tsx
  - components/status/clickable-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "User can optionally enter a note when changing status on QMRL"
    - "User can optionally enter a note when changing status on QMHQ"
    - "Note appears in History tab when present"
    - "Status changes without notes still work and appear in History"
    - "No duplicate audit entries when status is changed"
  artifacts:
    - path: "supabase/migrations/048_status_update_with_note.sql"
      provides: "RPC function for status update with note and trigger deduplication"
      contains: "update_status_with_note"
    - path: "components/status/status-change-dialog.tsx"
      provides: "Dialog that captures note and passes it to parent"
      exports: ["StatusChangeDialog"]
    - path: "components/status/clickable-status-badge.tsx"
      provides: "Badge component that calls RPC with note"
      contains: "update_status_with_note"
  key_links:
    - from: "components/status/status-change-dialog.tsx"
      to: "components/status/clickable-status-badge.tsx"
      via: "onConfirm callback now accepts note parameter"
      pattern: "onConfirm.*note"
    - from: "components/status/clickable-status-badge.tsx"
      to: "supabase/migrations/048_status_update_with_note.sql"
      via: "RPC call with note"
      pattern: "rpc.*update_status_with_note"
---

<objective>
Capture user-entered notes during status changes and store them in the audit log

Purpose: Users want to document WHY they changed a status (e.g., "Approved by manager", "Waiting for supplier quote"). Currently the note field exists in the UI but is not persisted.

Output: Status changes on QMRL and QMHQ can include an optional note that appears in the History tab.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-audit-notes-feature/16-CONTEXT.md
@.planning/phases/16-audit-notes-feature/16-RESEARCH.md

Key existing files:
- supabase/migrations/029_fix_audit_trigger_v2.sql (current trigger)
- components/status/status-change-dialog.tsx (UI already has note textarea)
- components/status/clickable-status-badge.tsx (handles status updates)
- components/history/history-tab.tsx (already displays notes lines 346-351)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RPC function and trigger deduplication</name>
  <files>supabase/migrations/048_status_update_with_note.sql</files>
  <action>
Create a new migration with:

1. RPC function `update_status_with_note(p_entity_type, p_entity_id, p_new_status_id, p_note, p_user_id)`:
   - First creates the audit log entry with the note (so trigger can detect it)
   - Then updates the entity (qmrl or qmhq) status_id
   - Uses a transaction to ensure atomicity
   - Gets old status name and new status name for summary
   - Returns success/error

2. Modify trigger `create_audit_log()` to detect and skip duplicates:
   - In the status_id change block (lines 122-147 of 029_fix_audit_trigger_v2.sql)
   - Before inserting, check if an audit entry exists within last 2 seconds for same entity_id + action + field_name + new_value
   - If found, skip the insert (return NEW without inserting)
   - This prevents the trigger from creating a duplicate when the RPC already created one

Pattern for deduplication check:
```sql
-- Check for recent duplicate (app may have already created audit entry with note)
IF EXISTS (
  SELECT 1 FROM public.audit_logs
  WHERE entity_type = TG_TABLE_NAME
    AND entity_id = NEW.id
    AND action = 'status_change'
    AND field_name = 'status_id'
    AND new_value = new_json->>'status_id'
    AND changed_at > NOW() - INTERVAL '2 seconds'
) THEN
  -- Skip - audit entry already created by RPC with note
  RETURN NEW;
END IF;
```

Security: Use SECURITY DEFINER with hardened search_path (pg_catalog, public) per project convention.
  </action>
  <verify>
Run migration: `npx supabase db push` or `npx supabase db reset`
Test RPC exists: `SELECT proname FROM pg_proc WHERE proname = 'update_status_with_note';`
  </verify>
  <done>
RPC function exists and trigger has deduplication logic. Migration applies without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire UI to pass note through status update flow</name>
  <files>
    components/status/status-change-dialog.tsx
    components/status/clickable-status-badge.tsx
  </files>
  <action>
**StatusChangeDialog changes:**

1. Change `onConfirm` prop signature from `() => Promise<void>` to `(note: string) => Promise<void>`
2. Update `handleConfirm` to pass the note: `await onConfirm(note);`
3. Add maxLength={256} to the Textarea (per CONTEXT.md decision)
4. Update the help text to remove "informational only" since notes are now persisted

**ClickableStatusBadge changes:**

1. Update `handleConfirm` to accept note parameter: `const handleConfirm = async (note: string) => {`
2. Replace direct Supabase update with RPC call:

```typescript
const { error } = await supabase.rpc('update_status_with_note', {
  p_entity_type: entityType,
  p_entity_id: entityId,
  p_new_status_id: selectedStatus.id,
  p_note: note || null,  // Pass null if empty
  p_user_id: user.id
});
```

3. Remove the direct `.from(tableName).update()` call - RPC handles everything

Keep error handling the same (toast on error, callback on success).
  </action>
  <verify>
TypeScript compiles: `npm run type-check`
Build succeeds: `npm run build`
  </verify>
  <done>
StatusChangeDialog passes note to callback. ClickableStatusBadge calls RPC with note.
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual verification of full flow</name>
  <files>N/A (verification only)</files>
  <action>
Start dev server and test the complete flow:

1. Navigate to a QMRL detail page
2. Click on the status badge to open the dropdown
3. Select a different status
4. In the confirmation dialog, type a note (e.g., "Approved per manager request")
5. Click Confirm
6. Navigate to the History tab
7. Find the status change entry and verify the note is displayed

Also test:
- Status change WITHOUT a note (leave textarea empty) - should still work
- Rapid status changes (change status, then change again quickly) - both should be recorded
- QMHQ status change with note - same behavior as QMRL
  </action>
  <verify>
1. Note appears in History tab entry for status changes
2. Status changes without notes still appear in History
3. No duplicate entries in audit_logs table
4. Both QMRL and QMHQ support notes
  </verify>
  <done>
Full flow works: note entered in dialog appears in History tab. No duplicates.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database check:
```sql
-- Verify RPC exists
SELECT proname, prosecdef FROM pg_proc WHERE proname = 'update_status_with_note';

-- Verify no duplicate audit entries (should return 0 for recent status changes)
SELECT entity_id, action, field_name, new_value, COUNT(*)
FROM audit_logs
WHERE action = 'status_change'
  AND changed_at > NOW() - INTERVAL '1 hour'
GROUP BY entity_id, action, field_name, new_value
HAVING COUNT(*) > 1;
```

2. UI check:
- Status badge click opens dropdown
- Selecting new status opens confirmation dialog
- Dialog has note textarea with 256 char limit
- Confirming with note shows note in History tab
- Confirming without note still works

3. No regressions:
- `npm run type-check` passes
- `npm run build` succeeds
</verification>

<success_criteria>
- RPC function `update_status_with_note` exists and works
- Trigger deduplication prevents double audit entries
- StatusChangeDialog passes note to parent callback
- ClickableStatusBadge calls RPC with note
- Notes appear in History tab (already displays them)
- Status changes without notes still work
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-audit-notes-feature/16-01-SUMMARY.md`
</output>
