---
phase: 23-comments-system
plan: 03
type: execute
wave: 3
depends_on: ["23-02"]
files_modified:
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMRL detail page shows Comments section at bottom"
    - "QMHQ detail page shows Comments section at bottom"
    - "PO detail page shows Comments section at bottom"
    - "Invoice detail page shows Comments section at bottom"
    - "Comments section is always visible (not in tabs)"
  artifacts:
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "QMRL detail with comments"
      contains: "CommentsSection"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail with comments"
      contains: "CommentsSection"
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "PO detail with comments"
      contains: "CommentsSection"
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail with comments"
      contains: "CommentsSection"
  key_links:
    - from: "detail pages"
      to: "CommentsSection component"
      via: "import and render"
      pattern: "import.*CommentsSection.*from.*components/comments"
---

<objective>
Integrate the CommentsSection component into all four detail pages: QMRL, QMHQ, PO, and Invoice.

Purpose: Enable users to comment on any of the four entity types.
Output: All detail pages display comments section at the bottom of content.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-comments-system/23-CONTEXT.md
@.planning/phases/23-comments-system/23-02-SUMMARY.md
@app/(dashboard)/qmrl/[id]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
@app/(dashboard)/po/[id]/page.tsx
@app/(dashboard)/invoice/[id]/page.tsx
@components/comments/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CommentsSection to QMRL and QMHQ detail pages</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
**QMRL detail page (app/(dashboard)/qmrl/[id]/page.tsx)**:

1. Add import at top:
```typescript
import { CommentsSection } from "@/components/comments";
```

2. Find the closing `</Tabs>` tag (around line 657) and add CommentsSection AFTER it, BEFORE the closing div:
```tsx
      </Tabs>

      {/* Comments Section - always visible at bottom per user decision */}
      <CommentsSection entityType="qmrl" entityId={qmrl.id} />
    </div>
```

The section should be outside Tabs, at the same level, so it's always visible regardless of which tab is selected.

**QMHQ detail page (app/(dashboard)/qmhq/[id]/page.tsx)**:

1. Add import at top:
```typescript
import { CommentsSection } from "@/components/comments";
```

2. Find the closing `</Tabs>` tag and add CommentsSection after it:
```tsx
      </Tabs>

      {/* Comments Section */}
      <CommentsSection entityType="qmhq" entityId={qmhq.id} />
    </div>
```

Ensure the entityId uses the correct state variable name (qmhq.id).
  </action>
  <verify>Navigate to /qmrl/{id} and /qmhq/{id}, verify Comments section appears below tabs</verify>
  <done>QMRL and QMHQ detail pages display Comments section at bottom of content</done>
</task>

<task type="auto">
  <name>Task 2: Add CommentsSection to PO and Invoice detail pages</name>
  <files>
    app/(dashboard)/po/[id]/page.tsx
    app/(dashboard)/invoice/[id]/page.tsx
  </files>
  <action>
**PO detail page (app/(dashboard)/po/[id]/page.tsx)**:

1. Add import at top:
```typescript
import { CommentsSection } from "@/components/comments";
```

2. Find the closing `</Tabs>` tag (around line 645) and add CommentsSection after it:
```tsx
      </Tabs>

      {/* Comments Section */}
      <CommentsSection entityType="po" entityId={poId} />
    </div>
```

Note: PO page uses `poId` from params, not `po.id`.

**Invoice detail page (app/(dashboard)/invoice/[id]/page.tsx)**:

1. Add import at top:
```typescript
import { CommentsSection } from "@/components/comments";
```

2. Find the closing `</Tabs>` tag and add CommentsSection after it:
```tsx
      </Tabs>

      {/* Comments Section */}
      <CommentsSection entityType="invoice" entityId={invoiceId} />
    </div>
```

Check the Invoice page for the correct variable name for the invoice ID (likely invoiceId from params or invoice.id from state).
  </action>
  <verify>Navigate to /po/{id} and /invoice/{id}, verify Comments section appears below tabs</verify>
  <done>PO and Invoice detail pages display Comments section at bottom of content</done>
</task>

<task type="auto">
  <name>Task 3: Manual testing of complete flow</name>
  <files></files>
  <action>
Perform end-to-end testing of the comments feature across all four entity types.

Test checklist:

1. **QMRL Comments**:
   - Navigate to any QMRL detail page
   - Verify "Comments (0)" header displays
   - Add a comment, verify it appears immediately
   - Reply to the comment, verify reply appears indented
   - Verify Reply button not visible on the reply
   - Verify Delete button on parent comment is disabled (has tooltip "Cannot delete: has replies")
   - Delete the reply, verify it disappears
   - Now delete the parent comment (should be allowed)

2. **QMHQ Comments**:
   - Navigate to any QMHQ detail page
   - Add a comment and reply
   - Verify same behavior as QMRL

3. **PO Comments**:
   - Navigate to any PO detail page
   - Add a comment and reply
   - Verify comment count updates in header

4. **Invoice Comments**:
   - Navigate to any Invoice detail page
   - Add a comment
   - Verify displays correctly

5. **Cross-role testing** (if multiple test users available):
   - As Requester: verify can only see/comment on own QMRL and linked QMHQ
   - As Admin/Quartermaster: verify can see all comments
   - Verify users can only delete their own comments

6. **Edge cases**:
   - Empty comment (should be blocked by UI)
   - Very long comment (should wrap correctly)
   - Rapid clicking submit (should not create duplicates - button disabled during submit)
  </action>
  <verify>All test cases pass, screenshots or notes captured if issues found</verify>
  <done>Complete comments feature working across all four entity types with proper threading and permissions</done>
</task>

</tasks>

<verification>
1. All 4 detail pages show Comments section below tabs
2. Comments persist after page refresh
3. Threading works correctly (replies under parents)
4. Delete protection works (cannot delete parent with replies)
5. Only own comments can be deleted
6. Toast notifications appear for all actions
</verification>

<success_criteria>
- COMM-01: User can add comments on QMRL detail page
- COMM-02: User can add comments on QMHQ detail page
- COMM-03: User can add comments on PO detail page
- COMM-04: User can add comments on Invoice detail page
- COMM-05: User can reply to a comment (one level only)
- COMM-06: User can delete own comments (soft delete)
- COMM-07: Comment displays author name and timestamp
- COMM-08: Comments ordered chronologically (oldest first)
- COMM-09: Comments follow existing entity RLS visibility rules
</success_criteria>

<output>
After completion, create `.planning/phases/23-comments-system/23-03-SUMMARY.md`
</output>
