---
phase: 11-warehouse-detail-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/warehouse/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see per-item WAC with EUSD values in warehouse inventory table"
    - "User can see items with zero stock displayed with visual distinction"
    - "User can see low stock items (below 10 units) highlighted in amber"
    - "User can see total warehouse value in EUSD in KPI cards"
    - "User can see unique items and total units counts in KPI cards"
  artifacts:
    - path: "app/(dashboard)/warehouse/[id]/page.tsx"
      provides: "Enhanced warehouse inventory display with WAC, EUSD, and visual indicators"
      contains: "LOW_STOCK_THRESHOLD"
  key_links:
    - from: "app/(dashboard)/warehouse/[id]/page.tsx"
      to: "lib/utils/index.ts"
      via: "formatCurrency for EUSD display"
      pattern: "formatCurrency"
---

<objective>
Enhance the warehouse detail page inventory tab to display per-item WAC with EUSD values, show zero-stock items with visual distinction, add low stock warnings, and update KPI cards to EUSD-only display.

Purpose: Complete WHSE-01 (per-item WAC display) and WHSE-02 (EUSD value per item) requirements for Phase 11.
Output: Enhanced warehouse detail page with comprehensive WAC/EUSD display, zero-stock visibility, and low stock indicators.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-warehouse-detail-enhancement/11-CONTEXT.md
@.planning/phases/11-warehouse-detail-enhancement/11-RESEARCH.md
@app/(dashboard)/warehouse/[id]/page.tsx
@lib/utils/index.ts
@lib/utils/inventory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update inventory aggregation to include zero-stock items and add default sorting</name>
  <files>app/(dashboard)/warehouse/[id]/page.tsx</files>
  <action>
    Modify the inventory calculation logic to include zero-stock items instead of filtering them out:

    1. Remove the `.filter((inv) => inv.current_stock > 0)` from line 152

    2. Keep all items in inventoryList including those with zero/negative stock

    3. Update the KPI calculation (useMemo around line 176) to:
       - Calculate totalItems as count of items with current_stock > 0 (not all items)
       - Calculate totalUnits from items with current_stock > 0 only
       - Calculate totalValueEusd from items with current_stock > 0 only
       - Remove totalValue (MMK) - we only need EUSD per CONTEXT.md

    4. Add initialState to useReactTable (currently not using it for sorting):
       - Default sort by total_value_eusd descending (highest value first)
       - This requires passing initialState.sorting to the DataTable component or handling it inline

    Note: The DataTable component already uses useReactTable internally, so we need to update the column definitions to enable sorting and rely on DataTable's built-in globalFilter for search.
  </action>
  <verify>
    - Build succeeds: `npm run build`
    - Navigate to warehouse detail page
    - Verify items with zero stock appear in the table (grayed out styling added in Task 2)
    - Verify KPIs only count items with positive stock
  </verify>
  <done>
    - Zero-stock items included in inventory list
    - KPIs correctly exclude zero-stock items from counts and totals
    - Default sort preparation complete
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance inventory table columns with EUSD-only display, low stock warning, and visual polish</name>
  <files>app/(dashboard)/warehouse/[id]/page.tsx</files>
  <action>
    Update the inventory table columns (inventoryColumns around line 194) with the following enhancements:

    1. Add LOW_STOCK_THRESHOLD constant at top of file:
       `const LOW_STOCK_THRESHOLD = 10;`

    2. Update column order to match CONTEXT.md:
       - Item name (linked to /item/[id])
       - Item code/SKU
       - Unit of measure
       - Stock quantity (with low stock/zero stock styling)
       - WAC (EUSD) - remove the separate MMK WAC column
       - Total Value (EUSD) - remove the separate MMK total value column

    3. Enhance Stock column cell to include visual indicators:
       - Zero stock (current_stock <= 0): text-slate-500 (grayed out)
       - Low stock (current_stock > 0 && current_stock < LOW_STOCK_THRESHOLD): text-amber-400 font-semibold
       - Normal stock: text-emerald-400 (existing)

    4. Update WAC column to show EUSD only:
       - Header: "WAC (EUSD)"
       - Display dash (—) for null/undefined WAC values
       - Format as: `${formatCurrency(wac_amount_eusd)} EUSD`

    5. Update Total Value column to show EUSD only:
       - Header: "Total (EUSD)"
       - Display dash (—) for zero or null values
       - Format as: `${formatCurrency(total_value_eusd)} EUSD`
       - Add text-right class for accounting-style alignment

    6. Make all numeric columns right-aligned:
       - Add className "text-right" to cell containers for Stock, WAC, and Total columns

    7. Remove redundant columns:
       - Remove wac_amount column (keep only wac_amount_eusd)
       - Remove total_value column (keep only total_value_eusd)

    8. Ensure all columns are sortable via DataTableColumnHeader pattern.
  </action>
  <verify>
    - Build succeeds: `npm run build`
    - Navigate to warehouse detail page
    - Verify columns appear in correct order: Item, SKU, Unit, Stock, WAC (EUSD), Total (EUSD)
    - Verify zero-stock items appear grayed out
    - Verify low-stock items (below 10) appear in amber
    - Verify numeric columns are right-aligned
    - Verify dash (—) appears for null WAC values
  </verify>
  <done>
    - Inventory table shows EUSD-only columns with proper formatting
    - Zero-stock items visually distinguished (grayed out)
    - Low-stock items highlighted in amber
    - Numeric columns right-aligned for readability
  </done>
</task>

<task type="auto">
  <name>Task 3: Update KPI cards to EUSD-only display with refined metrics</name>
  <files>app/(dashboard)/warehouse/[id]/page.tsx</files>
  <action>
    Update the KPI cards section (around line 495) to match CONTEXT.md specification:

    1. Reduce from 4 KPIs to 3 per CONTEXT.md:
       - Total Warehouse Value (EUSD)
       - Unique Items (with stock > 0)
       - Total Units

    2. Remove the "Total Value" (MMK) KPI card - we only display EUSD per CONTEXT.md

    3. Update grid layout from `grid-cols-4` to `grid-cols-3`

    4. Update KPI card content:

       Card 1 - Total Value (EUSD):
       - Icon: DollarSign (emerald)
       - Label: "Total Value"
       - Value: `${formatCurrency(kpis.totalValueEusd)} EUSD`
       - Subtitle: "EUSD equivalent"

       Card 2 - Unique Items:
       - Icon: Boxes (blue)
       - Label: "Unique Items"
       - Value: kpis.totalItems
       - Subtitle: "with stock > 0"

       Card 3 - Total Units:
       - Icon: Package (emerald)
       - Label: "Total Units"
       - Value: kpis.totalUnits.toLocaleString()
       - Subtitle: "units in stock"

    5. Keep the special highlighting on Total Value card:
       - `bg-emerald-500/5 border-emerald-500/20`

    6. Format all currency values with formatCurrency utility (already imported).
  </action>
  <verify>
    - Build succeeds: `npm run build`
    - Navigate to warehouse detail page
    - Verify 3 KPI cards displayed in grid
    - Verify Total Value shows EUSD amount with suffix
    - Verify Unique Items count excludes zero-stock items
    - Verify Total Units count excludes zero-stock items
  </verify>
  <done>
    - KPI cards updated to 3-card layout
    - Total Value displays EUSD only
    - Unique Items correctly counts only items with stock > 0
    - Total Units correctly sums only positive stock quantities
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   npm run build
   ```

2. Functional verification:
   - Navigate to a warehouse detail page with mixed inventory (some zero-stock, some low-stock, some normal)
   - Verify inventory table displays all items including zero-stock
   - Verify zero-stock items appear grayed out
   - Verify low-stock items (< 10 units) appear in amber
   - Verify table sorts by Total Value (EUSD) descending by default
   - Verify search works and includes zero-stock items
   - Verify KPIs show correct counts excluding zero-stock items
   - Verify all EUSD values display with proper formatting and suffix

3. Edge cases:
   - Empty warehouse: Shows "No items" message (existing behavior)
   - All items zero stock: KPIs show 0, table shows grayed items
   - Items without WAC: Display dash (—) instead of "0.00 EUSD"
</verification>

<success_criteria>
- WHSE-01 complete: User can see per-item WAC display (stock qty, WAC amount, total value)
- WHSE-02 complete: User can see EUSD value per item in warehouse
- Zero-stock items visible with grayed-out styling
- Low-stock items highlighted in amber (< 10 units)
- KPI cards show EUSD-only values with proper counts
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-warehouse-detail-enhancement/11-01-SUMMARY.md`
</output>
