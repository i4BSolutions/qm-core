---
phase: 10-inventory-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/042_inventory_dashboard_kpis.sql
  - lib/actions/inventory-dashboard.ts
  - app/(dashboard)/inventory/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view paginated list of all stock in/out transactions"
    - "User sees transaction count KPIs (stock in count, stock out count)"
    - "User sees transaction value KPIs (EUSD values)"
    - "User can toggle view between All, Stock In, and Stock Out tabs"
  artifacts:
    - path: "supabase/migrations/042_inventory_dashboard_kpis.sql"
      provides: "get_inventory_kpis RPC function for aggregations"
      contains: "CREATE OR REPLACE FUNCTION public.get_inventory_kpis"
    - path: "lib/actions/inventory-dashboard.ts"
      provides: "Server actions for KPI and transaction fetching"
      exports: ["getInventoryKPIs", "getInventoryTransactions"]
    - path: "app/(dashboard)/inventory/page.tsx"
      provides: "Inventory dashboard page with KPIs, tabs, and transaction table"
      min_lines: 200
  key_links:
    - from: "app/(dashboard)/inventory/page.tsx"
      to: "lib/actions/inventory-dashboard.ts"
      via: "Server action calls for data fetching"
      pattern: "getInventoryKPIs|getInventoryTransactions"
    - from: "lib/actions/inventory-dashboard.ts"
      to: "supabase.rpc"
      via: "Supabase RPC call"
      pattern: "rpc\\('get_inventory_kpis'"
---

<objective>
Build the inventory dashboard with KPI cards and transaction table with tabs.

Purpose: Users can view comprehensive stock transaction history with KPIs showing total in/out counts and EUSD values. The dashboard replaces the current placeholder page.

Output:
- PostgreSQL RPC function for efficient KPI aggregation
- Server actions for KPI and transaction fetching
- Dashboard page with KPI cards row, tabs (All/Stock In/Stock Out), and paginated transaction table
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-inventory-dashboard/10-CONTEXT.md
@.planning/phases/10-inventory-dashboard/10-RESEARCH.md
@supabase/migrations/023_inventory_transactions.sql
@supabase/migrations/033_dashboard_functions.sql
@app/(dashboard)/inventory/page.tsx
@app/(dashboard)/qmhq/page.tsx
@components/ui/tabs.tsx
@components/ui/pagination.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KPI aggregation RPC function</name>
  <files>supabase/migrations/042_inventory_dashboard_kpis.sql</files>
  <action>
Create a PostgreSQL RPC function `get_inventory_kpis` that computes aggregates from inventory_transactions table.

Function signature:
```sql
CREATE OR REPLACE FUNCTION public.get_inventory_kpis(
  from_date date DEFAULT NULL,
  to_date date DEFAULT NULL,
  warehouse_id_filter uuid DEFAULT NULL,
  item_id_filter uuid DEFAULT NULL
)
RETURNS TABLE(
  stock_in_count bigint,
  stock_in_value_eusd numeric,
  stock_out_count bigint,
  stock_out_value_eusd numeric,
  net_movement_eusd numeric
)
```

Implementation notes:
- Filter on `is_active = true` AND `status = 'completed'`
- Use FILTER clause for conditional aggregation by movement_type
- Handle NULL filter parameters (include all when NULL)
- Use COALESCE for SUM to return 0 instead of NULL
- Mark as `LANGUAGE sql STABLE SECURITY DEFINER`
- Set `search_path = pg_catalog, public` for SECURITY DEFINER hardening (per Phase 8 decision)
- Grant EXECUTE to authenticated role

Pattern follows existing `get_qmrl_status_counts()` in 033_dashboard_functions.sql.
  </action>
  <verify>
Run `npx supabase db push` to apply migration.
Verify function exists: `npx supabase db reset` should succeed without errors.
  </verify>
  <done>
RPC function `get_inventory_kpis` exists and returns correct aggregation data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server actions for dashboard data</name>
  <files>lib/actions/inventory-dashboard.ts</files>
  <action>
Create server actions file with two functions:

1. `getInventoryKPIs(filters)` - Calls RPC function for KPI aggregation
   - Parameters: fromDate?, toDate?, warehouseId?, itemId?
   - Returns: { stock_in_count, stock_in_value_eusd, stock_out_count, stock_out_value_eusd, net_movement_eusd }

2. `getInventoryTransactions(filters)` - Fetches paginated transaction list
   - Parameters: { fromDate?, toDate?, warehouseId?, itemId?, movementType?, page, pageSize }
   - Uses Supabase select with joins for item and warehouse names:
     ```typescript
     .select(`
       id, transaction_date, movement_type, quantity,
       unit_cost, currency, exchange_rate, total_cost, total_cost_eusd,
       reference_no, invoice_id, qmhq_id,
       item:items(id, name, sku),
       warehouse:warehouses(id, name),
       invoice:invoices(id, invoice_number),
       qmhq:qmhq(id, request_id)
     `)
     ```
   - Filters on is_active = true, status = 'completed'
   - Applies date range, warehouse, item filters when provided
   - Orders by transaction_date DESC (newest first)
   - Uses .range() for pagination
   - Returns: { transactions, totalCount }

Both functions use 'use server' directive and createClient from @/lib/supabase/server.
Include TypeScript interfaces for return types.
  </action>
  <verify>
TypeScript compiles without errors: `npm run type-check`
  </verify>
  <done>
Server actions `getInventoryKPIs` and `getInventoryTransactions` implemented with proper typing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace placeholder with full dashboard page</name>
  <files>app/(dashboard)/inventory/page.tsx</files>
  <action>
Replace the existing placeholder page with a full inventory dashboard.

**Page structure (top to bottom):**

1. **Header section**
   - Title: "Inventory Dashboard"
   - Subtitle: "Stock transaction history with KPIs"
   - Stock In / Stock Out buttons (existing, keep them)

2. **KPI Cards row** (horizontal, 3 cards)
   - Stock In card: count + EUSD value
   - Stock Out card: count + EUSD value
   - Net Movement card: EUSD value (can be negative)
   - Cards are clickable - clicking switches to corresponding tab
   - Negative net movement shows in red text (text-red-400)
   - Style following existing KPI card pattern in dashboard components

3. **Tabs section** (below KPIs)
   - Tab bar: "All (X)" | "Stock In (Y)" | "Stock Out (Z)"
   - Use @radix-ui/react-tabs via components/ui/tabs.tsx
   - Counts reflect current data (update when filters change - handled in Plan 02)
   - Default tab: "all"
   - Store tab state in URL search params: `?tab=all|in|out`

4. **Transaction table**
   - Columns: Date, Item, Warehouse, Quantity, Type, Unit Cost, Total Value, Reference
   - Date column: format as DD/MM/YYYY, sortable (default: newest first)
   - Type column: colored badges - green "IN", red "OUT"
   - Unit Cost: show as "1,000 MMK" format (original currency)
   - Total Value: show as "1,000 MMK (0.50 EUSD)" format
   - Reference column: For invoice-based, show invoice number. For QMHQ-based, show QMHQ ID. For manual, show "Manual"
   - Clickable rows: navigate to source document (invoice or QMHQ detail page). Manual transactions are non-clickable (no cursor-pointer).
   - Empty state: "No transactions found"

5. **Pagination** (below table)
   - Use existing Pagination component
   - Page size: 20 (default)
   - Reset to page 1 when tab changes

**State management:**
- Use 'use client' with useState for local state
- Use useSearchParams + useRouter for URL state (tab)
- Fetch data on mount and when tab changes
- Use loading skeleton while fetching

**Styling:**
- Follow existing QMHQ page patterns
- Use command-panel class for filter bar and table container
- Use tactical-card patterns for KPI cards
  </action>
  <verify>
Run `npm run dev` and navigate to /inventory.
Verify:
1. KPI cards show with counts and EUSD values
2. Tabs switch between All/Stock In/Stock Out
3. Transaction table displays with proper columns
4. Clicking row navigates to invoice or QMHQ (manual rows not clickable)
5. Pagination works
  </verify>
  <done>
Inventory dashboard displays KPIs, tabs, transaction table with pagination.
Tab state persists in URL. Clicking KPI card switches to corresponding tab.
  </done>
</task>

</tasks>

<verification>
1. Migration applies successfully: `npx supabase db push`
2. Type check passes: `npm run type-check`
3. Dev server runs: `npm run dev`
4. Navigate to /inventory - shows KPIs, tabs, table
5. Click KPI card - switches to corresponding tab
6. Click transaction row - navigates to source document
7. Change tabs - table filters to movement type
8. Pagination works with page size selector
</verification>

<success_criteria>
- [ ] RPC function `get_inventory_kpis` created with filter parameters
- [ ] Server actions fetch KPIs and transactions with filtering
- [ ] Dashboard shows KPI cards with counts and EUSD values
- [ ] Tabs filter transactions by movement type
- [ ] Transaction table shows all required columns
- [ ] Clickable rows navigate to source documents
- [ ] Pagination works correctly
- [ ] Tab state persists in URL
</success_criteria>

<output>
After completion, create `.planning/phases/10-inventory-dashboard/10-01-SUMMARY.md`
</output>
