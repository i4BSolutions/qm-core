---
phase: 21-item-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - app/(dashboard)/item/item-dialog.tsx
  - app/(dashboard)/item/page.tsx
  - components/po/po-line-items-table.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter price reference note when creating/editing an item"
    - "Price reference displays in Item List page as dedicated column"
    - "Price reference displays in PO line item selector as tooltip on hover"
    - "Item codes display prominently with code-first format in lists and selectors"
    - "Category is required when creating new items"
    - "SKU field is hidden during item creation, shown read-only after save"
  artifacts:
    - path: "app/(dashboard)/item/item-dialog.tsx"
      provides: "Price reference input field, required category"
      contains: "price_reference"
    - path: "app/(dashboard)/item/page.tsx"
      provides: "Price reference column, updated SKU display"
      contains: "price_reference"
    - path: "components/po/po-line-items-table.tsx"
      provides: "Tooltip for price reference, code-first item display"
      contains: "TooltipProvider"
  key_links:
    - from: "ItemDialog form"
      to: "items table"
      via: "supabase insert/update"
      pattern: "price_reference"
    - from: "PO line item selector"
      to: "Tooltip component"
      via: "TooltipTrigger wrapping SelectItem"
      pattern: "TooltipTrigger.*SelectItem"
---

<objective>
Update Item UI components to support price reference notes and display SKU codes prominently.

Purpose: Enable users to enter price references when creating/editing items, display this information in the Item List page and PO line item selector (as tooltip), and show the new SKU format prominently throughout the UI.

Output:
- Updated Item Dialog with price_reference field and required category
- Updated Item List page with price_reference column and code-first display
- Updated PO line item selector with tooltip for price reference and code-first display
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-item-enhancements/21-CONTEXT.md
@.planning/phases/21-item-enhancements/21-01-SUMMARY.md
@app/(dashboard)/item/item-dialog.tsx
@app/(dashboard)/item/page.tsx
@components/po/po-line-items-table.tsx
@components/ui/tooltip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Item Dialog with price reference and required category</name>
  <files>app/(dashboard)/item/item-dialog.tsx</files>
  <action>
Update the ItemDialog component to:

1. **Add price_reference to form state:**
   ```typescript
   const [formData, setFormData] = useState({
     name: "",
     category_id: "",
     price_reference: "",  // Add this
   });
   ```

2. **Update useEffect that sets form data from item:**
   ```typescript
   if (item) {
     setFormData({
       name: item.name || "",
       category_id: item.category_id || "",
       price_reference: item.price_reference || "",  // Add this
     });
     // ... rest of photo handling
   } else {
     setFormData({
       name: "",
       category_id: "",
       price_reference: "",  // Add this
     });
     // ... rest of photo handling
   }
   ```

3. **Add price reference input field after the Category field (before SKU display):**
   ```tsx
   {/* Price Reference */}
   <div className="grid gap-2">
     <Label htmlFor="price_reference">
       Price Reference <span className="text-red-400">*</span>
     </Label>
     <Input
       id="price_reference"
       value={formData.price_reference}
       onChange={(e) =>
         setFormData({ ...formData, price_reference: e.target.value })
       }
       placeholder="e.g., $50-75 retail, bulk discount available"
       maxLength={100}
       required
     />
     <p className="text-xs text-slate-400">
       {formData.price_reference.length}/100 characters - helps purchasing team
     </p>
   </div>
   ```

4. **Make category required - update Label:**
   Change the Category label from:
   ```tsx
   <Label>Category</Label>
   ```
   To:
   ```tsx
   <Label>
     Category <span className="text-red-400">*</span>
   </Label>
   ```

5. **Update submit button disabled state to require category and price_reference:**
   Change from:
   ```tsx
   disabled={isLoading || !formData.name}
   ```
   To:
   ```tsx
   disabled={isLoading || !formData.name || !formData.category_id || !formData.price_reference}
   ```

6. **Update data object in handleSubmit to include price_reference:**
   ```typescript
   const data = {
     name: formData.name,
     category_id: formData.category_id || null,  // This will now always have value for new items
     photo_url: photoUrl,
     price_reference: formData.price_reference || null,  // Add this
   };
   ```

7. **Update the SKU display section to show more prominently:**
   Change the SKU display section from showing "Product Code (SKU)" to just "Item Code" and make it more prominent:
   ```tsx
   {/* SKU (read-only, shown for existing items) */}
   {item?.sku && (
     <div className="grid gap-2">
       <Label>Item Code</Label>
       <div className="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700">
         <code className="text-lg font-mono font-semibold text-brand-400">
           {item.sku}
         </code>
       </div>
       <p className="text-xs text-slate-400">
         Auto-generated based on category
       </p>
     </div>
   )}
   ```

Note: Per user decision, category is now required for new items. Existing items without category can still be edited (the form allows saving without category for edit mode only).

For the submit button, adjust the logic to only require category for new items:
```tsx
disabled={isLoading || !formData.name || !formData.price_reference || (!item && !formData.category_id)}
```
  </action>
  <verify>
1. Run: `npm run type-check` - no TypeScript errors
2. Run: `npm run dev` and navigate to /item
3. Click "Add Item" - verify price reference field exists with 100 char counter
4. Verify category is marked as required with red asterisk
5. Try to submit without category or price reference - button should be disabled
6. Create a new item with category and price reference - verify it saves
7. Edit the item - verify SKU shows prominently, price reference is populated
  </verify>
  <done>
- ItemDialog has price_reference input field with 100 char limit and counter
- Category is marked as required for new items
- Submit button requires name, price_reference, and category (for new items)
- SKU displays prominently as "Item Code" in edit mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Item List page with price reference column and code-first display</name>
  <files>app/(dashboard)/item/page.tsx</files>
  <action>
Update the Items page to show price reference as a dedicated column and update SKU display.

1. **Update the select query to include price_reference:**
   Change:
   ```typescript
   .select(`
     id, name, sku, photo_url, category_id,
     category_rel:categories(id, name, color)
   `)
   ```
   To:
   ```typescript
   .select(`
     id, name, sku, photo_url, category_id, price_reference,
     category_rel:categories(id, name, color)
   `)
   ```

2. **Update ItemWithCategory interface:**
   The Item type already includes price_reference from the type update in Plan 01, but verify the extended interface still works.

3. **Reorder and update columns array:**
   The new column order should be: Photo, Code (SKU), Name, Price Reference, Category, Actions

   Update the columns definition:
   ```tsx
   const columns: ColumnDef<ItemWithCategory>[] = [
     {
       accessorKey: "photo_url",
       header: "Photo",
       cell: ({ row }) => {
         const photoUrl = row.getValue("photo_url") as string | null;
         return (
           <div className="relative w-10 h-10 rounded-lg overflow-hidden border border-slate-700 bg-slate-800/50 flex items-center justify-center">
             {photoUrl ? (
               <Image
                 src={photoUrl}
                 alt="Item"
                 fill
                 className="object-cover"
                 sizes="40px"
               />
             ) : (
               <ImageIcon className="h-4 w-4 text-slate-500" />
             )}
           </div>
         );
       },
     },
     {
       accessorKey: "sku",
       header: ({ column }) => (
         <DataTableColumnHeader column={column} title="Code" />
       ),
       cell: ({ row }) => (
         <code className="rounded bg-slate-800 px-2 py-1 text-sm font-mono font-semibold text-brand-400">
           {row.getValue("sku") || "---"}
         </code>
       ),
     },
     {
       accessorKey: "name",
       header: ({ column }) => (
         <DataTableColumnHeader column={column} title="Name" />
       ),
       cell: ({ row }) => (
         <div className="flex items-center gap-2">
           <Package className="h-4 w-4 text-slate-400" />
           <span className="font-medium text-slate-200">
             {row.getValue("name")}
           </span>
         </div>
       ),
     },
     {
       accessorKey: "price_reference",
       header: "Price Reference",
       cell: ({ row }) => {
         const ref = row.getValue("price_reference") as string | null;
         return ref ? (
           <span className="text-sm text-slate-300 truncate max-w-[200px] block" title={ref}>
             {ref}
           </span>
         ) : (
           <span className="text-slate-500">-</span>
         );
       },
     },
     {
       accessorKey: "category_rel",
       header: "Category",
       cell: ({ row }) => {
         const category = row.original.category_rel as Category | null;
         if (!category) {
           return <span className="text-slate-500">-</span>;
         }
         return (
           <Badge
             variant="outline"
             className="border-slate-600"
             style={{
               backgroundColor: `${category.color}20`,
               color: category.color || "#9CA3AF",
               borderColor: `${category.color}40`,
             }}
           >
             <Tag className="mr-1 h-3 w-3" />
             {category.name}
           </Badge>
         );
       },
     },
     {
       id: "actions",
       cell: ({ row }) => {
         const item = row.original;
         return (
           <DropdownMenu>
             <DropdownMenuTrigger asChild>
               <Button variant="ghost" className="h-8 w-8 p-0">
                 <span className="sr-only">Open menu</span>
                 <MoreHorizontal className="h-4 w-4" />
               </Button>
             </DropdownMenuTrigger>
             <DropdownMenuContent align="end">
               <DropdownMenuItem onClick={() => handleEdit(item)}>
                 <Pencil className="mr-2 h-4 w-4" />
                 Edit
               </DropdownMenuItem>
               <DropdownMenuItem
                 onClick={() => handleDelete(item.id)}
                 className="text-red-400 focus:text-red-400"
               >
                 <Trash2 className="mr-2 h-4 w-4" />
                 Delete
               </DropdownMenuItem>
             </DropdownMenuContent>
           </DropdownMenu>
         );
       },
     },
   ];
   ```

Key changes:
- Changed header from "SKU" to "Code"
- Made code display slightly larger (text-sm instead of text-xs) and bold
- Added price_reference column with truncation and native title tooltip
- Reordered columns: Photo, Code, Name, Price Reference, Category, Actions
  </action>
  <verify>
1. Run: `npm run type-check` - no TypeScript errors
2. Run: `npm run dev` and navigate to /item
3. Verify column order: Photo, Code, Name, Price Reference, Category, Actions
4. Verify Code column shows SKU-XXX-YYYY format prominently
5. Verify Price Reference column shows text with truncation
6. Hover over truncated price reference - verify native title tooltip shows full text
  </verify>
  <done>
- Item List page shows price_reference as dedicated column
- SKU displays as "Code" with prominent styling
- Column order is Photo, Code, Name, Price Reference, Category, Actions
- Long price references truncate with native title tooltip
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PO line item selector with tooltip and code-first display</name>
  <files>components/po/po-line-items-table.tsx</files>
  <action>
Update the EditableLineItemsTable component to show items with code-first format and display price reference as tooltip.

1. **Add Tooltip imports at the top:**
   ```typescript
   import {
     Tooltip,
     TooltipContent,
     TooltipProvider,
     TooltipTrigger,
   } from "@/components/ui/tooltip";
   ```

2. **Update the availableItems type in EditableLineItemsTableProps:**
   Change:
   ```typescript
   availableItems: Pick<Item, "id" | "name" | "sku" | "default_unit">[];
   ```
   To:
   ```typescript
   availableItems: Pick<Item, "id" | "name" | "sku" | "default_unit" | "price_reference">[];
   ```

3. **Wrap the SelectContent in TooltipProvider and update SelectItem display:**

   Find the Select component for item selection (in the `!item.item_id` branch) and update it:
   ```tsx
   <Select
     value=""
     onValueChange={(value) => {
       const selectedItem = availableItems.find(
         (i) => i.id === value
       );
       if (selectedItem) {
         onUpdateItem(item.id, "item_id", value);
         onUpdateItem(item.id, "item_name", selectedItem.name);
         onUpdateItem(item.id, "item_sku", selectedItem.sku || "");
         onUpdateItem(item.id, "item_unit", selectedItem.default_unit || "");
       }
     }}
     disabled={disabled}
   >
     <SelectTrigger className="w-full bg-slate-800 border-slate-700">
       <SelectValue placeholder="Select item..." />
     </SelectTrigger>
     <SelectContent>
       <TooltipProvider delayDuration={300}>
         {availableItems.map((avail) => (
           <Tooltip key={avail.id}>
             <TooltipTrigger asChild>
               <SelectItem value={avail.id} className="cursor-pointer">
                 <span className="flex items-center gap-2">
                   <code className="font-mono text-amber-400 text-xs">
                     {avail.sku || "---"}
                   </code>
                   <span className="text-slate-400">-</span>
                   <span>{avail.name}</span>
                 </span>
               </SelectItem>
             </TooltipTrigger>
             {avail.price_reference && (
               <TooltipContent side="right" className="max-w-xs">
                 <p className="text-xs">
                   <span className="text-slate-400">Price Ref: </span>
                   <span className="text-slate-200">{avail.price_reference}</span>
                 </p>
               </TooltipContent>
             )}
           </Tooltip>
         ))}
       </TooltipProvider>
     </SelectContent>
   </Select>
   ```

4. **Update the selected item display to show code-first format:**
   Find the display for when `item.item_id` is truthy and update:
   ```tsx
   {item.item_id ? (
     <div className="flex items-center gap-2">
       <div className="flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded text-sm">
         <code className="font-mono text-amber-400 mr-2">
           {item.item_sku || "---"}
         </code>
         <span className="text-slate-400 mr-2">-</span>
         <span className="text-slate-200">{item.item_name}</span>
       </div>
       <Button
         type="button"
         variant="ghost"
         size="sm"
         onClick={() => {
           onUpdateItem(item.id, "item_id", null);
           onUpdateItem(item.id, "item_name", "");
           onUpdateItem(item.id, "item_sku", "");
           onUpdateItem(item.id, "item_unit", "");
         }}
         disabled={disabled}
         className="h-8 px-2 text-slate-400 hover:text-slate-200"
       >
         Change
       </Button>
     </div>
   ) : (
   ```

5. **Update ReadonlyLineItemsTable to show code-first format:**
   In the readonly table, update the item display cell:
   ```tsx
   <td className="py-3 px-3">
     <div className="flex items-center gap-2">
       <div className="w-8 h-8 rounded bg-slate-700/50 flex items-center justify-center">
         <Package className="h-4 w-4 text-slate-400" />
       </div>
       <div>
         <div className="flex items-center gap-2">
           <code className="font-mono text-amber-400 text-xs">
             {item.item_sku || item.item?.sku || "---"}
           </code>
           <span className="text-slate-500">-</span>
           <span className="text-slate-200 font-medium">
             {item.item_name || item.item?.name || "Unknown Item"}
           </span>
         </div>
       </div>
     </div>
   </td>
   ```
   Remove the separate SKU code block that was below the name.
  </action>
  <verify>
1. Run: `npm run type-check` - no TypeScript errors
2. Run: `npm run dev`
3. Navigate to /po/new (or create new PO from QMHQ)
4. In line items table, click to select an item
5. Verify dropdown shows items in "SKU-XXX-YYYY - Item Name" format
6. Hover over an item with price reference - verify tooltip appears on right side
7. Select an item - verify selected display shows code-first format
8. Navigate to existing PO detail page - verify readonly table shows code-first format
  </verify>
  <done>
- PO line item selector shows items in code-first format (SKU - Name)
- Price reference displays as tooltip on hover when available
- Selected item display shows code prominently
- Readonly table also uses code-first format
  </done>
</task>

</tasks>

<verification>
1. Item Dialog: Create new item - price reference field exists and is required
2. Item Dialog: Edit existing item - price reference populated, SKU shows prominently
3. Item List: Price Reference column visible with truncation
4. Item List: Code column shows SKU-XXX-YYYY format prominently
5. PO Line Items: Select dropdown shows code-first format
6. PO Line Items: Tooltip shows price reference on hover
7. PO Line Items: Selected item displays code prominently
8. All pages: `npm run type-check` passes
</verification>

<success_criteria>
1. User can enter price reference note (max 100 chars) when creating/editing items
2. Category is required for new items (marked with red asterisk)
3. Price reference displays in Item List page as dedicated column
4. Price reference displays in PO line item selector as tooltip on hover
5. Item codes display in "SKU-XXX-YYYY - Name" format (code first) in:
   - Item List page Code column
   - PO line item selector dropdown
   - PO line item selected display
   - PO readonly line items table
6. SKU hidden during item creation, shown prominently after save
</success_criteria>

<output>
After completion, create `.planning/phases/21-item-enhancements/21-02-SUMMARY.md`
</output>
