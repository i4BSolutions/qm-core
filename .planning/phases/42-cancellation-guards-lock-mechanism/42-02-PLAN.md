---
phase: 42-cancellation-guards-lock-mechanism
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - app/(dashboard)/po/[id]/page.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
  - components/po/po-line-items-table.tsx
autonomous: true

must_haves:
  truths:
    - "Cancel PO button is disabled with tooltip when active invoices exist or PO is in terminal state"
    - "Void Invoice button is disabled with tooltip when stock-in exists or invoice is already voided"
    - "Closed PO hides Edit/Cancel buttons and shows admin Unlock button"
    - "Cancelled PO hides Edit/Cancel buttons (fully read-only)"
    - "Voided invoice hides Void button (fully read-only)"
    - "Admin unlock button calls unlockClosedPO and refreshes page"
    - "Per-line-item progress bars use stepped segment style following ItemsSummaryProgress pattern"
    - "PO cancel toast shows simple message (no cascade details)"
    - "Invoice void toast shows simple message (no cascade details)"
  artifacts:
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "PO detail with guard tooltips, read-only states, admin unlock, simplified toast"
      contains: "TooltipProvider"
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail with guard tooltips, read-only voided state, simplified toast"
      contains: "TooltipProvider"
    - path: "components/po/po-line-items-table.tsx"
      provides: "Stepped progress bars in ReadonlyLineItemsTable"
      contains: "POLineItemProgress"
  key_links:
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "lib/actions/po-actions.ts"
      via: "unlockClosedPO Server Action call"
      pattern: "unlockClosedPO"
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "components/ui/tooltip"
      via: "TooltipProvider for disabled button"
      pattern: "TooltipProvider"
    - from: "components/po/po-line-items-table.tsx"
      to: "lib/utils/po-status"
      via: "calculateLineItemProgress for bar data"
      pattern: "calculateLineItemProgress"
---

<objective>
Implement UI-level guard pre-checks with disabled button tooltips, enforce read-only terminal states for closed/cancelled POs and voided invoices, add admin unlock for closed POs, upgrade line item progress bars to stepped segment style, and simplify cascade toasts to simple confirmation messages.

Purpose: Provide clear visual feedback preventing invalid actions while maintaining audit trail visibility.
Output: Updated PO and Invoice detail pages with guard enforcement, updated line items table with styled progress bars.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-cancellation-guards-lock-mechanism/42-RESEARCH.md
@.planning/phases/42-cancellation-guards-lock-mechanism/42-01-SUMMARY.md
@app/(dashboard)/po/[id]/page.tsx
@app/(dashboard)/invoice/[id]/page.tsx
@components/po/po-line-items-table.tsx
@components/qmhq/items-summary-progress.tsx
@components/invoice/void-invoice-dialog.tsx
@lib/utils/po-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PO detail page -- guard tooltips, read-only states, admin unlock, simplified toast</name>
  <files>app/(dashboard)/po/[id]/page.tsx</files>
  <action>
Modify the PO detail page with the following changes:

**1. Import additions:**
- Add `Tooltip, TooltipContent, TooltipProvider, TooltipTrigger` from `@/components/ui/tooltip`
- Add `Unlock` (or `LockOpen`) from `lucide-react`
- Add `unlockClosedPO` from `@/lib/actions/po-actions`
- Add `canUnlockPO` from `@/lib/utils/po-status`

**2. Guard pre-check logic (add after progress calculation, around line 267):**

Replace the existing `showEditButton` and `showCancelButton` logic:

```typescript
const isTerminalState = po.status === 'cancelled' || po.status === 'closed';
const isClosed = po.status === 'closed';
const isCancelled = po.status === 'cancelled';
const isAdmin = can("delete", "purchase_orders"); // admin-only permission

// Check for active (non-voided) invoices for cancel guard
const hasActiveInvoices = invoices.some(inv => !inv.is_voided && inv.is_active !== false);

// Cancel button: visible to admins, disabled when dependencies exist or terminal state
const showCancelButton = isAdmin && !isCancelled;
const canCancelNow = !hasActiveInvoices && !isClosed && !isCancelled;

// Edit button: visible when user has update permission, hidden for terminal states
const showEditButton = can("update", "purchase_orders") && !isTerminalState;

// Unlock button: visible to admin when PO is closed
const showUnlockButton = isAdmin && isClosed;

// Tooltip reason for disabled cancel
const cancelDisabledReason = isClosed
  ? "Cannot cancel -- PO is closed"
  : hasActiveInvoices
  ? "Cannot cancel -- has active invoices"
  : "";
```

**3. Replace Cancel button in actions section (around line 324):**

Replace the plain Cancel button with a Tooltip-wrapped version. Follow the Phase 35 pattern (TooltipTrigger asChild > div > Button):

```tsx
{showCancelButton && (
  <TooltipProvider>
    <Tooltip>
      <TooltipTrigger asChild>
        <div>
          <Button
            variant="outline"
            onClick={() => setShowCancelDialog(true)}
            disabled={!canCancelNow}
            className="border-red-500/30 text-red-400 hover:bg-red-500/10"
          >
            <XCircle className="mr-2 h-4 w-4" />
            Cancel PO
          </Button>
        </div>
      </TooltipTrigger>
      {!canCancelNow && (
        <TooltipContent>
          <p className="text-xs">{cancelDisabledReason}</p>
        </TooltipContent>
      )}
    </Tooltip>
  </TooltipProvider>
)}
```

**4. Add Unlock button (after Cancel button in actions section):**

```tsx
{showUnlockButton && (
  <Button
    variant="outline"
    onClick={handleUnlockPO}
    disabled={isUnlocking}
    className="border-amber-500/30 text-amber-400 hover:bg-amber-500/10"
  >
    <LockOpen className="mr-2 h-4 w-4" />
    Unlock PO
  </Button>
)}
```

Add state and handler for unlock:
```typescript
const [isUnlocking, setIsUnlocking] = useState(false);

const handleUnlockPO = async () => {
  setIsUnlocking(true);
  const result = await unlockClosedPO(poId);
  if (result.success) {
    toast({
      title: "PO Unlocked",
      description: `${result.data.poNumber} unlocked for corrections`,
    });
    fetchData();
  } else {
    toast({
      title: "Unlock Failed",
      description: result.error,
      variant: "destructive",
    });
  }
  setIsUnlocking(false);
};
```

**5. Simplify cancel toast (around line 192-196):**

Replace the existing detailed cancel toast:
```typescript
// OLD:
// description: `${result.data.poNumber} cancelled. Budget released: ${result.data.releasedAmountEusd.toFixed(2)} EUSD to ${result.data.qmhqRequestId}. New Balance in Hand: ${result.data.newBalanceInHand.toFixed(2)} EUSD`,

// NEW (per user decision: simple toast, no cascade details):
toast({
  title: "PO Cancelled",
  description: `${result.data.poNumber} has been cancelled successfully`,
});
```

**6. Hide Create Invoice button for closed POs:**

The existing Invoices tab has a Create Invoice button conditioned on `canCreateInvoice()`. This function already excludes closed and cancelled. Verify it works -- no change needed, but confirm the condition at line 626.

**7. No changes to the cancel dialog** -- it already works correctly with textarea reason.
  </action>
  <verify>
Run `npm run type-check` -- no TypeScript errors. Run `npm run lint` -- no new lint errors. Verify imports compile correctly. Verify the tooltip pattern matches Phase 35 (TooltipTrigger asChild > div > Button).
  </verify>
  <done>
PO detail page has: Cancel button disabled with tooltip when dependencies exist. Unlock button visible to admin on closed POs. Edit/Cancel hidden for terminal states. Simple toast for cancel action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Invoice detail page -- void guard tooltip, read-only voided state, simplified toast</name>
  <files>app/(dashboard)/invoice/[id]/page.tsx</files>
  <action>
Modify the Invoice detail page with the following changes:

**1. Import additions:**
- Add `Tooltip, TooltipContent, TooltipProvider, TooltipTrigger` from `@/components/ui/tooltip`
- Add `usePermissions` from `@/lib/hooks/use-permissions` (if not already imported)

**2. Guard pre-check logic (add after the showVoidButton calculation, around line 281):**

Replace the current simple `showVoidButton` logic with guard-aware version:

```typescript
const isVoided = invoice.is_voided ?? false;
const hasStockIn = stockReceipts.length > 0;

// Void button: visible when invoice is not voided (shows disabled state with tooltip)
const showVoidButton = !isVoided;
const canVoidNow = !hasStockIn && !isVoided && canVoidInvoice(invoice.status as InvoiceStatus, isVoided);

// Tooltip reason for disabled void
const voidDisabledReason = hasStockIn
  ? "Cannot void -- goods received"
  : "";
```

Note: The existing `canVoidInvoice()` function checks status-based eligibility. We add the `hasStockIn` check on top of that for the UI pre-check (matching the database guard trigger).

**3. Replace Void button with Tooltip-wrapped version:**

Find the Void button in the actions section (around line 368) and replace:

```tsx
{showVoidButton && (
  <TooltipProvider>
    <Tooltip>
      <TooltipTrigger asChild>
        <div>
          <Button
            variant="outline"
            onClick={() => setShowVoidDialog(true)}
            disabled={!canVoidNow}
            className="border-red-500/30 text-red-400 hover:bg-red-500/10"
          >
            <Ban className="mr-2 h-4 w-4" />
            Void Invoice
          </Button>
        </div>
      </TooltipTrigger>
      {!canVoidNow && voidDisabledReason && (
        <TooltipContent>
          <p className="text-xs">{voidDisabledReason}</p>
        </TooltipContent>
      )}
    </Tooltip>
  </TooltipProvider>
)}
```

**4. Read-only enforcement for voided invoices:**

The page already has `showVoidButton` controlling void action visibility. Additionally:
- Check if there's an Edit button on the invoice detail page. If there is, hide it when `isVoided` is true.
- Look for any other action buttons and conditionally hide them when invoice is voided.

**5. Simplify void toast (around line 196-213):**

Replace the existing detailed void toast:

```typescript
// OLD: Shows PO status change and invoiced qty changes
// NEW (per user decision: simple toast):
toast({
  title: "Invoice Voided",
  description: `${data.invoiceNumber} has been voided successfully`,
});
```

Keep the error toast as-is (it's already simple).
  </action>
  <verify>
Run `npm run type-check` -- no TypeScript errors. Run `npm run lint` -- no new lint errors. Verify tooltip pattern matches Phase 35 pattern.
  </verify>
  <done>
Invoice detail page has: Void button disabled with tooltip when stock-in exists. Voided invoices are read-only with no action buttons. Simple toast for void action.
  </done>
</task>

<task type="auto">
  <name>Task 3: Upgrade ReadonlyLineItemsTable progress bars to stepped segment style</name>
  <files>components/po/po-line-items-table.tsx</files>
  <action>
Replace the existing MiniProgressBar-based progress column in ReadonlyLineItemsTable with a stepped segment bar following the ItemsSummaryProgress pattern from components/qmhq/items-summary-progress.tsx.

**Per user decision:** Progress bars go INSIDE the existing line items table as a column (not a separate tab). Use stacked segments style (ordered baseline gray, invoiced blue, received green). Follow the ItemsSummaryProgress pattern with fraction text header row and legend row with colored dots.

**1. Create POLineItemProgress inline component (or at top of file):**

```tsx
function POLineItemProgress({ ordered, invoiced, received }: {
  ordered: number;
  invoiced: number;
  received: number;
}) {
  const invoicedPercent = ordered > 0 ? Math.min(100, (invoiced / ordered) * 100) : 0;
  const receivedPercent = ordered > 0 ? Math.min(100, (received / ordered) * 100) : 0;

  return (
    <div className="space-y-1.5">
      {/* Header: fraction text */}
      <div className="flex items-center justify-between">
        <span className="text-xs text-slate-400">
          {received}/{ordered}
        </span>
      </div>

      {/* Stepped progress bar */}
      <div className="h-5 w-full bg-slate-800/50 rounded-md overflow-hidden relative">
        {/* Ordered baseline (full width, gray) */}
        <div
          className="absolute inset-y-0 left-0 bg-slate-600/30 transition-all duration-500"
          style={{ width: "100%" }}
        />
        {/* Invoiced segment (blue) */}
        <div
          className="absolute inset-y-0 left-0 bg-blue-500/40 transition-all duration-500"
          style={{ width: `${invoicedPercent}%` }}
        />
        {/* Received segment (green, overlays invoiced) */}
        <div
          className="absolute inset-y-0 left-0 bg-emerald-500 transition-all duration-500"
          style={{ width: `${receivedPercent}%` }}
        />
      </div>

      {/* Legend row with colored dots */}
      <div className="flex items-center gap-3 text-[10px]">
        <div className="flex items-center text-slate-400">
          <span className="w-1.5 h-1.5 rounded-full bg-slate-600 inline-block mr-1" />
          {ordered}
        </div>
        <div className="flex items-center text-blue-400">
          <span className="w-1.5 h-1.5 rounded-full bg-blue-500 inline-block mr-1" />
          {invoiced}
        </div>
        <div className="flex items-center text-emerald-400">
          <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 inline-block mr-1" />
          {received}
        </div>
      </div>
    </div>
  );
}
```

Use slightly smaller sizes (h-5 bar, text-[10px] legend) than ItemsSummaryProgress (h-6) since this is inside a table cell. Keep legend labels minimal (just numbers, not "Ordered: X") to fit in the column.

**2. Replace MiniProgressBar usage in ReadonlyLineItemsTable:**

In the progress column cell (around lines 406-431), replace the existing dual-track MiniProgressBar with POLineItemProgress:

```tsx
{showProgress && (
  <td className="py-3 px-3">
    <POLineItemProgress
      ordered={item.quantity}
      invoiced={item.invoiced_quantity ?? 0}
      received={item.received_quantity ?? 0}
    />
  </td>
)}
```

**3. Update column header:**

Change the Progress column header width from `w-40` to `w-44` to accommodate the legend row. Keep the text "Progress".

**4. Remove MiniProgressBar import if no longer used:**

Check if MiniProgressBar is imported at the top of the file. If it's only used in ReadonlyLineItemsTable, and this was the only usage, the import can stay (it may be used in EditableLineItemsTable or other places). Check first -- only remove if truly unused. The MiniProgressBar is imported from `./po-progress-bar`. Check if it's used elsewhere in this file. If used only in ReadonlyLineItemsTable, it's now replaced. But keep the import if EditableLineItemsTable or MiniProgressBar component itself may be used elsewhere. Actually, check: `import { MiniProgressBar } from "./po-progress-bar"` -- if this import is only used in ReadonlyLineItemsTable and we're replacing that usage, the import becomes unused. Remove it to avoid lint warnings. But the calculateLineItemProgress import from po-status should stay since POLineItemProgress doesn't use it directly (the data is passed in).

Actually, looking at the code, `calculateLineItemProgress` is called in ReadonlyLineItemsTable to compute `progress.invoicedPercent` etc. Since POLineItemProgress computes percentages internally from raw ordered/invoiced/received values, we no longer need `calculateLineItemProgress` in ReadonlyLineItemsTable. But check: is calculateLineItemProgress used elsewhere in this file (e.g., EditableLineItemsTable)? If not, remove the import. If yes, keep it.

Keep imports clean -- remove any newly-unused imports.
  </action>
  <verify>
Run `npm run type-check` -- no TypeScript errors. Run `npm run lint` -- no unused import warnings. Verify the POLineItemProgress component renders with the correct layered bar structure (gray baseline, blue invoiced overlay, green received overlay).
  </verify>
  <done>
ReadonlyLineItemsTable displays stepped segment progress bars per line item with fraction header and colored dot legend, matching the ItemsSummaryProgress pattern. Old MiniProgressBar pattern replaced.
  </done>
</task>

</tasks>

<verification>
1. PO Cancel button disabled with "Cannot cancel -- has active invoices" tooltip when invoices exist
2. PO Cancel button disabled with "Cannot cancel -- PO is closed" tooltip when PO is closed
3. PO Unlock button appears for admin users on closed POs
4. Clicking Unlock changes PO status and refreshes page
5. Edit button hidden for cancelled and closed POs
6. Invoice Void button disabled with "Cannot void -- goods received" tooltip when stock-in exists
7. Voided invoices show no action buttons
8. Cancel toast shows simple message: "[PO#] has been cancelled successfully"
9. Void toast shows simple message: "[INV#] has been voided successfully"
10. Line item progress bars show stepped segments with fraction header and legend
11. `npm run type-check` passes
12. `npm run lint` passes
</verification>

<success_criteria>
- Guard pre-checks enforce GARD-01 (UI-level disabled buttons with tooltips)
- Cancel button tooltip explains why action is blocked per GARD-02 (reason without counts)
- Terminal states (closed, cancelled, voided) are read-only per LOCK-01 and user decisions
- Admin unlock works for closed POs per LOCK-02
- Progress bars follow ItemsSummaryProgress pattern per POPR-01 and user decision
- Simple toast messages per user decision (no cascade details)
</success_criteria>

<output>
After completion, create `.planning/phases/42-cancellation-guards-lock-mechanism/42-02-SUMMARY.md`
</output>
