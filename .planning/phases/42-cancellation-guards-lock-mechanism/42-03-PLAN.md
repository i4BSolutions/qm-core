---
phase: 42-cancellation-guards-lock-mechanism
plan: 03
type: execute
wave: 3
depends_on: ["42-02"]
files_modified:
  - components/po/po-matching-tab.tsx
  - app/(dashboard)/po/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view Matching tab on PO detail with PO vs Invoice vs Stock-In comparison per line item"
    - "Under-invoiced and under-received items are highlighted with amber visual indicators"
    - "Fully matched items show green checkmark"
    - "Voided invoices are hidden by default in matching tab"
    - "User can toggle voided invoices visibility via checkbox"
    - "Voided invoices appear grayed out with VOID label when revealed"
  artifacts:
    - path: "components/po/po-matching-tab.tsx"
      provides: "PO matching comparison table component"
      exports: ["POMatchingTab"]
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "Matching tab integrated into PO detail tabs"
      contains: "POMatchingTab"
  key_links:
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "components/po/po-matching-tab.tsx"
      via: "import and render in Matching TabsContent"
      pattern: "POMatchingTab"
    - from: "components/po/po-matching-tab.tsx"
      to: "types/database"
      via: "POLineItem, Invoice, InvoiceLineItem types"
      pattern: "import type"
---

<objective>
Create a PO Matching tab component showing side-by-side comparison of ordered vs invoiced vs received quantities per line item, with mismatch highlighting and voided invoice toggle.

Purpose: Enable users to quickly identify discrepancies between PO expectations and actual invoiced/received quantities.
Output: New POMatchingTab component integrated into PO detail page.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-cancellation-guards-lock-mechanism/42-RESEARCH.md
@.planning/phases/42-cancellation-guards-lock-mechanism/42-02-SUMMARY.md
@app/(dashboard)/po/[id]/page.tsx
@components/po/po-line-items-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POMatchingTab component</name>
  <files>components/po/po-matching-tab.tsx</files>
  <action>
Create a new component `components/po/po-matching-tab.tsx` that displays a matching comparison table.

**Per user decision:** Layout is Claude's discretion. Using single table approach (recommended in research) for scannability. Mismatch highlighting is Claude's discretion -- using amber text + warning icon for under-invoiced/under-received, green checkmark for fully matched.

**Component interface:**

```typescript
"use client";

import { useState } from "react";
import { CheckCircle2, AlertTriangle, Package } from "lucide-react";
import { cn } from "@/lib/utils";
import type { POLineItem, Item, Invoice, InvoiceLineItem } from "@/types/database";

interface MatchingLineItem {
  id: string;
  itemId: string | null;
  itemName: string;
  itemSku: string | null;
  ordered: number;
  invoiced: number;
  received: number;
  unit: string | null;
}

interface InvoiceForMatching {
  id: string;
  invoice_number: string;
  is_voided: boolean;
  line_items: {
    item_id: string | null;
    po_line_item_id: string | null;
    quantity: number;
  }[];
}

interface POMatchingTabProps {
  lineItems: (POLineItem & { item?: Pick<Item, "id" | "name" | "sku"> | null })[];
  invoices: (Invoice & {
    invoice_line_items?: (InvoiceLineItem & { item?: Pick<Item, "id" | "name" | "sku"> | null })[];
  })[];
}
```

Actually, the invoices data may not have line items pre-loaded. The PO detail page currently only fetches invoices without their line items. The matching tab needs invoice line items to aggregate per-PO-line.

**Two approaches:**
A) Fetch invoice line items in the component (client-side query)
B) Use the existing po_line_items.invoiced_quantity and received_quantity fields (already aggregated by DB triggers)

**Choose approach B** -- the po_line_items already track invoiced_quantity and received_quantity as maintained by database triggers. The matching tab can use these aggregates directly from the lineItems prop. For the per-invoice breakdown, we need invoice line items. But the core matching table (POPR-02) is "PO vs Invoice vs Stock-In comparison per line item" -- this matches the aggregated data already in po_line_items.

For showing which invoices contributed to each line item, we can add a detail expansion. But the primary table is the aggregate view using existing data.

**For voided invoice display (INVV-07):** The invoices list is already fetched on PO detail page. We need invoice-level display (showing which invoices are voided), not line-item breakdown. Show a separate section below the matching table listing invoices with their void status.

**Revised approach:**

The matching table has TWO sections:
1. **Line Item Matching Table:** Shows each PO line item with ordered/invoiced/received from po_line_items fields + variance column + match status icon
2. **Invoice Summary:** Below the table, shows list of invoices linked to this PO with status/void badges. Voided invoices hidden by default with toggle.

**Component structure:**

```tsx
export function POMatchingTab({ lineItems, invoices }: POMatchingTabProps) {
  const [showVoided, setShowVoided] = useState(false);

  // Filter invoices
  const visibleInvoices = showVoided
    ? invoices
    : invoices.filter(inv => !inv.is_voided);

  const voidedCount = invoices.filter(inv => inv.is_voided).length;

  // Compute matching data from po_line_items (already has invoiced_quantity, received_quantity)
  const matchingData: MatchingLineItem[] = lineItems.map(li => ({
    id: li.id,
    itemId: li.item_id,
    itemName: li.item_name || li.item?.name || "Unknown Item",
    itemSku: li.item_sku || li.item?.sku || null,
    ordered: li.quantity,
    invoiced: li.invoiced_quantity ?? 0,
    received: li.received_quantity ?? 0,
    unit: li.item_unit || null,
  }));

  return (
    <div className="space-y-6">
      {/* Line Item Matching Table */}
      <div>
        <h3 className="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">
          Line Item Matching
        </h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-slate-700">
                <th className="text-left py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400">Item</th>
                <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-20">Ordered</th>
                <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-20">Invoiced</th>
                <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-20">Received</th>
                <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-24">Inv Variance</th>
                <th className="text-right py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-24">Rcv Variance</th>
                <th className="text-center py-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-400 w-16">Status</th>
              </tr>
            </thead>
            <tbody>
              {matchingData.map(row => {
                const invVariance = row.invoiced - row.ordered;
                const rcvVariance = row.received - row.ordered;
                const isFullyMatched = row.ordered === row.invoiced && row.ordered === row.received;
                const isUnderInvoiced = row.invoiced < row.ordered;
                const isUnderReceived = row.received < row.ordered;

                return (
                  <tr key={row.id} className="border-b border-slate-700/50 hover:bg-slate-800/30">
                    <td className="py-3 px-3">
                      <div className="flex items-center gap-2">
                        <div className="w-7 h-7 rounded bg-slate-700/50 flex items-center justify-center">
                          <Package className="h-3.5 w-3.5 text-slate-400" />
                        </div>
                        <div className="flex items-center gap-2">
                          {row.itemSku && (
                            <code className="font-mono text-amber-400 text-xs">{row.itemSku}</code>
                          )}
                          <span className="text-slate-200 text-sm">{row.itemName}</span>
                        </div>
                      </div>
                    </td>
                    <td className="py-3 px-3 text-right">
                      <span className="font-mono text-slate-200">{row.ordered}</span>
                      {row.unit && <span className="text-xs text-slate-400 ml-1">{row.unit}</span>}
                    </td>
                    <td className={cn(
                      "py-3 px-3 text-right font-mono",
                      isUnderInvoiced ? "text-amber-400" : "text-slate-200"
                    )}>
                      {row.invoiced}
                    </td>
                    <td className={cn(
                      "py-3 px-3 text-right font-mono",
                      isUnderReceived ? "text-amber-400" : "text-slate-200"
                    )}>
                      {row.received}
                    </td>
                    <td className="py-3 px-3 text-right">
                      {invVariance !== 0 && (
                        <span className={cn(
                          "font-mono text-sm",
                          invVariance < 0 ? "text-amber-400" : "text-emerald-400"
                        )}>
                          {invVariance > 0 ? "+" : ""}{invVariance}
                        </span>
                      )}
                    </td>
                    <td className="py-3 px-3 text-right">
                      {rcvVariance !== 0 && (
                        <span className={cn(
                          "font-mono text-sm",
                          rcvVariance < 0 ? "text-amber-400" : "text-emerald-400"
                        )}>
                          {rcvVariance > 0 ? "+" : ""}{rcvVariance}
                        </span>
                      )}
                    </td>
                    <td className="py-3 px-3 text-center">
                      {isFullyMatched ? (
                        <CheckCircle2 className="h-4 w-4 text-emerald-400 inline-block" />
                      ) : (
                        <AlertTriangle className="h-4 w-4 text-amber-400 inline-block" />
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
            {/* Summary footer */}
            <tfoot>
              <tr className="border-t border-slate-600">
                <td className="py-3 px-3 text-sm font-semibold text-slate-300 uppercase tracking-wider">
                  Total
                </td>
                <td className="py-3 px-3 text-right font-mono font-bold text-slate-200">
                  {matchingData.reduce((s, r) => s + r.ordered, 0)}
                </td>
                <td className="py-3 px-3 text-right font-mono font-bold text-slate-200">
                  {matchingData.reduce((s, r) => s + r.invoiced, 0)}
                </td>
                <td className="py-3 px-3 text-right font-mono font-bold text-slate-200">
                  {matchingData.reduce((s, r) => s + r.received, 0)}
                </td>
                <td colSpan={3}></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      {/* Invoice Summary with voided toggle */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-sm font-semibold text-slate-300 uppercase tracking-wider">
            Linked Invoices
          </h3>
          {voidedCount > 0 && (
            <label className="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
              <input
                type="checkbox"
                checked={showVoided}
                onChange={(e) => setShowVoided(e.target.checked)}
                className="rounded border-slate-700 bg-slate-800 text-amber-500 focus:ring-amber-500/30"
              />
              Show voided ({voidedCount})
            </label>
          )}
        </div>

        <div className="space-y-2">
          {visibleInvoices.length === 0 ? (
            <p className="text-sm text-slate-400 py-4 text-center">No invoices linked to this PO</p>
          ) : (
            visibleInvoices.map(inv => (
              <div
                key={inv.id}
                className={cn(
                  "flex items-center justify-between p-3 rounded-lg border",
                  inv.is_voided
                    ? "border-slate-700/50 bg-slate-800/20 opacity-60"
                    : "border-slate-700 bg-slate-800/30"
                )}
              >
                <div className="flex items-center gap-3">
                  <code className={cn(
                    "text-sm",
                    inv.is_voided ? "text-slate-500 line-through" : "text-amber-400"
                  )}>
                    {inv.invoice_number}
                  </code>
                  {inv.is_voided && (
                    <span className="px-1.5 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider bg-red-500/20 text-red-400 border border-red-500/30">
                      VOID
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-slate-400">
                    {inv.supplier_invoice_no || "â€”"}
                  </span>
                  <span className="font-mono text-emerald-400">
                    {formatCurrency(inv.total_amount_eusd ?? 0)} EUSD
                  </span>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}
```

Import `formatCurrency` from `@/lib/utils`.

The component is "use client" since it manages showVoided state.

Export the component as named export.
  </action>
  <verify>
Run `npm run type-check` -- no TypeScript errors. Run `npm run lint` -- no lint errors. Verify component accepts the correct props matching what PO detail page can provide.
  </verify>
  <done>
POMatchingTab component exists with: matching table showing ordered/invoiced/received per line item, variance columns, match status icons (green check / amber warning), invoice summary with voided toggle, voided invoices hidden by default with VOID badge when revealed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Matching tab into PO detail page</name>
  <files>app/(dashboard)/po/[id]/page.tsx</files>
  <action>
Add the Matching tab to the PO detail page tabs.

**1. Import POMatchingTab:**
```typescript
import { POMatchingTab } from "@/components/po/po-matching-tab";
```

**2. Add Matching tab trigger (after Invoices tab, before History tab, around line 398-404):**

Insert a new TabsTrigger between Invoices and History:
```tsx
<TabsTrigger value="matching" className="data-[state=active]:bg-amber-500/20 data-[state=active]:text-amber-400">
  Matching
</TabsTrigger>
```

**3. Add Matching TabsContent (after Invoices TabsContent, before History TabsContent, around line 718-719):**

```tsx
{/* Matching Tab */}
<TabsContent value="matching" className="mt-6">
  <div className="command-panel corner-accents">
    <POMatchingTab
      lineItems={lineItems}
      invoices={invoices}
    />
  </div>
</TabsContent>
```

**4. Verify invoice type compatibility:**

The POMatchingTab expects invoices with certain fields. The current `InvoiceForPO` type on the PO detail page extends Invoice with optional `line_items_count`. The matching tab only uses fields from the base Invoice type (id, invoice_number, is_voided, supplier_invoice_no, total_amount_eusd). Verify the type is compatible -- it should be since InvoiceForPO extends Invoice.

If there's a type mismatch, adjust the POMatchingTab props type to accept the Invoice base type (which has all needed fields) or use a looser type.

No other changes needed -- the matching tab uses the existing lineItems and invoices state that are already fetched.
  </action>
  <verify>
Run `npm run type-check` -- no TypeScript errors. Run `npm run lint` -- no lint errors. Verify the Matching tab appears in the tabs list and renders the POMatchingTab component.
  </verify>
  <done>
PO detail page has a Matching tab that renders POMatchingTab with line items and invoices data. Tab appears between Invoices and History tabs.
  </done>
</task>

</tasks>

<verification>
1. Matching tab appears in PO detail page tabs
2. Matching table shows each line item with ordered/invoiced/received columns
3. Under-invoiced items have amber text on invoiced column
4. Under-received items have amber text on received column
5. Fully matched items show green checkmark icon
6. Variance columns show negative amounts in amber, positive in green
7. Invoice summary shows linked invoices with amount
8. Voided invoices hidden by default
9. Toggle checkbox reveals voided invoices with VOID badge and grayed-out styling
10. Voided invoices show strikethrough on invoice number
11. `npm run type-check` passes
12. `npm run lint` passes
</verification>

<success_criteria>
- POPR-02: Matching tab with side-by-side PO vs Invoice vs Stock-In comparison per line item
- POPR-03: Mismatch highlighting with amber indicators for under-invoiced/under-received
- INVV-07: Voided invoices appear grayed out with VOID label, hidden by default with toggle
- Component is reusable and accepts standard PO data types
</success_criteria>

<output>
After completion, create `.planning/phases/42-cancellation-guards-lock-mechanism/42-03-SUMMARY.md`
</output>
