---
phase: 47-schema-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260214200000_standard_unit_columns.sql
  - types/database.ts
autonomous: true

must_haves:
  truths:
    - "PO line items store conversion_rate and standard_qty columns"
    - "Invoice line items store conversion_rate and standard_qty columns"
    - "Inventory transactions store conversion_rate and standard_qty columns"
    - "Stock-out line items store conversion_rate and standard_qty columns"
    - "All existing records have conversion_rate = 1 and standard_qty = their original quantity"
    - "New records require conversion_rate (NOT NULL constraint enforced)"
    - "standard_qty is auto-calculated as qty * conversion_rate via generated column"
  artifacts:
    - path: "supabase/migrations/20260214200000_standard_unit_columns.sql"
      provides: "Schema migration for 4 tables with backfill"
      contains: "conversion_rate"
    - path: "types/database.ts"
      provides: "TypeScript types matching new schema"
      contains: "conversion_rate"
  key_links:
    - from: "supabase/migrations/20260214200000_standard_unit_columns.sql"
      to: "types/database.ts"
      via: "TypeScript types match DB columns"
      pattern: "conversion_rate.*number"
---

<objective>
Add conversion_rate and standard_qty columns to all 4 quantity-bearing transaction tables, backfill existing data with conversion_rate = 1, and update TypeScript types.

Purpose: Establishes the database foundation for the Standard Unit System (v1.11). All subsequent phases (input components, display components) depend on these columns existing.

Output: One migration file adding columns to 4 tables with backfill, and updated TypeScript types.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/016_po_line_items.sql
@supabase/migrations/022_invoice_line_items.sql
@supabase/migrations/023_inventory_transactions.sql
@supabase/migrations/052_stock_out_requests.sql
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration adding conversion_rate and standard_qty to 4 tables</name>
  <files>supabase/migrations/20260214200000_standard_unit_columns.sql</files>
  <action>
Create a single migration file that adds `conversion_rate` and `standard_qty` columns to all 4 tables. The migration must follow this exact sequence for each table to handle the NOT NULL constraint on existing data:

**For each of the 4 tables, repeat the pattern:**

1. **po_line_items:**
   - Add `conversion_rate DECIMAL(10,4)` as nullable first
   - Backfill all existing rows: `UPDATE po_line_items SET conversion_rate = 1.0000 WHERE conversion_rate IS NULL;`
   - Add NOT NULL constraint: `ALTER TABLE po_line_items ALTER COLUMN conversion_rate SET NOT NULL;`
   - Add CHECK constraint: `ALTER TABLE po_line_items ADD CONSTRAINT po_line_items_conversion_rate_positive CHECK (conversion_rate > 0);`
   - Add generated column: `ALTER TABLE po_line_items ADD COLUMN standard_qty DECIMAL(15,2) GENERATED ALWAYS AS (ROUND(quantity * conversion_rate, 2)) STORED;`
   - Add comment on both columns

2. **invoice_line_items:**
   - Same pattern as above but column names reference `quantity` field
   - Constraint name: `invoice_line_items_conversion_rate_positive`
   - Generated column: `standard_qty DECIMAL(15,2) GENERATED ALWAYS AS (ROUND(quantity * conversion_rate, 2)) STORED`

3. **inventory_transactions:**
   - Same pattern, referencing `quantity` field
   - Constraint name: `inventory_transactions_conversion_rate_positive`
   - Generated column: `standard_qty DECIMAL(15,2) GENERATED ALWAYS AS (ROUND(quantity * conversion_rate, 2)) STORED`

4. **stock_out_line_items:**
   - Same pattern but referencing `requested_quantity` field (NOT `quantity`)
   - Constraint name: `stock_out_line_items_conversion_rate_positive`
   - Generated column: `standard_qty DECIMAL(15,2) GENERATED ALWAYS AS (ROUND(requested_quantity * conversion_rate, 2)) STORED`

**Important implementation notes:**
- Use multiplication formula per user decision: `standard_qty = qty * conversion_rate` (NOT division)
- ROUND to 2 decimal places to match DECIMAL(15,2)
- conversion_rate uses DECIMAL(10,4) to mirror the exchange_rate pattern already used in inventory_transactions
- Add clear section comments (e.g., `-- ============================================================================`) between each table's changes for readability
- Add table-level COMMENTs for the new columns explaining their purpose
- Do NOT touch any triggers or functions -- just add columns
  </action>
  <verify>
Run `npx supabase db reset` in the project root to verify the migration applies cleanly against all existing migrations. Expected: no errors, database resets successfully with the new columns present.

Then verify columns exist:
```bash
npx supabase db reset 2>&1 | tail -5
```
  </verify>
  <done>
All 4 tables have conversion_rate (NOT NULL, DECIMAL(10,4), CHECK > 0) and standard_qty (generated column, DECIMAL(15,2)) columns. Existing rows have conversion_rate = 1.0000 and standard_qty = their original quantity value.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types to include conversion_rate and standard_qty</name>
  <files>types/database.ts</files>
  <action>
Update the TypeScript type definitions in `types/database.ts` to include the new columns for all 4 tables. Follow the existing patterns in the file exactly.

**po_line_items** (around line 1315):
- Row: Add `conversion_rate: number` and `standard_qty: number | null` (generated columns are nullable in TS types since they're computed)
- Insert: Add `conversion_rate: number` (required, no `?` -- matches NOT NULL)
- Update: Add `conversion_rate?: number` (optional on update)
- Do NOT add `standard_qty` to Insert or Update (it's a generated column, cannot be set)

**invoice_line_items** (around line 1484):
- Row: Add `conversion_rate: number` and `standard_qty: number | null`
- Insert: Add `conversion_rate: number` (required)
- Update: Add `conversion_rate?: number`

**inventory_transactions** (around line 1561):
- Row: Add `conversion_rate: number` and `standard_qty: number | null`
- Insert: Add `conversion_rate: number` (required -- note: this differs from the existing `exchange_rate` which is optional because it has a DEFAULT; conversion_rate has no default per user decision)
- Update: Add `conversion_rate?: number`

**stock_out_line_items** (around line 589):
- Row: Add `conversion_rate: number` and `standard_qty: number | null`
- Insert: Add `conversion_rate: number` (required)
- Update: Add `conversion_rate?: number`

**Placement:** Add the new fields after the existing quantity-related fields in each table to maintain logical grouping. Specifically:
- po_line_items: after `unit_price` / `total_price` line
- invoice_line_items: after `total_price` line
- inventory_transactions: after `quantity` line
- stock_out_line_items: after `requested_quantity` line
  </action>
  <verify>
Run `npm run type-check` to verify TypeScript compilation passes with the new types. No type errors should appear.
  </verify>
  <done>
All 4 table types in `types/database.ts` include `conversion_rate` and `standard_qty` fields with correct nullability and optionality matching the database schema. TypeScript type-check passes.
  </done>
</task>

</tasks>

<verification>
1. Migration applies cleanly: `npx supabase db reset` completes without errors
2. TypeScript compiles: `npm run type-check` passes
3. Column verification (via psql or Supabase Studio): All 4 tables show conversion_rate and standard_qty columns
4. Backfill verification: Existing records have conversion_rate = 1.0000 and standard_qty equals their original quantity
5. NOT NULL enforcement: Attempting to insert a row without conversion_rate fails
6. Generated column works: Inserting a row with conversion_rate = 2.5 and quantity = 10 produces standard_qty = 25.00
</verification>

<success_criteria>
- Migration file exists at `supabase/migrations/20260214200000_standard_unit_columns.sql`
- `npx supabase db reset` succeeds with no errors
- `npm run type-check` passes
- 4 tables have `conversion_rate DECIMAL(10,4) NOT NULL CHECK (> 0)` column
- 4 tables have `standard_qty DECIMAL(15,2) GENERATED ALWAYS AS (qty * conversion_rate)` column
- All existing rows backfilled with `conversion_rate = 1.0000`
</success_criteria>

<output>
After completion, create `.planning/phases/47-schema-data-foundation/47-01-SUMMARY.md`
</output>
