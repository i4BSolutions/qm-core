---
phase: 35-per-line-item-execution-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - components/stock-out-requests/execution-confirmation-dialog.tsx
  - components/stock-out-requests/execution-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Each approved line item in the Approvals tab has its own Execute button"
    - "Executing one line item changes only that line's status, other approved items remain unchanged"
    - "Execute button is disabled (not hidden) when stock is insufficient, with tooltip showing available vs needed qty"
    - "Confirmation dialog shows item name, quantity, and source warehouse before execution"
    - "Old request-level Execute button is removed (clean break)"
    - "After execution, parent request status auto-refreshes on the same page"
    - "BroadcastChannel message is sent after successful execution for cross-tab sync"
  artifacts:
    - path: "components/stock-out-requests/execution-confirmation-dialog.tsx"
      provides: "Minimal confirmation dialog for per-line-item execution"
      contains: "ExecutionConfirmationDialog"
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "Refactored approval detail page with per-approval Execute buttons"
      contains: "handleExecuteApproval"
  key_links:
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "components/stock-out-requests/execution-confirmation-dialog.tsx"
      via: "import and render"
      pattern: "ExecutionConfirmationDialog"
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "BroadcastChannel"
      via: "postMessage after execution"
      pattern: "qm-stock-out-execution"
---

<objective>
Replace the whole-request execution pattern with per-line-item execution from the approval detail page. Each approved stock-out approval gets its own Execute button with stock pre-check, confirmation dialog, optimistic update, and cross-tab broadcast.

Purpose: Enables granular fulfillment -- users can execute individual approvals independently instead of being forced to execute everything at once. This directly implements EXEC-01 and EXEC-02 requirements.

Output: Refactored SOR detail page with per-approval Execute buttons, new minimal confirmation dialog, removed old ExecutionDialog.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@components/stock-out-requests/execution-dialog.tsx
@components/stock-out-requests/line-item-table.tsx
@components/stock-out-requests/approval-dialog.tsx
@components/providers/auth-provider.tsx
@supabase/migrations/059_row_lock_status_aggregation.sql
@supabase/migrations/053_stock_out_validation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExecutionConfirmationDialog and refactor SOR detail page for per-approval execution</name>
  <files>
    components/stock-out-requests/execution-confirmation-dialog.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
    components/stock-out-requests/execution-dialog.tsx
  </files>
  <action>
**1. Create `components/stock-out-requests/execution-confirmation-dialog.tsx`**

Create a minimal confirmation dialog component with these props:
- `open: boolean`, `onOpenChange: (open: boolean) => void`
- `itemName: string`, `quantity: number`, `warehouseName: string`
- `onConfirm: () => void`, `isExecuting: boolean`

Content: Dialog with DialogHeader "Execute Stock-Out", three detail fields (Item, Quantity, Warehouse) rendered as label/value pairs, an amber warning banner "This action is permanent. Stock-out transactions cannot be voided.", and footer with Cancel + "Confirm Execution" (emerald-600) buttons. Use the existing shadcn Dialog, Button, and lucide AlertTriangle/CheckCircle2 icons. Button shows Loader2 spinner when `isExecuting` is true.

**2. Refactor the SOR detail page Approvals tab**

In `app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx`:

a) **Remove old execution state and imports:**
- Remove `import { ExecutionDialog }` and the `<ExecutionDialog>` component render
- Remove `executingApprovalId`, `executingApprovalNumber`, `isExecutionDialogOpen` state variables
- Remove `approvalPendingStatus` state and the loop that checks pending transactions (lines ~307-322)
- Keep the `inventoryTransactions` state since the Transactions tab still uses it

b) **Add new state for per-approval execution:**
```tsx
const [executionDialogState, setExecutionDialogState] = useState<{
  open: boolean;
  approvalId: string;
  itemName: string;
  quantity: number;
  warehouseName: string;
} | null>(null);
const [isExecuting, setIsExecuting] = useState(false);
const [optimisticExecutedIds, setOptimisticExecutedIds] = useState<Set<string>>(new Set());
const [approvalStockLevels, setApprovalStockLevels] = useState<Map<string, { available: number; needed: number }>>(new Map());
```

c) **Add stock availability check after fetching approvals:**
After fetching approvals and inventory transactions in `fetchData`, calculate stock availability for each approved approval. For each approval with `decision === 'approved'`:
- Check if a completed inventory_transaction exists with `stock_out_approval_id = approval.id` -- if yes, this approval is already executed
- For not-yet-executed approvals, look up the approval's line_item to get `item_id`, then find the warehouse from existing inventory_transactions where `stock_out_approval_id = approval.id` (status=pending), or from the approval data itself
- Calculate available stock for that warehouse+item combination by summing completed inventory_transactions (in minus out)
- Store as `Map<approvalId, { available: number, needed: number }>`

Important: Extend the approvals query to also fetch warehouse info. Modify the approvals fetch to include the inventory_transactions linked to each approval:
```tsx
// After fetching approvals, also get linked transactions per approval
const approvalIds = (approvalsData || []).filter((a: any) => a.decision === 'approved').map((a: any) => a.id);
if (approvalIds.length > 0) {
  const { data: approvalTxData } = await supabase
    .from('inventory_transactions')
    .select('id, stock_out_approval_id, item_id, warehouse_id, quantity, status, movement_type, warehouses!inventory_transactions_warehouse_id_fkey(id, name)')
    .in('stock_out_approval_id', approvalIds)
    .eq('is_active', true);
  // Build stock levels map from this data
}
```

d) **Add `handleExecuteApproval` function:**
- Takes `approvalId: string`
- Finds the approval from the approvals list
- Gets stock info from `approvalStockLevels`
- Opens the confirmation dialog by setting `executionDialogState`

e) **Add `confirmExecution` function:**
- Sets `isExecuting = true`
- Adds approvalId to `optimisticExecutedIds` set immediately (optimistic update)
- Calls supabase to update the pending inventory_transaction for this approval to `status: 'completed'` and `transaction_date: new Date().toISOString()`
- On success: show toast.success, broadcast via BroadcastChannel('qm-stock-out-execution') with `{ type: 'APPROVAL_EXECUTED', approvalId, requestId, qmhqId: request.qmhq_id }`, close dialog, refetch data
- On error: remove approvalId from `optimisticExecutedIds` (rollback), show toast.error

f) **Add BroadcastChannel listener in a useEffect:**
Listen on `qm-stock-out-execution` channel. When receiving `APPROVAL_EXECUTED` message with matching `requestId`, re-check stock levels and refetch data. Use try/catch for Safari fallback.

g) **Refactor the Approvals tab rendering:**
For each approval card in the approvals list, determine execution state:
- `isExecuted`: Check if a completed inventory_transaction exists for this approval (from fetched `inventoryTransactions`) OR if `optimisticExecutedIds.has(approval.id)`
- `isRejected`: `approval.decision === 'rejected'`
- `stockInfo`: from `approvalStockLevels.get(approval.id)`
- `hasInsufficientStock`: `stockInfo && stockInfo.available < stockInfo.needed`

Replace the old `canExecute && hasPendingExecution` button with new button states per user decision:
- If `approval.decision === 'approved'` AND `isExecuted`: Show gray Badge "Executed" (bg-slate-500/10 text-slate-400)
- If `approval.decision === 'approved'` AND NOT executed: Show green "Execute" Button (bg-emerald-600). Disabled when `hasInsufficientStock` or `isExecuting`. Wrap in Tooltip from shadcn that shows "Insufficient stock: Need {needed}, Available: {available}" when insufficient.
- If `approval.decision === 'rejected'`: Show red Badge "Rejected" (bg-red-500/10 text-red-400)

Import Tooltip, TooltipContent, TooltipProvider, TooltipTrigger from '@/components/ui/tooltip'. Wrap the entire approvals list in a single `<TooltipProvider>`.

h) **Update REQUEST_STATUS_CONFIG** to use "Partially Fulfilled" label for `partially_executed` status (per user decision). Keep the purple color. Also update `executed` label to "Fulfilled".

**3. Delete the old ExecutionDialog content but keep the file as a redirect:**
Actually, just delete the import and usage of ExecutionDialog from the page. The file `execution-dialog.tsx` can be left as-is since deleting unused files is optional. But remove ALL references to it from the page.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors
2. Run `npm run lint` -- no lint errors
3. Run `npm run build` -- builds successfully
4. Verify the old ExecutionDialog import is removed from the SOR detail page
5. Verify ExecutionConfirmationDialog is imported and rendered
6. Grep for `hasPendingExecution` in the page -- should not exist
7. Grep for `ExecutionConfirmationDialog` in the page -- should exist
8. Grep for `qm-stock-out-execution` BroadcastChannel in the page -- should exist
  </verify>
  <done>
- Each approved approval in the Approvals tab has its own Execute button (green) or Executed badge (gray) or Rejected badge (red)
- Execute button is disabled with tooltip when stock is insufficient
- Clicking Execute opens a minimal confirmation dialog showing item name, qty, warehouse
- Confirming execution updates transaction status to completed, shows success toast, broadcasts to other tabs
- Optimistic update immediately shows Executed badge, rolls back on error
- Parent request status auto-refreshes after execution via refetch
- Old request-level ExecutionDialog is removed from the page
- REQUEST_STATUS_CONFIG shows "Partially Fulfilled" for partially_executed, "Fulfilled" for executed
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. ExecutionConfirmationDialog exists at components/stock-out-requests/execution-confirmation-dialog.tsx
4. SOR detail page no longer imports or renders ExecutionDialog
5. SOR detail page renders per-approval Execute buttons in Approvals tab
6. BroadcastChannel 'qm-stock-out-execution' is used for cross-tab sync
7. Optimistic update pattern (optimisticExecutedIds Set) is implemented
8. Stock availability pre-check disables button when insufficient
</verification>

<success_criteria>
- Each approved line item has its own Execute button (EXEC-01)
- Executing one line item does not affect other approved items (EXEC-02)
- Confirmation dialog shows item name, quantity, source warehouse
- Execute button disabled with tooltip when stock insufficient
- Cross-tab broadcast sent after execution
- Old request-level execution pattern removed
</success_criteria>

<output>
After completion, create `.planning/phases/35-per-line-item-execution-ui/35-01-SUMMARY.md`
</output>
