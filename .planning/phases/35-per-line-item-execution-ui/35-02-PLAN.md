---
phase: 35-per-line-item-execution-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/fulfillment-metrics.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMHQ item detail shows requested qty (sum of SOR line items)"
    - "QMHQ item detail shows approved qty (sum of approved approvals)"
    - "QMHQ item detail shows rejected qty (sum of rejected approvals)"
    - "QMHQ item detail shows executed/fulfilled qty (sum of completed stock-out transactions)"
    - "When no SOR linked, shows empty state message 'No stock-out request linked'"
    - "Cross-tab sync updates metrics when execution happens on another tab"
    - "Fulfillment section is positioned below item details, above SOR transaction groups"
  artifacts:
    - path: "components/qmhq/fulfillment-metrics.tsx"
      provides: "Fulfillment metrics display component"
      contains: "FulfillmentMetrics"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail page with Fulfillment section"
      contains: "FulfillmentMetrics"
  key_links:
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/qmhq/fulfillment-metrics.tsx"
      via: "import and render in details tab"
      pattern: "FulfillmentMetrics"
    - from: "components/qmhq/fulfillment-metrics.tsx"
      to: "BroadcastChannel"
      via: "listener for cross-tab execution events"
      pattern: "qm-stock-out-execution"
---

<objective>
Add a dedicated "Fulfillment" section to the QMHQ item detail page showing numbers-only metrics: Requested, Approved, Rejected, and Executed quantities from the linked SOR. Cross-tab sync ensures metrics update when execution happens on another tab.

Purpose: Users can see fulfillment progress at a glance on the QMHQ detail page without navigating to the SOR detail page. This implements METRIC-01 through METRIC-06 requirements.

Output: New FulfillmentMetrics component, integrated into QMHQ detail page below item details and above SOR transaction groups.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/(dashboard)/qmhq/[id]/page.tsx
@components/qmhq/sor-transaction-group.tsx
@components/qmhq/items-summary-progress.tsx
@components/providers/auth-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FulfillmentMetrics component with cross-tab sync</name>
  <files>
    components/qmhq/fulfillment-metrics.tsx
  </files>
  <action>
Create `components/qmhq/fulfillment-metrics.tsx` -- a client component that displays aggregate fulfillment metrics for a QMHQ's linked stock-out request.

**Props interface:**
```tsx
interface FulfillmentMetricsProps {
  qmhqId: string;
}
```

**Data fetching (inside component, using useState + useCallback pattern consistent with codebase):**

1. `fetchMetrics` callback:
   - Query `stock_out_requests` where `qmhq_id = qmhqId` and `is_active = true`, using `.single()` (1:1 QMHQ-to-SOR relationship per context decision). If no SOR found or error, set metrics to null.
   - Use nested select to get line_items with their approvals:
     ```
     stock_out_requests(
       id,
       line_items:stock_out_line_items(
         id, requested_quantity, status,
         approvals:stock_out_approvals(approved_quantity, decision)
       )
     )
     ```
   - Calculate `requested`: sum of all `line_item.requested_quantity`
   - Calculate `approved`: sum of `approval.approved_quantity` where `decision = 'approved'`
   - Calculate `rejected`: sum of `approval.approved_quantity` where `decision = 'rejected'` (for rejected, approved_quantity might be 0, so also count the number of rejections as a fallback)
   - For `executed`: query `inventory_transactions` where `qmhq_id = qmhqId`, `movement_type = 'inventory_out'`, `status = 'completed'`, `is_active = true`, sum the quantities.
   - Store in state: `{ requested: number, approved: number, rejected: number, executed: number } | null`

2. `useEffect` to call `fetchMetrics` on mount and when `qmhqId` changes.

3. **BroadcastChannel listener** in a separate `useEffect`:
   - Open channel `'qm-stock-out-execution'`
   - On message with `type === 'APPROVAL_EXECUTED'` AND `event.data.qmhqId === qmhqId`, call `fetchMetrics()` to refresh
   - Cleanup: close channel on unmount
   - Wrap in try/catch for Safari graceful degradation

**Rendering:**

- Loading state: Show `Loader2` spinner (animate-spin, text-slate-400)
- Null metrics (no SOR linked): Show centered text "No stock-out request linked" in text-slate-500, py-4
- Metrics available: Render a `command-panel p-6` div with:
  - Heading: `<h3 className="text-lg font-semibold text-slate-200 mb-4">Fulfillment</h3>`
  - Grid: `grid grid-cols-4 gap-4` with four stat cards:
    - **Requested**: label "Requested" in text-xs text-slate-500, value in font-mono text-xl text-slate-200
    - **Approved**: label "Approved", value in font-mono text-xl text-emerald-400
    - **Rejected**: label "Rejected", value in font-mono text-xl text-red-400
    - **Executed**: label "Executed", value in font-mono text-xl text-blue-400

Keep it numbers-only per user decision -- no progress bar, no percentage.
  </action>
  <verify>
1. `npx tsc --noEmit` -- no type errors
2. File exists at components/qmhq/fulfillment-metrics.tsx
3. Contains "use client" directive
4. Contains BroadcastChannel listener for 'qm-stock-out-execution'
5. Contains "No stock-out request linked" empty state text
6. Does NOT contain progress bar or percentage elements
  </verify>
  <done>
- FulfillmentMetrics component created with four metrics: Requested, Approved, Rejected, Executed
- Numbers-only display (no progress bar)
- Empty state shows "No stock-out request linked" when no SOR exists
- BroadcastChannel listener refreshes metrics on cross-tab execution events
- Loading spinner while fetching
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FulfillmentMetrics into QMHQ item detail page</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Modify `app/(dashboard)/qmhq/[id]/page.tsx` to add the FulfillmentMetrics section.

**1. Add import:**
```tsx
import { FulfillmentMetrics } from "@/components/qmhq/fulfillment-metrics";
```

**2. Add FulfillmentMetrics in the Details tab:**

Per user decision: Position below item details, above SOR transaction groups.

In the Details tab (`<TabsContent value="details">`), after the existing "Fulfillment Progress" section (which shows the ItemsSummaryProgress with the stepped progress bar), add the FulfillmentMetrics component:

Find the section:
```tsx
{/* Fulfillment Progress for item route */}
{qmhq.route_type === "item" && qmhqItems.length > 0 && (
  <div className="command-panel corner-accents lg:col-span-2">
    <div className="section-header">
      <CheckCircle2 className="h-4 w-4 text-emerald-400" />
      <h2>Fulfillment Progress</h2>
    </div>
    <ItemsSummaryProgress items={itemsProgressData} />
  </div>
)}
```

Replace this entire block with a combined section that uses FulfillmentMetrics for the aggregate numbers and keeps ItemsSummaryProgress for the per-item stepped bar:

```tsx
{/* Fulfillment for item route */}
{qmhq.route_type === "item" && (
  <div className="lg:col-span-2 space-y-6">
    {/* Aggregate Fulfillment Metrics */}
    <FulfillmentMetrics qmhqId={qmhqId} />

    {/* Per-Item Progress */}
    {qmhqItems.length > 0 && (
      <div className="command-panel corner-accents">
        <div className="section-header">
          <CheckCircle2 className="h-4 w-4 text-emerald-400" />
          <h2>Item Progress</h2>
        </div>
        <ItemsSummaryProgress items={itemsProgressData} />
      </div>
    )}
  </div>
)}
```

Note: The FulfillmentMetrics component renders its own command-panel wrapper, so no additional wrapper needed.

Note: Changed the condition from `qmhqItems.length > 0` to just `qmhq.route_type === "item"` for the outer wrapper, because FulfillmentMetrics handles its own empty state when no SOR is linked. The inner ItemsSummaryProgress still requires `qmhqItems.length > 0`.

**3. Add BroadcastChannel listener for cross-tab data refresh:**

Add a useEffect in the QMHQ page that listens on `'qm-stock-out-execution'` channel. When receiving `APPROVAL_EXECUTED` with `qmhqId` matching current page, call `fetchData()` to refresh all data including stockOutTransactions and stockOutRequest (which feed into itemsProgressData).

```tsx
// Cross-tab execution sync
useEffect(() => {
  let channel: BroadcastChannel | null = null;
  try {
    channel = new BroadcastChannel('qm-stock-out-execution');
    channel.onmessage = (event) => {
      if (event.data.type === 'APPROVAL_EXECUTED' && event.data.qmhqId === qmhqId) {
        fetchData();
      }
    };
  } catch {
    // BroadcastChannel not supported - graceful degradation
  }
  return () => {
    try { channel?.close(); } catch {}
  };
}, [qmhqId, fetchData]);
```

Place this after the existing `useEffect` that calls `fetchData`.
  </action>
  <verify>
1. `npx tsc --noEmit` -- no type errors
2. `npm run build` -- builds successfully
3. Grep for "FulfillmentMetrics" in qmhq/[id]/page.tsx -- should exist
4. Grep for "qm-stock-out-execution" in qmhq/[id]/page.tsx -- should exist (BroadcastChannel listener)
5. The FulfillmentMetrics section appears for item route type
6. ItemsSummaryProgress still renders (not removed, still available for per-item view)
  </verify>
  <done>
- FulfillmentMetrics component is rendered on QMHQ item detail page
- Positioned in the details tab, below item details
- ItemsSummaryProgress still available for per-item stepped bar
- Cross-tab BroadcastChannel listener refreshes QMHQ data when execution happens on another tab
- Route type "item" shows both aggregate fulfillment and per-item progress
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. FulfillmentMetrics component exists at components/qmhq/fulfillment-metrics.tsx
4. QMHQ detail page imports and renders FulfillmentMetrics for item route type
5. BroadcastChannel 'qm-stock-out-execution' is listened to in both FulfillmentMetrics component and QMHQ page
6. No progress bar in FulfillmentMetrics (numbers-only display)
7. Empty state "No stock-out request linked" renders when no SOR exists
</verification>

<success_criteria>
- QMHQ item detail shows requested qty (METRIC-01)
- QMHQ item detail shows approved qty (METRIC-02)
- QMHQ item detail shows rejected qty (METRIC-03)
- QMHQ item detail shows executed/fulfilled qty (METRIC-04)
- Fulfillment display uses numbers only, no progress bar (METRIC-05 simplified per user decision)
- Requested qty is visible alongside fulfillment metrics (METRIC-06)
- Cross-tab sync updates metrics when execution happens on approval page
</success_criteria>

<output>
After completion, create `.planning/phases/35-per-line-item-execution-ui/35-02-SUMMARY.md`
</output>
