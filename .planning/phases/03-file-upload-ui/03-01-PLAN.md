---
phase: 03-file-upload-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/files/file-dropzone.tsx
  - components/files/file-card.tsx
  - components/files/file-grid.tsx
  - components/files/upload-progress.tsx
  - components/files/delete-file-dialog.tsx
  - lib/hooks/use-file-upload.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Drop zone accepts files via drag-drop and click-to-browse"
    - "File cards display thumbnail for images and extension badge for documents"
    - "Upload progress shows batch completion count"
    - "Delete confirmation dialog prevents accidental deletion"
  artifacts:
    - path: "components/files/file-dropzone.tsx"
      provides: "Drag-drop zone with react-dropzone"
      exports: ["FileDropzone"]
    - path: "components/files/file-card.tsx"
      provides: "Individual file display with thumbnail/badge"
      exports: ["FileCard"]
    - path: "components/files/file-grid.tsx"
      provides: "4-column grid layout for file cards"
      exports: ["FileGrid"]
    - path: "components/files/upload-progress.tsx"
      provides: "Batch upload progress indicator"
      exports: ["UploadProgress"]
    - path: "components/files/delete-file-dialog.tsx"
      provides: "Confirmation dialog for file deletion"
      exports: ["DeleteFileDialog"]
    - path: "lib/hooks/use-file-upload.ts"
      provides: "Upload state management with retry logic"
      exports: ["useFileUpload"]
  key_links:
    - from: "components/files/file-dropzone.tsx"
      to: "lib/utils/file-validation.ts"
      via: "imports ALLOWED_EXTENSIONS, MAX_FILE_SIZE, EXTENSION_MIME_MAP"
      pattern: "from '@/lib/utils/file-validation'"
    - from: "lib/hooks/use-file-upload.ts"
      to: "lib/actions/files.ts"
      via: "calls uploadFile server action"
      pattern: "uploadFile\\("
---

<objective>
Build reusable file upload components using react-dropzone

Purpose: Create the UI building blocks for file attachments that will be integrated into QMRL and QMHQ detail pages in subsequent plans. These components handle drag-drop, file display with thumbnails, upload progress, and deletion confirmation.

Output:
- FileDropzone component with react-dropzone integration
- FileCard component with image thumbnails and document extension badges
- FileGrid component for 4-column responsive layout
- UploadProgress component showing batch completion
- DeleteFileDialog confirmation component
- useFileUpload hook for state management with retry logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-file-upload-ui/03-CONTEXT.md
@.planning/phases/03-file-upload-ui/03-RESEARCH.md
@.planning/phases/02-file-storage-foundation/02-02-SUMMARY.md

# Existing code to reference
@lib/utils/file-validation.ts
@lib/actions/files.ts
@components/ui/toast.tsx
@components/ui/dialog.tsx
@components/ui/dropdown-menu.tsx
@components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and create file upload hook</name>
  <files>
    - package.json
    - lib/hooks/use-file-upload.ts
  </files>
  <action>
Install react-dropzone:
```bash
npm install react-dropzone
```

Create `lib/hooks/use-file-upload.ts` with:

1. **Types:**
   - `UploadState`: 'idle' | 'uploading' | 'success' | 'error'
   - `FileUploadItem`: { id, file, state, error?, retryCount, result? }
   - `UploadProgress`: { total, completed, failed, isUploading }

2. **Hook: useFileUpload(entityType, entityId)**
   - State: `items` (FileUploadItem[]), derived `progress` (UploadProgress)
   - Methods:
     - `uploadFiles(files: File[])`: Add files to queue, process sequentially
     - `uploadWithRetry(item, maxRetries=3)`: Upload single file with exponential backoff (1s, 2s, 4s delays)
     - `cancel()`: Abort remaining uploads via AbortController
     - `clearCompleted()`: Remove successful/failed items from state

3. **Upload logic:**
   - Process files sequentially (not parallel) to avoid server overload
   - Create FormData with 'file' key, call uploadFile server action
   - On success: update item state to 'success', store result
   - On error: retry up to 3 times, then mark as 'error'
   - Track progress as { completed: successCount, failed: errorCount, total: items.length }

4. **Abort handling:**
   - Store AbortController in ref (not state)
   - Check controller.signal.aborted before each upload
   - Clean up controller in useEffect cleanup

5. **Return:** { items, progress, uploadFiles, cancel, clearCompleted, isUploading }
  </action>
  <verify>
  - `npm run type-check` passes
  - Hook file exists with all exported types and functions
  </verify>
  <done>useFileUpload hook manages upload state with retry logic and abort capability</done>
</task>

<task type="auto">
  <name>Task 2: Create file dropzone component</name>
  <files>
    - components/files/file-dropzone.tsx
  </files>
  <action>
Create `components/files/file-dropzone.tsx`:

1. **Props interface:**
   ```typescript
   interface FileDropzoneProps {
     onFilesAccepted: (files: File[]) => void;
     disabled?: boolean;
     className?: string;
   }
   ```

2. **useDropzone configuration:**
   - Build accept object from EXTENSION_MIME_MAP (from file-validation.ts):
     ```typescript
     const acceptMimeTypes = {
       'image/jpeg': ['.jpg', '.jpeg'],
       'image/png': ['.png'],
       'image/gif': ['.gif'],
       'image/webp': ['.webp'],
       'application/pdf': ['.pdf'],
       'application/msword': ['.doc'],
       'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
       'application/vnd.ms-excel': ['.xls'],
       'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
       'application/vnd.ms-powerpoint': ['.ppt'],
       'application/vnd.openxmlformats-officedocument.presentationml.presentation': ['.pptx'],
     };
     ```
   - maxSize: MAX_FILE_SIZE (from file-validation.ts)
   - multiple: true
   - disabled prop pass-through

3. **onDrop handler:**
   - For rejected files: show toast with "Some files were rejected" and list reasons
   - For accepted files: call onFilesAccepted prop
   - Use toast from @/components/ui/use-toast

4. **Visual states (per 03-CONTEXT.md):**
   - **Idle:** h-[180px], border-2 border-dashed border-slate-700, bg-slate-800/30
     - Upload icon (lucide-react Upload), "Drag files here or click to browse" text
     - "Accepted: PDF, images, docs. Max 25MB" subtext (use getAllowedTypesDisplay and formatFileSize)
   - **Drag active (valid):** border-amber-500, bg-amber-500/10, icon animates (animate-bounce)
     - Text: "Drop files here"
   - **Drag reject:** border-red-500, bg-red-500/10
     - AlertCircle icon, "File type not supported" text
   - **Disabled:** opacity-50, cursor-not-allowed

5. **Implementation pattern from RESEARCH.md:**
   ```tsx
   const { getRootProps, getInputProps, isDragActive, isDragReject } = useDropzone({...});
   return (
     <div {...getRootProps()} className={cn(...)}>
       <input {...getInputProps()} />
       {/* Conditional content based on state */}
     </div>
   );
   ```

Mark as "use client" - this is a client component.
  </action>
  <verify>
  - `npm run type-check` passes
  - Component exports FileDropzone
  - Imports from react-dropzone, lucide-react, file-validation utilities
  </verify>
  <done>FileDropzone component handles drag-drop with visual feedback and validation</done>
</task>

<task type="auto">
  <name>Task 3: Create file card, grid, progress, and delete dialog components</name>
  <files>
    - components/files/file-card.tsx
    - components/files/file-grid.tsx
    - components/files/upload-progress.tsx
    - components/files/delete-file-dialog.tsx
  </files>
  <action>
**Create `components/files/file-card.tsx`:**

1. **Props:**
   ```typescript
   interface FileCardProps {
     file: FileAttachmentWithUploader;
     thumbnailUrl?: string;
     onDelete?: () => void;
     canDelete?: boolean;
   }
   ```

2. **Extension color mapping (per RESEARCH.md):**
   ```typescript
   const EXTENSION_COLORS: Record<string, { bg: string; text: string }> = {
     '.pdf': { bg: 'bg-red-500/20', text: 'text-red-400' },
     '.doc': { bg: 'bg-blue-500/20', text: 'text-blue-400' },
     '.docx': { bg: 'bg-blue-500/20', text: 'text-blue-400' },
     '.xls': { bg: 'bg-emerald-500/20', text: 'text-emerald-400' },
     '.xlsx': { bg: 'bg-emerald-500/20', text: 'text-emerald-400' },
     '.ppt': { bg: 'bg-orange-500/20', text: 'text-orange-400' },
     '.pptx': { bg: 'bg-orange-500/20', text: 'text-orange-400' },
   };
   ```

3. **Layout (per 03-CONTEXT.md):**
   - Card with rounded-lg border border-slate-700 bg-slate-800/50
   - **Thumbnail area (h-24):**
     - If image (mime_type.startsWith('image/')) and thumbnailUrl: show img with object-cover
     - Else: colored extension badge (full area, large extension text)
   - **Info area (p-3):**
     - Filename (truncate with title attribute)
     - File size and upload date (text-xs text-slate-400)
     - Uploader name if available

4. **Delete action:**
   - Show context menu (DropdownMenu) on hover (opacity-0 group-hover:opacity-100)
   - Three-dot icon (MoreVertical) top-right
   - Menu item: "Delete" with Trash2 icon, text-red-400
   - Only show if canDelete prop is true

**Create `components/files/file-grid.tsx`:**

1. **Props:**
   ```typescript
   interface FileGridProps {
     children: React.ReactNode;
     className?: string;
   }
   ```

2. **Layout:**
   - grid grid-cols-4 gap-4
   - Add max-h-[500px] overflow-y-auto for scrolling when many files (per 03-CONTEXT.md)
   - Simple wrapper component

**Create `components/files/upload-progress.tsx`:**

1. **Props:**
   ```typescript
   interface UploadProgressProps {
     completed: number;
     total: number;
     failed: number;
     onCancel?: () => void;
   }
   ```

2. **Layout (per RESEARCH.md example):**
   - Conditional styling based on state:
     - In progress: bg-slate-800/50 border-slate-700
     - Complete (no errors): bg-emerald-500/10 border-emerald-500/30
     - Complete (with errors): bg-amber-500/10 border-amber-500/30
   - Icon:
     - In progress: Loader2 animate-spin text-amber-400
     - Complete (no errors): CheckCircle text-emerald-400
     - Complete (with errors): AlertCircle text-amber-400
   - Text:
     - In progress: "Uploading X of Y files..."
     - Complete (no errors): "X files uploaded successfully"
     - Complete (with errors): "X uploaded, Y failed"
   - Cancel button (only during upload): X icon, calls onCancel

**Create `components/files/delete-file-dialog.tsx`:**

1. **Props:**
   ```typescript
   interface DeleteFileDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     filename: string;
     onConfirm: () => void;
     isDeleting?: boolean;
   }
   ```

2. **Layout:**
   - Use Dialog from @/components/ui/dialog
   - Title: "Delete file"
   - Description: "Are you sure you want to delete '{filename}'? This action cannot be undone."
   - Buttons:
     - Cancel: variant="outline", calls onOpenChange(false)
     - Delete: variant="destructive" style (bg-red-600 hover:bg-red-500), calls onConfirm
     - Show loading spinner when isDeleting

All components should be marked "use client".
  </action>
  <verify>
  - `npm run type-check` passes
  - `npm run lint` passes (or only pre-existing warnings)
  - All 4 component files exist with proper exports
  </verify>
  <done>File card, grid, progress, and delete dialog components ready for integration</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type check passes: `npm run type-check`
2. Lint passes: `npm run lint`
3. All files exist:
   - lib/hooks/use-file-upload.ts
   - components/files/file-dropzone.tsx
   - components/files/file-card.tsx
   - components/files/file-grid.tsx
   - components/files/upload-progress.tsx
   - components/files/delete-file-dialog.tsx
4. react-dropzone is in package.json dependencies
</verification>

<success_criteria>
- FileDropzone accepts drag-drop and shows visual feedback for all states
- FileCard displays thumbnails for images and colored extension badges for documents
- FileGrid arranges cards in 4-column layout with scroll for overflow
- UploadProgress shows batch completion with appropriate success/error styling
- DeleteFileDialog confirms before deletion
- useFileUpload hook manages upload queue with retry and abort capability
- All components compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-file-upload-ui/03-01-SUMMARY.md`
</output>
