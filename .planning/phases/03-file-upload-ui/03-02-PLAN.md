---
phase: 03-file-upload-ui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/files/attachments-tab.tsx
  - app/(dashboard)/qmrl/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-drop files onto QMRL detail page Attachments tab to upload"
    - "User sees list of uploaded files sorted by upload date with thumbnails"
    - "Attachments tab shows file count badge"
    - "User can delete files with confirmation dialog"
    - "Read-only users see file list but no drop zone"
  artifacts:
    - path: "components/files/attachments-tab.tsx"
      provides: "Orchestrator component combining dropzone, grid, progress, delete"
      exports: ["AttachmentsTab"]
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "QMRL detail page with Attachments tab"
      contains: "AttachmentsTab"
  key_links:
    - from: "components/files/attachments-tab.tsx"
      to: "lib/hooks/use-file-upload.ts"
      via: "uses useFileUpload hook"
      pattern: "useFileUpload\\("
    - from: "components/files/attachments-tab.tsx"
      to: "lib/actions/files.ts"
      via: "calls getFilesByEntity, deleteFile, getFileUrl"
      pattern: "getFilesByEntity|deleteFile|getFileUrl"
    - from: "app/(dashboard)/qmrl/[id]/page.tsx"
      to: "components/files/attachments-tab.tsx"
      via: "renders AttachmentsTab in tab content"
      pattern: "<AttachmentsTab"
---

<objective>
Integrate file upload into QMRL detail page

Purpose: Create the AttachmentsTab orchestrator component that combines all file upload components (dropzone, grid, progress, delete dialog) and integrate it into the QMRL detail page as a new tab alongside Details, QMHQ Lines, and History.

Output:
- AttachmentsTab component that handles file upload/display/delete workflow
- QMRL detail page with new Attachments tab showing file count badge
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-file-upload-ui/03-CONTEXT.md
@.planning/phases/03-file-upload-ui/03-01-SUMMARY.md (will exist after Plan 01)

# Existing code to reference
@app/(dashboard)/qmrl/[id]/page.tsx
@lib/actions/files.ts
@lib/hooks/use-file-upload.ts (created in Plan 01)
@components/files/file-dropzone.tsx (created in Plan 01)
@components/files/file-card.tsx (created in Plan 01)
@components/files/file-grid.tsx (created in Plan 01)
@components/files/upload-progress.tsx (created in Plan 01)
@components/files/delete-file-dialog.tsx (created in Plan 01)
@components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AttachmentsTab orchestrator component</name>
  <files>
    - components/files/attachments-tab.tsx
  </files>
  <action>
Create `components/files/attachments-tab.tsx`:

1. **Props interface:**
   ```typescript
   interface AttachmentsTabProps {
     entityType: 'qmrl' | 'qmhq';
     entityId: string;
     canEdit?: boolean;  // Controls whether dropzone shows
   }
   ```

2. **State management:**
   - `files`: FileAttachmentWithUploader[] - loaded from server
   - `thumbnailUrls`: Map<string, string> - signed URLs for image previews
   - `isLoading`: boolean - initial load state
   - `fileToDelete`: FileAttachmentWithUploader | null - for delete dialog
   - `isDeleting`: boolean - delete in progress
   - Use `useFileUpload(entityType, entityId)` hook for upload state

3. **Data fetching (useEffect on mount):**
   ```typescript
   const loadFiles = async () => {
     setIsLoading(true);
     const result = await getFilesByEntity(entityType, entityId);
     if (result.success) {
       setFiles(result.data);
       // Load thumbnail URLs for images
       await loadThumbnails(result.data);
     }
     setIsLoading(false);
   };
   ```

4. **Thumbnail loading:**
   - For each file where mime_type.startsWith('image/'):
     - Call getFileUrl(file.storage_path)
     - Store in thumbnailUrls Map keyed by file.id
   - Memory management: Clean up blob URLs in useEffect cleanup if creating any local URLs
     (Note: We use signed URLs from storage, not blob URLs, so no cleanup needed)

5. **Upload handling:**
   - `handleFilesAccepted(files: File[])`:
     - Check soft limit: if files.length + existingFiles.length > 20, show warning toast but continue
     - Call uploadFiles from useFileUpload hook
   - When upload completes (progress.isUploading becomes false and progress.completed > 0):
     - Reload files from server: await loadFiles()
     - Call clearCompleted() from hook
     - Show success toast: "X files uploaded successfully" (or partial success message)

6. **Delete handling:**
   - `handleDeleteClick(file)`: Set fileToDelete to show dialog
   - `handleDeleteConfirm()`:
     - setIsDeleting(true)
     - Call deleteFile(fileToDelete.id)
     - On success: remove file from local state, show success toast
     - On error: show error toast
     - setIsDeleting(false), setFileToDelete(null)

7. **Layout (per 03-CONTEXT.md):**
   ```tsx
   <div className="space-y-6">
     {/* Header with file count */}
     <div className="section-header">
       <Paperclip className="h-4 w-4 text-amber-500" />
       <h3>Attachments ({files.length})</h3>
     </div>

     {/* Upload Progress (only show when uploading) */}
     {progress.isUploading && (
       <UploadProgress
         completed={progress.completed}
         total={progress.total}
         failed={progress.failed}
         onCancel={cancel}
       />
     )}

     {/* File Grid */}
     {isLoading ? (
       <div className="grid grid-cols-4 gap-4">
         {[...Array(4)].map((_, i) => (
           <Skeleton key={i} className="h-40 rounded-lg" />
         ))}
       </div>
     ) : files.length === 0 ? (
       <div className="text-center py-8 text-slate-400">
         <Paperclip className="h-8 w-8 mx-auto mb-2 opacity-50" />
         <p>No files attached</p>
       </div>
     ) : (
       <FileGrid>
         {files.map(file => (
           <FileCard
             key={file.id}
             file={file}
             thumbnailUrl={thumbnailUrls.get(file.id)}
             canDelete={canEdit}
             onDelete={() => handleDeleteClick(file)}
           />
         ))}
       </FileGrid>
     )}

     {/* Drop Zone (only if canEdit) */}
     {canEdit && (
       <FileDropzone
         onFilesAccepted={handleFilesAccepted}
         disabled={progress.isUploading}
       />
     )}

     {/* Delete Dialog */}
     <DeleteFileDialog
       open={!!fileToDelete}
       onOpenChange={(open) => !open && setFileToDelete(null)}
       filename={fileToDelete?.filename ?? ''}
       onConfirm={handleDeleteConfirm}
       isDeleting={isDeleting}
     />
   </div>
   ```

8. **Navigation warning (per 03-CONTEXT.md):**
   - Use beforeunload event when uploads in progress
   ```typescript
   useEffect(() => {
     const handleBeforeUnload = (e: BeforeUnloadEvent) => {
       if (progress.isUploading) {
         e.preventDefault();
         e.returnValue = '';
       }
     };
     window.addEventListener('beforeunload', handleBeforeUnload);
     return () => window.removeEventListener('beforeunload', handleBeforeUnload);
   }, [progress.isUploading]);
   ```

Mark as "use client".
  </action>
  <verify>
  - `npm run type-check` passes
  - Component exports AttachmentsTab
  - Imports all file components from components/files/
  - Imports server actions from lib/actions/files.ts
  </verify>
  <done>AttachmentsTab orchestrates file upload workflow with all sub-components</done>
</task>

<task type="auto">
  <name>Task 2: Add Attachments tab to QMRL detail page</name>
  <files>
    - app/(dashboard)/qmrl/[id]/page.tsx
  </files>
  <action>
Modify `app/(dashboard)/qmrl/[id]/page.tsx`:

1. **Add imports:**
   ```typescript
   import { Paperclip } from "lucide-react";
   import { AttachmentsTab } from "@/components/files/attachments-tab";
   ```

2. **Add state for file count (for tab badge):**
   ```typescript
   const [fileCount, setFileCount] = useState(0);
   ```

3. **Fetch file count on load:**
   In the `fetchQMRL` callback, after fetching QMRL data, add:
   ```typescript
   // Fetch file count for tab badge
   const { data: filesData } = await supabase
     .from("file_attachments")
     .select("id", { count: 'exact', head: true })
     .eq("entity_type", "qmrl")
     .eq("entity_id", id)
     .is("deleted_at", null);

   if (filesData !== null) {
     // For head: true with count, the count is in the response metadata
     // Actually, use count query properly:
   }
   ```

   Better approach - simpler count query:
   ```typescript
   const { count: filesCount } = await supabase
     .from("file_attachments")
     .select("*", { count: 'exact', head: true })
     .eq("entity_type", "qmrl")
     .eq("entity_id", id)
     .is("deleted_at", null);

   setFileCount(filesCount ?? 0);
   ```

4. **Add Attachments tab trigger in TabsList:**
   Insert after the History tab trigger:
   ```tsx
   <TabsTrigger value="attachments" className="data-[state=active]:bg-slate-700 data-[state=active]:text-amber-400">
     <Paperclip className="mr-2 h-4 w-4" />
     Attachments ({fileCount})
   </TabsTrigger>
   ```

5. **Add Attachments TabsContent:**
   After the History TabsContent, add:
   ```tsx
   {/* Attachments Tab */}
   <TabsContent value="attachments">
     <div className="command-panel corner-accents animate-slide-up">
       <AttachmentsTab
         entityType="qmrl"
         entityId={qmrl.id}
         canEdit={true}  // TODO: Check user permissions in future phase
       />
     </div>
   </TabsContent>
   ```

6. **Update file count when files change:**
   Pass a callback to AttachmentsTab to update count:
   - Add prop to AttachmentsTab: `onFileCountChange?: (count: number) => void`
   - In AttachmentsTab, call this when files state changes
   - In QMRL page: `onFileCountChange={setFileCount}`

   Actually, simpler approach: AttachmentsTab already has files.length internally.
   Let's keep the count in sync by:
   - Exposing fileCount via a callback prop OR
   - Re-fetching count when tab becomes active

   Cleanest solution: Add `onFileCountChange` prop to AttachmentsTab:
   ```typescript
   // In AttachmentsTab
   useEffect(() => {
     onFileCountChange?.(files.length);
   }, [files.length, onFileCountChange]);
   ```
  </action>
  <verify>
  - `npm run type-check` passes
  - `npm run build` passes
  - QMRL detail page renders with Attachments tab showing file count
  </verify>
  <done>QMRL detail page has Attachments tab with file upload capability</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type check passes: `npm run type-check`
2. Build passes: `npm run build`
3. Files exist:
   - components/files/attachments-tab.tsx
   - app/(dashboard)/qmrl/[id]/page.tsx (modified)
4. Manual verification (if dev server running):
   - Navigate to /qmrl/{id}
   - See Attachments tab with count badge
   - Click Attachments tab
   - See dropzone and empty state (or existing files if any)
</verification>

<success_criteria>
- AttachmentsTab component orchestrates dropzone, grid, progress, and delete dialog
- QMRL detail page shows Attachments tab with file count badge
- Files load on tab mount and display with thumbnails/extension badges
- Upload progress shows during file upload
- Delete confirmation dialog appears before deletion
- Navigation warning appears if leaving during upload
</success_criteria>

<output>
After completion, create `.planning/phases/03-file-upload-ui/03-02-SUMMARY.md`
</output>
