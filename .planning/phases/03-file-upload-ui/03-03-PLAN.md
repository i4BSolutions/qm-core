---
phase: 03-file-upload-ui
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-drop files onto QMHQ detail page Attachments tab to upload"
    - "User sees list of uploaded files sorted by upload date with thumbnails"
    - "Attachments tab shows file count badge"
    - "User can delete files with confirmation dialog"
  artifacts:
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail page with Attachments tab"
      contains: "AttachmentsTab"
  key_links:
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "components/files/attachments-tab.tsx"
      via: "renders AttachmentsTab in tab content"
      pattern: "<AttachmentsTab"
---

<objective>
Integrate file upload into QMHQ detail page

Purpose: Add the Attachments tab to the QMHQ detail page, reusing the AttachmentsTab component created in Plan 02. This enables file attachments on QMHQ entities using the same UI pattern as QMRL.

Output:
- QMHQ detail page with new Attachments tab showing file count badge
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-file-upload-ui/03-CONTEXT.md
@.planning/phases/03-file-upload-ui/03-02-SUMMARY.md (will exist after Plan 02)

# Existing code to reference
@app/(dashboard)/qmhq/[id]/page.tsx
@components/files/attachments-tab.tsx (created in Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Attachments tab to QMHQ detail page</name>
  <files>
    - app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Modify `app/(dashboard)/qmhq/[id]/page.tsx`:

1. **Add imports:**
   ```typescript
   import { Paperclip } from "lucide-react";
   import { AttachmentsTab } from "@/components/files/attachments-tab";
   ```

2. **Add state for file count:**
   ```typescript
   const [fileCount, setFileCount] = useState(0);
   ```

3. **Fetch file count in fetchData callback:**
   After fetching QMHQ data (around line 120, after setQmhq), add:
   ```typescript
   // Fetch file count for attachments tab badge
   const { count: filesCount } = await supabase
     .from("file_attachments")
     .select("*", { count: 'exact', head: true })
     .eq("entity_type", "qmhq")
     .eq("entity_id", qmhqId)
     .is("deleted_at", null);

   setFileCount(filesCount ?? 0);
   ```

4. **Add Attachments tab trigger in TabsList:**
   The QMHQ detail page has dynamic tabs based on route_type. Add the Attachments tab
   after the History tab trigger (around line 391):
   ```tsx
   <TabsTrigger value="attachments" className="data-[state=active]:bg-amber-500/20 data-[state=active]:text-amber-400">
     <Paperclip className="mr-2 h-4 w-4" />
     Attachments ({fileCount})
   </TabsTrigger>
   ```

   Note: QMHQ uses slightly different tab styling: `data-[state=active]:bg-amber-500/20`
   Match the existing pattern in the file.

5. **Add Attachments TabsContent:**
   After the History TabsContent (around line 815), add:
   ```tsx
   {/* Attachments Tab */}
   <TabsContent value="attachments" className="mt-6">
     <div className="command-panel corner-accents">
       <AttachmentsTab
         entityType="qmhq"
         entityId={qmhqId}
         canEdit={true}
         onFileCountChange={setFileCount}
       />
     </div>
   </TabsContent>
   ```

6. **Verify tab ordering:**
   The tabs should appear in this order:
   - Details
   - Transactions (expense/po routes only)
   - Purchase Orders (po route only)
   - History
   - Attachments (new)
  </action>
  <verify>
  - `npm run type-check` passes
  - `npm run build` passes
  - QMHQ detail page includes Attachments tab with file count badge
  </verify>
  <done>QMHQ detail page has Attachments tab with file upload capability</done>
</task>

<task type="auto">
  <name>Task 2: Verify complete integration</name>
  <files>
    (no files modified - verification task)
  </files>
  <action>
Run verification to ensure full Phase 3 integration works:

1. **Build verification:**
   ```bash
   npm run build
   ```
   Must pass without errors.

2. **Type checking:**
   ```bash
   npm run type-check
   ```
   Must pass without errors.

3. **Lint check:**
   ```bash
   npm run lint
   ```
   Should pass (or only pre-existing warnings).

4. **File structure verification:**
   Confirm all Phase 3 files exist:
   - lib/hooks/use-file-upload.ts
   - components/files/file-dropzone.tsx
   - components/files/file-card.tsx
   - components/files/file-grid.tsx
   - components/files/upload-progress.tsx
   - components/files/delete-file-dialog.tsx
   - components/files/attachments-tab.tsx

5. **Import chain verification:**
   - QMRL page imports AttachmentsTab
   - QMHQ page imports AttachmentsTab
   - AttachmentsTab imports all file components and hooks
   - useFileUpload imports uploadFile from server actions
   - FileDropzone imports from file-validation utilities

If any issues found, fix them before marking complete.
  </action>
  <verify>
  - `npm run build` passes
  - `npm run type-check` passes
  - All file components exist and export correctly
  </verify>
  <done>Phase 3 file upload integration complete for both QMRL and QMHQ</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build passes: `npm run build`
2. Type check passes: `npm run type-check`
3. QMHQ detail page modified with Attachments tab
4. Both QMRL and QMHQ detail pages have identical file upload capability

Phase 3 Success Criteria (from ROADMAP.md):
- [x] User can drag-drop files onto QMRL detail page to upload
- [x] User can drag-drop files onto QMHQ detail page to upload
- [x] User sees list of uploaded files sorted by upload date with thumbnail previews
- [x] User sees upload progress indicators during file transfer

Note: Create form integration (FILE-01, FILE-03) was descoped per 03-CONTEXT.md:
"Files only on detail pages - NOT on create forms"
</verification>

<success_criteria>
- QMHQ detail page shows Attachments tab with file count badge
- File upload works identically to QMRL page
- Build and type-check pass without errors
- Phase 3 success criteria met for both entity types
</success_criteria>

<output>
After completion, create `.planning/phases/03-file-upload-ui/03-03-SUMMARY.md`
</output>
