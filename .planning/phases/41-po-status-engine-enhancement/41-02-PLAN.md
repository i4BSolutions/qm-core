---
phase: 41-po-status-engine-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - components/po/po-status-badge.tsx
  - components/po/po-card.tsx
  - app/(dashboard)/po/page.tsx
  - app/(dashboard)/po/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can hover over PO status badge and see tooltip with invoiced/received counts and percentages"
    - "PO list shows closed POs with dimmed row opacity and lock icon next to status badge"
    - "PO list shows cancelled POs with strikethrough text on PO number and red Cancelled badge"
    - "PO list mini progress bar appears under status badge in both card and list views"
    - "Admin user can cancel PO via dialog with mandatory reason field, sees cascade toast with released budget"
    - "PO status badge pulses briefly when status has just changed"
    - "Status is non-editable - tooltip explains current state calculation"
  artifacts:
    - path: "components/po/po-status-badge.tsx"
      provides: "Enhanced POStatusBadge with Tooltip, lock icon for closed, pulse animation"
      min_lines: 80
    - path: "components/po/po-card.tsx"
      provides: "POCard with dimmed/strikethrough styling for closed/cancelled states"
      min_lines: 100
    - path: "app/(dashboard)/po/page.tsx"
      provides: "PO list with status tooltip, closed row dimming, cancelled strikethrough, mini progress under badge"
      min_lines: 400
    - path: "app/(dashboard)/po/[id]/page.tsx"
      provides: "PO detail with cancel dialog (reason field), cascade toast, pulse animation, safety-net recompute"
      min_lines: 500
  key_links:
    - from: "components/po/po-status-badge.tsx"
      to: "lib/utils/po-status.ts"
      via: "imports generateStatusTooltip for tooltip text"
      pattern: "generateStatusTooltip"
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "lib/actions/po-actions.ts"
      via: "calls cancelPO Server Action on confirm"
      pattern: "cancelPO"
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "lib/utils/po-status.ts"
      via: "calls recomputeStatusFromAggregates as safety net"
      pattern: "recomputeStatusFromAggregates"
---

<objective>
Enhance the PO UI components with status tooltips, visual state indicators, and the cancellation dialog with cascade feedback.

Purpose: Users need to understand what their PO status means at a glance (POSE-04, POSE-05). Closed and cancelled POs need distinct visual treatment per user decisions. The cancel flow must enforce admin-only access with mandatory reason and show released budget feedback.

Output: Enhanced POStatusBadge with tooltip, updated PO list with visual indicators, updated PO detail with cancel dialog and toast notifications.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/41-po-status-engine-enhancement/41-CONTEXT.md
@.planning/phases/41-po-status-engine-enhancement/41-01-SUMMARY.md
@components/po/po-status-badge.tsx
@components/po/po-card.tsx
@components/po/po-progress-bar.tsx
@components/ui/tooltip.tsx
@app/(dashboard)/po/page.tsx
@app/(dashboard)/po/[id]/page.tsx
@lib/utils/po-status.ts
@lib/actions/po-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance POStatusBadge with tooltip, lock icon, and pulse animation</name>
  <files>components/po/po-status-badge.tsx, components/po/po-card.tsx</files>
  <action>
**1. Update `components/po/po-status-badge.tsx`:**

Keep the existing `POStatusBadge` component as-is (it's used elsewhere). Add a NEW exported component `POStatusBadgeWithTooltip` that wraps it:

```typescript
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Lock } from "lucide-react";
import { generateStatusTooltip } from "@/lib/utils/po-status";
```

Props for `POStatusBadgeWithTooltip`:
- `status: POStatusEnum`
- `totalQty: number`
- `invoicedQty: number`
- `receivedQty: number`
- `showIcon?: boolean` (default true)
- `size?: "sm" | "md"` (default "md")
- `animate?: boolean` (default false - when true, adds `animate-pulse` for 3 seconds then stops)

Implementation:
- Use `generateStatusTooltip(status, totalQty, invoicedQty, receivedQty)` from po-status.ts for tooltip text
- Wrap the existing `POStatusBadge` in Radix Tooltip (TooltipProvider > Tooltip > TooltipTrigger/Content)
- For `status === "closed"`: show Lock icon (h-3.5 w-3.5 text-emerald-400) NEXT TO the badge (outside tooltip trigger, inside a flex container)
- For `animate === true`: apply `animate-pulse` class to the badge wrapper. Use a useEffect with setTimeout(3000) to auto-disable the pulse after 3 seconds by toggling a local state.
- TooltipContent: show tooltip text with `text-xs font-mono` styling, white-space pre-wrap
- For cancelled status: tooltip says "This PO has been cancelled" with the cancellation reason if available (pass optional `cancellationReason` prop)

Keep `ApprovalStatusBadge` unchanged.

**2. Update `components/po/po-card.tsx`:**

- Import `POStatusBadgeWithTooltip` instead of using `POStatusBadge` directly
- Replace the POStatusBadge usage in the card header with `POStatusBadgeWithTooltip`, passing the aggregate quantities
- For cancelled POs: add `line-through` class to the PO number `<code>` element, and add `opacity-60` to the card wrapper div
- For closed POs: add `opacity-75` to the card wrapper div (dimmed but not as much as cancelled)
- The mini progress bar already shows under the financial info - keep this as-is since it already works

Apply these conditional classes using `cn()` from `@/lib/utils`:
```typescript
<div className={cn(
  "tactical-card corner-accents p-4 animate-slide-up cursor-pointer",
  po.status === "cancelled" && "opacity-60",
  po.status === "closed" && "opacity-75"
)} ...>
```

For the PO number:
```typescript
<code className={cn(po.status === "cancelled" && "line-through text-red-400")}>
  {po.po_number || "â€”"}
</code>
```
  </action>
  <verify>
Run `npm run type-check` to verify TypeScript compiles.
Run `npm run lint` to verify no lint errors.
Verify POStatusBadgeWithTooltip is exported from po-status-badge.tsx.
  </verify>
  <done>
POStatusBadgeWithTooltip component renders badge with Radix tooltip showing "X/Y invoiced (Z%), X/Y received (Z%)" on hover. Lock icon appears next to closed PO badges. Badge pulses for 3 seconds when animate=true. POCard shows dimmed opacity for closed POs and strikethrough + opacity for cancelled POs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PO list page with enhanced status display and row styling</name>
  <files>app/(dashboard)/po/page.tsx</files>
  <action>
Update the PO list page with these changes:

**1. Import changes:**
- Import `POStatusBadgeWithTooltip` from `@/components/po/po-status-badge`
- Import `MiniProgressBar` from `@/components/po/po-progress-bar`
- Import `cn` from `@/lib/utils`

**2. List view table - replace POStatusBadge with POStatusBadgeWithTooltip:**
In the list view `<tbody>`, where `<POStatusBadge>` is currently used, replace with:
```tsx
<POStatusBadgeWithTooltip
  status={(po.status || "not_started") as POStatusEnum}
  totalQty={po.line_items_aggregate?.total_quantity ?? 0}
  invoicedQty={po.line_items_aggregate?.total_invoiced ?? 0}
  receivedQty={po.line_items_aggregate?.total_received ?? 0}
  size="sm"
/>
```

**3. List view - add mini dual progress bar under the status badge in the Status cell:**
Combine status badge and mini progress into the same `<td>`:
```tsx
<td className="py-3 px-4">
  <div className="space-y-1.5">
    <POStatusBadgeWithTooltip ... />
    {po.line_items_aggregate?.total_quantity > 0 && (
      <div className="w-24">
        <POProgressBar
          invoicedPercent={progress.invoicedPercent}
          receivedPercent={progress.receivedPercent}
          showLabels={false}
          size="sm"
        />
      </div>
    )}
  </div>
</td>
```
Remove the separate "Progress" column (`<th>` and `<td>`) since the progress bar is now integrated into the Status cell. This reduces the table from 7 columns to 6.

**4. List view - row styling for closed and cancelled POs:**
On the `<tr>` element, apply conditional classes:
```tsx
<tr
  key={po.id}
  className={cn(
    "border-b border-slate-700/50 hover:bg-slate-800/30 transition-colors cursor-pointer",
    po.status === "closed" && "opacity-60",
    po.status === "cancelled" && "opacity-50"
  )}
  onClick={() => (window.location.href = `/po/${po.id}`)}
>
```

**5. List view - PO number styling for cancelled:**
```tsx
<td className="py-3 px-4">
  <code className={cn(
    "text-amber-400 text-sm",
    po.status === "cancelled" && "line-through text-red-400"
  )}>
    {po.po_number}
  </code>
</td>
```

**6. Add "Active" filter option** in the status filter dropdown. Insert it after "All Statuses":
```typescript
{ value: "active", label: "Active (excl. Closed/Cancelled)" },
```
Then update the filter logic in `filteredPOs` to handle the "active" value:
```typescript
if (statusFilter === "active" && (po.status === "closed" || po.status === "cancelled")) return false;
```

**7. Card view** - the POCard component already handles its own styling (updated in Task 1). No additional card view changes needed here.
  </action>
  <verify>
Run `npm run type-check` and `npm run lint`.
Run `npm run dev` and visually verify:
- PO list page loads without errors
- Status badges show tooltips on hover
- Closed PO rows appear dimmed
- Cancelled PO rows appear with strikethrough PO number
- "Active" filter option works to exclude closed/cancelled
  </verify>
  <done>
PO list page shows POStatusBadgeWithTooltip with hover tooltips showing invoiced/received counts. Mini progress bar appears under status badge in list view. Closed rows have reduced opacity. Cancelled rows have strikethrough PO numbers and reduced opacity. Status filter includes "Active" option to exclude closed/cancelled POs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PO detail page with cancel dialog, cascade toast, and safety-net recompute</name>
  <files>app/(dashboard)/po/[id]/page.tsx</files>
  <action>
Significant updates to the PO detail page:

**1. New imports:**
```typescript
import { cancelPO } from "@/lib/actions/po-actions";
import { POStatusBadgeWithTooltip } from "@/components/po/po-status-badge";
import { generateStatusTooltip, recomputeStatusFromAggregates } from "@/lib/utils/po-status";
import { useToast } from "@/components/ui/use-toast";
import { Lock } from "lucide-react";
```

**2. Replace the cancel handler (handleCancelPO):**

Remove the existing `handleCancelPO` that uses `window.confirm` and raw Supabase update.

Add state for cancel dialog:
```typescript
const [showCancelDialog, setShowCancelDialog] = useState(false);
const [cancelReason, setCancelReason] = useState("");
const { toast } = useToast();
```

Create new `handleCancelPO`:
```typescript
const handleCancelPO = async () => {
  if (!cancelReason.trim()) return; // reason is mandatory

  setIsCancelling(true);
  const result = await cancelPO(poId, cancelReason.trim());

  if (result.success) {
    toast({
      title: "PO Cancelled",
      description: `${result.data.poNumber} cancelled. Budget released: ${result.data.releasedAmountEusd.toFixed(2)} EUSD to ${result.data.qmhqRequestId}. New Balance in Hand: ${result.data.newBalanceInHand.toFixed(2)} EUSD`,
    });
    setShowCancelDialog(false);
    setCancelReason("");
    fetchData(); // Refresh page data
  } else {
    toast({
      title: "Cancellation Failed",
      description: result.error,
      variant: "destructive",
    });
  }

  setIsCancelling(false);
};
```

**3. Cancel confirmation dialog:**

Replace the Cancel PO button's onClick to open the dialog instead:
```tsx
onClick={() => setShowCancelDialog(true)}
```

Only show the Cancel button if user `can("admin", "purchase_orders")` (admin role check). The existing `showCancelButton` checks `canCancelPO(status)` - combine both:
```typescript
const showCancelButton = can("admin", "purchase_orders") && canCancelPO(po.status as POStatusEnum);
```

Note: Check how `usePermissions().can()` works in this codebase. The role system is 3-role (admin/qmrl/qmhq). The check should verify the user's role is 'admin'. If `can("admin", ...)` doesn't exist as a valid call, check the permissions hook and use whatever admin check is appropriate (e.g., checking `user.role === 'admin'` from user context).

Render the dialog BELOW the DetailPageLayout (as a modal overlay):
```tsx
{showCancelDialog && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
    <div className="command-panel w-full max-w-md mx-4 p-6">
      <h3 className="text-lg font-semibold text-slate-200 mb-2">Cancel Purchase Order</h3>
      <p className="text-sm text-slate-400 mb-4">
        This action is permanent and cannot be undone. The committed budget will be released back to QMHQ Balance in Hand.
      </p>

      <div className="mb-4">
        <label className="block text-xs text-slate-400 uppercase tracking-wider mb-1.5">
          Cancellation Reason *
        </label>
        <textarea
          value={cancelReason}
          onChange={(e) => setCancelReason(e.target.value)}
          placeholder="Why is this PO being cancelled?"
          className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-200 text-sm placeholder-slate-500 focus:border-amber-500/50 focus:outline-none focus:ring-1 focus:ring-amber-500/30 min-h-[80px] resize-none"
          autoFocus
        />
      </div>

      <div className="flex justify-end gap-2">
        <Button
          variant="outline"
          onClick={() => { setShowCancelDialog(false); setCancelReason(""); }}
          className="border-slate-700"
        >
          Go Back
        </Button>
        <Button
          onClick={handleCancelPO}
          disabled={!cancelReason.trim() || isCancelling}
          className="bg-red-600 hover:bg-red-700 text-white"
        >
          {isCancelling ? (
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          ) : (
            <XCircle className="mr-2 h-4 w-4" />
          )}
          Confirm Cancellation
        </Button>
      </div>
    </div>
  </div>
)}
```

**4. Replace POStatusBadge with POStatusBadgeWithTooltip in the header:**
Replace the existing `<POStatusBadge>` in the header section with:
```tsx
<POStatusBadgeWithTooltip
  status={(po.status || "not_started") as POStatusEnum}
  totalQty={totalQty}
  invoicedQty={invoicedQty}
  receivedQty={receivedQty}
  animate={statusJustChanged}
/>
```

Add state for detecting status changes:
```typescript
const [previousStatus, setPreviousStatus] = useState<string | null>(null);
const [statusJustChanged, setStatusJustChanged] = useState(false);
```

In the fetchData callback, after setting po state, detect status change:
```typescript
if (poData && previousStatus !== null && poData.status !== previousStatus) {
  setStatusJustChanged(true);
  toast({
    title: "Status Updated",
    description: `${poData.po_number} status: ${PO_STATUS_CONFIG[poData.status as POStatusEnum]?.label || poData.status}`,
  });
}
setPreviousStatus(poData?.status || null);
```

**5. Safety-net recompute on page load:**
After line items are fetched and totals calculated, compare DB status with recomputed status:
```typescript
const recomputedStatus = recomputeStatusFromAggregates(
  totalQty, invoicedQty, receivedQty,
  po?.status === 'cancelled'
);
// Log mismatch for debugging (don't override DB - it's authoritative)
if (po && recomputedStatus !== po.status && po.status !== 'cancelled') {
  console.warn(`PO status mismatch: DB=${po.status}, computed=${recomputedStatus}`);
}
```

This is purely diagnostic. The database is authoritative.

**6. Cancelled PO visual treatment on detail page:**
If `po.status === 'cancelled'`:
- Show strikethrough on the PO number: add `line-through` class to the `<code>` element
- Show cancellation details in the Details tab: add a "Cancellation" info card showing reason, timestamp, cancelled by user (query these from the PO record)
- Add `cancelled_at` and `cancellation_reason` to the PO query SELECT

**7. Closed PO visual treatment on detail page:**
If `po.status === 'closed'`:
- Show a small "Locked" indicator near the status badge (Lock icon + "Fully Matched" text in emerald color)
  </action>
  <verify>
Run `npm run type-check` and `npm run lint`.
Run `npm run dev` and verify:
- PO detail page loads without errors
- Status badge shows tooltip on hover
- Cancel button only appears for admin users
- Cancel dialog opens with reason field
- Cancel button is disabled when reason is empty
- After cancel, toast shows released budget details
- Cancelled PO shows strikethrough number and cancellation details
- Closed PO shows lock icon
  </verify>
  <done>
PO detail page shows POStatusBadgeWithTooltip with hover tooltip. Cancel dialog requires mandatory reason, enforces admin-only, shows cascade toast with released budget and QMHQ info. Cancelled POs show strikethrough and cancellation details. Closed POs show lock icon. Safety-net recompute logs mismatches for debugging. Status badge pulses on status change.
  </done>
</task>

</tasks>

<verification>
- `npm run type-check` passes
- `npm run lint` passes
- `npm run dev` serves without errors
- Hovering over any PO status badge shows tooltip with invoiced/received counts
- Closed PO rows in list view are dimmed with lock icon
- Cancelled PO rows show strikethrough PO number
- Cancel button only visible to admin users
- Cancel dialog requires reason (button disabled when empty)
- Cancel success shows toast with released EUSD amount and QMHQ reference
- PO detail badge pulses briefly on status transitions
- Status filter dropdown includes "Active" option
</verification>

<success_criteria>
1. POSE-04: PO status displays as color-coded badge with tooltip on both list and detail pages
2. POSE-05: PO status is non-editable, tooltip explains current state with counts/percentages
3. Status badge shows lock icon for closed POs, strikethrough for cancelled POs
4. Admin-only cancellation with mandatory reason, cascade feedback toast
5. Dual-track mini progress bar visible on PO list under status badge
6. Safety-net recompute detects DB/computed mismatches
</success_criteria>

<output>
After completion, create `.planning/phases/41-po-status-engine-enhancement/41-02-SUMMARY.md`
</output>
