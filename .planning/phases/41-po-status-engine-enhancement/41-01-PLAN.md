---
phase: 41-po-status-engine-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260212200000_po_status_engine_enhancement.sql
  - lib/utils/po-status.ts
  - lib/actions/po-actions.ts
autonomous: true

must_haves:
  truths:
    - "PO status auto-calculates to correct state based on line-item quantities"
    - "When both invoiced and received are partial, status shows partially_invoiced (not partially_received)"
    - "Cancelled POs have reason, timestamp, and user recorded"
    - "Cancellation releases committed budget back to QMHQ Balance in Hand"
    - "Concurrent status calculations are serialized via advisory locks"
    - "Page-load safety net recomputes status from live data"
  artifacts:
    - path: "supabase/migrations/20260212200000_po_status_engine_enhancement.sql"
      provides: "Enhanced calculate_po_status with invoice-first priority, advisory locks, cancellation columns, audit trigger"
      contains: "pg_advisory_xact_lock"
    - path: "lib/actions/po-actions.ts"
      provides: "cancelPO Server Action with admin auth check and cascade feedback"
      exports: ["cancelPO", "CancelPOResult"]
    - path: "lib/utils/po-status.ts"
      provides: "Updated status utilities with recompute helper and tooltip text generator"
      exports: ["calculatePOProgress", "generateStatusTooltip", "PO_STATUS_CONFIG"]
  key_links:
    - from: "supabase/migrations/20260212200000_po_status_engine_enhancement.sql"
      to: "po_line_items.invoiced_quantity, po_line_items.received_quantity"
      via: "calculate_po_status function reads line item quantities"
      pattern: "FROM po_line_items WHERE po_id"
    - from: "lib/actions/po-actions.ts"
      to: "purchase_orders.status"
      via: "Supabase update sets status to cancelled, triggers cascade"
      pattern: "update.*status.*cancelled"
    - from: "supabase/migrations/20260212200000_po_status_engine_enhancement.sql"
      to: "qmhq.total_po_committed"
      via: "Existing update_qmhq_po_committed trigger recalculates on PO status change"
      pattern: "status != 'cancelled'"
---

<objective>
Harden the PO status calculation engine at the database level and create the cancelPO Server Action.

Purpose: The existing `calculate_po_status()` function has a priority bug (partially_received takes precedence over partially_invoiced when both exist) and lacks advisory locks for concurrency safety. This plan fixes the status logic per POSE-03 (invoice-first priority), adds cancellation infrastructure (columns + audit trigger), and creates the Server Action for PO cancellation with cascade feedback.

Output: Migration file with hardened status engine, Server Action for cancellation, updated utility functions.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-po-status-engine-enhancement/41-CONTEXT.md
@.planning/phases/41-po-status-engine-enhancement/41-RESEARCH.md
@supabase/migrations/015_purchase_orders.sql
@supabase/migrations/016_po_line_items.sql
@supabase/migrations/058_advisory_lock_stock_validation.sql
@lib/utils/po-status.ts
@lib/actions/invoice-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration - Fix status priority, add advisory locks, add cancellation infrastructure</name>
  <files>supabase/migrations/20260212200000_po_status_engine_enhancement.sql</files>
  <action>
Create a single migration file that does the following:

**1. Add cancellation columns to purchase_orders:**
```sql
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS cancellation_reason TEXT;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS cancelled_at TIMESTAMPTZ;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS cancelled_by UUID REFERENCES users(id);
```

**2. Replace `calculate_po_status()` with invoice-first priority logic (POSE-03):**

The current function in migration 016 checks `partially_received` before `partially_invoiced`. The new logic must follow this priority order:
- If cancelled -> cancelled (bypass auto-calc)
- If total_ordered = 0 -> not_started
- If total_received >= total_ordered AND total_invoiced >= total_ordered -> closed (3-way match)
- If total_invoiced > 0 AND total_invoiced < total_ordered -> partially_invoiced (INVOICE TAKES PRIORITY - even if some items received)
- If total_invoiced >= total_ordered AND total_received > 0 AND total_received < total_ordered -> partially_received (only after fully invoiced)
- If total_invoiced >= total_ordered AND total_received = 0 -> awaiting_delivery
- Otherwise -> not_started

Add advisory lock at the start of the function using `pg_advisory_xact_lock(hashtext(p_po_id::text))` to serialize concurrent calculations for the same PO. Follow the pattern from migration 058.

**3. Create cancellation audit trigger:**

Create function `zz_audit_po_cancellation()` that fires AFTER UPDATE on purchase_orders. When `NEW.status = 'cancelled' AND OLD.status != 'cancelled'`:
- Look up the cancelling user's full_name from users table
- Insert audit log entry for the PO with action='cancelled', including cancellation_reason
- Insert audit log entry for the parent QMHQ with action='budget_released', showing the released EUSD amount
- Use `zz_` prefix so it fires after other triggers (following migration 040-041 convention)

The audit_logs table uses columns: entity_type, entity_id, action, changes_summary, changed_by, changed_by_name, changed_at. Use SECURITY DEFINER and SET search_path for security.

**4. Add index for cancellation queries:**
```sql
CREATE INDEX IF NOT EXISTS idx_purchase_orders_cancelled_at ON purchase_orders(cancelled_at) WHERE cancelled_at IS NOT NULL;
```

**Important notes:**
- The existing `update_qmhq_po_committed()` trigger in migration 015 already excludes cancelled POs from the SUM (`AND status != 'cancelled'`), so Balance in Hand release happens automatically when status changes to cancelled. No need to duplicate this logic.
- The existing `trigger_update_po_status()` in migration 016 already skips cancelled POs (`AND status != 'cancelled'`). Keep this behavior.
- Use `CREATE OR REPLACE FUNCTION` for all function definitions to make migration idempotent.
  </action>
  <verify>
Run `npx supabase db reset` to apply all migrations including the new one. Verify no errors.

Then validate the status priority logic by checking the function exists:
```sql
SELECT pg_get_functiondef(oid) FROM pg_proc WHERE proname = 'calculate_po_status';
```

Check cancellation columns exist:
```sql
SELECT column_name FROM information_schema.columns WHERE table_name = 'purchase_orders' AND column_name IN ('cancellation_reason', 'cancelled_at', 'cancelled_by');
```

Check audit trigger exists:
```sql
SELECT tgname FROM pg_trigger WHERE tgname = 'zz_audit_po_cancellation';
```
  </verify>
  <done>
Migration applies cleanly. calculate_po_status() uses invoice-first priority with advisory lock. purchase_orders has cancellation_reason, cancelled_at, cancelled_by columns. zz_audit_po_cancellation trigger exists and fires on status change to cancelled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cancelPO Server Action and update po-status utilities</name>
  <files>lib/actions/po-actions.ts, lib/utils/po-status.ts</files>
  <action>
**1. Create `lib/actions/po-actions.ts`** following the exact pattern from `lib/actions/invoice-actions.ts`:

```typescript
'use server';
```

Define `CancelPOResult` type:
```typescript
export type CancelPOResult =
  | {
      success: true;
      data: {
        poNumber: string;
        previousStatus: string;
        releasedAmountEusd: number;
        qmhqRequestId: string;
        newBalanceInHand: number;
      };
    }
  | { success: false; error: string };
```

Implement `cancelPO(poId: string, reason: string): Promise<CancelPOResult>`:
1. Validate auth via `supabase.auth.getUser()`
2. Check user role is 'admin' by querying users table (`role = 'admin'`). Return error "Only administrators can cancel Purchase Orders" if not admin.
3. Fetch PO BEFORE cancel: select po_number, status, total_amount_eusd, qmhq_id, and join qmhq for request_id, total_money_in, total_po_committed
4. Guard: if status is already 'cancelled', return error "PO is already cancelled"
5. Guard: if status is 'closed', return error "Cannot cancel a closed PO. Unlock it first."
6. Execute UPDATE: set status='cancelled', cancellation_reason=reason, cancelled_at=new Date().toISOString(), cancelled_by=user.id, updated_by=user.id
7. Fetch QMHQ AFTER cancel to get new total_po_committed (the existing trigger will have recalculated)
8. Calculate new Balance in Hand: total_money_in - new total_po_committed
9. revalidatePath for '/po', `/po/${poId}`, '/qmhq'
10. Return success with cascade data

**2. Update `lib/utils/po-status.ts`** - add two new functions:

`generateStatusTooltip(status, totalQty, invoicedQty, receivedQty)`:
- Returns a string like "3/5 invoiced (60%), 1/5 received (20%)"
- For cancelled: return "This PO has been cancelled"
- For closed: return "Fully matched: ordered = invoiced = received"
- For not_started with totalQty=0: return "No line items"
- Handle division by zero (totalQty=0)

`recomputeStatusFromAggregates(totalQty, invoicedQty, receivedQty, isCancelled)`:
- Client-side mirror of the database logic for page-load safety net display
- Returns the expected POStatusEnum value using the same invoice-first priority logic
- This is for display comparison only, not for writing back to DB

Keep all existing exports unchanged. Add the new functions as additional named exports.
  </action>
  <verify>
Run `npm run type-check` to verify TypeScript compiles.
Run `npm run lint` to verify no lint errors.

Check that `lib/actions/po-actions.ts` exports `cancelPO` and `CancelPOResult`.
Check that `lib/utils/po-status.ts` exports `generateStatusTooltip` and `recomputeStatusFromAggregates`.
  </verify>
  <done>
cancelPO Server Action validates admin role, sets cancellation fields, returns cascade feedback (released amount, new Balance in Hand, QMHQ request ID). po-status.ts has generateStatusTooltip and recomputeStatusFromAggregates functions. All TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
- Migration applies cleanly with `npx supabase db reset`
- `npm run type-check` passes
- `npm run lint` passes
- calculate_po_status returns partially_invoiced when both invoiced and received are partial (not partially_received)
- Cancellation columns exist on purchase_orders table
- cancelPO Server Action is importable and type-safe
- generateStatusTooltip produces correct tooltip text for all 6 states
</verification>

<success_criteria>
1. Database status engine uses invoice-first priority per POSE-03
2. Advisory locks prevent concurrent status calculation race conditions
3. PO cancellation records reason, timestamp, and user
4. Cancellation audit logs created for both PO and parent QMHQ
5. cancelPO Server Action enforces admin-only access and returns cascade feedback
6. Status utility functions support tooltip generation and client-side recompute
</success_criteria>

<output>
After completion, create `.planning/phases/41-po-status-engine-enhancement/41-01-SUMMARY.md`
</output>
