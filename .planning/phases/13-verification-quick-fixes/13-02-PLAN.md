---
phase: 13-verification-quick-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/fulfillment-progress-bar.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
  - app/(dashboard)/inventory/stock-out/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMHQ detail page shows fulfillment progress indicator for each item"
    - "Stock-out tab shows per-item fulfillment progress bar"
    - "QMHQ header area shows aggregate fulfillment summary for item route"
    - "General stock-out form only shows items not assigned to QMHQ"
    - "Issue Stock button is disabled with tooltip when item is fully fulfilled"
    - "Stock-out quantity cannot exceed remaining unfulfilled quantity"
  artifacts:
    - path: "components/qmhq/fulfillment-progress-bar.tsx"
      provides: "Visual progress bar for fulfillment tracking"
      exports: ["FulfillmentProgressBar"]
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Fulfillment progress in header and stock-out tab"
      contains: "FulfillmentProgressBar"
    - path: "app/(dashboard)/inventory/stock-out/page.tsx"
      provides: "Item filtering and max quantity validation"
      contains: "qmhqItemIds"
  key_links:
    - from: "QMHQ detail stock-out tab"
      to: "FulfillmentProgressBar"
      via: "component import"
      pattern: "FulfillmentProgressBar"
    - from: "Issue Stock button"
      to: "isFullyIssued state"
      via: "disabled prop"
      pattern: "disabled=\\{isFullyIssued\\}"
    - from: "General stock-out form"
      to: "qmhq_items filter"
      via: "client-side filtering"
      pattern: "qmhqItemIds\\.has"
---

<objective>
Add fulfillment progress tracking to QMHQ item route and restrict stock-out access to prevent duplicate fulfillment channels.

Purpose: Users can see fulfillment progress and cannot over-issue items, fulfilling FULF-01, FULF-02, and FULF-03 requirements.
Output: Visual progress bar component, QMHQ detail page enhancements, and stock-out form filtering.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-verification-quick-fixes/13-CONTEXT.md
@.planning/phases/13-verification-quick-fixes/13-RESEARCH.md

# Key files for existing patterns
@components/po/po-progress-bar.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
@app/(dashboard)/inventory/stock-out/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FulfillmentProgressBar component</name>
  <files>
    components/qmhq/fulfillment-progress-bar.tsx
  </files>
  <action>
Create a new FulfillmentProgressBar component based on the POProgressBar pattern but simplified for single-metric fulfillment:

1. Create file at components/qmhq/fulfillment-progress-bar.tsx

2. Component props:
   ```typescript
   interface FulfillmentProgressBarProps {
     issuedQty: number;
     requestedQty: number;
     showLabel?: boolean;  // default: true
     size?: "sm" | "md";   // default: "md"
   }
   ```

3. Implementation:
   - Calculate percent: `Math.min(100, Math.round((issuedQty / requestedQty) * 100))`
   - Use emerald color gradient (matches existing "Complete" badge color)
   - Label format: "Fulfilled" on left, "{issued}/{requested}" on right
   - Height: sm = h-1.5, md = h-2
   - Background: bg-slate-700/50
   - Bar: bg-gradient-to-r from-emerald-600 to-emerald-500

4. Pattern follows components/po/po-progress-bar.tsx but with:
   - Single bar instead of dual bars
   - Emerald color (not amber/emerald split)
   - Quantity display instead of percentage

5. Create index export in components/qmhq/index.ts if it exists, otherwise just export from component file directly
  </action>
  <verify>
TypeScript compiles: `npm run type-check`
Component renders correctly when imported
  </verify>
  <done>
FulfillmentProgressBar component created with emerald styling and quantity-based labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate progress bar and enhance stock-out tab in QMHQ detail</name>
  <files>
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Enhance QMHQ detail page with fulfillment progress indicators:

1. Import FulfillmentProgressBar:
   ```typescript
   import { FulfillmentProgressBar } from '@/components/qmhq/fulfillment-progress-bar';
   ```

2. Add progress summary in QMHQ header (for item route only):
   - Location: After the basic info cards in the details tab (around line 685)
   - Only show when qmhq.route_type === "item"
   - For each item in qmhqItems, show a compact progress row:
     ```tsx
     {qmhq.route_type === "item" && qmhqItems.length > 0 && (
       <div className="mt-6 p-4 rounded-lg bg-slate-800/30 border border-slate-700">
         <p className="text-xs text-slate-400 uppercase tracking-wider mb-3">Fulfillment Progress</p>
         <div className="space-y-3">
           {qmhqItems.map((item) => {
             const issuedQty = stockOutTransactions
               .filter(t => t.item_id === item.item_id)
               .reduce((sum, t) => sum + (t.quantity || 0), 0);
             return (
               <div key={item.id} className="space-y-1">
                 <div className="flex items-center justify-between text-sm">
                   <span className="text-slate-200">{item.item?.name}</span>
                   {item.item?.sku && <code className="text-amber-400 text-xs">{item.item.sku}</code>}
                 </div>
                 <FulfillmentProgressBar
                   issuedQty={issuedQty}
                   requestedQty={item.quantity}
                   size="sm"
                 />
               </div>
             );
           })}
         </div>
       </div>
     )}
     ```

3. Replace text display with progress bar in stock-out tab (around line 743):
   - Keep the existing item summary structure
   - Add FulfillmentProgressBar after the text stats:
     ```tsx
     <FulfillmentProgressBar
       issuedQty={issuedQty}
       requestedQty={item.quantity}
       size="sm"
     />
     ```

4. Enhance "Issue Items" button (around line 721):
   - Calculate if all items are fully fulfilled
   - Disable button when fully fulfilled
   - Change button text to "Fully Issued" when disabled
   - Add tooltip explaining why disabled
   ```tsx
   const allItemsFullyIssued = useMemo(() => {
     return qmhqItems.every((item) => {
       const issuedQty = stockOutTransactions
         .filter(t => t.item_id === item.item_id)
         .reduce((sum, t) => sum + (t.quantity || 0), 0);
       return issuedQty >= item.quantity;
     });
   }, [qmhqItems, stockOutTransactions]);

   // In JSX - wrap button with tooltip when disabled
   <Button
     disabled={allItemsFullyIssued}
     className={allItemsFullyIssued
       ? "bg-slate-600 cursor-not-allowed"
       : "bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400"
     }
   >
     <Plus className="mr-2 h-4 w-4" />
     {allItemsFullyIssued ? "Fully Issued" : "Issue Items"}
   </Button>
   ```
   - If disabled, show as non-link (remove Link wrapper or use div)

5. Add useMemo import if not already present
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. QMHQ detail page shows progress bar in header for item route
3. Stock-out tab shows progress bar per item
4. Issue Items button is disabled when all items fully issued
5. Issue Items button changes text to "Fully Issued" when disabled
  </verify>
  <done>
QMHQ detail page displays fulfillment progress in header and stock-out tab with enhanced Issue Items button state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Filter QMHQ items from general stock-out form</name>
  <files>
    app/(dashboard)/inventory/stock-out/page.tsx
  </files>
  <action>
Modify general stock-out form to exclude items assigned to QMHQ item routes:

1. Fetch QMHQ-assigned items after fetching all items (in fetchReferenceData):
   ```typescript
   // Fetch items assigned to QMHQ item routes
   const { data: qmhqItemsData } = await supabase
     .from("qmhq_items")
     .select(`
       item_id,
       qmhq!inner(id, route_type)
     `)
     .eq("qmhq.route_type", "item");

   const qmhqItemIds = new Set(qmhqItemsData?.map(qi => qi.item_id) || []);
   ```

2. Filter items before setting state:
   ```typescript
   if (itemsData) {
     // Filter out items assigned to active QMHQ
     const availableItems = itemsData.filter(item => !qmhqItemIds.has(item.id));
     setItems(availableItems as ItemWithStock[]);
   }
   ```

3. When coming from QMHQ (qmhqId exists), do NOT filter:
   - The stock-out form should show items when accessed from QMHQ detail page
   - Only filter when accessed directly (general stock-out form)
   ```typescript
   if (itemsData) {
     if (qmhqId) {
       // Coming from QMHQ - show all items (filtered by QMHQ's items in the form)
       setItems(itemsData as ItemWithStock[]);
     } else {
       // General stock-out - exclude QMHQ items
       const availableItems = itemsData.filter(item => !qmhqItemIds.has(item.id));
       setItems(availableItems as ItemWithStock[]);
     }
   }
   ```

4. Add validation for maximum quantity when coming from QMHQ:
   - Fetch the qmhq_items for the specific QMHQ
   - Calculate remaining unfulfilled quantity per item
   - Validate quantity input doesn't exceed remaining
   - Show max issuable quantity as helper text

5. In the quantity input section, add remaining quantity display:
   ```tsx
   {qmhqId && selectedItemId && (
     <p className="text-xs text-slate-400 mt-1">
       Max issuable: {remainingQty} (requested: {requestedQty}, already issued: {issuedQty})
     </p>
   )}
   ```

6. Add validation on form submit:
   ```typescript
   if (qmhqId && remainingQty !== undefined && parsedQuantity > remainingQty) {
     setError(`Cannot issue more than remaining quantity (${remainingQty})`);
     return;
   }
   ```
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. General stock-out form (/inventory/stock-out) does not show items assigned to QMHQ
3. Stock-out from QMHQ detail page (/inventory/stock-out?qmhq=xxx) shows correct items
4. Quantity validation prevents over-issuance when coming from QMHQ
5. Max issuable quantity is displayed as helper text
  </verify>
  <done>
General stock-out form filters QMHQ items, and QMHQ stock-out validates max quantity to prevent over-issuance.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. FulfillmentProgressBar component displays correctly with emerald styling
3. QMHQ detail header shows fulfillment progress for item route
4. QMHQ stock-out tab shows progress bar per item
5. Issue Items button disabled with "Fully Issued" text when all items complete
6. General stock-out form excludes QMHQ-assigned items
7. QMHQ stock-out shows max issuable quantity and validates input
8. Cannot issue more than remaining unfulfilled quantity
</verification>

<success_criteria>
- [ ] FulfillmentProgressBar component created with emerald styling
- [ ] QMHQ header shows fulfillment progress for item route (FULF-03)
- [ ] Stock-out tab shows per-item progress bar (FULF-03)
- [ ] Issue Items button disabled when fully fulfilled
- [ ] General stock-out filters QMHQ items (FULF-01)
- [ ] Max quantity validation prevents over-issuance (FULF-02)
- [ ] Helper text shows remaining quantity for QMHQ stock-out
</success_criteria>

<output>
After completion, create `.planning/phases/13-verification-quick-fixes/13-02-SUMMARY.md`
</output>
