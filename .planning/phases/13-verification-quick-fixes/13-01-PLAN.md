---
phase: 13-verification-quick-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/files/attachments-tab.tsx
  - app/(dashboard)/qmrl/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User who uploaded an attachment can delete it from QMRL detail page"
    - "User who uploaded an attachment can delete it from QMHQ detail page"
    - "Admin and Quartermaster can delete any attachment regardless of uploader"
    - "Users cannot delete attachments uploaded by others (unless admin/quartermaster)"
  artifacts:
    - path: "components/files/attachments-tab.tsx"
      provides: "Per-file permission check function passed to FileCard"
      contains: "canDeleteFile"
    - path: "app/(dashboard)/qmrl/[id]/page.tsx"
      provides: "Per-file delete permission check"
      contains: "canDeleteFile"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "Per-file delete permission check"
      contains: "canDeleteFile"
  key_links:
    - from: "AttachmentsTab"
      to: "FileCard.canDelete"
      via: "per-file function call"
      pattern: "canDeleteFile\\(file\\)"
    - from: "canDeleteFile"
      to: "user.id vs file.uploaded_by"
      via: "ownership comparison"
      pattern: "file\\.uploaded_by === user\\.id"
---

<objective>
Fix attachment delete permission UI to match RLS policy (migration 037). Currently, UI only allows admin/quartermaster to delete files, but RLS policy allows users to delete their own uploads.

Purpose: Users can delete their own file uploads, fulfilling ATCH-01 and ATCH-02 requirements.
Output: Updated permission logic in QMRL and QMHQ detail pages that checks per-file ownership.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-verification-quick-fixes/13-CONTEXT.md
@.planning/phases/13-verification-quick-fixes/13-RESEARCH.md

# Key files to understand current implementation
@components/files/attachments-tab.tsx
@components/files/file-card.tsx
@app/(dashboard)/qmrl/[id]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AttachmentsTab to accept per-file permission function</name>
  <files>
    components/files/attachments-tab.tsx
  </files>
  <action>
Modify AttachmentsTab component to accept a canDeleteFile callback prop instead of boolean canEdit:

1. Update AttachmentsTabProps interface:
   - Change `canEdit?: boolean` to `canDeleteFile?: (file: FileAttachmentWithUploader) => boolean`
   - Add `canUpload?: boolean` for controlling upload capability (replaces canEdit for uploads)

2. Update FileCard rendering in the file grid:
   - Change `canDelete={canEdit}` to `canDelete={canDeleteFile?.(file) ?? false}`
   - This passes per-file permission check result

3. Update FileDropzone visibility:
   - Use `canUpload` prop to control dropzone visibility (default: true)

4. Keep backward compatibility:
   - If neither prop provided, default to showing upload and no delete (safe default)

The key insight: canEdit was a single boolean for all files. Now we need per-file checks because permission depends on who uploaded each file.
  </action>
  <verify>
TypeScript compiles without errors: `npm run type-check`
  </verify>
  <done>
AttachmentsTab accepts canDeleteFile callback prop and passes per-file permission to FileCard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update QMRL and QMHQ detail pages with per-file permission check</name>
  <files>
    app/(dashboard)/qmrl/[id]/page.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
Update both detail pages to implement per-file permission logic matching RLS policy:

1. In QMRL detail page (app/(dashboard)/qmrl/[id]/page.tsx):
   - Replace `const canEditAttachments = user?.role === 'admin' || user?.role === 'quartermaster';`
   - With a canDeleteFile callback:
     ```typescript
     const canDeleteFile = useCallback((file: FileAttachmentWithUploader) => {
       if (!user) return false;
       // Admin and quartermaster can delete any file
       if (user.role === 'admin' || user.role === 'quartermaster') return true;
       // Users can delete their own uploads
       return file.uploaded_by === user.id;
     }, [user]);
     ```
   - Update AttachmentsTab usage:
     - Change `canEdit={canEditAttachments}` to `canDeleteFile={canDeleteFile}`
     - Add `canUpload={true}` (all users can upload)
   - Import FileAttachmentWithUploader type from '@/lib/actions/files'

2. In QMHQ detail page (app/(dashboard)/qmhq/[id]/page.tsx):
   - Same changes as QMRL detail page
   - Replace canEditAttachments with canDeleteFile callback
   - Update AttachmentsTab props

This matches the RLS policy in migration 037_file_attachments_delete_own.sql which allows:
- Admin/quartermaster: full delete access
- Other users: can delete files where uploaded_by = auth.uid()
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Manual test: Login as requester, upload file to QMRL, verify delete button appears on own file
3. Manual test: Login as different user, verify delete button hidden on files not uploaded by them
4. Manual test: Login as admin, verify delete button appears on all files
  </verify>
  <done>
QMRL and QMHQ detail pages check per-file ownership for delete permission, matching RLS policy behavior.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. User who uploaded file sees delete button on their own attachments
3. User cannot see delete button on files uploaded by others
4. Admin/Quartermaster sees delete button on all files
5. Delete confirmation dialog shows filename and works correctly
6. Toast shows "Attachment deleted" on successful delete
</verification>

<success_criteria>
- [ ] AttachmentsTab accepts canDeleteFile callback prop
- [ ] QMRL detail page implements per-file permission check
- [ ] QMHQ detail page implements per-file permission check
- [ ] Users can delete their own uploads (ATCH-01)
- [ ] Admin/Quartermaster can delete any file (ATCH-02)
- [ ] Delete button hidden for files user cannot delete
</success_criteria>

<output>
After completion, create `.planning/phases/13-verification-quick-fixes/13-01-SUMMARY.md`
</output>
