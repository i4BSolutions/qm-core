---
phase: 44-po-edit-capability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/po/[id]/edit/page.tsx
  - lib/actions/po-actions.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to PO edit page from detail page Edit button"
    - "User can modify supplier, notes, and expected delivery date"
    - "Line items, amounts, currency, and exchange rate are displayed read-only (not editable)"
    - "Edit page shows clear block message when PO status is closed or cancelled"
    - "All edits trigger audit logging with before/after values"
  artifacts:
    - path: "app/(dashboard)/po/[id]/edit/page.tsx"
      provides: "PO edit page with header-only editing"
      min_lines: 100
    - path: "lib/actions/po-actions.ts"
      provides: "updatePO server action with audit logging"
      exports: ["updatePO"]
  key_links:
    - from: "app/(dashboard)/po/[id]/page.tsx"
      to: "app/(dashboard)/po/[id]/edit/page.tsx"
      via: "Link href={/po/${poId}/edit}"
      pattern: "href.*po.*edit"
    - from: "app/(dashboard)/po/[id]/edit/page.tsx"
      to: "lib/actions/po-actions.ts"
      via: "updatePO server action call"
      pattern: "updatePO"
    - from: "app/(dashboard)/po/[id]/edit/page.tsx"
      to: "lib/utils/po-status.ts"
      via: "canEditPO guard check"
      pattern: "canEditPO"
---

<objective>
Build a PO edit page that allows users to modify header fields (supplier, notes, expected delivery date, contact/sign persons) while keeping line items and financial data immutable. Block editing for closed/cancelled POs with a clear message.

Purpose: Fulfills POED-01 and POED-02 -- gives users the ability to correct PO metadata after creation without risking financial data integrity.
Output: Working PO edit page at `/po/[id]/edit` with server-side update action and audit logging.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@app/(dashboard)/qmhq/[id]/edit/page.tsx
@app/(dashboard)/po/[id]/page.tsx
@app/(dashboard)/po/new/page.tsx
@lib/actions/po-actions.ts
@lib/utils/po-status.ts
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updatePO server action with audit logging</name>
  <files>lib/actions/po-actions.ts</files>
  <action>
Add an `updatePO` server action to the existing `lib/actions/po-actions.ts` file. Follow the same pattern as `cancelPO` and `unlockClosedPO` already in that file.

The action must:
1. Accept `poId: string` and `data: { supplier_id?: string, notes?: string, expected_delivery_date?: string | null, contact_person_name?: string | null, sign_person_name?: string | null, authorized_signer_name?: string | null }`
2. Validate authentication (get user from supabase.auth.getUser())
3. Fetch the PO BEFORE update to get current values for audit comparison
4. Guard: return error if `status === 'closed' || status === 'cancelled'` -- message "Cannot edit a closed or cancelled PO"
5. Build update object from provided data fields (only include fields that are present in the input), always set `updated_by: user.id`
6. Execute `supabase.from('purchase_orders').update(updateData).eq('id', poId)`
7. Create audit log entry in `audit_logs` table with: `entity_type: 'purchase_orders'`, `entity_id: poId`, `action: 'update'`, `old_values` (JSONB of changed fields before), `new_values` (JSONB of changed fields after), `summary: 'PO header fields updated'`, `changed_by: user.id`
8. Revalidate paths: `/po`, `/po/${poId}`
9. Return `{ success: true, data: { poNumber } }` or `{ success: false, error: string }`

Export the result type as `UpdatePOResult`. Follow the same try/catch and error handling pattern as `cancelPO`.
  </action>
  <verify>Run `npx tsc --noEmit` -- no new type errors in po-actions.ts</verify>
  <done>updatePO function exported from lib/actions/po-actions.ts, accepts header fields only, guards against closed/cancelled status, creates audit log entry with old/new values</done>
</task>

<task type="auto">
  <name>Task 2: Create PO edit page with header-only editing and status guard</name>
  <files>app/(dashboard)/po/[id]/edit/page.tsx</files>
  <action>
Create the PO edit page following the exact same pattern as `app/(dashboard)/qmhq/[id]/edit/page.tsx`. Use the same composite components (FormSection, FormField, PageHeader) and Tailwind styling conventions.

Page structure:
1. "use client" directive at top
2. Fetch PO data on mount: `supabase.from('purchase_orders').select('*, supplier:suppliers(id, name, company_name)').eq('id', poId).single()`
3. Also fetch suppliers list: `supabase.from('suppliers').select('*').eq('is_active', true).order('name')` and contact persons: `supabase.from('contact_persons').select('id, name, position').eq('is_active', true).order('name')`
4. Guard check at render time: if `po.status === 'closed' || po.status === 'cancelled'`, show a block message panel (red-tinted command-panel with AlertTriangle icon, message "This PO cannot be edited because it is {closed/cancelled}", and a Back button linking to `/po/${poId}`). Do NOT render the edit form.
5. Form state for editable fields only:
   - `supplier_id` (Select dropdown from suppliers list)
   - `expected_delivery_date` (DatePicker component)
   - `notes` (Textarea)
   - `contact_person_name` (Select from contact persons, storing name string)
   - `sign_person_name` (Select from contact persons, storing name string)
   - `authorized_signer_name` (Select from contact persons, storing name string)
6. Read-only display section showing immutable fields (NOT in form inputs -- just display text):
   - PO Number (code badge)
   - QMHQ Reference (link)
   - PO Date
   - Currency
   - Exchange Rate
   - Total Amount with EUSD (using CurrencyDisplay component)
   - Line items count ("X line items -- not editable")
7. Form layout:
   - Header: Back button (links to `/po/${poId}`), PageHeader with title "Edit Purchase Order", description showing PO number in amber code badge, badge showing "Edit" with Edit icon
   - FormSection "Editable Fields" with icon Building2: supplier select, expected delivery date picker, contact/sign person selects, notes textarea
   - FormSection "Read-Only Information" with icon Lock: display immutable fields in a grid, styled with `opacity-70` and "These fields cannot be changed after PO creation" helper text
   - Action buttons: Cancel (links back to detail), Save Changes (calls updatePO server action)
8. On submit: call `updatePO(poId, formData)` from `@/lib/actions/po-actions`. On success, show toast "PO updated successfully" and redirect to `/po/${poId}`. On error, show destructive toast with error message.
9. Loading state: Loader2 spinner with "Loading PO data..." text (same pattern as QMHQ edit)
10. Not found state: AlertTriangle with "Purchase Order Not Found" and back button

Import the following from existing codebase:
- `FormSection, FormField, PageHeader` from `@/components/composite`
- `Button` from `@/components/ui/button`
- `Select, SelectContent, SelectItem, SelectTrigger, SelectValue` from `@/components/ui/select`
- `Textarea` from `@/components/ui/textarea`
- `DatePicker` from `@/components/ui/date-picker`
- `CurrencyDisplay` from `@/components/ui/currency-display`
- `useToast` from `@/components/ui/use-toast`
- `useAuth` from `@/components/providers/auth-provider`
- `updatePO` from `@/lib/actions/po-actions`
- Icons: ArrowLeft, Loader2, Save, Building2, Lock, AlertTriangle, Edit, ShoppingCart from lucide-react
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors
2. Run `npm run build` -- page compiles successfully
3. Visit `/po/{any-po-id}/edit` in browser -- page loads with PO data pre-filled
  </verify>
  <done>
- PO edit page renders at `/po/[id]/edit` with editable header fields and read-only immutable fields
- Closed/cancelled POs show block message instead of edit form
- Save button calls updatePO server action and redirects on success
- Edit button on PO detail page (already wired) navigates to this page
- Audit log created for every edit with old/new values
  </done>
</task>

</tasks>

<verification>
1. Navigate to any non-closed, non-cancelled PO detail page -- Edit button is visible and links to `/po/{id}/edit`
2. On edit page, supplier/notes/delivery date/signer fields are editable; currency, exchange rate, amounts, line items are displayed read-only
3. Change supplier and notes, click Save -- redirects to detail page showing updated values
4. Check audit_logs table -- entry exists with old_values and new_values for the changed fields
5. Navigate to a closed PO's edit page -- sees block message "This PO cannot be edited because it is closed", no edit form rendered
6. Navigate to a cancelled PO's edit page -- sees block message "This PO cannot be edited because it is cancelled", no edit form rendered
</verification>

<success_criteria>
- PO edit page loads with pre-filled header data from existing PO
- Only supplier, notes, expected delivery date, and signer names are editable
- Line items, amounts, currency, exchange rate shown as read-only
- Closed/cancelled POs display block message instead of form
- Successful edit creates audit log entry and redirects to detail page
- TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-po-edit-capability/44-01-SUMMARY.md`
</output>
