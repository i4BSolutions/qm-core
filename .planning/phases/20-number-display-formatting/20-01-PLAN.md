---
phase: 20-number-display-formatting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ui/amount-input.tsx
  - components/ui/exchange-rate-input.tsx
  - components/ui/currency-display.tsx
  - app/(dashboard)/invoice/new/page.tsx
  - app/(dashboard)/po/new/page.tsx
  - app/(dashboard)/inventory/stock-in/page.tsx
  - app/(dashboard)/qmhq/new/[route]/page.tsx
  - components/qmhq/transaction-dialog.tsx
  - components/invoice/invoice-line-items-table.tsx
  - components/po/po-line-items-table.tsx
autonomous: true

must_haves:
  truths:
    - "Amount input fields display thousand separators as user types (1000 -> 1,000)"
    - "Separators are stripped before form submission (clean numeric values)"
    - "Large amounts display responsively without breaking layout"
    - "Currency display shows full value on hover when truncated"
  artifacts:
    - path: "components/ui/amount-input.tsx"
      provides: "NumericFormat wrapper for amount inputs with thousand separators"
      exports: ["AmountInput"]
    - path: "components/ui/exchange-rate-input.tsx"
      provides: "Exchange rate input with 4 decimal places"
      exports: ["ExchangeRateInput"]
    - path: "components/ui/currency-display.tsx"
      provides: "Enhanced CurrencyDisplay with truncation support"
      exports: ["CurrencyDisplay", "CurrencyInline"]
  key_links:
    - from: "components/ui/amount-input.tsx"
      to: "react-number-format"
      via: "NumericFormat component"
      pattern: "import.*NumericFormat.*from.*react-number-format"
    - from: "app/(dashboard)/invoice/new/page.tsx"
      to: "components/ui/amount-input.tsx"
      via: "AmountInput import"
      pattern: "import.*AmountInput.*from.*@/components/ui/amount-input"
---

<objective>
Implement thousand separator formatting for amount input fields and responsive display for large currency values.

Purpose: Users see formatted numbers (1,234.56) while typing for better readability, and large amounts display without breaking container layouts.

Output: AmountInput and ExchangeRateInput components using react-number-format, enhanced CurrencyDisplay with truncation, all forms migrated.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-number-display-formatting/20-RESEARCH.md

# Existing components to understand patterns
@components/ui/input.tsx
@components/ui/currency-display.tsx
@lib/utils/number-input.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AmountInput and ExchangeRateInput components</name>
  <files>
    components/ui/amount-input.tsx
    components/ui/exchange-rate-input.tsx
    package.json
  </files>
  <action>
1. Install react-number-format:
   ```bash
   npm install react-number-format@^5.4.4
   ```

2. Create `components/ui/amount-input.tsx`:
   - "use client" directive (required for react-number-format)
   - Import NumericFormat, NumberFormatValues from react-number-format
   - Import Input from @/components/ui/input
   - Export AmountInputProps interface extending Omit<InputProps, "value" | "onChange" | "type">
   - Props: value (string), onValueChange (value: string) => void, decimalScale (default 2), fixedDecimalScale (default false)
   - Use forwardRef pattern matching Input component
   - NumericFormat with:
     - thousandSeparator=","
     - decimalScale={decimalScale}
     - allowNegative={false}
     - customInput={Input}
     - getInputRef={ref}
   - handleValueChange extracts values.value (unformatted) and passes to onValueChange
   - Apply font-mono class and hide spinner buttons

3. Create `components/ui/exchange-rate-input.tsx`:
   - Simple wrapper around AmountInput with decimalScale={4}
   - Export ExchangeRateInputProps and ExchangeRateInput component

Note: The existing handleAmountKeyDown/handleExchangeRateKeyDown utilities remain for any non-formatted inputs but are NOT used with NumericFormat (it handles validation internally).
  </action>
  <verify>
    - `npm run type-check` passes
    - `npm run lint` passes
    - Files exist at components/ui/amount-input.tsx and components/ui/exchange-rate-input.tsx
  </verify>
  <done>
    - AmountInput component created with thousand separator formatting
    - ExchangeRateInput component created with 4 decimal places
    - react-number-format installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate forms to use AmountInput/ExchangeRateInput</name>
  <files>
    app/(dashboard)/invoice/new/page.tsx
    app/(dashboard)/po/new/page.tsx
    app/(dashboard)/inventory/stock-in/page.tsx
    app/(dashboard)/qmhq/new/[route]/page.tsx
    components/qmhq/transaction-dialog.tsx
    components/invoice/invoice-line-items-table.tsx
    components/po/po-line-items-table.tsx
  </files>
  <action>
For each file, replace amount/exchange rate inputs:

**Pattern before:**
```tsx
<Input
  type="text"
  inputMode="decimal"
  value={amount}
  onChange={(e) => setAmount(e.target.value)}
  onKeyDown={handleAmountKeyDown}
  className="font-mono ..."
/>
```

**Pattern after:**
```tsx
<AmountInput
  value={amount}
  onValueChange={setAmount}
  placeholder="0.00"
  // other props (disabled, className for width, etc.)
/>
```

**Specific migrations:**

1. `app/(dashboard)/invoice/new/page.tsx`:
   - Line ~543: exchangeRate input -> ExchangeRateInput
   - Line ~669: unit price in step 3 table -> AmountInput
   - Remove handleExchangeRateKeyDown, handleAmountKeyDown from imports (keep handleQuantityKeyDown)

2. `app/(dashboard)/po/new/page.tsx`:
   - Line ~457: exchangeRate input -> ExchangeRateInput
   - Remove handleExchangeRateKeyDown from imports

3. `app/(dashboard)/inventory/stock-in/page.tsx`:
   - Line ~803: unit cost in line items -> AmountInput
   - Line ~896: manual unit cost -> AmountInput
   - Line ~931: manual exchange rate -> ExchangeRateInput
   - Remove handleAmountKeyDown, handleExchangeRateKeyDown from imports

4. `app/(dashboard)/qmhq/new/[route]/page.tsx`:
   - Line ~581: expense amount -> AmountInput
   - Line ~612: expense exchange rate -> ExchangeRateInput
   - Line ~677: PO budget amount -> AmountInput
   - Line ~708: PO exchange rate -> ExchangeRateInput
   - Remove handleAmountKeyDown, handleExchangeRateKeyDown from imports

5. `components/qmhq/transaction-dialog.tsx`:
   - Line ~322: amount -> AmountInput
   - Line ~354: exchange rate -> ExchangeRateInput
   - Remove handleAmountKeyDown, handleExchangeRateKeyDown from imports

6. `components/invoice/invoice-line-items-table.tsx`:
   - Line ~168: unit price -> AmountInput
   - Remove handleAmountKeyDown from imports (keep handleQuantityKeyDown)

7. `components/po/po-line-items-table.tsx`:
   - Line ~200: unit price -> AmountInput
   - Remove handleAmountKeyDown from imports (keep handleQuantityKeyDown)

**Important:** State variables remain string type. The onValueChange callback receives unformatted values (e.g., "1234.56" not "1,234.56"). No changes needed to form submission logic since parseFloat works on unformatted values.
  </action>
  <verify>
    - `npm run type-check` passes
    - `npm run lint` passes
    - `npm run dev` starts without errors
    - Manual test: Navigate to /invoice/new, type "1234567" in exchange rate field, see "1,234,567" formatted
    - Manual test: Submit form, verify clean numeric value submitted (no commas in database)
  </verify>
  <done>
    - All 7 files migrated to use AmountInput/ExchangeRateInput
    - Thousand separators display while typing
    - Clean numeric values submitted to database
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance CurrencyDisplay with truncation</name>
  <files>
    components/ui/currency-display.tsx
  </files>
  <action>
Enhance CurrencyDisplay component to handle overflow:

1. Add `truncate?: boolean` prop (default false)
2. Add `min-w-0` to container div (required for flex child truncation)
3. When truncate is true:
   - Add `truncate max-w-full` classes to both primary and secondary spans
   - Add `title` attribute with full formatted value for hover tooltip

**Updated component structure:**
```tsx
<div className={cn("flex flex-col min-w-0", align === "right" && "items-end", className)}>
  <span
    className={cn(
      "font-mono text-slate-200",
      styles.primary,
      truncate && "truncate max-w-full"
    )}
    title={truncate ? `${formatCurrency(displayAmount)} ${currency}` : undefined}
  >
    {formatCurrency(displayAmount)} {currency}
  </span>
  <span
    className={cn(
      "font-mono text-slate-400",
      styles.secondary,
      truncate && "truncate max-w-full"
    )}
    title={truncate ? `${formatCurrency(eusdValue)} EUSD` : undefined}
  >
    {formatCurrency(eusdValue)} EUSD
  </span>
</div>
```

4. Also update CurrencyInline with similar truncation support:
   - Add `truncate?: boolean` prop
   - Apply `truncate` class and title when enabled

Note: min-w-0 is critical - without it, flex children won't shrink below their content width, preventing truncation.
  </action>
  <verify>
    - `npm run type-check` passes
    - `npm run lint` passes
    - Manual test: On a page with CurrencyDisplay in a constrained width, verify large amounts truncate with "..." and show full value on hover
  </verify>
  <done>
    - CurrencyDisplay supports truncate prop
    - CurrencyInline supports truncate prop
    - Large amounts truncate with title tooltip for full value
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. All amount inputs show thousand separators while typing
3. Form submissions contain clean numeric values (no commas)
4. CurrencyDisplay truncates gracefully in tight containers
5. No TypeScript or lint errors
</verification>

<success_criteria>
1. Amount input fields show thousand separators as user types (1000 -> 1,000)
2. Separators are stripped before form submission (clean numeric values)
3. Large amounts (millions/billions) display responsively without overflow
4. Currency display components handle long values without breaking layout
</success_criteria>

<output>
After completion, create `.planning/phases/20-number-display-formatting/20-01-SUMMARY.md`
</output>
