---
phase: 43-pdf-export-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - lib/pdf/documents/invoice-pdf.tsx
  - app/(dashboard)/invoice/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Download PDF' button on invoice detail page and receive a PDF file downloaded to their browser"
    - "Invoice PDF contains header with invoice number, status badge, invoice date, and exchange rate"
    - "Invoice PDF contains line items table with item name, SKU, qty, unit price, line total, and received qty"
    - "Invoice PDF shows dual currency (original + EUSD) for invoice total"
    - "Invoice PDF includes full supplier block (company name, contact person, email, phone)"
    - "Invoice PDF includes PO summary (PO number, supplier, PO total)"
    - "Invoice PDF includes received progress summary (ordered vs invoiced vs received quantities)"
    - "Invoice PDF filename follows format: Invoice_INV-YYYY-NNNNN_YYYY-MM-DD.pdf"
    - "Voided invoices can still be exported with VOIDED status badge"
  artifacts:
    - path: "lib/pdf/documents/invoice-pdf.tsx"
      provides: "Invoice Receipt PDF document component"
      contains: "InvoicePDF"
    - path: "app/(dashboard)/invoice/[id]/page.tsx"
      provides: "Invoice detail page with Download PDF button"
      contains: "PDFDownloadButton"
  key_links:
    - from: "app/(dashboard)/invoice/[id]/page.tsx"
      to: "components/pdf-export/pdf-download-button.tsx"
      via: "import PDFDownloadButton"
      pattern: "PDFDownloadButton"
    - from: "app/(dashboard)/invoice/[id]/page.tsx"
      to: "lib/pdf/documents/invoice-pdf.tsx"
      via: "import InvoicePDF"
      pattern: "InvoicePDF"
---

<objective>
Build the Invoice Receipt PDF document and integrate the Download PDF button into the invoice detail page.

Purpose: Enable users to download professional Invoice Receipt PDFs with full line items, PO context, supplier info, received progress, and dual currency display.

Output: InvoicePDF document component and Download PDF button on /invoice/[id] page.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-pdf-export-infrastructure/43-RESEARCH.md
@.planning/phases/43-pdf-export-infrastructure/43-CONTEXT.md
@.planning/phases/43-pdf-export-infrastructure/43-01-SUMMARY.md
@app/(dashboard)/invoice/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Invoice Receipt PDF document component</name>
  <files>lib/pdf/documents/invoice-pdf.tsx</files>
  <action>
    Create `lib/pdf/documents/invoice-pdf.tsx`:

    1. Define `InvoicePDFProps` interface matching the data available in the invoice detail page:
       ```typescript
       interface InvoicePDFProps {
         invoice: {
           invoice_number: string;
           invoice_date: string | null;
           currency: string;
           exchange_rate: number;
           total_amount: number;
           total_amount_eusd: number;
           status: string;
           is_voided: boolean;
           void_reason?: string | null;
           notes?: string | null;
         };
         lineItems: Array<{
           item_name?: string;
           item_sku?: string;
           quantity: number;
           unit_price: number;
           line_total: number;
           line_total_eusd?: number;
           received_quantity?: number;
           po_unit_price?: number;
         }>;
         purchaseOrder?: {
           po_number: string;
           total_amount: number;
           total_amount_eusd: number;
           currency: string;
         } | null;
         supplier?: {
           company_name?: string;
           name: string;
           email?: string;
           phone?: string;
         } | null;
       }
       ```

    2. Build the `InvoicePDF` component using `PDFTemplate`:
       - Status: Show "VOIDED" if is_voided, else capitalize invoice.status
       - Status color: red for voided, map other statuses appropriately

    3. Content sections (inside PDFTemplate children):

       **Section A: PO Summary** (if purchaseOrder exists)
       - Section title: "PURCHASE ORDER REFERENCE"
       - PO Number (mono font), Supplier name
       - PO Total with dual currency display
       - "This invoice covers X of Y line items" (count lineItems vs PO context)

       **Section B: Supplier Information** (if supplier exists)
       - Section title: "SUPPLIER"
       - Company name (bold), contact name
       - Email and phone in a row

       **Section C: Line Items Table**
       - Section title: "LINE ITEMS"
       - Use PDFTable component with columns:
         - # (row index, width 5%)
         - Item (name + SKU below in smaller text, width 30%)
         - Qty (right-aligned, width 10%)
         - Unit Price (right-aligned, with currency, width 15%)
         - Line Total (right-aligned, dual currency, width 25%)
         - Received (right-aligned, width 15%)
       - After table: Totals row showing invoice total with dual currency (bold, larger text)

       **Section D: Received Progress Summary**
       - Section title: "RECEIVING PROGRESS"
       - Simple table with 3 rows: "Ordered" (sum of qty), "Invoiced" (same as ordered -- it's this invoice), "Received" (sum of received_quantity)
       - Show percentage received
       - Use a simple visual: "Received: X / Y (Z%)"

       **Section E: Notes** (conditional -- only if invoice.notes exists)
       - Section title: "NOTES"
       - Notes text in slate-300 color

    4. Format amounts using inline helper (toFixed(2) with comma separators). Do NOT import from lib/utils since those may use browser APIs.

    5. Export `InvoicePDF` as default and named export.
  </action>
  <verify>
    - File exists: `ls lib/pdf/documents/invoice-pdf.tsx`
    - `npx tsc --noEmit` passes for this file
  </verify>
  <done>
    InvoicePDF document component renders invoice header, PO reference, supplier info, line items table with received qty, totals with dual currency, receiving progress summary, and conditional notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Download PDF button into invoice detail page</name>
  <files>app/(dashboard)/invoice/[id]/page.tsx</files>
  <action>
    Modify the invoice detail page to add a "Download PDF" button in the actions area.

    1. Add imports at top of file:
       ```typescript
       import { PDFDownloadButton } from "@/components/pdf-export/pdf-download-button";
       import { InvoicePDF } from "@/lib/pdf/documents/invoice-pdf";
       import { format } from "date-fns";
       ```

    2. In the actions prop of DetailPageLayout, add the PDFDownloadButton BEFORE the void button:
       ```tsx
       <PDFDownloadButton
         document={
           <InvoicePDF
             invoice={{
               invoice_number: invoice.invoice_number || "",
               invoice_date: invoice.invoice_date,
               currency: invoice.currency || "MMK",
               exchange_rate: invoice.exchange_rate ?? 1,
               total_amount: invoice.total_amount ?? 0,
               total_amount_eusd: invoice.total_amount_eusd ?? 0,
               status: (invoice.status || "draft"),
               is_voided: invoice.is_voided ?? false,
               void_reason: invoice.void_reason,
               notes: invoice.notes,
             }}
             lineItems={lineItems.map(li => ({
               item_name: li.item?.name || "Unknown Item",
               item_sku: li.item?.sku || undefined,
               quantity: li.quantity || 0,
               unit_price: li.unit_price || 0,
               line_total: li.line_total || 0,
               line_total_eusd: li.line_total_eusd ?? undefined,
               received_quantity: li.received_quantity ?? 0,
               po_unit_price: li.po_unit_price ?? undefined,
             }))}
             purchaseOrder={invoice.purchase_order ? {
               po_number: invoice.purchase_order.po_number || "",
               total_amount: invoice.purchase_order.total_amount ?? 0,
               total_amount_eusd: invoice.purchase_order.total_amount_eusd ?? 0,
               currency: invoice.purchase_order.currency || "MMK",
             } : null}
             supplier={invoice.purchase_order?.supplier ? {
               company_name: invoice.purchase_order.supplier.company_name || undefined,
               name: invoice.purchase_order.supplier.name || "",
               email: invoice.purchase_order.supplier.email || undefined,
               phone: invoice.purchase_order.supplier.phone || undefined,
             } : null}
           />
         }
         fileName={`Invoice_${invoice.invoice_number || "DRAFT"}_${format(new Date(), "yyyy-MM-dd")}.pdf`}
       />
       ```

    3. The actions section should now contain: Download PDF button + Void button (when applicable).
       Keep the existing void button logic unchanged. Just add the PDF button before it.

    4. IMPORTANT: The PDFDownloadButton dynamically imports @react-pdf/renderer client-side only.
       The InvoicePDF component is passed as a React element to the `document` prop.
       This means InvoicePDF itself will only be evaluated client-side inside PDFDownloadLink.
       No special handling needed for SSR since the button wrapper handles it.
  </action>
  <verify>
    - `npm run build` succeeds (no SSR errors)
    - Open /invoice/[id] in browser -- Download PDF button appears in actions area
    - Click Download PDF -- browser downloads a PDF file named Invoice_INV-XXXX-XXXXX_YYYY-MM-DD.pdf
    - PDF opens and shows: dark theme, invoice header, line items table, totals with dual currency, footer with timestamp and page numbers
  </verify>
  <done>
    Invoice detail page shows "Download PDF" button in actions area. Clicking it generates and downloads Invoice Receipt PDF with dark theme, line items, PO reference, supplier info, received progress, and dual currency display. Voided invoices show VOIDED status badge. Filename follows format: Invoice_INV-YYYY-NNNNN_YYYY-MM-DD.pdf
  </done>
</task>

</tasks>

<verification>
1. Invoice detail page shows Download PDF button alongside existing Void button
2. PDF downloads immediately on click with correct filename format
3. PDF content includes: header with invoice number and status, PO summary, supplier block, line items table with received qty, total with dual currency, receiving progress, conditional notes, dark theme styling, footer with timestamp and page numbers
4. Voided invoices still allow PDF download with VOIDED badge
5. Build succeeds with no SSR errors
</verification>

<success_criteria>
- PDF-01 satisfied: User can download Invoice Receipt PDF from invoice detail page with invoice header, line items, totals, and EUSD equivalent
- PDF-04 partially satisfied: Dark theme matching app UI
- PDF-05 partially satisfied: Company branding and timestamp in footer
- Invoice PDF includes PO summary, supplier info, received progress per user decisions
</success_criteria>

<output>
After completion, create `.planning/phases/43-pdf-export-infrastructure/43-02-SUMMARY.md`
</output>
