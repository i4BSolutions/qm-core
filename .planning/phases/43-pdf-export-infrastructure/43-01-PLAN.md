---
phase: 43-pdf-export-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/pdf/styles.ts
  - lib/pdf/types.ts
  - lib/pdf/components/logo.tsx
  - lib/pdf/components/header.tsx
  - lib/pdf/components/footer.tsx
  - lib/pdf/components/status-badge.tsx
  - lib/pdf/components/table.tsx
  - lib/pdf/components/dual-currency.tsx
  - lib/pdf/components/template.tsx
  - components/pdf-export/pdf-download-button.tsx
autonomous: true

must_haves:
  truths:
    - "Shared PDF template renders A4 page with dark theme (slate-900 background, slate-50 text)"
    - "PDF footer shows 'QM System | Generated on: YYYY-MM-DD HH:MM | Page X of Y' on every page"
    - "PDF header shows placeholder QM logo and company name"
    - "PDF download button component loads via dynamic import with ssr: false"
    - "Dual currency display component shows original amount and EUSD side by side"
  artifacts:
    - path: "lib/pdf/styles.ts"
      provides: "Shared dark theme StyleSheet for all PDFs"
      contains: "darkThemeStyles"
    - path: "lib/pdf/components/template.tsx"
      provides: "Base PDF template with header, footer, page layout"
      contains: "PDFTemplate"
    - path: "lib/pdf/components/footer.tsx"
      provides: "Fixed footer with timestamp and page numbers"
      contains: "PDFFooter"
    - path: "components/pdf-export/pdf-download-button.tsx"
      provides: "Reusable download button with dynamic import"
      contains: "PDFDownloadButton"
  key_links:
    - from: "components/pdf-export/pdf-download-button.tsx"
      to: "@react-pdf/renderer"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*ssr.*false"
    - from: "lib/pdf/components/template.tsx"
      to: "lib/pdf/components/header.tsx"
      via: "import PDFHeader"
      pattern: "PDFHeader"
---

<objective>
Install @react-pdf/renderer and build the shared PDF template infrastructure used by all three document types.

Purpose: Establish the foundation of reusable PDF components (template, header, footer, table, status badge, dual currency display, download button) that Invoice, Stock-Out, and Money-Out PDFs will compose from.

Output: Shared PDF component library in lib/pdf/ and a reusable download button wrapper in components/pdf-export/.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-pdf-export-infrastructure/43-RESEARCH.md
@.planning/phases/43-pdf-export-infrastructure/43-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-pdf/renderer and create shared PDF styles, types, and atomic components</name>
  <files>
    package.json
    lib/pdf/styles.ts
    lib/pdf/types.ts
    lib/pdf/components/logo.tsx
    lib/pdf/components/header.tsx
    lib/pdf/components/footer.tsx
    lib/pdf/components/status-badge.tsx
    lib/pdf/components/table.tsx
    lib/pdf/components/dual-currency.tsx
  </files>
  <action>
    1. Install @react-pdf/renderer:
       ```
       npm install @react-pdf/renderer
       ```
       If peer dependency conflicts arise with React 18, add overrides to package.json per research doc.

    2. Create `lib/pdf/types.ts`:
       - Define `PDFDocumentType = "invoice" | "stock_out" | "money_out"`
       - Define `PDFHeaderProps` interface: `{ title: string; documentNumber: string; status: string; statusColor?: string; date?: string; exchangeRate?: number; currency?: string }`
       - Define `PDFTableColumn` interface: `{ header: string; key: string; width: string; align?: "left" | "right" | "center" }`
       - Define `DualCurrencyProps`: `{ label?: string; amount: number; currency: string; amountEusd: number }`

    3. Create `lib/pdf/styles.ts`:
       - Use `StyleSheet.create()` from @react-pdf/renderer
       - Dark theme colors matching app aesthetic:
         - page background: #0F172A (slate-900)
         - text color: #F8FAFC (slate-50)
         - borders: #334155 (slate-700)
         - muted text: #94A3B8 (slate-400)
         - secondary text: #E2E8F0 (slate-200)
         - table header bg: #1E293B (slate-800)
         - accent: #F59E0B (amber-500)
       - Styles: page (A4, padding 40, fontSize 10, fontFamily Helvetica), header, footer (position absolute, bottom 30, fixed), content (flex 1, marginBottom 50 to avoid footer overlap), section, sectionTitle, table, tableRow, tableHeader, tableCell, statusBadge, amountRow, label, amount (fontFamily Courier for monospace alignment)

    4. Create `lib/pdf/components/logo.tsx`:
       - SVG placeholder logo using @react-pdf/renderer's `Svg`, `Path`, `Circle`, `Text` components
       - Simple shield/badge shape with "QM" text inside, using amber (#F59E0B) accent color
       - Export `PDFLogo` component, width/height ~40x40
       - Keep it as a single swappable component (user will provide real logo later)

    5. Create `lib/pdf/components/header.tsx`:
       - Import `PDFLogo` and darkThemeStyles
       - Props: `title`, `documentNumber`, `status`, `statusColor?`, `date?`, `exchangeRate?`, `currency?`
       - Layout: Row with logo on left, document info on right
       - Document info: title (e.g., "INVOICE RECEIPT"), document number (mono font), date
       - Status badge near document number (using PDFStatusBadge imported from status-badge.tsx)
       - If exchangeRate provided, show "Exchange Rate: 1 EUSD = {rate} {currency}" below date

    6. Create `lib/pdf/components/footer.tsx`:
       - Use `fixed` prop on View so it renders on every page
       - Position: absolute, bottom 30, left 40, right 40
       - Content: "QM System | Generated on: {format(new Date(), 'yyyy-MM-dd HH:mm')}" on left
       - Page numbers on right: use `render` prop with `({pageNumber, totalPages}) => Page ${pageNumber} of ${totalPages}`
       - Use date-fns format for timestamp
       - Border top: 1 solid #334155, paddingTop 10, fontSize 8, color #94A3B8

    7. Create `lib/pdf/components/status-badge.tsx`:
       - Props: `status: string`, `label: string`, `color?: string`
       - Style: backgroundColor #1E293B, borderLeft 3 solid {color}, paddingHorizontal 8, paddingVertical 4, borderRadius 4
       - Text: fontSize 9, fontWeight bold, color from prop or default slate-400
       - Status color map: completed=#10B981, voided=#EF4444, draft=#9CA3AF, pending=#F59E0B, approved=#10B981, rejected=#EF4444, cancelled=#9CA3AF, closed=#64748B, executed=#10B981, partially_approved=#3B82F6

    8. Create `lib/pdf/components/table.tsx`:
       - Generic `PDFTable` component
       - Props: `columns: PDFTableColumn[]`, `data: Record<string, any>[]`, `showRowIndex?: boolean`
       - Render header row with dark bg (#1E293B), bold text
       - Render data rows with alternating subtle bg (every other row #1E293B at 30% opacity)
       - Column widths defined by percentage strings from columns prop
       - Text alignment per column (default left, "right" for amounts)
       - Border bottom on each row: 1 solid #1E293B

    9. Create `lib/pdf/components/dual-currency.tsx`:
       - Props: `label?: string`, `amount: number`, `currency: string`, `amountEusd: number`, `size?: "sm" | "md" | "lg"`
       - Format amounts using simple toFixed(2) with commas (replicate formatCurrency logic inline since we can't import DOM-dependent utils)
       - Display: "{formattedAmount} {currency} / {formattedEusd} EUSD"
       - Use Courier font family for amount alignment
       - If label provided, show as row: label on left, amounts on right
  </action>
  <verify>
    - `npm ls @react-pdf/renderer` shows installed version
    - All files exist: `ls lib/pdf/styles.ts lib/pdf/types.ts lib/pdf/components/logo.tsx lib/pdf/components/header.tsx lib/pdf/components/footer.tsx lib/pdf/components/status-badge.tsx lib/pdf/components/table.tsx lib/pdf/components/dual-currency.tsx`
    - `npx tsc --noEmit` passes (or only has pre-existing errors)
  </verify>
  <done>
    @react-pdf/renderer installed, shared PDF styles and 7 atomic components created with dark theme matching app aesthetic. All components use built-in Helvetica/Courier fonts and dark slate color palette.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PDF template wrapper and reusable download button</name>
  <files>
    lib/pdf/components/template.tsx
    components/pdf-export/pdf-download-button.tsx
  </files>
  <action>
    1. Create `lib/pdf/components/template.tsx`:
       - Import `Document`, `Page`, `View` from @react-pdf/renderer
       - Import `PDFHeader`, `PDFFooter` from sibling components
       - Import `darkThemeStyles` from ../styles
       - Props: `title: string`, `documentNumber: string`, `status: string`, `statusColor?: string`, `date?: string`, `exchangeRate?: number`, `currency?: string`, `children: React.ReactNode`
       - Structure:
         ```
         <Document>
           <Page size="A4" style={darkThemeStyles.page}>
             <PDFHeader title={title} documentNumber={documentNumber} status={status} statusColor={statusColor} date={date} exchangeRate={exchangeRate} currency={currency} />
             <View style={darkThemeStyles.content}>
               {children}
             </View>
             <PDFFooter />
           </Page>
         </Document>
         ```
       - Export as `PDFTemplate`

    2. Create `components/pdf-export/pdf-download-button.tsx`:
       - Mark as `"use client"`
       - Use `dynamic` from next/dynamic to import PDFDownloadLink from @react-pdf/renderer with `{ ssr: false }`
       - CRITICAL: The dynamic import must wrap the entire component that uses PDFDownloadLink, not just PDFDownloadLink itself, to avoid SSR issues
       - Props: `document: React.ReactElement`, `fileName: string`, `label?: string` (default "Download PDF"), `variant?: "default" | "outline"`, `className?: string`
       - Implementation approach: Create an inner client component that uses PDFDownloadLink directly, then dynamically import THAT component
       - The inner component renders PDFDownloadLink wrapping a Button
       - Loading state: Show Button with Loader2 spinner and "Preparing PDF..." text (disabled)
       - Ready state: Show Button with Download icon and label text
       - On click, show toast "Generating PDF..." via sonner toast (the component itself doesn't need to handle this -- PDFDownloadLink handles the download automatically)
       - Import Download, Loader2 icons from lucide-react
       - Import Button from @/components/ui/button
       - Export `PDFDownloadButton`
       - Also export a simple wrapper that handles the dynamic import:
         ```typescript
         // The actual component that does the rendering
         function PDFDownloadButtonInner({ document, fileName, label, variant, className }) {
           // Uses PDFDownloadLink from @react-pdf/renderer directly
         }

         // Dynamic wrapper for Next.js
         const DynamicPDFButton = dynamic(() => Promise.resolve(PDFDownloadButtonInner), { ssr: false, loading: () => <Button disabled>...</Button> });

         // Exported component
         export function PDFDownloadButton(props) {
           return <DynamicPDFButton {...props} />;
         }
         ```
  </action>
  <verify>
    - Files exist: `ls lib/pdf/components/template.tsx components/pdf-export/pdf-download-button.tsx`
    - `npx tsc --noEmit` passes (or only has pre-existing errors)
    - `npm run build` succeeds (critical to verify SSR compatibility -- no 'canvas' or 'fs' errors)
  </verify>
  <done>
    PDFTemplate wraps Document/Page with shared header/footer. PDFDownloadButton uses dynamic import with ssr:false to avoid build errors. Build succeeds with no SSR-related crashes.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @react-pdf/renderer` shows library installed
2. All 10 files exist in lib/pdf/ and components/pdf-export/
3. `npm run build` succeeds without SSR errors (canvas, fs, stream)
4. TypeScript compilation has no new errors related to PDF files
</verification>

<success_criteria>
- @react-pdf/renderer installed and build-compatible
- Shared dark-theme PDF styles defined with slate/amber color palette
- PDFTemplate component assembles header + content + footer on A4 page
- PDFDownloadButton loads client-side only via dynamic import
- All components typed and exportable for use by document-specific plans
</success_criteria>

<output>
After completion, create `.planning/phases/43-pdf-export-infrastructure/43-01-SUMMARY.md`
</output>
