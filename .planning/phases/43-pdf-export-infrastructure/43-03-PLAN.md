---
phase: 43-pdf-export-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - lib/pdf/documents/stock-out-pdf.tsx
  - lib/pdf/documents/money-out-pdf.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - app/(dashboard)/qmhq/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Download PDF' button on stock-out request detail page and receive a PDF file"
    - "Stock-Out Receipt PDF groups line items by SOR number with quantities, warehouse references, and approval status"
    - "Stock-Out Receipt PDF includes full approval chain (who requested, who approved, approval date)"
    - "User can click 'Download PDF' button on QMHQ detail page (expense/po route with money-out transactions) and receive a PDF"
    - "Money-Out Receipt PDF shows parent QMHQ context (request ID, line name) and financial transaction details with dual currency"
    - "Stock-Out PDF filename follows format: StockOut_SOR-XXXX-XXXXX_YYYY-MM-DD.pdf"
    - "MoneyOut PDF filename follows format: MoneyOut_QMHQ-XXXX-XXXXX_YYYY-MM-DD.pdf"
  artifacts:
    - path: "lib/pdf/documents/stock-out-pdf.tsx"
      provides: "Stock-Out Receipt PDF document component"
      contains: "StockOutPDF"
    - path: "lib/pdf/documents/money-out-pdf.tsx"
      provides: "Money-Out Receipt PDF document component"
      contains: "MoneyOutPDF"
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "SOR detail page with Download PDF button"
      contains: "PDFDownloadButton"
    - path: "app/(dashboard)/qmhq/[id]/page.tsx"
      provides: "QMHQ detail page with Download PDF button for money-out"
      contains: "PDFDownloadButton"
  key_links:
    - from: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      to: "lib/pdf/documents/stock-out-pdf.tsx"
      via: "import StockOutPDF"
      pattern: "StockOutPDF"
    - from: "app/(dashboard)/qmhq/[id]/page.tsx"
      to: "lib/pdf/documents/money-out-pdf.tsx"
      via: "import MoneyOutPDF"
      pattern: "MoneyOutPDF"
---

<objective>
Build the Stock-Out Receipt PDF and Money-Out Receipt PDF documents, and integrate Download PDF buttons into the SOR detail page and QMHQ detail page respectively.

Purpose: Enable users to download professional PDF receipts for stock-out requests (with approval audit trail) and QMHQ money-out transactions (with parent context and dual currency).

Output: StockOutPDF and MoneyOutPDF document components, Download PDF buttons on /inventory/stock-out-requests/[id] and /qmhq/[id] pages.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-pdf-export-infrastructure/43-RESEARCH.md
@.planning/phases/43-pdf-export-infrastructure/43-CONTEXT.md
@.planning/phases/43-pdf-export-infrastructure/43-01-SUMMARY.md
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@app/(dashboard)/qmhq/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stock-Out Receipt PDF and integrate into SOR detail page</name>
  <files>
    lib/pdf/documents/stock-out-pdf.tsx
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  </files>
  <action>
    **Part A: Create `lib/pdf/documents/stock-out-pdf.tsx`**

    1. Define `StockOutPDFProps` interface:
       ```typescript
       interface StockOutPDFProps {
         request: {
           request_number: string;
           status: string;
           reason: string;
           notes?: string | null;
           requester_name: string;
           created_at: string;
           qmhq_reference?: string | null;
           qmhq_line_name?: string | null;
         };
         lineItems: Array<{
           item_name: string;
           item_sku?: string | null;
           requested_quantity: number;
           status: string;
           total_approved_quantity: number;
           total_rejected_quantity: number;
         }>;
         approvals: Array<{
           approval_number?: string | null;
           item_name: string;
           item_sku?: string | null;
           approved_quantity: number;
           decision: string;
           rejection_reason?: string | null;
           decided_by_name: string;
           decided_at: string;
         }>;
       }
       ```

    2. Build `StockOutPDF` component using `PDFTemplate`:
       - Title: "STOCK-OUT RECEIPT"
       - DocumentNumber: request.request_number
       - Status: Map request.status using same labels as SOR detail page (pending, approved, rejected, etc.)

    3. Content sections:

       **Section A: Request Summary**
       - Section title: "REQUEST DETAILS"
       - Requester name, Reason (formatted label), Created date
       - QMHQ reference link (text only in PDF): if qmhq_reference, show "QMHQ: {qmhq_reference} ({qmhq_line_name})"
       - Notes (conditional)

       **Section B: Line Items Table**
       - Section title: "LINE ITEMS"
       - PDFTable with columns: #, Item (name + SKU), Requested Qty, Approved Qty, Rejected Qty, Status
       - Status cell should use color text: approved=emerald, rejected=red, pending=amber, executed=emerald, cancelled=slate

       **Section C: Approval Chain (Audit Trail)**
       - Section title: "APPROVAL HISTORY"
       - For each approval, render a card-like block:
         - Approval number (if exists), Decision badge (Approved/Rejected)
         - Item name, Quantity
         - "Decided by: {name}" and "Date: {formatted date}"
         - If rejected: show rejection reason in red text
       - This is the critical audit trail per user decisions

    4. Export `StockOutPDF`.

    **Part B: Integrate into SOR detail page**

    1. Add imports:
       ```typescript
       import { PDFDownloadButton } from "@/components/pdf-export/pdf-download-button";
       import { StockOutPDF } from "@/lib/pdf/documents/stock-out-pdf";
       import { format } from "date-fns";
       ```

    2. In the `actions` prop of DetailPageLayout, add PDFDownloadButton BEFORE the Cancel button:
       ```tsx
       <PDFDownloadButton
         document={
           <StockOutPDF
             request={{
               request_number: request.request_number,
               status: request.status,
               reason: request.reason,
               notes: request.notes,
               requester_name: request.requester?.full_name || "Unknown",
               created_at: request.created_at,
               qmhq_reference: request.qmhq?.request_id || null,
               qmhq_line_name: request.qmhq?.line_name || null,
             }}
             lineItems={lineItems.map(li => ({
               item_name: li.item_name || "Unknown Item",
               item_sku: li.item_sku,
               requested_quantity: li.requested_quantity,
               status: li.status,
               total_approved_quantity: li.total_approved_quantity,
               total_rejected_quantity: li.total_rejected_quantity,
             }))}
             approvals={approvals.map(a => ({
               approval_number: a.approval_number,
               item_name: a.line_item?.item_name || "Unknown",
               item_sku: a.line_item?.item_sku,
               approved_quantity: a.approved_quantity,
               decision: a.decision,
               rejection_reason: a.rejection_reason,
               decided_by_name: a.decided_by_user?.full_name || "Unknown",
               decided_at: a.decided_at,
             }))}
           />
         }
         fileName={`StockOut_${request.request_number}_${format(new Date(), "yyyy-MM-dd")}.pdf`}
       />
       ```

    3. The PDFDownloadButton should appear for ALL request statuses (no blocking for any status per user decision about voided docs).
  </action>
  <verify>
    - Files exist: `ls lib/pdf/documents/stock-out-pdf.tsx`
    - `npm run build` succeeds
    - Open /inventory/stock-out-requests/[id] -- Download PDF button visible in actions
    - Click Download PDF -- browser downloads StockOut_SOR-XXXX_YYYY-MM-DD.pdf
    - PDF shows: request summary, line items table, approval history with audit trail
  </verify>
  <done>
    Stock-Out Receipt PDF renders SOR-level summary with line items (quantities, status), full approval chain (who requested, who approved/rejected, dates), and conditional notes. Download button integrated on SOR detail page for all statuses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Money-Out Receipt PDF and integrate into QMHQ detail page</name>
  <files>
    lib/pdf/documents/money-out-pdf.tsx
    app/(dashboard)/qmhq/[id]/page.tsx
  </files>
  <action>
    **Part A: Create `lib/pdf/documents/money-out-pdf.tsx`**

    1. Define `MoneyOutPDFProps` interface:
       ```typescript
       interface MoneyOutPDFProps {
         qmhq: {
           request_id: string;
           line_name: string;
           route_type: string;
           status_name?: string;
           status_color?: string;
           category_name?: string;
           amount?: number;
           currency?: string;
           exchange_rate?: number;
           amount_eusd?: number;
           notes?: string | null;
         };
         transactions: Array<{
           transaction_id?: string;
           transaction_type: string; // money_in or money_out
           amount: number;
           currency: string;
           exchange_rate: number;
           amount_eusd: number;
           notes?: string | null;
           transaction_date?: string | null;
           created_by_name?: string | null;
         }>;
         parentQmrl?: {
           request_id: string;
           title: string;
         } | null;
       }
       ```

    2. Build `MoneyOutPDF` component using `PDFTemplate`:
       - Title: "MONEY-OUT RECEIPT" (or "FINANCIAL TRANSACTIONS RECEIPT" -- use the former per user context of "Money-Out Receipt")
       - DocumentNumber: qmhq.request_id
       - Status: qmhq.status_name or route_type label
       - StatusColor: qmhq.status_color or default

    3. Content sections:

       **Section A: QMHQ Context**
       - Section title: "QMHQ DETAILS"
       - Request ID (mono), Line Name (bold)
       - Route type badge text, Category
       - If parentQmrl: "Parent QMRL: {request_id} - {title}"
       - QMHQ Amount with dual currency display
       - Exchange Rate display

       **Section B: Financial Transactions Table**
       - Section title: "FINANCIAL TRANSACTIONS"
       - PDFTable with columns:
         - Transaction ID (mono, width 15%)
         - Type (Money In / Money Out with color, width 12%)
         - Amount (original currency, right-aligned, width 18%)
         - EUSD (right-aligned, width 15%)
         - Rate (mono, width 10%)
         - Date (width 15%)
         - By (created_by_name, width 15%)
       - After table: Summary row showing:
         - Total Money In (EUSD)
         - Total Money Out (EUSD)
         - Net Balance (EUSD)

       **Section C: Notes** (conditional)
       - Only render if qmhq.notes exists

    4. Format transaction types with color: money_in = emerald, money_out = amber.

    5. Export `MoneyOutPDF`.

    **Part B: Integrate into QMHQ detail page**

    1. Add imports:
       ```typescript
       import { PDFDownloadButton } from "@/components/pdf-export/pdf-download-button";
       import { MoneyOutPDF } from "@/lib/pdf/documents/money-out-pdf";
       import { format } from "date-fns";
       ```

    2. In the `actions` prop of DetailPageLayout, add PDFDownloadButton AFTER the existing Edit button.
       IMPORTANT: Only show the PDF button for expense and po route types (not item route -- item route doesn't have money-out transactions).
       ```tsx
       {(qmhq.route_type === "expense" || qmhq.route_type === "po") && transactions.length > 0 && (
         <PDFDownloadButton
           document={
             <MoneyOutPDF
               qmhq={{
                 request_id: qmhq.request_id || "",
                 line_name: qmhq.line_name || "",
                 route_type: qmhq.route_type || "",
                 status_name: qmhq.status?.name,
                 status_color: qmhq.status?.color,
                 category_name: qmhq.category?.name,
                 amount: qmhq.amount ?? undefined,
                 currency: qmhq.currency || "MMK",
                 exchange_rate: qmhq.exchange_rate ?? 1,
                 amount_eusd: qmhq.amount_eusd ?? undefined,
                 notes: qmhq.notes,
               }}
               transactions={transactions.map(tx => ({
                 transaction_id: tx.transaction_id || undefined,
                 transaction_type: tx.transaction_type || "money_out",
                 amount: tx.amount ?? 0,
                 currency: tx.currency || "MMK",
                 exchange_rate: tx.exchange_rate ?? 1,
                 amount_eusd: tx.amount_eusd ?? 0,
                 notes: tx.notes || undefined,
                 transaction_date: tx.transaction_date,
                 created_by_name: tx.created_by_user?.full_name || undefined,
               }))}
               parentQmrl={qmhq.qmrl ? {
                 request_id: qmhq.qmrl.request_id || "",
                 title: qmhq.qmrl.title || "",
               } : null}
             />
           }
           fileName={`MoneyOut_${qmhq.request_id || "DRAFT"}_${format(new Date(), "yyyy-MM-dd")}.pdf`}
         />
       )}
       ```

    3. The button only appears when there are transactions to show (transactions.length > 0).
       This prevents generating empty Money-Out PDFs.

    4. Keep existing Edit button and all other actions unchanged.
  </action>
  <verify>
    - Files exist: `ls lib/pdf/documents/money-out-pdf.tsx`
    - `npm run build` succeeds
    - Open /qmhq/[id] for an expense or po route QMHQ with transactions -- Download PDF button visible
    - Click Download PDF -- browser downloads MoneyOut_QMHQ-XXXX-XXXXX_YYYY-MM-DD.pdf
    - PDF shows: QMHQ context, parent QMRL reference, transactions table with dual currency, totals summary
    - For item route QMHQs: no Download PDF button (correct -- no money-out transactions)
  </verify>
  <done>
    Money-Out Receipt PDF renders QMHQ context (request ID, line name, route type, parent QMRL), financial transactions table with dual currency display, and totals summary. Download button appears on QMHQ detail page only for expense/po routes with existing transactions.
    Stock-Out Receipt PDF and button also verified working from Task 1.
  </done>
</task>

</tasks>

<verification>
1. SOR detail page shows Download PDF button; clicking downloads StockOut_SOR-XXXX_YYYY-MM-DD.pdf
2. Stock-Out PDF content: request summary, line items with approval status, approval chain audit trail
3. QMHQ detail page (expense/po route with transactions) shows Download PDF button; clicking downloads MoneyOut_QMHQ-XXXX_YYYY-MM-DD.pdf
4. Money-Out PDF content: QMHQ context, parent QMRL, transactions table with dual currency, totals
5. QMHQ detail page for item route does NOT show Money-Out PDF button
6. Build succeeds with no SSR errors
7. All PDFs use dark theme, have footer with timestamp and page numbers
</verification>

<success_criteria>
- PDF-02 satisfied: User can download SOR-based Stock-Out Receipt PDF from SOR detail page
- PDF-03 satisfied: User can download Money-Out Receipt PDF from QMHQ money-out transaction detail
- PDF-04 fully satisfied: Both new PDFs match dark theme app styling
- PDF-05 fully satisfied: Both PDFs include company branding and export timestamp
- Stock-Out PDF includes full approval chain per user decision
- Money-Out PDF includes parent QMHQ context per user decision
</success_criteria>

<output>
After completion, create `.planning/phases/43-pdf-export-infrastructure/43-03-SUMMARY.md`
</output>
