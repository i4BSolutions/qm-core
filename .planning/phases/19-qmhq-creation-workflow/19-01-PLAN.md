---
phase: 19-qmhq-creation-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/qmhq/qmrl-context-panel.tsx
  - app/(dashboard)/qmhq/new/page.tsx
  - app/(dashboard)/qmhq/new/[route]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees QMRL context panel on right side when creating QMHQ on desktop"
    - "User sees toggle button to open QMRL context drawer on mobile"
    - "Panel shows QMRL ID, title, status, category, priority, request date"
    - "Panel shows truncated description with Show more button"
    - "Panel shows department and contact person details"
    - "Panel shows existing QMHQ count and list"
    - "Panel shows attachment thumbnails clickable for preview"
    - "Panel can be collapsed and expanded without losing form state"
    - "Panel state persists between step 1 and step 2"
  artifacts:
    - path: "components/qmhq/qmrl-context-panel.tsx"
      provides: "Reusable QMRL context panel component"
      min_lines: 150
    - path: "app/(dashboard)/qmhq/new/page.tsx"
      provides: "Step 1 QMHQ creation with panel integration"
      contains: "QmrlContextPanel"
    - path: "app/(dashboard)/qmhq/new/[route]/page.tsx"
      provides: "Step 2 QMHQ creation with panel integration"
      contains: "QmrlContextPanel"
  key_links:
    - from: "components/qmhq/qmrl-context-panel.tsx"
      to: "supabase qmrl table"
      via: "fetch in useEffect"
      pattern: "from\\(['\"]qmrl['\"]\\)"
    - from: "components/qmhq/qmrl-context-panel.tsx"
      to: "components/files/file-preview-modal.tsx"
      via: "import and render"
      pattern: "FilePreviewModal"
    - from: "app/(dashboard)/qmhq/new/page.tsx"
      to: "components/qmhq/qmrl-context-panel.tsx"
      via: "import and render"
      pattern: "import.*QmrlContextPanel"
---

<objective>
Add a QMRL context panel to the QMHQ creation workflow (both step 1 and step 2) so users can reference the parent request details without switching tabs.

Purpose: When creating QMHQ lines, users need to reference parent QMRL details (description, attachments, existing lines) to avoid duplicates and ensure accuracy. Currently users must open QMRL in another tab.

Output:
- New `QmrlContextPanel` component showing QMRL details, attachments, and existing QMHQ lines
- Updated QMHQ creation pages (step 1 and step 2) with responsive panel integration
- Desktop: Panel always visible on right side
- Mobile: Hidden by default with toggle button to open as slide-in drawer
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-qmhq-creation-workflow/19-CONTEXT.md
@.planning/phases/19-qmhq-creation-workflow/19-RESEARCH.md

# Existing patterns to follow
@app/(dashboard)/qmrl/[id]/page.tsx
@components/files/file-preview-modal.tsx
@app/(dashboard)/qmhq/new/page.tsx
@app/(dashboard)/qmhq/new/[route]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QmrlContextPanel component</name>
  <files>components/qmhq/qmrl-context-panel.tsx</files>
  <action>
Create a new client component `QmrlContextPanel` with these features:

**Props interface:**
```typescript
interface QmrlContextPanelProps {
  qmrlId: string | null;  // null when QMRL not yet selected
  isOpen: boolean;
  onToggle: () => void;
}
```

**Data fetching:**
- Fetch QMRL with relations when qmrlId changes (status, category, department, contact_person)
- Fetch related QMHQ list (id, line_id, line_name, route_type) for this QMRL
- Fetch file attachments for this QMRL (entity_type='qmrl', entity_id=qmrlId, deleted_at IS NULL)
- Use existing Supabase client pattern from QMRL detail page

**Layout (per user decisions):**
- Desktop (md+): Always visible on right side, sticky position, width `md:w-80 lg:w-96`
- Mobile (<md): Slide-in drawer from right using transform/transition
- Fixed toggle button (bottom-right corner) shown only on mobile when panel closed
- Backdrop overlay on mobile when panel open

**Content sections:**
1. **Header**: QMRL ID with close button (close only visible on mobile)
2. **Core info**: Title, status badge, category badge, priority badge, request date
3. **Description**: Truncated with line-clamp-4, "Show more" button if >200 chars
4. **Notes**: Same truncation pattern (only if notes exist)
5. **Department & Contact**: Department name, contact person name + position
6. **Existing QMHQ**: Count badge + list of line names with route type badges
7. **Attachments**: Grid of thumbnails (4 cols), clickable for preview using FilePreviewModal

**Styling:**
- Match existing tactical command center theme (dark mode only)
- Use existing Badge component for status/category (same colors as detail page)
- Use existing FilePreviewModal for attachment preview
- Mobile drawer: bg-slate-900, border-l border-slate-700

**State management:**
- Description expanded state (useState)
- Notes expanded state (useState)
- Preview file state for FilePreviewModal
- Loading state for data fetch
- Scroll lock on body when mobile drawer is open

**Key patterns from research:**
- Use `cn()` for conditional classes
- Transform + transition for slide animation
- Only render backdrop on mobile using `md:hidden`
  </action>
  <verify>
- File exists at components/qmhq/qmrl-context-panel.tsx
- `npm run type-check` passes
- `npm run lint` passes
  </verify>
  <done>
QmrlContextPanel component exists with responsive layout, QMRL data display, QMHQ list, attachment thumbnails with preview, and proper mobile drawer behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate panel into QMHQ creation pages</name>
  <files>app/(dashboard)/qmhq/new/page.tsx, app/(dashboard)/qmhq/new/[route]/page.tsx</files>
  <action>
Update both QMHQ creation pages to include the QmrlContextPanel component.

**Step 1 page (page.tsx):**

1. Add imports:
```typescript
import { QmrlContextPanel } from "@/components/qmhq/qmrl-context-panel";
```

2. Add panel state:
```typescript
const [isPanelOpen, setIsPanelOpen] = useState(() => {
  if (typeof window !== 'undefined') {
    const saved = sessionStorage.getItem('qmhq_panel_open');
    return saved ? JSON.parse(saved) : window.innerWidth >= 768;
  }
  return true;
});

useEffect(() => {
  sessionStorage.setItem('qmhq_panel_open', JSON.stringify(isPanelOpen));
}, [isPanelOpen]);
```

3. Update layout:
- Wrap content in responsive grid: `md:grid md:grid-cols-[1fr_384px] gap-6`
- Keep existing form in left column (update max-w-4xl to remove width constraint on desktop)
- Add QmrlContextPanel in right column

4. Pass props:
```tsx
<QmrlContextPanel
  qmrlId={formData.qmrl_id || null}
  isOpen={isPanelOpen}
  onToggle={() => setIsPanelOpen(prev => !prev)}
/>
```

**Step 2 page ([route]/page.tsx):**

Same integration pattern:
1. Add imports
2. Add panel state with sessionStorage persistence
3. Update layout to responsive grid
4. Pass qmrlId from draftData.qmrl_id

**Layout adjustments for both pages:**
- Remove `max-w-4xl mx-auto` from outer container (let grid handle widths)
- Keep form content styling intact
- Ensure form sections don't break at new widths

**SessionStorage cleanup:**
- Clear 'qmhq_panel_open' in the same place 'qmhq_draft' is cleared (on successful creation)
  </action>
  <verify>
- `npm run type-check` passes
- `npm run lint` passes
- `npm run build` passes
  </verify>
  <done>
Both QMHQ creation pages show QmrlContextPanel on desktop right side, with toggle button on mobile, panel state persists across steps.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual and functional verification</name>
  <what-built>
QMRL context panel integration in QMHQ creation workflow:
- Responsive side panel showing parent QMRL details
- Mobile slide-in drawer with toggle button
- Attachment preview using existing modal
- Existing QMHQ count display
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/qmrl and select a QMRL with attachments and existing QMHQ lines
2. Click "Add QMHQ Line" button
3. **Desktop verification (resize browser to >768px):**
   - Panel should be visible on right side
   - Panel shows: QMRL ID, title, status badge, category badge, priority, request date
   - Scroll down in panel to see: description (truncated), department, contact, existing QMHQ count, attachments
   - Click "Show more" on description if truncated - should expand
   - Click attachment thumbnail - should open FilePreviewModal
   - Panel should stay visible while filling form
4. **Mobile verification (resize browser to <768px):**
   - Panel should be hidden
   - Toggle button should appear in bottom-right corner
   - Click toggle - panel should slide in from right with backdrop
   - Click backdrop or X button - panel should close
   - Form state should be preserved when toggling panel
5. **Step 2 verification:**
   - Select route type and click Next
   - Panel should still be visible/accessible on step 2
   - Panel state (open/closed) should match what was set on step 1
6. **Submit verification:**
   - Complete QMHQ creation
   - Verify no console errors
   - Verify panel state is cleared (sessionStorage)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run type-check` passes
2. `npm run lint` passes
3. `npm run build` passes
4. QMHQ creation workflow shows QMRL context panel on desktop
5. Mobile toggle button works to open/close drawer
6. Attachment preview works using existing modal
7. Panel state persists between step 1 and step 2
</verification>

<success_criteria>
1. User sees side panel showing QMRL details when creating QMHQ on desktop
2. Side panel displays QMRL title, description, status, category, and key fields
3. Side panel remains visible throughout multi-step QMHQ creation
4. Panel can be collapsed/expanded without losing QMHQ form state
5. Mobile users can access panel via toggle button
6. Attachments are clickable and open in preview modal
7. Existing QMHQ count/list is displayed to help avoid duplicates
</success_criteria>

<output>
After completion, create `.planning/phases/19-qmhq-creation-workflow/19-01-SUMMARY.md`
</output>
