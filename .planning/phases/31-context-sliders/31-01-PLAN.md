---
phase: 31-context-sliders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/context-slider/context-slider.tsx
  - components/context-slider/qmrl-slider-content.tsx
  - components/context-slider/sibling-qmhq-list.tsx
  - app/(dashboard)/qmhq/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "QMHQ create page shows QMRL full details in right side slider"
    - "QMHQ create slider shows sibling QMHQ lines as view-only list"
    - "Slider pushes form content on desktop (both visible simultaneously)"
    - "Slider is open by default on desktop, closed on mobile, toggleable"
    - "Toggle button in page header controls slider visibility"
    - "Old QmrlContextPanel is no longer used on QMHQ create page"
  artifacts:
    - path: "components/context-slider/context-slider.tsx"
      provides: "Reusable slider shell with push-content layout, mobile drawer, toggle, backdrop"
      exports: ["ContextSlider"]
    - path: "components/context-slider/qmrl-slider-content.tsx"
      provides: "Full QMRL detail display for slider (status, category, priority, description, notes, department, contact, attachments)"
      exports: ["QmrlSliderContent"]
    - path: "components/context-slider/sibling-qmhq-list.tsx"
      provides: "View-only list of sibling QMHQ lines (line name, route type, status badge)"
      exports: ["SiblingQmhqList"]
    - path: "app/(dashboard)/qmhq/new/page.tsx"
      provides: "QMHQ create page with new context slider replacing QmrlContextPanel"
  key_links:
    - from: "app/(dashboard)/qmhq/new/page.tsx"
      to: "components/context-slider/context-slider.tsx"
      via: "import and render ContextSlider"
      pattern: "ContextSlider"
    - from: "app/(dashboard)/qmhq/new/page.tsx"
      to: "components/context-slider/qmrl-slider-content.tsx"
      via: "import and render inside ContextSlider"
      pattern: "QmrlSliderContent"
    - from: "app/(dashboard)/qmhq/new/page.tsx"
      to: "components/context-slider/sibling-qmhq-list.tsx"
      via: "import and render inside ContextSlider"
      pattern: "SiblingQmhqList"
---

<objective>
Create the reusable ContextSlider shell component and QMRL-specific content components, then integrate into the QMHQ create page to replace the existing QmrlContextPanel.

Purpose: Users creating QMHQ lines need contextual QMRL information alongside the form. The new slider provides a full detail view with tabs, sibling QMHQ list, and a reusable architecture for the stock-out page (Plan 02).

Output: Three new components (ContextSlider, QmrlSliderContent, SiblingQmhqList) and updated QMHQ create page.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-context-sliders/31-CONTEXT.md
@.planning/phases/31-context-sliders/31-RESEARCH.md
@components/qmhq/qmrl-context-panel.tsx
@app/(dashboard)/qmhq/new/page.tsx
@components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContextSlider shell, QmrlSliderContent, and SiblingQmhqList components</name>
  <files>
    components/context-slider/context-slider.tsx
    components/context-slider/qmrl-slider-content.tsx
    components/context-slider/sibling-qmhq-list.tsx
  </files>
  <action>
Create three new components in `components/context-slider/`:

**1. `context-slider.tsx` — Reusable slider shell**

A `'use client'` component that provides the outer container, animation, mobile drawer, backdrop, scroll lock, and toggle affordances. This is the structural wrapper used by both the QMHQ create page and stock-out request page.

Props interface:
```typescript
interface ContextSliderProps {
  isOpen: boolean;
  onToggle: () => void;
  title: string; // e.g. "QMRL Context" or "Request Context"
  children: React.ReactNode;
}
```

Implementation details — extract patterns directly from existing `QmrlContextPanel` (components/qmhq/qmrl-context-panel.tsx):

- **Desktop:** Visible in CSS Grid column, `md:block md:relative md:translate-x-0`, push-content layout (parent grid handles this), sticky position within grid cell.
- **Mobile:** Fixed slide-in from right (`fixed inset-y-0 right-0 z-50`), smooth animation (`transform transition-transform duration-300 ease-in-out`), `translate-x-0` when open, `translate-x-full` when closed (but `md:translate-x-0` always on desktop).
- **Width:** `w-80 md:w-80 lg:w-96` (320px mobile, 384px desktop) — matches existing pattern.
- **Styling:** `border-l border-slate-700 bg-slate-900`, `overflow-hidden flex flex-col`.
- **Header:** Sticky header with amber icon + title text (uppercase tracking-wider), close button visible only on mobile (`md:hidden`).
- **Mobile backdrop:** When open, show `md:hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm` overlay that calls onToggle on click.
- **Mobile floating toggle button:** When closed on mobile (`!isOpen && md:hidden`), show fixed bottom-right amber gradient pill button with FileText icon + "Context" label. Same styling as existing panel: `bg-gradient-to-r from-amber-600 to-amber-500 px-4 py-3 shadow-lg rounded-full`.
- **Body scroll lock:** `useEffect` that sets `document.body.style.overflow = 'hidden'` when `isOpen && window.innerWidth < 768`, restores on close/unmount.
- **Content area:** `<div className="flex-1 overflow-y-auto p-4 space-y-4">{children}</div>` for scrollable content.

Do NOT include any data fetching or content rendering — this is purely structural.

**2. `qmrl-slider-content.tsx` — Full QMRL detail display**

A `'use client'` component that renders full QMRL details inside the slider. This is the content that goes inside ContextSlider's children.

Props interface:
```typescript
interface QmrlSliderContentProps {
  qmrl: QMRLWithRelations | null;
  isLoading: boolean;
  // Attachment-related props (same pattern as existing panel)
  attachments: FileAttachmentWithUploader[];
  thumbnailUrls: Map<string, string>;
  onAttachmentClick: (file: FileAttachmentWithUploader) => void;
  // QMHQ count for badge display at bottom
  qmhqLinesCount: number;
}
```

Extract and reorganize the content rendering from existing `QmrlContextPanel` (lines 377-617). Show ALL fields (per user decision — full detail view, not summarized):

- **QMRL ID Badge:** `code` tag with amber monospace, in slate-800 rounded container
- **Title:** `text-base font-semibold text-slate-200`
- **Status + Category + Priority badges:** Flex wrap row with Badge components (colored borders from status/category config, priority from priorityConfig)
- **Request Date:** Calendar icon + formatted date
- **Description:** Collapsible with "Show more/less" toggle (ChevronDown/Up), `line-clamp-4` when collapsed, expand if >200 chars
- **Notes:** Same collapsible pattern as description
- **Department & Contact:** Card with Building2/User icons, label + value
- **Attachments section:** Grid of 4-col thumbnail buttons with image preview and PDF/file icons. Keep the same click-to-preview pattern — accept `onAttachmentClick` callback.
- **QMHQ Lines Count Badge at bottom** (per user decision): Show a small section at the very bottom with ExternalLink icon, "QMHQ Lines" label, and the count badge number. This is informational only (the sibling list is in a separate tab on the QMHQ create page).

Include the same loading skeleton and "no QMRL selected" empty state as existing panel.

Reuse all the same config objects: `routeConfig`, `priorityConfig`, `formatDate`. Import types from `@/types/database`.

**3. `sibling-qmhq-list.tsx` — View-only sibling QMHQ list**

A simple component showing sibling QMHQ lines linked to the same parent QMRL. View-only per user decision (no navigation links).

Props interface:
```typescript
interface SiblingQmhqListProps {
  siblings: Array<{
    id: string;
    request_id: string;
    line_name: string;
    route_type: 'item' | 'expense' | 'po';
    status?: { name: string; color: string } | null;
  }>;
  isLoading: boolean;
}
```

Render:
- Loading state: 3 Skeleton rows
- Empty state: "No QMHQ lines created yet" italic text
- Each sibling: row with route type icon (Package/Wallet/ShoppingCart with color from routeConfig), line_name (text-xs truncate), request_id (monospace text-[10px]), and status Badge if available. Same item styling as existing panel's QMHQ lines section (lines 542-566).
- Container: No outer card wrapper (the parent component handles structure), just a list with `space-y-2`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in the three new files. Verify files exist at the expected paths.
  </verify>
  <done>
Three components created: ContextSlider (structural shell), QmrlSliderContent (full QMRL details), SiblingQmhqList (view-only sibling list). All type-check cleanly. No data fetching in any component — they receive data via props.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate context slider into QMHQ create page, replace QmrlContextPanel</name>
  <files>
    app/(dashboard)/qmhq/new/page.tsx
  </files>
  <action>
Modify the QMHQ create page (`app/(dashboard)/qmhq/new/page.tsx`) to replace the existing `QmrlContextPanel` with the new slider components.

**Changes to make:**

1. **Replace imports:**
   - Remove: `import { QmrlContextPanel } from "@/components/qmhq/qmrl-context-panel";`
   - Add: `import { ContextSlider } from "@/components/context-slider/context-slider";`
   - Add: `import { QmrlSliderContent } from "@/components/context-slider/qmrl-slider-content";`
   - Add: `import { SiblingQmhqList } from "@/components/context-slider/sibling-qmhq-list";`
   - Add: `import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";`
   - Add: `import { PanelRightOpen, PanelRightClose } from "lucide-react";` (for toggle button icons)

2. **Add data state for slider content** (similar to what QmrlContextPanel fetched internally, but now fetched in the page component to follow the pattern of data ownership at page level):
   - Add state: `qmrlDetail` (full QMRL with relations), `siblingQmhq` (sibling QMHQ lines with status), `qmrlAttachments` (FileAttachmentWithUploader[]), `thumbnailUrls` (Map).
   - Add a `useEffect` that fires when `formData.qmrl_id` changes. When qmrl_id is set, fetch:
     - QMRL with relations: `supabase.from('qmrl').select('*, status:status_config(*), category:categories(*), department:departments(*), contact_person:contact_persons(*)').eq('id', qmrlId).single()`
     - Sibling QMHQ: `supabase.from('qmhq').select('id, request_id, line_name, route_type, status:status_config(name, color)').eq('qmrl_id', qmrlId).eq('is_active', true).order('created_at', { ascending: false })`
     - Attachments: `supabase.from('file_attachments').select('*, uploaded_by_user:users!uploaded_by(full_name, email)').eq('entity_type', 'qmrl').eq('entity_id', qmrlId).is('deleted_at', null).order('uploaded_at', { ascending: false })`
   - Load thumbnail URLs for image attachments using `getFileUrl` (same pattern as existing panel).
   - Import `getFileUrl` and `FileAttachmentWithUploader` from `@/lib/actions/files`.
   - Add `FilePreviewModal`, `ImagePreview`, and dynamic `PDFPreview` imports for attachment preview (same as existing panel).
   - Add preview state: `previewFile`, `previewUrl`, `isLoadingPreview`, and handlers `handleAttachmentClick`, `handlePreviewClose`, `renderPreviewContent`.

   NOTE: The existing QmrlContextPanel fetched data internally via client-side useEffect. We're keeping this same pattern here (client component fetches when qmrl_id changes) since the QMHQ create page is already a `'use client'` component and qmrl_id can change dynamically when user selects a different QMRL from the dropdown.

3. **Add toggle button in header** (per user decision — toggle via icon button in page header):
   In the header section (around line 303-324), add a toggle button next to the page title:
   ```tsx
   <div className="flex items-center gap-3 mb-2">
     <div className="flex items-center gap-2 px-3 py-1 rounded bg-emerald-500/10 border border-emerald-500/20">
       <span className="text-xs font-semibold uppercase tracking-widest text-emerald-500">
         Step 1 of 2
       </span>
     </div>
     {/* Slider toggle button */}
     {formData.qmrl_id && (
       <button
         onClick={() => setIsPanelOpen(prev => !prev)}
         className="hidden md:inline-flex items-center gap-1 px-2 py-1 rounded text-xs text-slate-400 hover:text-amber-400 hover:bg-slate-800 transition-colors"
         aria-label={isPanelOpen ? "Hide context panel" : "Show context panel"}
       >
         {isPanelOpen ? <PanelRightClose className="h-4 w-4" /> : <PanelRightOpen className="h-4 w-4" />}
       </button>
     )}
   </div>
   ```
   Only show toggle when a QMRL is selected. Use `hidden md:inline-flex` so it's desktop-only (mobile uses the floating button from ContextSlider).

4. **Replace the QmrlContextPanel render** (around line 653-658):
   Replace:
   ```tsx
   <QmrlContextPanel
     qmrlId={formData.qmrl_id || null}
     isOpen={isPanelOpen}
     onToggle={() => setIsPanelOpen(prev => !prev)}
   />
   ```
   With the new slider using Tabs. The QMHQ create page shows QMRL detail + sibling QMHQ list (per user decision):
   ```tsx
   {formData.qmrl_id && (
     <ContextSlider
       isOpen={isPanelOpen}
       onToggle={() => setIsPanelOpen(prev => !prev)}
       title="QMRL Context"
     >
       <Tabs defaultValue="details" className="w-full">
         <TabsList className="grid w-full grid-cols-2">
           <TabsTrigger value="details">QMRL Details</TabsTrigger>
           <TabsTrigger value="siblings">
             QMHQ Lines
             {siblingQmhq.length > 0 && (
               <Badge variant="outline" className="ml-1.5 text-[10px] px-1.5 py-0">{siblingQmhq.length}</Badge>
             )}
           </TabsTrigger>
         </TabsList>
         <TabsContent value="details">
           <QmrlSliderContent
             qmrl={qmrlDetail}
             isLoading={isSliderLoading}
             attachments={qmrlAttachments}
             thumbnailUrls={thumbnailUrls}
             onAttachmentClick={handleAttachmentClick}
             qmhqLinesCount={siblingQmhq.length}
           />
         </TabsContent>
         <TabsContent value="siblings">
           <SiblingQmhqList
             siblings={siblingQmhq}
             isLoading={isSliderLoading}
           />
         </TabsContent>
       </Tabs>
     </ContextSlider>
   )}
   ```

5. **Adjust grid layout** to be conditional on slider open state. When no QMRL is selected, use single column. When slider is open, use 2-column grid:
   The existing grid `md:grid md:grid-cols-[1fr_320px] lg:grid-cols-[1fr_384px]` is fine as-is — the ContextSlider handles its own visibility/collapse internally. Keep the grid structure but only apply it when `formData.qmrl_id` is set:
   ```tsx
   <div className={cn(
     formData.qmrl_id ? "md:grid md:grid-cols-[1fr_320px] lg:grid-cols-[1fr_384px] gap-6" : ""
   )}>
   ```

6. **Add FilePreviewModal** render after ContextSlider (inside the outer container, same level as existing panel's modal):
   ```tsx
   <FilePreviewModal
     isOpen={!!previewFile}
     onClose={handlePreviewClose}
     file={previewFile}
     fileUrl={previewUrl}
   >
     {renderPreviewContent()}
   </FilePreviewModal>
   ```

7. **Badge import:** Add `Badge` to the imports from `@/components/ui/badge` if not already imported.

The overall structure should be: the page owns the data and preview state, passes data down to the slider content components, and handles attachment preview modals at the page level.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Visit `http://localhost:3000/qmhq/new?qmrl={valid_qmrl_id}` and verify the slider shows QMRL details and sibling QMHQ list in tabs. Verify toggle button in header works. Verify mobile floating button works. Verify old QmrlContextPanel import is removed.
  </verify>
  <done>
QMHQ create page uses new ContextSlider + QmrlSliderContent + SiblingQmhqList components. Old QmrlContextPanel is no longer imported. Slider shows two tabs: QMRL Details (full view with attachments) and QMHQ Lines (sibling list with count badge). Toggle button in header. Push-content layout on desktop, slide-in drawer on mobile.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. QMHQ create page loads at `/qmhq/new?qmrl={id}` with slider showing QMRL details
4. Slider has two tabs: "QMRL Details" and "QMHQ Lines" (with count badge)
5. QMRL Details tab shows all fields: ID, title, status, category, priority, date, description (collapsible), notes (collapsible), department, contact, attachments
6. QMHQ Lines tab shows sibling list with route type icon, line name, request ID, status badge
7. Sibling lines are view-only (no clickable links)
8. Toggle button visible in page header on desktop
9. Slider defaults open on desktop, closed on mobile
10. Mobile floating "Context" button appears when slider is closed
11. Mobile backdrop closes slider on tap
12. Old QmrlContextPanel import removed from QMHQ create page
</verification>

<success_criteria>
QMHQ create page shows QMRL context in a tabbed side slider that pushes form content. The slider is built from reusable components (ContextSlider shell, QmrlSliderContent, SiblingQmhqList) that can be composed for the stock-out page in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/31-context-sliders/31-01-SUMMARY.md`
</output>
