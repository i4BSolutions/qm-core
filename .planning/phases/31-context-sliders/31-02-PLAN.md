---
phase: 31-context-sliders
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - components/context-slider/qmhq-slider-content.tsx
  - app/(dashboard)/inventory/stock-out-requests/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Stock-out request create page shows QMRL and QMHQ details in right side slider when linked to QMHQ"
    - "Slider has two tabs: QMRL and QMHQ"
    - "Slider only appears when stock-out request originates from QMHQ (has ?qmhq= param)"
    - "Manual stock-out requests (no QMHQ link) have no slider"
    - "Slider pushes form content on desktop (both visible simultaneously)"
    - "Slider is open by default on desktop, closed on mobile, toggleable"
  artifacts:
    - path: "components/context-slider/qmhq-slider-content.tsx"
      provides: "Full QMHQ detail display for slider (line name, route type, status, category, items, financial data)"
      exports: ["QmhqSliderContent"]
    - path: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      provides: "Stock-out request create page with context slider showing QMRL and QMHQ"
  key_links:
    - from: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      to: "components/context-slider/context-slider.tsx"
      via: "import and render ContextSlider"
      pattern: "ContextSlider"
    - from: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      to: "components/context-slider/qmrl-slider-content.tsx"
      via: "import and render inside QMRL tab"
      pattern: "QmrlSliderContent"
    - from: "app/(dashboard)/inventory/stock-out-requests/new/page.tsx"
      to: "components/context-slider/qmhq-slider-content.tsx"
      via: "import and render inside QMHQ tab"
      pattern: "QmhqSliderContent"
---

<objective>
Add context slider to the stock-out request create page showing both QMRL and QMHQ details in tabs when the request is linked to a QMHQ item route.

Purpose: Users creating stock-out requests from QMHQ need to see the full request context (both the parent QMRL and the specific QMHQ line) while filling out the form, without navigating away.

Output: QmhqSliderContent component and updated stock-out request create page with context slider.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-context-sliders/31-CONTEXT.md
@.planning/phases/31-context-sliders/31-RESEARCH.md
@.planning/phases/31-context-sliders/31-01-SUMMARY.md
@app/(dashboard)/inventory/stock-out-requests/new/page.tsx
@components/context-slider/context-slider.tsx
@components/context-slider/qmrl-slider-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QmhqSliderContent component for QMHQ detail display in slider</name>
  <files>
    components/context-slider/qmhq-slider-content.tsx
  </files>
  <action>
Create a new `'use client'` component at `components/context-slider/qmhq-slider-content.tsx` that renders full QMHQ details inside the slider (per user decision: full detail view, not summarized).

Props interface:
```typescript
interface QmhqSliderContentProps {
  qmhq: QMHQWithSliderRelations | null;
  isLoading: boolean;
}

interface QMHQWithSliderRelations {
  id: string;
  request_id: string | null;
  line_name: string | null;
  route_type: 'item' | 'expense' | 'po';
  description: string | null;
  notes: string | null;
  quantity: number | null;
  amount: number | null;
  currency: string | null;
  exchange_rate: number | null;
  amount_eusd: number | null;
  budget_amount: number | null;
  budget_currency: string | null;
  budget_exchange_rate: number | null;
  budget_amount_eusd: number | null;
  status?: { name: string; color: string } | null;
  category?: { name: string; color: string } | null;
  assigned_user?: { full_name: string } | null;
  contact_person?: { name: string; position: string | null } | null;
  item?: { name: string; sku: string | null } | null;
  qmhq_items?: Array<{
    item: { name: string; sku: string | null };
    quantity: number;
  }>;
}
```

Display sections (mirror the QMHQ detail page structure, but condensed for slider width):

1. **QMHQ ID Badge:** Same pattern as QMRL — monospace amber code in slate-800 container.
2. **Line Name:** `text-base font-semibold text-slate-200`.
3. **Route Type Badge:** Icon (Package/Wallet/ShoppingCart) + label with route-specific color. Use same `routeConfig` as existing codebase.
4. **Status + Category badges:** Flex wrap row, same colored Badge pattern.
5. **Assigned To:** User icon + name if present.
6. **Contact Person:** User icon + name/position if present.

7. **Route-specific section:**
   - **Item route:** Show item name + SKU, quantity. If `qmhq_items` array exists, show each item in a list.
   - **Expense route:** Show amount with currency, exchange rate (4 decimals), EUSD equivalent. Use CurrencyDisplay component if available, otherwise format manually.
   - **PO route:** Show budget amount with currency, exchange rate (4 decimals), budget EUSD equivalent.

8. **Description:** Collapsible with "Show more/less" (same pattern as QmrlSliderContent — line-clamp-4, expand if >200 chars).
9. **Notes:** Same collapsible pattern.

Loading state: Skeleton rows (same pattern as QmrlSliderContent).
Empty/null state: "No QMHQ data" centered text with alert icon.

Import route type config (Package, Wallet, ShoppingCart icons) and formatting utilities. Use `formatCurrency` from `@/lib/utils` for amounts.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. File exists at `components/context-slider/qmhq-slider-content.tsx`.
  </verify>
  <done>
QmhqSliderContent component created with full QMHQ detail display including route-specific financial/item sections, status/category badges, collapsible description/notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate context slider into stock-out request create page</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/new/page.tsx
  </files>
  <action>
Modify the stock-out request create page to add a context slider with QMRL | QMHQ tabs when the request is linked to a QMHQ.

**Key constraint from user decisions:**
- Slider only appears when stock-out request originates from QMHQ item route (`?qmhq=` param present)
- Manual requests (no qmhq param) have NO slider
- Two tabs: QMRL | QMHQ

**Changes to make:**

1. **Add imports:**
   ```tsx
   import { ContextSlider } from "@/components/context-slider/context-slider";
   import { QmrlSliderContent } from "@/components/context-slider/qmrl-slider-content";
   import { QmhqSliderContent } from "@/components/context-slider/qmhq-slider-content";
   import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
   import { PanelRightOpen, PanelRightClose } from "lucide-react";
   import { getFileUrl, type FileAttachmentWithUploader } from "@/lib/actions/files";
   import { FilePreviewModal } from "@/components/files/file-preview-modal";
   import { ImagePreview } from "@/components/files/image-preview";
   import dynamic from "next/dynamic";
   ```
   Also dynamically import PDFPreview (same pattern as qmrl-context-panel.tsx).

2. **Add slider state:**
   ```tsx
   const [isPanelOpen, setIsPanelOpen] = useState(() => {
     if (typeof window !== 'undefined') {
       return window.innerWidth >= 768;
     }
     return true;
   });
   ```

3. **Add data state for slider content:**
   - `qmrlData` — full QMRL with relations (for QMRL tab)
   - `qmhqFullData` — full QMHQ with relations (for QMHQ tab, extended beyond the existing `qmhqData`)
   - `qmrlAttachments` — FileAttachmentWithUploader[]
   - `thumbnailUrls` — Map<string, string>
   - `isSliderLoading` — boolean
   - Preview state: `previewFile`, `previewUrl`, `isLoadingPreview`
   - Preview handlers: `handleAttachmentClick`, `handlePreviewClose`, `renderPreviewContent`

4. **Fetch slider data after QMHQ loads:**
   Add a second `useEffect` that runs after `qmhqData` is set (when qmhqId is present and QMHQ fetch completes). This effect:
   - Gets the `qmrl_id` from the QMHQ record. Since the existing fetch doesn't include `qmrl_id`, extend the existing QMHQ select query to also fetch `qmrl_id`.
   - Then fetches:
     a. **Full QMHQ with slider relations:** `supabase.from('qmhq').select('*, status:status_config(name, color), category:categories(name, color), assigned_user:users!qmhq_assigned_to_fkey(full_name), contact_person:contact_persons(name, position), qmhq_items(quantity, item:items(name, sku))').eq('id', qmhqId).single()`
     b. **Parent QMRL with relations:** `supabase.from('qmrl').select('*, status:status_config(*), category:categories(*), department:departments(*), contact_person:contact_persons(*)').eq('id', qmrlId).single()`
     c. **QMRL attachments:** `supabase.from('file_attachments').select('*, uploaded_by_user:users!uploaded_by(full_name, email)').eq('entity_type', 'qmrl').eq('entity_id', qmrlId).is('deleted_at', null).order('uploaded_at', { ascending: false })`
   - Load thumbnail URLs for image attachments.

   IMPORTANT: To get `qmrl_id`, modify the existing QMHQ fetch query (around line 82-90) to include `qmrl_id` in the select. Change:
   ```
   .select(`id, request_id, line_name, item_id, quantity, route_type, ...`)
   ```
   to:
   ```
   .select(`id, request_id, line_name, item_id, quantity, route_type, qmrl_id, ...`)
   ```
   Also update the `QMHQData` interface to include `qmrl_id: string | null`.

5. **Add toggle button in header:**
   Only show when `qmhqId` is present (slider is relevant). In the header section (around line 326-341), add a toggle button next to the title:
   ```tsx
   <div className="flex-1">
     <div className="flex items-center gap-3">
       <h1 className="text-2xl font-bold text-white tracking-tight">
         New Stock-Out Request
       </h1>
       {qmhqId && (
         <button
           onClick={() => setIsPanelOpen(prev => !prev)}
           className="hidden md:inline-flex items-center gap-1 px-2 py-1 rounded text-xs text-slate-400 hover:text-amber-400 hover:bg-slate-800 transition-colors"
           aria-label={isPanelOpen ? "Hide context panel" : "Show context panel"}
         >
           {isPanelOpen ? <PanelRightClose className="h-4 w-4" /> : <PanelRightOpen className="h-4 w-4" />}
         </button>
       )}
     </div>
     <p className="text-sm text-slate-400 mt-1">
       Request items to be issued from warehouse
     </p>
   </div>
   ```

6. **Change the outer container layout:**
   Replace the current `<div className="p-8 max-w-3xl mx-auto space-y-6">` (line 324) with a conditional grid layout when slider is present:
   ```tsx
   <div className={cn(
     "p-8 space-y-6",
     qmhqId
       ? "md:grid md:grid-cols-[1fr_320px] lg:grid-cols-[1fr_384px] md:gap-6 md:max-w-none md:space-y-0"
       : "max-w-3xl mx-auto"
   )}>
     {/* Wrap existing form content in a div when grid is active */}
     <div className={qmhqId ? "space-y-6" : ""}>
       {/* All existing header, banner, form, and action content goes here */}
     </div>

     {/* Context Slider - only when QMHQ-linked */}
     {qmhqId && (
       <ContextSlider
         isOpen={isPanelOpen}
         onToggle={() => setIsPanelOpen(prev => !prev)}
         title="Request Context"
       >
         <Tabs defaultValue="qmrl" className="w-full">
           <TabsList className="grid w-full grid-cols-2">
             <TabsTrigger value="qmrl">QMRL</TabsTrigger>
             <TabsTrigger value="qmhq">QMHQ</TabsTrigger>
           </TabsList>
           <TabsContent value="qmrl">
             <QmrlSliderContent
               qmrl={qmrlData}
               isLoading={isSliderLoading}
               attachments={qmrlAttachments}
               thumbnailUrls={thumbnailUrls}
               onAttachmentClick={handleAttachmentClick}
               qmhqLinesCount={0}
             />
           </TabsContent>
           <TabsContent value="qmhq">
             <QmhqSliderContent
               qmhq={qmhqFullData}
               isLoading={isSliderLoading}
             />
           </TabsContent>
         </Tabs>
       </ContextSlider>
     )}

     {/* File Preview Modal */}
     {qmhqId && (
       <FilePreviewModal
         isOpen={!!previewFile}
         onClose={handlePreviewClose}
         file={previewFile}
         fileUrl={previewUrl}
       >
         {renderPreviewContent()}
       </FilePreviewModal>
     )}
   </div>
   ```

7. **Remove the existing QMHQ Reference Banner** (lines 344-356) since that context information is now in the slider's QMHQ tab. OR keep a minimal one-line reference and let the slider show full details. Per the design — keep the banner as it serves as a quick reference when slider is collapsed. Leave it as-is.

8. **Import `cn`** from `@/lib/utils` if not already imported.

9. **Handle the loading/skeleton state:** The existing page has loading and error states. The slider data fetch should NOT block the form from loading. Use a separate `isSliderLoading` state. The form shows immediately; slider content loads in parallel.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Test these scenarios:
1. Visit `/inventory/stock-out-requests/new` (no qmhq param) — no slider shown, form displays at max-w-3xl as before.
2. Visit `/inventory/stock-out-requests/new?qmhq={valid_id}` — slider appears with QMRL | QMHQ tabs, form content pushed to left.
3. Click QMRL tab — shows full QMRL details with attachments.
4. Click QMHQ tab — shows full QMHQ details with route-specific info.
5. Click toggle button in header — slider collapses/expands.
6. On mobile viewport — slider closed by default, floating button opens it, backdrop closes it.
  </verify>
  <done>
Stock-out request create page shows context slider with QMRL | QMHQ tabs when linked to a QMHQ. Manual requests show no slider. Push-content layout on desktop. Toggle via header button. Mobile drawer with floating toggle.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Stock-out request page at `/inventory/stock-out-requests/new?qmhq={id}` shows slider
4. Slider has two tabs: "QMRL" and "QMHQ"
5. QMRL tab shows full QMRL details (same quality as QMHQ create page slider)
6. QMHQ tab shows full QMHQ details including route-specific info (item/expense/PO data)
7. Manual request page (no qmhq param) has NO slider
8. Toggle button in header works on desktop
9. Slider defaults open on desktop, closed on mobile
10. Mobile floating button and backdrop work correctly
</verification>

<success_criteria>
Stock-out request create page shows contextual QMRL and QMHQ information in a tabbed side slider when linked to a QMHQ item route. Manual requests are unaffected. Both the QMHQ create page (Plan 01) and stock-out page (Plan 02) share the same ContextSlider shell component.
</success_criteria>

<output>
After completion, create `.planning/phases/31-context-sliders/31-02-SUMMARY.md`
</output>
