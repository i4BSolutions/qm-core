---
phase: 50-standard-quantity-display
plan: 03
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - app/(dashboard)/warehouse/[id]/page.tsx
  - app/(dashboard)/inventory/page.tsx
  - app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
  - components/stock-out-requests/line-item-table.tsx
  - components/stock-out-requests/stock-out-pdf-button.tsx
  - lib/pdf/documents/stock-out-pdf.tsx
autonomous: true

must_haves:
  truths:
    - "Warehouse detail inventory table shows standard qty alongside current stock for each item"
    - "Inventory dashboard transaction list shows standard qty alongside quantity"
    - "Stock-out request detail shows standard qty on line items and approval quantities"
    - "Stock-out PDF receipt includes standard qty for line items and approvals"
  artifacts:
    - path: "app/(dashboard)/warehouse/[id]/page.tsx"
      provides: "Warehouse detail with standard qty on inventory rows"
    - path: "app/(dashboard)/inventory/page.tsx"
      provides: "Inventory dashboard with standard qty on transaction list"
    - path: "app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx"
      provides: "Stock-out request detail with standard qty"
    - path: "components/stock-out-requests/line-item-table.tsx"
      provides: "Line item table with standard qty display"
    - path: "lib/pdf/documents/stock-out-pdf.tsx"
      provides: "Stock-out PDF with standard qty column"
  key_links:
    - from: "app/(dashboard)/warehouse/[id]/page.tsx"
      to: "components/ui/standard-unit-display.tsx"
      via: "import StandardUnitDisplay"
      pattern: "StandardUnitDisplay"
    - from: "app/(dashboard)/inventory/page.tsx"
      to: "components/ui/standard-unit-display.tsx"
      via: "import StandardUnitDisplay"
      pattern: "StandardUnitDisplay"
---

<objective>
Add standard quantity display to inventory, warehouse, and stock-out request pages, including PDF export.

Purpose: Inventory and warehouse views show quantity data that needs standard unit equivalents. Stock-out requests show requested/approved quantities that also need standard unit conversion.
Output: Updated warehouse detail, inventory dashboard, stock-out request detail, stock-out line item table, and stock-out PDF with standard qty display.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-standard-quantity-display/50-01-SUMMARY.md
@app/(dashboard)/warehouse/[id]/page.tsx
@app/(dashboard)/inventory/page.tsx
@app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
@components/stock-out-requests/line-item-table.tsx
@lib/pdf/documents/stock-out-pdf.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add standard qty to warehouse detail and inventory dashboard</name>
  <files>
    app/(dashboard)/warehouse/[id]/page.tsx
    app/(dashboard)/inventory/page.tsx
  </files>
  <action>
**Warehouse Detail Page (app/(dashboard)/warehouse/[id]/page.tsx):**

1. Import `StandardUnitDisplay` from `@/components/ui/standard-unit-display`.

2. The warehouse detail page has an inventory table showing items with `current_stock`. The inventory data is computed from summing `inventory_in` and subtracting `inventory_out` transactions. Since inventory is aggregated across transactions (each with different conversion_rates), the warehouse inventory view does NOT have a single conversion_rate per item.

3. **Approach for warehouse inventory:** Since each inventory transaction has its own conversion_rate, and the warehouse page shows aggregated stock per item, we need to also aggregate the standard_qty. Modify the data fetching to also sum `standard_qty` from inventory_transactions for each item in this warehouse.

4. Update the inventory query to include `conversion_rate` and `standard_qty` from inventory_transactions:
   ```typescript
   // When computing inventory per item, also track standard qty
   // Each transaction has: quantity, conversion_rate, standard_qty (generated column = qty * rate)
   ```
   In the reduce loop where `current_stock` is calculated, also accumulate `standard_stock`:
   ```typescript
   if (t.movement_type === "inventory_in") {
     inv.current_stock += t.quantity;
     inv.standard_stock += (t.standard_qty ?? t.quantity);
   } else if (t.movement_type === "inventory_out") {
     inv.current_stock -= t.quantity;
     inv.standard_stock -= (t.standard_qty ?? t.quantity);
   }
   ```

5. Add `standard_stock` to `WarehouseInventoryItem` interface and display it below `current_stock` using `useStandardUnitName()` hook. Format as a second line in smaller muted text:
   ```tsx
   <div className="text-right">
     <span className="font-mono text-slate-200">{formatStockQuantity(item.current_stock)}</span>
     {unitName && (
       <div className="text-xs font-mono text-slate-400">
         {item.standard_stock.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} {unitName}
       </div>
     )}
   </div>
   ```

6. Update warehouse KPI total units card to also show standard units total alongside.

7. Make sure to fetch `standard_qty` in the Supabase select query for inventory_transactions.

**Inventory Dashboard Page (app/(dashboard)/inventory/page.tsx):**

1. Import `StandardUnitDisplay`.

2. Find the transaction table that shows individual inventory transactions. Each transaction row has a `quantity` column (currently displaying +/- quantity). Update to use StandardUnitDisplay:
   ```tsx
   // In the DataTable column definition for "quantity":
   cell: ({ row }) => {
     const type = row.original.movement_type;
     const qty = row.getValue("quantity") as number;
     const conversionRate = row.original.conversion_rate ?? 1;
     const prefix = type === "inventory_in" ? "+" : "-";
     return (
       <div className={type === "inventory_in" ? "text-emerald-400" : "text-red-400"}>
         <span className="font-mono">{prefix}{qty}</span>
         {unitName && (
           <div className="text-xs font-mono text-slate-400">
             {prefix}{(qty * conversionRate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} {unitName}
           </div>
         )}
       </div>
     );
   }
   ```

3. Add `useStandardUnitName()` to the component and conditionally show the standard qty line.

4. Make sure the Supabase select for transactions includes `conversion_rate` field.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(warehouse|inventory/page)" | head -20` — should return 0 type errors.
  </verify>
  <done>
Warehouse detail shows standard stock per item and in KPI totals. Inventory dashboard transaction list shows standard qty alongside +/- quantity. Both use conversion_rate from database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add standard qty to stock-out request detail and PDF</name>
  <files>
    app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx
    components/stock-out-requests/line-item-table.tsx
    components/stock-out-requests/stock-out-pdf-button.tsx
    lib/pdf/documents/stock-out-pdf.tsx
  </files>
  <action>
**Stock-Out Request Line Item Table (components/stock-out-requests/line-item-table.tsx):**

1. Import `useStandardUnitName` from `@/lib/hooks/use-standard-unit-name`.

2. Update `LineItemWithApprovals` interface to include `conversion_rate`:
   ```typescript
   export interface LineItemWithApprovals {
     // ... existing fields
     conversion_rate: number; // NEW
   }
   ```

3. In the table body where `requested_quantity` is displayed, add standard qty below:
   ```tsx
   <span className="font-mono">{item.requested_quantity}</span>
   {unitName && (
     <div className="text-xs font-mono text-slate-400">
       {(item.requested_quantity * item.conversion_rate).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} {unitName}
     </div>
   )}
   ```

4. Similarly update approved/rejected quantity displays in the table to show standard equivalents.

**Stock-Out Request Detail Page (app/(dashboard)/inventory/stock-out-requests/[id]/page.tsx):**

1. Update the data fetching query for line items to include `conversion_rate` from `stock_out_line_items`:
   ```typescript
   // In the select query, add conversion_rate
   item_id, item_name, item_sku, requested_quantity, conversion_rate, status, ...
   ```

2. Pass `conversion_rate` through to LineItemWithApprovals when mapping data.

3. In the approval cards section (where `approval.approved_quantity` is displayed), add standard qty below:
   ```tsx
   <span className="font-mono text-slate-300">{approval.approved_quantity}</span>
   {unitName && (
     <div className="text-xs font-mono text-slate-400">
       {(approval.approved_quantity * lineItemConversionRate).toLocaleString(...)} {unitName}
     </div>
   )}
   ```
   Note: The approval doesn't have its own conversion_rate; use the parent line item's rate.

4. In the transaction cards section (where `tx.quantity` is displayed as `-{tx.quantity}`), add standard qty:
   ```tsx
   <div className="text-lg font-mono font-bold text-red-400">-{tx.quantity}</div>
   {unitName && (
     <div className="text-xs font-mono text-slate-400">
       -{(tx.quantity * (tx.conversion_rate ?? 1)).toLocaleString(...)} {unitName}
     </div>
   )}
   ```

5. Import and use `useStandardUnitName()` at component level.

6. Make sure the transaction query includes `conversion_rate` in the select.

**Stock-Out PDF (lib/pdf/documents/stock-out-pdf.tsx):**

1. Add `conversion_rate?: number` to the lineItems type and `standardUnitName?: string` to StockOutPDFProps.

2. If `standardUnitName` is provided, add a "Std Qty" column to the line items table showing `requested_quantity * conversion_rate`.

3. Add `conversion_rate?: number` to approvals type. In the approvals table, add standard qty column showing `approved_quantity * conversion_rate`.

4. Use the muted color (#94A3B8) for standard qty text matching the EUSD secondary line pattern.

**Stock-Out PDF Button (components/stock-out-requests/stock-out-pdf-button.tsx):**

1. Add `conversion_rate?: number` to lineItems array type.
2. Add `standardUnitName?: string` prop.
3. Pass `standardUnitName` to StockOutPDF component.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(stock-out|line-item-table)" | head -20` — should return 0 type errors.
  </verify>
  <done>
Stock-out request line item table shows standard qty for requested/approved quantities. Stock-out request detail page shows standard qty on line items, approvals, and transactions. Stock-out PDF includes standard qty columns. All use conversion_rate from database.
  </done>
</task>

</tasks>

<verification>
1. Warehouse detail page shows standard stock per item in inventory table
2. Warehouse KPI total units shows standard qty equivalent
3. Inventory dashboard transaction list shows standard qty alongside quantity
4. Stock-out request line items show standard qty for requested quantity
5. Stock-out request detail shows standard qty on approvals and transactions
6. Stock-out PDF includes standard qty columns
7. No TypeScript errors in modified files
</verification>

<success_criteria>
- Warehouse detail inventory rows show aggregated standard stock from transaction standard_qty
- Inventory transaction list shows standard qty per transaction
- Stock-out request displays show standard qty for all quantity fields
- Stock-out PDF includes standard qty when standardUnitName is provided
- Existing data with conversion_rate=1 displays correctly
</success_criteria>

<output>
After completion, create `.planning/phases/50-standard-quantity-display/50-03-SUMMARY.md`
</output>
