---
phase: 50-standard-quantity-display
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - components/po/po-line-items-table.tsx
  - components/invoice/invoice-line-items-table.tsx
  - lib/pdf/documents/invoice-pdf.tsx
  - components/invoice/invoice-pdf-button.tsx
  - app/(dashboard)/invoice/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "PO detail readonly line items table shows standard qty below each quantity value"
    - "Invoice detail readonly line items table shows standard qty below each quantity value"
    - "PO subtotal row shows summed standard qty total"
    - "Invoice subtotal row shows summed standard qty total"
    - "Invoice PDF receipt includes standard qty column alongside quantity"
    - "Invoice creation Step 3 summary shows standard qty for each line item"
  artifacts:
    - path: "components/po/po-line-items-table.tsx"
      provides: "ReadonlyLineItemsTable with StandardUnitDisplay on qty column"
    - path: "components/invoice/invoice-line-items-table.tsx"
      provides: "ReadonlyInvoiceLineItemsTable with StandardUnitDisplay on qty column"
    - path: "lib/pdf/documents/invoice-pdf.tsx"
      provides: "Invoice PDF with standard qty column"
    - path: "components/invoice/invoice-pdf-button.tsx"
      provides: "InvoicePDFButton passing conversion_rate to PDF"
  key_links:
    - from: "components/po/po-line-items-table.tsx"
      to: "components/ui/standard-unit-display.tsx"
      via: "import StandardUnitDisplay"
      pattern: "StandardUnitDisplay"
    - from: "components/invoice/invoice-line-items-table.tsx"
      to: "components/ui/standard-unit-display.tsx"
      via: "import StandardUnitDisplay"
      pattern: "StandardUnitDisplay"
---

<objective>
Add standard quantity display to PO and Invoice detail pages, including PDF export.

Purpose: PO and Invoice line items are the primary transactional views where users need to see standard unit equivalents alongside original quantities.
Output: Updated PO line items table, Invoice line items table, Invoice PDF, and Invoice creation summary with standard qty display.
</objective>

<execution_context>
@/home/yaungni/.claude/get-shit-done/workflows/execute-plan.md
@/home/yaungni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-standard-quantity-display/50-01-SUMMARY.md
@components/po/po-line-items-table.tsx
@components/invoice/invoice-line-items-table.tsx
@components/invoice/invoice-pdf-button.tsx
@lib/pdf/documents/invoice-pdf.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StandardUnitDisplay to PO and Invoice readonly line items tables</name>
  <files>
    components/po/po-line-items-table.tsx
    components/invoice/invoice-line-items-table.tsx
  </files>
  <action>
**PO ReadonlyLineItemsTable (components/po/po-line-items-table.tsx):**

1. Import `StandardUnitDisplay` from `@/components/ui/standard-unit-display`.

2. In the `ReadonlyLineItemsTable` component, update the Qty column cell (currently at line ~447-455):
   - Replace the plain `{item.quantity}` display with `StandardUnitDisplay`:
   ```tsx
   <td className="py-3 px-3 text-right">
     <StandardUnitDisplay
       quantity={item.quantity}
       conversionRate={item.conversion_rate ?? 1}
       size="sm"
       align="right"
     />
   </td>
   ```
   - Remove the existing `item_unit` span since it's replaced by the standard unit display.

3. In the footer/subtotal row, add a standard qty total. Calculate `totalStandardQty` from items:
   ```tsx
   const totalStandardQty = items.reduce(
     (sum, item) => sum + (item.quantity * (item.conversion_rate ?? 1)),
     0
   );
   ```
   Display below the subtotal amount label or in the Qty column footer cell, formatted as `{totalStandardQty.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} {unitName}` using `useStandardUnitName()` hook. Since ReadonlyLineItemsTable is already "use client", add the hook at component level.

4. The `ReadonlyLineItemsTableProps` interface already receives POLineItem which has `conversion_rate` in the database type. The existing `items` prop type is `(POLineItem & { item?: ... })[]` — POLineItem already includes `conversion_rate: number` from Phase 47 types. No interface changes needed.

**Invoice ReadonlyInvoiceLineItemsTable (components/invoice/invoice-line-items-table.tsx):**

1. Import `StandardUnitDisplay`.

2. Update the Qty column cell (currently at line ~302-308):
   ```tsx
   <td className="py-3 px-3 text-right">
     <StandardUnitDisplay
       quantity={qty}
       conversionRate={item.conversion_rate ?? 1}
       size="sm"
       align="right"
     />
   </td>
   ```
   - Remove the existing `item_unit` span.

3. Add standard qty total to footer row, same approach as PO table.

4. The InvoiceLineItem type already includes `conversion_rate: number` from Phase 47 types.

**Important:** Do NOT modify the Editable variants (EditableLineItemsTable, EditableInvoiceLineItemsTable). Those are for form input where ConversionRateInput is already present. StandardUnitDisplay is for readonly/display only.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(po-line-items|invoice-line-items)" | head -20` — should return 0 type errors for these files.
  </verify>
  <done>
PO ReadonlyLineItemsTable shows StandardUnitDisplay in Qty column with per-line standard qty and footer total. Invoice ReadonlyInvoiceLineItemsTable shows the same pattern. Both use conversion_rate from their database types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add standard qty to Invoice PDF and Invoice creation summary</name>
  <files>
    lib/pdf/documents/invoice-pdf.tsx
    components/invoice/invoice-pdf-button.tsx
    app/(dashboard)/invoice/new/page.tsx
  </files>
  <action>
**Invoice PDF (lib/pdf/documents/invoice-pdf.tsx):**

1. Update the `lineItems` type in `InvoicePDFProps` to include `conversion_rate`:
   ```tsx
   lineItems: Array<{
     item_name?: string;
     item_sku?: string;
     quantity: number;
     unit_price: number;
     line_total: number;
     line_total_eusd?: number;
     received_quantity?: number;
     po_unit_price?: number;
     conversion_rate?: number;  // NEW
     standard_qty?: number;     // NEW (pre-calculated)
     standard_unit_name?: string; // NEW (passed from parent)
   }>;
   ```

2. Add a `standardUnitName` prop to InvoicePDFProps (optional string). If provided, show standard qty column/line in the PDF table.

3. In the PDF table columns definition, add a "Std Qty" column if standardUnitName is provided:
   ```tsx
   ...(standardUnitName ? [{
     header: "Std Qty",
     key: "standard_qty",
     width: "12%",
     align: "right" as const,
   }] : []),
   ```
   Adjust other column widths to accommodate (reduce Item from 30% to 25%, etc.).

4. In the row rendering, add the standard_qty cell:
   ```tsx
   ...(standardUnitName ? {
     standard_qty: (
       <Text style={{ fontFamily: "Courier", fontSize: 9, color: "#94A3B8" }}>
         {((li.quantity * (li.conversion_rate ?? 1)).toFixed(2))} {standardUnitName}
       </Text>
     ),
   } : {}),
   ```

5. Add a total standard qty row in the summary section below total amount (if standardUnitName provided).

**Invoice PDF Button (components/invoice/invoice-pdf-button.tsx):**

1. Add `conversion_rate?: number` to the lineItems array type.
2. Add `standardUnitName?: string` prop to InvoicePDFButtonProps.
3. Pass `standardUnitName` prop to the InvoicePDF component.

**Invoice creation Step 3 summary (app/(dashboard)/invoice/new/page.tsx):**

1. Find the Step 3 (Summary) section that displays line items before submission.
2. Import `StandardUnitDisplay` and add it to the quantity display in the summary table.
3. Look for where conversion_rate is displayed in Step 3 (added in Phase 49-02) and add the standard qty below the quantity in the same section.
4. Import `useStandardUnitName` and use it to conditionally show standard quantities.

**Key constraint:** The PDF uses @react-pdf/renderer which is server-rendered. Do NOT use React hooks (useStandardUnitName) inside PDF components. Instead, pass the `standardUnitName` as a prop from the parent page component that calls InvoicePDFButton.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(invoice-pdf|invoice/new)" | head -20` — should return 0 type errors.
  </verify>
  <done>
Invoice PDF includes standard qty column when standardUnitName is provided. InvoicePDFButton accepts and passes standardUnitName. Invoice creation summary page shows standard qty alongside quantity in Step 3.
  </done>
</task>

</tasks>

<verification>
1. PO detail page shows standard qty below each line item quantity
2. PO detail page footer shows total standard qty
3. Invoice detail page shows standard qty below each line item quantity
4. Invoice PDF includes standard qty column
5. Invoice creation Step 3 summary shows standard qty
6. No TypeScript errors in modified files
</verification>

<success_criteria>
- ReadonlyLineItemsTable (PO) renders StandardUnitDisplay in Qty cells
- ReadonlyInvoiceLineItemsTable renders StandardUnitDisplay in Qty cells
- Both tables show summed standard qty totals in footer
- Invoice PDF includes standard qty column
- Invoice Step 3 summary shows standard qty
- Existing transactions with conversion_rate=1 display correctly
</success_criteria>

<output>
After completion, create `.planning/phases/50-standard-quantity-display/50-02-SUMMARY.md`
</output>
